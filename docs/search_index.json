[["index.html", "Estimating Chlorination Take-up in Malawi and Uganda 1 Introduction", " Estimating Chlorination Take-up in Malawi and Uganda 2026-01-12 1 Introduction This notebook presents the code used for analysis in the report to GiveWell. To see the code used to create each exhibit, click on the Code button. "],["inputs.html", "2 Inputs 2.1 Villages 2.2 Water points 2.3 Household census 2.4 Household survey 2.5 Monitoring survey 2.6 Water point census 2.7 Promoter survey", " 2 Inputs Code pacman::p_load( sf, tidyverse, viridis, fixest, janitor, broom, car, modelsummary, survey ) 2.1 Villages 2.1.1 All villages in admin data Code villages &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;Villages&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;villages.rds&quot; ) ) %&gt;% dplyr::filter(!(country == &quot;Uganda&quot; &amp; !dsw)) 2.1.2 Sampled villages DSW villages were replaced at random (e.g. because of disputed village boundaries or because the village could not be identified under the names in the admin data). Therefore, we remove replaced villages from the analysis ILC villages were not replaced at random: these were replaced when no ILC was present in the village or when all of the water collection points were not functioning. Therefore, we consider replaced villages to have zero users. Code sampled_villages &lt;- villages %&gt;% dplyr::filter( (sample_group == &quot;ILC&quot; &amp; visited == &quot;In sample&quot;) | (sample_group != &quot;ILC&quot; &amp; visited == &quot;In sample&quot; &amp; !vil_replaced) ) village_intervention &lt;- sampled_villages %&gt;% crossing(wp_intervention = c(&quot;DSW&quot;, &quot;ILC&quot;)) %&gt;% dplyr::filter(!(wp_intervention == &quot;ILC&quot; &amp; sample_group != &quot;ILC&quot;)) 2.1.3 Calculate village sample sizes for weighing Code sample_sizes &lt;- villages %&gt;% mutate(sampled_village = village_id %in% sampled_villages$village_id) %&gt;% group_by(country, sample_group) %&gt;% summarise( n_villages = n_distinct(village_id), visited_villages = sum(visited == &quot;In sample&quot; &amp; !vil_replaced), sampled_villages = sum(sampled_village) ) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. 2.2 Water points Code wp_sample_sizes &lt;- tribble( ~ country, ~ sample_group, ~ wp_intervention, ~ pop_points, &quot;Uganda&quot;, &quot;Expansion&quot;, &quot;DSW&quot;, 12262, &quot;Uganda&quot;, &quot;Footprint&quot;, &quot;DSW&quot;, 5456, &quot;Uganda&quot;, &quot;ILC&quot;, &quot;DSW&quot;, 398, &quot;Uganda&quot;, &quot;ILC&quot;, &quot;ILC&quot;, 1229, &quot;Malawi&quot;, &quot;Expansion&quot;, &quot;DSW&quot;, 11292, &quot;Malawi&quot;, &quot;Footprint&quot;, &quot;DSW&quot;, 3844, &quot;Malawi&quot;, &quot;ILC&quot;, &quot;DSW&quot;, 1062, &quot;Malawi&quot;, &quot;ILC&quot;, &quot;ILC&quot;, 2024 ) 2.3 Household census Code hh_census &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;HouseholdCensus&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;hh-census.rds&quot; ) ) %&gt;% st_drop_geometry() %&gt;% # To account for non-responses, we calculate the village-level non-response rate group_by(village_id) %&gt;% mutate( response_rate = mean(response), intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) %&gt;% ungroup %&gt;% dplyr::filter( !(sample_group == &quot;ILC&quot; &amp; country == &quot;Uganda&quot;) ) 2.4 Household survey Code hh_survey &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;HouseholdSurvey&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;hh-survey.rds&quot; ) ) %&gt;% dplyr::filter( survey == &quot;Household Survey&quot; ) %&gt;% mutate( intervention_selfreport = case_when( hh_dsw ~ &quot;DSW&quot;, hh_ilc ~ &quot;ILC&quot; ), intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) %&gt;% dplyr::filter( !(sample_group == &quot;ILC&quot; &amp; country == &quot;Uganda&quot;) ) 2.5 Monitoring survey Code mon_survey &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;HouseholdSurvey&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;hh-survey.rds&quot; ) ) %&gt;% dplyr::filter( survey == &quot;Monitoring Survey&quot; ) %&gt;% mutate( intervention_selfreport = case_when( hh_dsw ~ &quot;DSW&quot;, hh_ilc ~ &quot;ILC&quot; ), intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) %&gt;% dplyr::filter( !(sample_group == &quot;ILC&quot; &amp; country == &quot;Uganda&quot;) ) 2.6 Water point census Code wp_census &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;WaterPointCensus&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;wp-census.rds&quot; ) ) %&gt;% st_drop_geometry %&gt;% mutate( intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) %&gt;% dplyr::filter( !(sample_group == &quot;ILC&quot; &amp; country == &quot;Uganda&quot;) ) 2.7 Promoter survey Code pm_survey &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;PromoterSurvey&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;pm-survey.rds&quot; ) ) %&gt;% left_join(villages) %&gt;% st_drop_geometry %&gt;% dplyr::filter( !(sample_group == &quot;ILC&quot; &amp; country == &quot;Uganda&quot;), !vil_replaced, !vil_dropped ) ## Joining with `by = join_by(village_id)` "],["sample-sizes-and-descriptives.html", "3 Sample sizes and descriptives 3.1 Summary table 3.2 Uganda 3.3 Malawi 3.4 Descriptive statistics", " 3 Sample sizes and descriptives Code pacman::p_load( dplyr, readr, tidyr, glue, sf, tidyverse, viridis, fixest, janitor, broom, car, modelsummary, survey, here ) 3.1 Summary table Code evac &lt;- villages %&gt;% mutate( sample_group = if_else( country == &quot;Uganda&quot;, pre_expansion %&gt;% as.character, sample_group %&gt;% as.character ) %&gt;% factor(levels = c(&quot;Footprint&quot;, &quot;Expansion&quot;, &quot;ILC&quot;), ordered = TRUE) ) %&gt;% group_by( country, sample_group, ea_program_vil ) %&gt;% summarise( districts = n_distinct(district_id), villages = n(), dsw = sum(dsw_wpt), ilc_wpt = sum(ilc_wpt), ilc_wcp = sum(ilc_wcp) ) %&gt;% ungroup %&gt;% select(-country) %&gt;% set_names( c( &quot;Village group&quot;, &quot;Active programs&quot;, &quot;Districts&quot;, &quot;Villages&quot;, &quot;DSW water points&quot;, &quot;ILC water points&quot;, &quot;ILC water collection points&quot; ) ) ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override ## using the `.groups` argument. Code evac %&gt;% kable( format = &quot;html&quot;, format.args = list(big.mark = &quot;,&quot;, decimal.mark = &quot;.&quot;) ) %&gt;% kable_paper(&quot;striped&quot;, full_width = TRUE) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 4) %&gt;% pack_rows(&quot;Uganda&quot;, 5, 8) Village group Active programs Districts Villages DSW water points ILC water points ILC water collection points Malawi Footprint DSW 1 1,161 2,187 0 0 Expansion DSW 8 4,809 12,949 0 0 ILC DSW &amp; ILC 8 275 1,062 212 1,087 ILC ILC 10 362 0 140 937 Uganda Footprint DSW 11 3,171 5,192 0 0 Footprint DSW &amp; ILC 11 161 264 80 342 Expansion DSW 22 4,012 11,942 0 0 Expansion DSW &amp; ILC 15 72 320 69 205 Code table &lt;- evac %&gt;% kable( format = &quot;latex&quot;, format.args = list(big.mark = &quot;,&quot;, decimal.mark = &quot;.&quot;), align = &quot;c&quot;, booktabs = T, caption = &quot;Summary of Evidence Action administrative data&quot;, label = &quot;population&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 4) %&gt;% pack_rows(&quot;Uganda&quot;, 5, 8) writeLines( table, &quot;output/appendix-tables/population.tex&quot; ) 3.2 Uganda 3.2.1 Villages Code villages %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% summarise( Visited = sum(!is.na(vil_replaced)), Replaced = sum(vil_replaced, na.rm = TRUE), Included = sum(!vil_replaced &amp; !vil_dropped, na.rm = TRUE), Footprint = sum(!vil_replaced &amp; !vil_dropped &amp; sample_group == &quot;Footprint&quot;, na.rm = TRUE), Expansion = sum(!vil_replaced &amp; !vil_dropped &amp; sample_group == &quot;Expansion&quot;, na.rm = TRUE) ) ## # A tibble: 1 × 5 ## Visited Replaced Included Footprint Expansion ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 86 9 77 30 30 3.2.2 Water points Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% summarise( All = n(), Eligible = sum(analysis, na.rm = TRUE), `ILC WPs` = sum(ilc), `ILC Villages` = if_else(ilc, village_id, NA) %&gt;% n_distinct(na.rm = TRUE), DSW = sum(dsw), Matched = sum(dsw &amp; !is.na(ea_id)), Unmatched = sum(dsw &amp; is.na(ea_id)), `Unmatched with ID` = sum(dsw &amp; is.na(ea_id) &amp; (!is.na(disp_dsw_id) | !is.na(disp_barcode))), `Unmatched with no ID` = sum(dsw &amp; is.na(ea_id) &amp; !wp_func) ) ## # A tibble: 1 × 9 ## All Eligible `ILC WPs` `ILC Villages` DSW Matched Unmatched ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 524 452 11 6 185 172 13 ## # ℹ 2 more variables: `Unmatched with ID` &lt;int&gt;, `Unmatched with no ID` &lt;int&gt; . 4 were located, but no longer had dispensers when the water point census took place. 7 are outside of the village boundaries according to the GPS data. 3.2.3 Water samples tested Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, dsw, disp_filled) %&gt;% summarise( `Filled dispensers` = n(), Disc = sum(!is.na(disctcr) | !is.na(discfcr)), Colorimeter = sum(!is.na(metertcr) | !is.na(meterfcr)) ) ## # A tibble: 1 × 3 ## `Filled dispensers` Disc Colorimeter ## &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 128 128 128 3.2.4 Household census Code hh_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% summarise( All = n(), Outside = sum(inclusion == &quot;Up to 200m outside of village boundaries&quot;), Responses = sum(response), `Responses (%)` = Responses/All ) ## # A tibble: 1 × 4 ## All Outside Responses `Responses (%)` ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; ## 1 9525 1515 8467 0.889 Code hh_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, response) %&gt;% summarise( `WP matched` = sum(!is.na(wp_id)), `WP matched (%)` = mean(!is.na(wp_id)), `DSW users` = sum(wp_dsw, na.rm = TRUE), `DSW users (%)` = mean(wp_dsw, na.rm = TRUE), Outside = sum(inclusion == &quot;Up to 200m outside of village boundaries&quot;), Responses = sum(response) ) ## # A tibble: 1 × 6 ## `WP matched` `WP matched (%)` `DSW users` `DSW users (%)` Outside Responses ## &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 8155 0.963 5963 0.754 1406 8467 3.2.5 Household survey Code hh_survey %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% summarise( All = n(), DSW = sum(wp_dsw, na.rm = TRUE), `DSW (%)` = DSW/All, `Non-program (%)` = sum(wp_intervention == &quot;Non-program&quot;, na.rm = TRUE)/All, `No WP (%)` = sum(is.na(wp_id), na.rm = TRUE)/All, `Water sample` = sum(water_sample, na.rm = TRUE), `Water sample (% DSW)` = `Water sample`/DSW, `Color wheel` = sum(!is.na(disctcr) | !is.na(discfcr)), Colorimeter = sum(!is.na(metertcr) | !is.na(meterfcr)) ) ## # A tibble: 1 × 9 ## All DSW `DSW (%)` `Non-program (%)` `No WP (%)` `Water sample` ## &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1209 1147 0.949 0.0323 0.00662 1067 ## # ℹ 3 more variables: `Water sample (% DSW)` &lt;dbl&gt;, `Color wheel` &lt;int&gt;, ## # Colorimeter &lt;int&gt; 3.2.6 Promoter survey Code pm_survey %&gt;% dplyr::filter(country == &quot;Uganda&quot;, sample_group != &quot;ILC&quot;) %&gt;% nrow ## [1] 119 Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, wp_id %in% pm_survey$wp_id) %&gt;% summarise(sum(promoter_surveyed)) ## # A tibble: 1 × 1 ## `sum(promoter_surveyed)` ## &lt;int&gt; ## 1 119 Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, sample_group != &quot;ILC&quot;, dsw) %&gt;% summarise(mean(promoter_surveyed)) ## # A tibble: 1 × 1 ## `mean(promoter_surveyed)` ## &lt;dbl&gt; ## 1 0.627 Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, sample_group != &quot;ILC&quot;, wp_id %in% pm_survey$wp_id) %&gt;% group_by(intervention) %&gt;% summarise(sum(promoter_surveyed)) ## # A tibble: 3 × 2 ## intervention `sum(promoter_surveyed)` ## &lt;fct&gt; &lt;int&gt; ## 1 DSW 115 ## 2 Non-program 1 ## 3 ILC 3 Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;, wp_id %in% pm_survey$wp_id, pm_ea_list) %&gt;% summarise(sum(promoter_surveyed)) ## # A tibble: 1 × 1 ## `sum(promoter_surveyed)` ## &lt;int&gt; ## 1 111 Code wp_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% group_by(pm_ea_list) %&gt;% summarise(sum(promoter_surveyed)) ## # A tibble: 3 × 2 ## pm_ea_list `sum(promoter_surveyed)` ## &lt;lgl&gt; &lt;int&gt; ## 1 FALSE 8 ## 2 TRUE 112 ## 3 NA 0 Code mon_survey %&gt;% dplyr::filter(country == &quot;Uganda&quot;, sample_group != &quot;ILC&quot;) %&gt;% nrow ## [1] 460 3.3 Malawi 3.3.1 Villages Code villages %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% summarise( Visited = sum(!is.na(vil_replaced)), Replaced = sum(vil_replaced, na.rm = TRUE), Included = sum(!vil_replaced &amp; !vil_dropped, na.rm = TRUE), Footprint = sum(!vil_replaced &amp; !vil_dropped &amp; sample_group == &quot;Footprint&quot;, na.rm = TRUE), Expansion = sum(!vil_replaced &amp; !vil_dropped &amp; sample_group == &quot;Expansion&quot;, na.rm = TRUE), ILC = sum(!vil_replaced &amp; !vil_dropped &amp; sample_group == &quot;ILC&quot;, na.rm = TRUE) ) ## # A tibble: 1 × 6 ## Visited Replaced Included Footprint Expansion ILC ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 107 7 99 28 28 43 3.3.2 ILC villages With ILC water collection points Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, ilc_wcp) %&gt;% summarise( WCPs = n(), Villages = n_distinct(village_id) ) %&gt;% kable WCPs Villages 178 39 With DSW Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, dsw, sample_group == &quot;ILC&quot;) %&gt;% summarise( WPs = n(), Villages = n_distinct(village_id) ) %&gt;% kable WPs Villages 66 24 3.3.3 Water point census Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, dsw) %&gt;% summarise( All = n(), `ILC sample group` = sum(sample_group == &quot;ILC&quot;), Matched = sum(dsw &amp; !is.na(ea_id)), Unmatched = sum(dsw &amp; is.na(ea_id)), `Unmatched with ID` = sum(dsw &amp; is.na(ea_id) &amp; (!is.na(disp_dsw_id) | !is.na(disp_barcode))) ) ## # A tibble: 1 × 5 ## All `ILC sample group` Matched Unmatched `Unmatched with ID` ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 202 66 197 5 5 Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, ilc, !is.na(ea_ilc_wpt)) %&gt;% summarise( Clusters = n_distinct(ea_ilc_wpt), WP = sum(ilc_wp), WCP = sum(ilc_wcp) ) ## # A tibble: 1 × 3 ## Clusters WP WCP ## &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 32 26 178 Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, ilc) %&gt;% group_by(ea_ilc_wpt) %&gt;% summarise( Tested = any(!is.na(disctcr)), Closer = sum(closer), `Closer tested` = sum((!is.na(disctcr) | is.na(discfcr)) &amp; closer), Count = sum(!is.na(disctcr)) ) %&gt;% summarise( across( -ea_ilc_wpt, ~sum(.) ) ) ## # A tibble: 1 × 4 ## Tested Closer `Closer tested` Count ## &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 20 15 15 63 3.3.4 Household census Code hh_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% summarise( Listed = n(), Surveyed = sum(response), `Surveyed (%)` = Surveyed/Listed, DSW = sum(wp_dsw, na.rm = TRUE), `DSW (%)` = DSW/Surveyed, ILC = sum(wp_ilc, na.rm = TRUE), `ILC (%)` = ILC/Surveyed ) %&gt;% kable Listed Surveyed Surveyed (%) DSW DSW (%) ILC ILC (%) 11426 11209 0.9810082 5361 0.4782764 1165 0.1039343 3.3.5 Household survey Code hh_survey %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% summarise( Total = n(), Villages = n_distinct(village_id), `Water available` = sum(water_sample), Tested = sum(!is.na(disctcr) | !is.na(discfcr)) ) %&gt;% kable Total Villages Water available Tested 1947 98 1932 1894 3.3.6 Promoter survey Code pm_survey %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% nrow ## [1] 196 Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, wp_id %in% pm_survey$wp_id) %&gt;% summarise(sum(promoter_surveyed)) ## # A tibble: 1 × 1 ## `sum(promoter_surveyed)` ## &lt;int&gt; ## 1 196 Code wp_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;, wp_id %in% pm_survey$wp_id) %&gt;% group_by(intervention, sample_group) %&gt;% summarise(sum(promoter_surveyed)) ## `summarise()` has grouped output by &#39;intervention&#39;. You can override using the ## `.groups` argument. ## # A tibble: 6 × 3 ## # Groups: intervention [3] ## intervention sample_group `sum(promoter_surveyed)` ## &lt;fct&gt; &lt;ord&gt; &lt;int&gt; ## 1 DSW Footprint 46 ## 2 DSW Expansion 59 ## 3 DSW ILC 45 ## 4 Non-program Footprint 2 ## 5 Non-program ILC 2 ## 6 ILC ILC 42 Code mon_survey %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% nrow ## [1] 724 3.4 Descriptive statistics 3.4.1 Average village sizes Code hh_census %&gt;% group_by(village_id, country, sample_group) %&gt;% summarise(size = n()) %&gt;% group_by(country, sample_group) %&gt;% summarise(mean(size)) ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;. You can override using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;. You can override using the `.groups` argument. ## # A tibble: 5 × 3 ## # Groups: country [2] ## country sample_group `mean(size)` ## &lt;chr&gt; &lt;ord&gt; &lt;dbl&gt; ## 1 Malawi Footprint 122. ## 2 Malawi Expansion 111. ## 3 Malawi ILC 114. ## 4 Uganda Footprint 114 ## 5 Uganda Expansion 204. 3.4.2 Households living inside the village Code hh_census %&gt;% group_by(country, sample_group) %&gt;% summarise(within = mean(inclusion == &quot;Within village boundaries&quot;)) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. ## # A tibble: 5 × 3 ## # Groups: country [2] ## country sample_group within ## &lt;chr&gt; &lt;ord&gt; &lt;dbl&gt; ## 1 Malawi Footprint 0.904 ## 2 Malawi Expansion 0.978 ## 3 Malawi ILC 0.988 ## 4 Uganda Footprint 0.788 ## 5 Uganda Expansion 0.870 3.4.3 Households using water points inside the village Code hh_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% tabyl(wp_source, sample_group) %&gt;% adorn_percentages(denominator = &quot;col&quot;) %&gt;% adorn_pct_formatting() ## wp_source Footprint Expansion ILC ## Other 0.3% 0.1% 0.4% ## From a water point in this village 76.2% 93.0% 87.1% ## From a water point outside of village 18.8% 6.1% 9.6% ## Rainwater 0.0% 0.0% 0.0% ## Piped water into the household 1.0% 0.3% 1.3% ## &lt;NA&gt; 3.7% 0.5% 1.5% Code hh_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% tabyl(wp_source, sample_group) %&gt;% adorn_percentages(denominator = &quot;col&quot;) %&gt;% adorn_pct_formatting() ## wp_source Footprint Expansion ILC ## Other 0.1% 0.0% - ## From a water point in this village 67.0% 72.6% - ## From a water point outside of village 25.9% 13.7% - ## Rainwater 0.0% 0.1% - ## Piped water into the household 0.4% 0.1% - ## &lt;NA&gt; 6.7% 13.5% - 3.4.4 Use of water points served by Evidence Action Code hh_census %&gt;% tabyl(country, wp_intervention) %&gt;% adorn_percentages() %&gt;% adorn_pct_formatting() ## country DSW ILC Non-program NA_ ## Malawi 46.4% 11.2% 28.5% 13.9% ## Uganda 63.5% 1.0% 21.1% 14.4% Code hh_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;) %&gt;% tabyl(wp_intervention, sample_group) %&gt;% adorn_percentages(denominator = &quot;col&quot;) %&gt;% adorn_pct_formatting() ## wp_intervention Footprint Expansion ILC ## DSW 57.6% 66.8% - ## ILC 2.8% 0.0% - ## Non-program 27.3% 17.7% - ## &lt;NA&gt; 12.3% 15.5% - Code hh_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% tabyl(wp_intervention, sample_group) %&gt;% adorn_percentages(denominator = &quot;col&quot;) %&gt;% adorn_pct_formatting() ## wp_intervention Footprint Expansion ILC ## DSW 40.5% 70.1% 35.6% ## ILC 0.1% 1.4% 25.1% ## Non-program 36.9% 22.4% 26.4% ## &lt;NA&gt; 22.5% 6.1% 12.9% 3.4.5 Number of water sources Code hh_census &lt;- hh_census %&gt;% mutate( wp_single = wp_count_pastmonth == 1, wp_nonprogram = wp_intervention == &quot;Non-program&quot;, wp_intervention = fct_relevel(wp_intervention, &quot;Non-program&quot;) ) hh_census %&gt;% dplyr::filter(!wp_nonprogram) %&gt;% summarise( single = mean(wp_single, na.rm = TRUE), av_count = if_else(!wp_single, wp_count_pastmonth, NA) %&gt;% mean(na.rm = TRUE) ) ## # A tibble: 1 × 2 ## single av_count ## &lt;dbl&gt; &lt;dbl&gt; ## 1 0.795 2.21 Code hh_census %&gt;% dplyr::filter(!wp_nonprogram) %&gt;% group_by(country, sample_group) %&gt;% summarise( mean = mean(wp_secweek, na.rm = TRUE) ) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. ## # A tibble: 5 × 3 ## # Groups: country [2] ## country sample_group mean ## &lt;chr&gt; &lt;ord&gt; &lt;dbl&gt; ## 1 Malawi Footprint 0.235 ## 2 Malawi Expansion 0.140 ## 3 Malawi ILC 0.245 ## 4 Uganda Footprint 0.239 ## 5 Uganda Expansion 0.200 Difference between interventions Code feols( wp_single ~ wp_nonprogram | sample_group + country, data = hh_census, cluster = ~ village_id ) ## NOTE: 2,960 observations removed because of NA values (LHS: 1,266, RHS: 2,960). ## OLS estimation, Dep. Var.: wp_single ## Observations: 17,991 ## Fixed-effects: sample_group: 3, country: 2 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## wp_nonprogramTRUE -0.059941 0.01602 -3.74172 0.00025534 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.413898 Adj. R2: 0.010212 ## Within R2: 0.004184 No difference between countries Code feols( wp_single ~ country | sample_group + wp_intervention, data = hh_census %&gt;% dplyr::filter(!wp_nonprogram), cluster = ~ village_id ) ## OLS estimation, Dep. Var.: wp_single ## Observations: 12,726 ## Fixed-effects: sample_group: 3, wp_intervention: 2 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## countryUganda -0.041967 0.024964 -1.68109 0.09472 . ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.400759 Adj. R2: 0.013423 ## Within R2: 0.001952 No difference between groups in Uganda Code feols( wp_single ~ sample_group | wp_intervention, data = hh_census %&gt;% dplyr::filter(country == &quot;Uganda&quot;), cluster = ~ village_id ) ## NOTE: 1,370 observations removed because of NA values (LHS: 1,051, Fixed-effects: 1,370). ## OLS estimation, Dep. Var.: wp_single ## Observations: 8,155 ## Fixed-effects: wp_intervention: 3 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## sample_group.L 0.046722 0.027054 1.726985 0.089403 . ## sample_group.Q 0.013107 0.015663 0.836817 0.406072 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.421103 Adj. R2: 0.011907 ## Within R2: 3.638e-4 3.4.6 Average household size Code hh_census %&gt;% group_by(country, sample_group) %&gt;% summarise( mean = mean(hh_members, na.rm = TRUE) ) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. ## # A tibble: 5 × 3 ## # Groups: country [2] ## country sample_group mean ## &lt;chr&gt; &lt;ord&gt; &lt;dbl&gt; ## 1 Malawi Footprint 4.41 ## 2 Malawi Expansion 4.71 ## 3 Malawi ILC 4.51 ## 4 Uganda Footprint 5.43 ## 5 Uganda Expansion 5.38 Code feols( hh_members ~ country | sample_group, data = hh_census, cluster = ~ village_id ) ## NOTE: 2,637 observations removed because of NA values (LHS: 2,637). ## OLS estimation, Dep. Var.: hh_members ## Observations: 18,314 ## Fixed-effects: sample_group: 3 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## countryUganda 0.823954 0.105877 7.7822 1.072e-12 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 2.38576 Adj. R2: 0.030161 ## Within R2: 0.020987 Code feols( hh_members ~ sample_group, data = hh_census %&gt;% dplyr::filter(country == &quot;Malawi&quot;), cluster = ~ village_id ) ## NOTE: 217 observations removed because of NA values (LHS: 217). ## OLS estimation, Dep. Var.: hh_members ## Observations: 11,209 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 4.544399 0.054587 83.249943 &lt; 2.2e-16 *** ## sample_group.L 0.075929 0.080499 0.943226 0.347885 ## sample_group.Q -0.204955 0.106764 -1.919693 0.057805 . ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 1.97328 Adj. R2: 0.003305 Code feols( hh_members ~ dsw | country, data = hh_census %&gt;% dplyr::filter(sample_group == &quot;Expansion&quot;), cluster = ~ village_id ) ## NOTE: 1,912 observations removed because of NA values (LHS: 1,648, RHS: 1,138). ## OLS estimation, Dep. Var.: hh_members ## Observations: 7,300 ## Fixed-effects: country: 2 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## dswTRUE -0.040429 0.120756 -0.334803 0.7391 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 2.60456 Adj. R2: 0.013759 ## Within R2: 4.102e-5 Code feols( hh_members ~ dsw | country, data = hh_census %&gt;% dplyr::filter(sample_group == &quot;Footprint&quot;), cluster = ~ village_id ) ## NOTE: 1,779 observations removed because of NA values (LHS: 918, RHS: 1,250). ## OLS estimation, Dep. Var.: hh_members ## Observations: 5,068 ## Fixed-effects: country: 2 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## dswTRUE 0.057903 0.087727 0.660031 0.51215 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 2.44653 Adj. R2: 0.042027 ## Within R2: 1.3e-4 Code feols( hh_members ~ wp_intervention | country, data = hh_census %&gt;% dplyr::filter(sample_group == &quot;ILC&quot;) %&gt;% mutate(wp_intervention = fct_relevel(wp_intervention, &quot;Non-program&quot;)), cluster = ~ village_id ) ## NOTE: 631 observations removed because of NA values (LHS: 71, RHS: 631). ## OLS estimation, Dep. Var.: hh_members ## Observations: 4,261 ## Fixed-effects: country: 1 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## wp_interventionDSW -0.726878 0.215365 -3.37510 0.0015979 ** ## wp_interventionILC -0.469705 0.180257 -2.60575 0.0126291 * ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 1.94732 Adj. R2: 0.023355 ## Within R2: 0.023813 "],["village-level-headline-results.html", "4 Village-level headline results 4.1 People using DSW/ILC water points 4.2 Chlorine detection rates 4.3 Table", " 4 Village-level headline results Code pacman::p_load( dplyr, readr, tidyr, glue, sf, tidyverse, viridis, fixest, janitor, broom, car, modelsummary, survey, here ) 4.1 People using DSW/ILC water points 4.1.1 Prepare data To calculate the number of people using water points with DSW or ILC, we use self-reported data from the household census on what is the household’s primary water point. This information is combined with data from the water point census to determine whether these water points are served by DSW or ILC. We start by restricting the household census data to households using water points with DSW or ILC located inside the sampled villages. We also exclude households using ILC in Uganda because we did not design the survey to be representative of this population. Code users_data &lt;- hh_census %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) The relevant variable to calculate the number of people using water points with DSW or ILC is the number of people living in households that report their primary water source has DSW or ILC. Due to a coding mistake, this variable was not collected in the first few days of data collection in Uganda. Therefore, we need to impute values for the households where this information is missing. Code users_data %&gt;% dplyr::filter(!is.na(wp_intervention_type), is.na(hh_members)) %&gt;% tabyl(date, country) %&gt;% adorn_totals() ## date Uganda ## 2025-07-02 4 ## 2025-07-03 35 ## 2025-07-04 3 ## 2025-07-07 13 ## 2025-07-08 255 ## 2025-07-09 158 ## 2025-07-10 28 ## 2025-07-11 37 ## 2025-07-14 130 ## 2025-07-15 21 ## 2025-07-16 1 ## Total 685 There are 12 villages in Uganda with no observations for this variable, so we cannot impute it as the village average. Therefore, we impute it are the sample group level. Code users_data &lt;- users_data %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) To account for the villages where all the water points with ILC were out of order, we add them to the data, but with zero households using water points with ILC. Code users_data &lt;- users_data %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` Since the unit of reference for our analysis is the village, we calculate the number of people whose primary water source has DSW or ILC by adding the number of household members across all such households in a village. Code users_village &lt;- users_data %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. To scale to the country level, we combine this data with the number of sampled villages and the number of villages in the admin data per group. Code users_village &lt;- users_village %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% ungroup ## Joining with `by = join_by(country, sample_group)` There is one village in Malawi with only one household using ILC: Code users_village %&gt;% dplyr::filter(hhs == 1) ## # A tibble: 89 × 12 ## village_id country sample_group wp_intervention response_rate hhs users ## &lt;chr&gt; &lt;chr&gt; &lt;ord&gt; &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; ## 1 1041204010 Uganda ILC DSW NA 1 0 ## 2 1041204010 Uganda ILC ILC NA 1 0 ## 3 1051401001 Uganda ILC DSW NA 1 0 ## 4 1051401001 Uganda ILC ILC NA 1 0 ## 5 1080102001 Uganda ILC DSW NA 1 0 ## 6 1080102001 Uganda ILC ILC NA 1 0 ## 7 1080501001 Uganda ILC DSW NA 1 0 ## 8 1080501001 Uganda ILC ILC NA 1 0 ## 9 1090104009 Uganda ILC DSW NA 1 0 ## 10 1090104009 Uganda ILC ILC NA 1 0 ## # ℹ 79 more rows ## # ℹ 5 more variables: users_increased &lt;dbl&gt;, n_villages &lt;int&gt;, ## # visited_villages &lt;int&gt;, sampled_villages &lt;int&gt;, weight &lt;dbl&gt; To simplify the calculation of standard errors, we remove it from the estimates. Code users_village &lt;- users_village %&gt;% dplyr::filter(hhs &gt; 1) 4.1.2 Sanity check Here we just calculate the total number of people without CIs. The point estimate should be the same as the one calculated with a canned function. Code users_village %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( n = n_distinct(village_id), hhs = mean(hhs), av_people = mean(users), av_people_non = mean(users_increased), sampled_villages = unique(sampled_villages), vil_weight = n/sampled_villages, group_weight = unique(n_villages) ) %&gt;% mutate( total_people = round(av_people * group_weight * vil_weight), total_people_non = round(av_people_non * group_weight * vil_weight) ) ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override ## using the `.groups` argument. ## # A tibble: 6 × 12 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention n hhs av_people av_people_non ## &lt;chr&gt; &lt;ord&gt; &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 Malawi Footprint DSW 27 47.1 208. 217. ## 2 Malawi Expansion DSW 28 76.5 363. 365. ## 3 Malawi ILC DSW 24 70.9 299. 301. ## 4 Malawi ILC ILC 28 42.5 191. 195. ## 5 Uganda Footprint DSW 30 49.3 265. 286. ## 6 Uganda Expansion DSW 30 116. 621. 722. ## # ℹ 5 more variables: sampled_villages &lt;int&gt;, vil_weight &lt;dbl&gt;, ## # group_weight &lt;int&gt;, total_people &lt;dbl&gt;, total_people_non &lt;dbl&gt; 4.1.3 Final numbers We the total number of users per sample group and the confidence intervals around this number using the package survey to adjust standard errors for the survey design. 4.1.3.1 By program and sample group Code people_per_group &lt;- map( users_village %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, households = .x %&gt;% pull(hhs) %&gt;% mean, weight = .x %&gt;% pull(weight) %&gt;% unique ) ) %&gt;% bind_rows() %&gt;% select( country, sample_group, wp_intervention, outcome, villages, weight, everything() ) %&gt;% arrange(outcome) people_per_group ## country sample_group wp_intervention outcome villages weight ## 1 Malawi Footprint DSW users_increased 27 41.46429 ## 2 Malawi Expansion DSW users_increased 28 171.75000 ## 3 Malawi ILC DSW users_increased 24 13.27083 ## 4 Malawi ILC ILC users_increased 28 13.27083 ## 5 Uganda Footprint DSW users_increased 30 105.76667 ## 6 Uganda Expansion DSW users_increased 30 133.73333 ## total se lb ub households ## 1 242715.55 34298.61 175491.50 309939.59 47.14815 ## 2 1752944.50 301860.50 1161308.79 2344580.21 76.46429 ## 3 95998.09 17111.60 62459.96 129536.21 70.91667 ## 4 72326.63 12894.19 47054.49 97598.77 42.53571 ## 5 907708.20 127724.20 657373.37 1158043.03 49.30000 ## 6 2895777.68 380425.48 2150157.44 3641397.92 115.56667 4.1.3.2 By program Code people_per_country &lt;- map( users_village %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, hhs = .x %&gt;% pull(hhs) %&gt;% sum, pop = .x %&gt;% pull(n_villages) %&gt;% unique %&gt;% sum ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) people_per_country ## country wp_intervention outcome villages total se ## 1 Malawi DSW users_increased 79 2091658.13 384814.82 ## 2 Malawi ILC users_increased 28 72326.63 12894.19 ## 3 Uganda DSW users_increased 60 3803485.88 474655.40 ## lb ub hhs pop ## 1 1337434.95 2845881.32 5116 6607 ## 2 47054.49 97598.77 1191 637 ## 3 2873178.39 4733793.37 4946 7185 4.1.4 Sensitivity checks 4.1.4.1 Don’t correct for non-responses Code users_vil_responseonly &lt;- map( users_village %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.2 Include households using water points outside of the village Code users_outside &lt;- hh_census %&gt;% dplyr::filter( !is.na(wp_intervention), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_outside &lt;- map( users_outside %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.3 Exclude households living outside of village boundaries Code users_vilboundary &lt;- hh_census %&gt;% dplyr::filter( !is.na(wp_intervention), wp_invillage, inclusion == &quot;Within village boundaries&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_boundary &lt;- map( users_vilboundary %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.4 Correct for missed water points Code users_vil_misspoints &lt;- map( users_vilboundary %&gt;% mutate( users_increased = case_when( wp_intervention == &quot;DSW&quot; ~ users_increased * 1.12, wp_intervention == &quot;ILC&quot; ~ users_increased * 1.05 ) ) %&gt;% dplyr::filter(country == &quot;Malawi&quot;) %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.5 Don’t correct for non-functional ILC Code users_func &lt;- hh_census %&gt;% dplyr::filter( !is.na(wp_intervention), wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_func &lt;- map( users_func %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.6 Use raw FO reports Code users_fo &lt;- hh_census %&gt;% mutate(wp_intervention = intervention_fo) %&gt;% dplyr::filter( !is.na(wp_intervention), wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_fo &lt;- map( users_fo %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 4.1.4.7 Plot Code plot_data &lt;- list( &quot;Main estimate&quot; = people_per_country, &quot;Including households using water points\\noutside of sampled villages&quot; = users_vil_outside, &quot;Excluding households living outside of\\nthe village boundaries&quot; = users_vil_boundary, &quot;Without correction for non-responses&quot; = users_vil_responseonly, &quot;Without corrections to DSW/ILC status\\nfrom admin data&quot; = users_vil_fo, &quot;Without correction for water point\\nfunctionality&quot; = users_vil_func, &quot;Correcting for potentially missed \\nwater points&quot; = users_vil_misspoints ) %&gt;% map( ~ .x %&gt;% select(country, wp_intervention, outcome, total, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( main = label == &quot;Main estimate&quot; ) %&gt;% dplyr::filter(wp_intervention != &quot;Non-program&quot;) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = total, label = format(round(total), big.mark = &quot;,&quot;), color = main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_fill_brewer(palette = &quot;Dark2&quot;) + scale_color_brewer(palette = &quot;Dark2&quot;) + theme + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + theme(legend.position = &quot;none&quot;) + labs( y = NULL, x = &quot;Number of people using a water point with DSW/ILC as\\nmain source of drinking water&quot; ) ## Scale for x is already present. ## Adding another scale for x, which will replace the existing scale. 4.1.4.8 Save Plot Code ggplot2::ggsave( filename = &quot;output/graphs/users-vil.png&quot;, plot = ggplot2::last_plot(), width = 8, height = 4.5, units = &quot;in&quot;, dpi = 300 ) 4.2 Chlorine detection rates 4.2.1 Prepare data Code chlorination_data &lt;- hh_survey %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) %&gt;% ungroup ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` 4.2.2 Sanity check Code chlorination_data %&gt;% group_by(village_id, sample_group, wp_intervention_type, country) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n() ) %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = sum(hhs), villages = n() ) ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;sample_group&#39;, &#39;wp_intervention_type&#39;. You can override using ## the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` argument. ## # A tibble: 7 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention_type disctcr_02 discfcr_02 hhs villages ## &lt;chr&gt; &lt;ord&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Footprint DSW 0.296 0.209 442 25 ## 2 Malawi Expansion DSW 0.264 0.210 520 28 ## 3 Malawi ILC DSW 0.239 0.207 331 25 ## 4 Malawi ILC ILC water collectio… 0.342 0.137 308 23 ## 5 Malawi ILC ILC water point 0.479 0.381 60 10 ## 6 Uganda Footprint DSW 0.303 0.207 547 30 ## 7 Uganda Expansion DSW 0.319 0.204 588 30 Code chlorination_data %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n(), villages = n_distinct(village_id) ) ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override ## using the `.groups` argument. ## # A tibble: 7 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention_type disctcr_02 discfcr_02 hhs villages ## &lt;chr&gt; &lt;ord&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Footprint DSW 0.301 0.216 442 25 ## 2 Malawi Expansion DSW 0.270 0.217 520 28 ## 3 Malawi ILC DSW 0.206 0.181 331 25 ## 4 Malawi ILC ILC water collectio… 0.282 0.130 308 23 ## 5 Malawi ILC ILC water point 0.451 0.255 60 10 ## 6 Uganda Footprint DSW 0.280 0.180 547 30 ## 7 Uganda Expansion DSW 0.327 0.212 588 30 4.2.3 Final numbers 4.2.3.1 Separating ILC WP and ILC WCP Code cl_village_noweights_ilc &lt;- chlorination_data %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention_type) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.3.2 By sample group and program Code cl_village_noweights_samplegroup &lt;- chlorination_data %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.3.3 Check program differences Before we combine observations in different sample groups, we want to make sure that chlorination rates are not different across them Code feols( disctcr_02 ~ sample_group, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter(country == &quot;Uganda&quot;) ) %&gt;% summary ## NOTE: 146 observations removed because of NA values (LHS: 146). ## The variable &#39;sample_group.Q&#39; has been removed because of collinearity (see $collin.var). ## OLS estimation, Dep. Var.: disctcr_02 ## Observations: 989 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.327451 0.036975 8.856108 1.9858e-12 *** ## sample_group.L 0.067460 0.080521 0.837799 4.0552e-01 ## ... 1 variable was removed because of collinearity (sample_group.Q) ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.459513 Adj. R2: 0.001674 Code feols( disctcr_02 ~ sample_group, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter(country == &quot;Malawi&quot;) ) %&gt;% summary ## NOTE: 41 observations removed because of NA values (LHS: 41). ## OLS estimation, Dep. Var.: disctcr_02 ## Observations: 1,620 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.276408 0.025430 10.869343 &lt; 2.2e-16 *** ## sample_group.L -0.030127 0.040913 -0.736365 0.46332 ## sample_group.Q 0.008422 0.046971 0.179312 0.85807 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.445393 Adj. R2: 2.91e-4 Code model &lt;- feols( disctcr_02 ~ sample_group, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter( country == &quot;Malawi&quot; ) ) ## NOTE: 41 observations removed because of NA values (LHS: 41). Code summary(model) ## OLS estimation, Dep. Var.: disctcr_02 ## Observations: 1,620 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.276408 0.025430 10.869343 &lt; 2.2e-16 *** ## sample_group.L -0.030127 0.040913 -0.736365 0.46332 ## sample_group.Q 0.008422 0.046971 0.179312 0.85807 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.445393 Adj. R2: 2.91e-4 Code fitstat(model, type = &quot;f&quot;) ## F-test: stat = 0.072596, p = 0.930028, on 2 and 95 DoF. Code feols( discfcr_02 ~ wp_intervention_type, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter( country == &quot;Malawi&quot;, wp_intervention == &quot;ILC&quot; ) ) %&gt;% summary ## NOTE: 16 observations removed because of NA values (LHS: 16). ## The variable &#39;wp_intervention_typeILC water point&#39; has been removed because of collinearity (see $collin.var). ## OLS estimation, Dep. Var.: discfcr_02 ## Observations: 352 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value ## (Intercept) 0.254902 0.067692 3.76564 ## wp_intervention_typeILC water collection point -0.125334 0.071920 -1.74269 ## Pr(&gt;|t|) ## (Intercept) 0.00085888 *** ## wp_intervention_typeILC water collection point 0.09320598 . ## ... 1 variable was removed because of collinearity (wp_intervention_typeILC water point) ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.352076 Adj. R2: 0.012645 4.2.3.4 By program Code cl_village_noweights_country &lt;- chlorination_data %&gt;% group_by(country, wp_intervention) %&gt;% group_split() %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE, strata = ~ sample_group ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability 4.2.4 Sensitivity checks 4.2.4.1 Assinging no chlorination if not tested Code cl_village_nottested &lt;- chlorination_data %&gt;% mutate( across( c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), ~ case_when( !water_sample ~ FALSE, TRUE ~ . ) ) ) %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., strata = ~ sample_group, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., strata = ## ~sample_group, : No weights or probabilities supplied, assuming equal ## probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., strata = ## ~sample_group, : No weights or probabilities supplied, assuming equal ## probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., strata = ## ~sample_group, : No weights or probabilities supplied, assuming equal ## probability 4.2.4.2 Weighing villages equally Code cl_village_vilweights &lt;- chlorination_data %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., strata = ~ sample_group, prob = ~ weight_equal, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) 4.2.4.3 Weighing villages by number of users Code cl_village_userweights &lt;- chlorination_data %&gt;% dplyr::filter(!is.na(weight_users)) %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., prob = ~ weight_users, strata = ~ sample_group, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) 4.2.4.4 Exclude villages where it was raining Code cl_village_rain &lt;- chlorination_data %&gt;% dplyr::filter(is.na(vil_rain), country == &quot;Uganda&quot;) %&gt;% group_by(country, wp_intervention) %&gt;% group_split() %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE, strata = ~ sample_group ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability 4.2.4.5 Exclude villages with potential interference from promoters Code cl_village_int &lt;- chlorination_data %&gt;% dplyr::filter( !(village_id %in% (villages %&gt;% dplyr::filter(potential_interference) %&gt;% pull(village_id) ) ), country == &quot;Uganda&quot; ) %&gt;% group_by(country, wp_intervention) %&gt;% group_split() %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE, strata = ~ sample_group ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability 4.2.4.6 FO reports of intervention Code chlorination_fo &lt;- hh_survey %&gt;% mutate(wp_intervention = intervention_fo) %&gt;% dplyr::filter( !is.na(intervention_fo), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_fo &lt;- chlorination_fo %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability 4.2.4.7 Self-reported users Code chlorination_self &lt;- hh_survey %&gt;% mutate(wp_intervention = intervention_selfreport) %&gt;% dplyr::filter( !is.na(wp_intervention), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_self &lt;- chlorination_self %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability 4.2.4.8 All households surveyed Code chlorination_all &lt;- hh_survey %&gt;% mutate( wp_intervention = case_when( !is.na(wp_intervention) ~ wp_intervention, hh_dsw ~ &quot;DSW&quot;, hh_ilc ~ &quot;ILC&quot;, sample_group != &quot;ILC&quot; ~ &quot;DSW&quot; ) ) %&gt;% dplyr::filter( !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_all &lt;- chlorination_all %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability 4.2.4.9 Plot Code plot_data &lt;- list( &quot;Weighing each tested household equally&quot; = cl_village_noweights_country, &quot;Weighing each village equally&quot; = cl_village_vilweights, &quot;Weighing villages by number of users&quot; = cl_village_userweights, &quot;Without corrections to DSW/ILC status\\nfrom admin data&quot; = cl_village_fo, &quot;Using self-report of DSW/ILC status&quot; = cl_village_self, &quot;Including household with unconfirmed\\nDSW/ILC status&quot; = cl_village_all, &quot;Excluding villages with unseasonable rain&quot; = cl_village_rain, &quot;Excluding villages with potential \\npromoter interference&quot; = cl_village_int ) %&gt;% map( ~ .x %&gt;% dplyr::filter(outcome == &quot;disctcr_02&quot;) %&gt;% select(country, wp_intervention, outcome, mean, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( across( c(mean, ub, lb), ~ . * 100 ), main = (label == &quot;Weighing each tested household equally&quot;) ) %&gt;% dplyr::filter(wp_intervention != &quot;Non-program&quot;) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = mean, label = round(mean, 1) %&gt;% paste0(&quot;%&quot;), color = main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_fill_brewer(palette = &quot;Dark2&quot;) + scale_color_brewer(palette = &quot;Dark2&quot;) + theme + labs( y = NULL, x = &quot;Percent of tested households where color wheel\\nTCR reading was at least 0.2 ppm&quot; ) 4.2.4.10 Save Plot Code ggplot2::ggsave( filename = &quot;output/graphs/chlorine-vil.png&quot;, plot = ggplot2::last_plot(), width = 8, height = 5, units = &quot;in&quot;, dpi = 300 ) 4.3 Table 4.3.1 By program Code obs &lt;- users_village %&gt;% group_by( country, wp_intervention ) %&gt;% summarise( visited_villages = sum(hhs != 0), census = sum(hhs) %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% mutate( name = &quot;est&quot; ) people &lt;- people_per_country %&gt;% left_join( wp_sample_sizes %&gt;% group_by(country, wp_intervention) %&gt;% summarise(pop = sum(pop_points)) ) %&gt;% mutate( across( c(total, lb, ub, pop), ~ . %&gt;% round %&gt;% format(big.mark = &quot;,&quot;) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) ) %&gt;% select( country, wp_intervention, pop, est = total, ci ) %&gt;% pivot_longer( cols = c(est, ci), values_to = &quot;people&quot; ) cl &lt;- cl_village_noweights_country %&gt;% mutate( across( c(mean, lb, ub), ~ (. * 100) %&gt;% round(1) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) , hhs = hhs %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% select(country, wp_intervention, outcome, villages, hhs, est = mean, ci) %&gt;% pivot_wider( values_from = c(est, ci), names_from = outcome ) %&gt;% pivot_longer( cols = ends_with(&quot;02&quot;), names_pattern = &quot;(.*)_disc(.*)_02&quot;, names_to = c(&quot;name&quot;, &quot;.value&quot;) ) tab &lt;- obs %&gt;% full_join(people) %&gt;% left_join(cl) %&gt;% arrange(country, wp_intervention, desc(name)) %&gt;% mutate( across( everything(), ~ as.character(.) ), across( -c(people, tcr, fcr), ~ case_when( name == &quot;est&quot; ~ ., TRUE ~ &quot;&quot; ) ) ) %&gt;% ungroup %&gt;% select(-c(name, country)) table &lt;- kable( tab, format = &quot;latex&quot;, escape = F, align = &quot;c&quot;, booktabs = T, col.names = linebreak( c(&quot;Intervention&quot;, &quot;\\\\#Vil&quot;, &quot;\\\\#HH&quot;, &quot;\\\\#Vil&quot;, &quot;People using\\nDSW/ILC\\n(95\\\\% CI)&quot;, &quot;\\\\#Vil&quot;, &quot;\\\\#HH&quot;, &quot;TCR\\n(95\\\\% CI)&quot;, &quot;FCR\\n(95\\\\% CI)&quot;), align = &quot;c&quot; ), caption = &quot;Primary outcomes estimated using the village as the unit of reference&quot;, label = &quot;headlines-vil&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 4) %&gt;% pack_rows(&quot;Uganda&quot;, 5, 6) %&gt;% add_header_above( c( &quot; &quot;, &quot;Household census&quot; = 2, &quot;Country-level estimates&quot; = 2, &quot;Percent of color wheel readings ≥ 0.2 ppm&quot; = 4 ) ) %&gt;% add_header_above(c(&quot; &quot;, paste0(&quot;(&quot;, 1:8,&quot;)&quot;)), line = FALSE) writeLines( table, &quot;output/tables/headlines-vil.tex&quot; ) 4.3.2 By program and sample group Code obs &lt;- users_village %&gt;% group_by( country, wp_intervention, sample_group ) %&gt;% summarise( visited_villages = sum(hhs != 0), census = sum(hhs) %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% mutate( name = &quot;est&quot; ) people &lt;- people_per_group %&gt;% left_join( wp_sample_sizes %&gt;% group_by(country, wp_intervention, sample_group) %&gt;% summarise(pop = sum(pop_points)) ) %&gt;% mutate( across( c(total, lb, ub, pop), ~ . %&gt;% round %&gt;% format(big.mark = &quot;,&quot;) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) ) %&gt;% select( country, wp_intervention, sample_group, pop, est = total, ci ) %&gt;% pivot_longer( cols = c(est, ci), values_to = &quot;people&quot; ) cl &lt;- cl_village_noweights_samplegroup %&gt;% mutate( across( c(mean, lb, ub), ~ (. * 100) %&gt;% round(1) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) , hhs = hhs %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% select(country, wp_intervention, sample_group, outcome, villages, hhs, est = mean, ci) %&gt;% pivot_wider( values_from = c(est, ci), names_from = outcome ) %&gt;% pivot_longer( cols = ends_with(&quot;02&quot;), names_pattern = &quot;(.*)_disc(.*)_02&quot;, names_to = c(&quot;name&quot;, &quot;.value&quot;) ) tab &lt;- obs %&gt;% full_join(people) %&gt;% left_join(cl) %&gt;% arrange(country, wp_intervention, sample_group, desc(name)) %&gt;% ungroup %&gt;% mutate( across( everything(), ~ as.character(.) ), across( -c(people, tcr, fcr), ~ case_when( name == &quot;est&quot; ~ ., TRUE ~ &quot;&quot; ) ) ) %&gt;% select(-c(name, country)) table &lt;- kable( tab, format = &quot;latex&quot;, escape = F, align = &quot;c&quot;, booktabs = T, col.names = linebreak( c(&quot; &quot;, &quot;Sample group&quot;, &quot;\\\\#Vil&quot;, &quot;\\\\#HH&quot;, &quot;\\\\#Vil&quot;, &quot;People using\\nDSW/ILC\\n(95\\\\% CI)&quot;, &quot;\\\\#Vil&quot;, &quot;\\\\#HH&quot;, &quot;TCR\\n(95\\\\% CI)&quot;, &quot;FCR\\n(95\\\\% CI)&quot;), align = &quot;c&quot; ), caption = &quot;Primary outcomes estimated using the village as the unit of reference&quot;, label = &quot;headlines-vil-by-group&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 8) %&gt;% pack_rows(&quot;Uganda&quot;, 9, 12) %&gt;% add_header_above( c( &quot; &quot; = 2, &quot;Household census&quot; = 2, &quot;Country-level estimates&quot; = 2, &quot;Percent of color wheel readings ≥ 0.2 ppm&quot; = 4 ) ) %&gt;% add_header_above(c(&quot; &quot;, &quot; &quot;, paste0(&quot;(&quot;, 1:8,&quot;)&quot;)), line = FALSE) writeLines( table, &quot;output/tables/headlines-vil-by-group.tex&quot; ) "],["water-point-level-headline-results.html", "5 Water point-level headline results 5.1 Number of people using DSW/ILC 5.2 Chlorination rates 5.3 Table", " 5 Water point-level headline results 5.1 Number of people using DSW/ILC 5.1.1 Prepare data Code hh_census_wp &lt;- hh_census %&gt;% left_join(wp_sample_sizes) ## Joining with `by = join_by(country, sample_group, wp_intervention)` 5.1.1.1 Main treatment Code users_data_wp &lt;- hh_census_wp %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;), # These are households using water points outside of the village # that were found to have DSW. Since we don&#39;t have a water point ID # for them, we cannot used them fow water point-level estimates !is.na(wp_id) ) %&gt;% left_join( wp_census %&gt;% dplyr::filter(dsw | ilc_wcp) %&gt;% rename(wp_intervention = intervention) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( func_rate = mean(wp_func, na.rm = TRUE) ) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% mutate( func_points = func_rate * pop_points, weight = n_distinct(wp_id)/func_points, weight_nofunc = n_distinct(wp_id)/pop_points ) %&gt;% ungroup ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(country, sample_group, wp_intervention)` Code users_data_wp &lt;- users_data_wp %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ), hh_members_increased = hh_members/response_rate ) 5.1.2 Sanity check Code group &lt;- users_data_wp %&gt;% group_by( wp_id, wp_intervention, sample_group, country, pop_points, func_points ) %&gt;% summarise( users = sum(hh_members), users_increased = sum(hh_members_increased) ) %&gt;% group_by( country, sample_group, wp_intervention, pop_points, func_points ) %&gt;% summarise( across( c(users, users_increased), ~ mean(.) ) ) %&gt;% mutate( across( c(users, users_increased), ~ . * pop_points, .names = &quot;{.col}_total&quot; ), across( c(users, users_increased), ~ . * func_points, .names = &quot;{.col}_func&quot; ) ) ## `summarise()` has grouped output by &#39;wp_id&#39;, &#39;wp_intervention&#39;, &#39;sample_group&#39;, &#39;country&#39;, &#39;pop_points&#39;. You can ## override using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;, &#39;wp_intervention&#39;, &#39;pop_points&#39;. You can override ## using the `.groups` argument. Code group ## # A tibble: 6 × 11 ## # Groups: country, sample_group, wp_intervention, pop_points [6] ## country sample_group wp_intervention pop_points func_points users ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 Malawi Expansion DSW 11292 11159. 126. ## 2 Malawi Footprint DSW 3844 3618. 117. ## 3 Malawi ILC DSW 1062 1046. 115. ## 4 Malawi ILC ILC 2024 1720. 40.5 ## 5 Uganda Expansion DSW 12262 11471. 185. ## 6 Uganda Footprint DSW 5456 5367. 188. ## # ℹ 5 more variables: users_increased &lt;dbl&gt;, users_total &lt;dbl&gt;, ## # users_increased_total &lt;dbl&gt;, users_func &lt;dbl&gt;, users_increased_func &lt;dbl&gt; Code group %&gt;% group_by(wp_intervention, country) %&gt;% summarise( across( c(contains(&quot;users_&quot;)), ~ sum(.) ) ) %&gt;% select(-users_increased) ## `summarise()` has grouped output by &#39;wp_intervention&#39;. You can override using ## the `.groups` argument. ## # A tibble: 3 × 6 ## # Groups: wp_intervention [2] ## wp_intervention country users_total users_increased_total users_func ## &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 DSW Malawi 1993436. 2020561. 1948326. ## 2 DSW Uganda 3297742. 3733048. 3134461. ## 3 ILC Malawi 81912. 83400. 69602. ## # ℹ 1 more variable: users_increased_func &lt;dbl&gt; 5.1.3 Final numbers Code users_wp &lt;- users_data_wp %&gt;% group_by( country, sample_group, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) Code users_wp_country &lt;- users_data_wp %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) Code users_wp %&gt;% bind_rows(users_wp_country) %&gt;% write_csv( here( &quot;../output/tables/users-wp.csv&quot; ) ) 5.2 Chlorination rates 5.2.1 Prepare data Code hh_survey_wp &lt;- hh_survey %&gt;% left_join(wp_sample_sizes) ## Joining with `by = join_by(country, sample_group, wp_intervention)` Code chlorination_data &lt;- hh_survey_wp %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) Code chlorination_data &lt;- chlorination_data %&gt;% # Sampling weights group_by(wp_id) %&gt;% mutate( n_cl = n_distinct(household_id) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% mutate( n_cat = n_distinct(wp_id) ) %&gt;% # Weight by number of users left_join( hh_census %&gt;% group_by(wp_id) %&gt;% summarise( n_users = n_distinct(household_id) ) ) %&gt;% ungroup %&gt;% mutate( # Number of households using this water point represented by the observation weight_obs = n_users/n_cl, # Weighting all water points equally, weight_wp = 1/n_cl ) ## Joining with `by = join_by(wp_id)` 5.2.2 Sanity check Code chlorination_data %&gt;% group_by(wp_id, wp_intervention, sample_group, country) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n_distinct(household_id) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = sum(hhs), wp_id = n_distinct(wp_id) ) ## `summarise()` has grouped output by &#39;wp_id&#39;, &#39;wp_intervention&#39;, &#39;sample_group&#39;. You can override using the ## `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` argument. ## # A tibble: 6 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention disctcr_02 discfcr_02 hhs wp_id ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Expansion DSW 0.233 0.174 520 75 ## 2 Malawi Footprint DSW 0.292 0.197 442 45 ## 3 Malawi ILC DSW 0.222 0.165 331 56 ## 4 Malawi ILC ILC 0.255 0.103 368 92 ## 5 Uganda Expansion DSW 0.319 0.191 588 96 ## 6 Uganda Footprint DSW 0.271 0.173 547 55 5.2.3 Final numbers 5.2.3.1 By program and sample group Code cl_wp_sample &lt;- chlorination_data %&gt;% group_by( country, wp_intervention, sample_group ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, sample_group, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 5.2.3.2 Separate ILC Code cl_wp_ilc &lt;- chlorination_data %&gt;% dplyr::filter(sample_group == &quot;ILC&quot;) %&gt;% group_by( country, wp_intervention_type ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention_type) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, sample_group, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 5.2.3.3 By program Code cl_wp_noweights &lt;- chlorination_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% dplyr::filter(!is.na(disctcr_02) | !is.na(discfcr_02)) %&gt;% pull(household_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability Code cl_wp_noweights %&gt;% bind_rows(cl_wp_ilc) %&gt;% bind_rows(cl_wp_sample) %&gt;% write_csv( here(&quot;../output/tables/chlorine-wp.csv&quot;) ) 5.3 Table 5.3.1 By program Code obs &lt;- users_data_wp %&gt;% dplyr::filter(!is.na(wp_id)) %&gt;% group_by( country, wp_intervention ) %&gt;% summarise( n_wps = n_distinct(wp_id), census = n_distinct(household_id) %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% mutate( name = &quot;est&quot; ) people &lt;- users_wp_country %&gt;% left_join( wp_sample_sizes %&gt;% group_by(country, wp_intervention) %&gt;% summarise(pop = sum(pop_points)) ) %&gt;% mutate( across( c(total, lb, ub, pop), ~ . %&gt;% round %&gt;% format(big.mark = &quot;,&quot;) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) ) %&gt;% select( country, wp_intervention, pop, est = total, ci ) %&gt;% pivot_longer( cols = c(est, ci), values_to = &quot;people&quot; ) cl &lt;- cl_wp_noweights %&gt;% mutate( across( c(mean, lb, ub), ~ (. * 100) %&gt;% round(1) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) , hhs = households %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% select(country, wp_intervention, outcome, wps, hhs, est = mean, ci) %&gt;% pivot_wider( values_from = c(est, ci), names_from = outcome ) %&gt;% pivot_longer( cols = ends_with(&quot;02&quot;), names_pattern = &quot;(.*)_disc(.*)_02&quot;, names_to = c(&quot;name&quot;, &quot;.value&quot;) ) tab &lt;- obs %&gt;% full_join(people) %&gt;% left_join(cl) %&gt;% arrange(country, wp_intervention, desc(name)) %&gt;% mutate( across( everything(), ~ as.character(.) ), across( -c(people, tcr, fcr), ~ case_when( name == &quot;est&quot; ~ ., TRUE ~ &quot;&quot; ) ) ) %&gt;% ungroup %&gt;% select(-c(name, country)) table &lt;- kable( tab, format = &quot;latex&quot;, escape = F, align = &quot;c&quot;, booktabs = T, col.names = linebreak( c(&quot;Intervention&quot;, &quot;\\\\#WP&quot;, &quot;\\\\#HH&quot;, &quot;\\\\#WP&quot;, &quot;People using\\nDSW/ILC\\n(95\\\\% CI)&quot;, &quot;\\\\#WP&quot;, &quot;\\\\#HH&quot;, &quot;TCR\\n(95\\\\% CI)&quot;, &quot;FCR\\n(95\\\\% CI)&quot;), align = &quot;c&quot; ), caption = &quot;Primary outcomes estimated using the water point as the unit of reference&quot;, label = &quot;headlines-wp&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 4) %&gt;% pack_rows(&quot;Uganda&quot;, 5, 6) %&gt;% add_header_above( c( &quot; &quot;, &quot;Household census&quot; = 2, &quot;Country-level estimates&quot; = 2, &quot;Percent of color wheel readings ≥ 0.2 ppm&quot; = 4 ) ) %&gt;% add_header_above(c(&quot; &quot;, paste0(&quot;(&quot;, 1:8,&quot;)&quot;)), line = FALSE) writeLines( table, &quot;output/tables/headlines-wp.tex&quot; ) 5.3.2 By program and sample group Code obs &lt;- users_data_wp %&gt;% dplyr::filter(!is.na(wp_id)) %&gt;% group_by( country, wp_intervention, sample_group ) %&gt;% summarise( n_wps = n_distinct(wp_id), census = n_distinct(household_id) %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% mutate( name = &quot;est&quot; ) people &lt;- users_wp %&gt;% left_join( wp_sample_sizes %&gt;% group_by(country, wp_intervention, sample_group) %&gt;% summarise(pop = sum(pop_points)) ) %&gt;% mutate( across( c(total, lb, ub, pop), ~ . %&gt;% round %&gt;% format(big.mark = &quot;,&quot;) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) ) %&gt;% select( country, wp_intervention, sample_group, pop, est = total, ci ) %&gt;% pivot_longer( cols = c(est, ci), values_to = &quot;people&quot; ) cl &lt;- cl_wp_sample %&gt;% mutate( across( c(mean, lb, ub), ~ (. * 100) %&gt;% round(1) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) , hhs = households %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% select(country, wp_intervention, sample_group, outcome, wps, hhs, est = mean, ci) %&gt;% pivot_wider( values_from = c(est, ci), names_from = outcome ) %&gt;% pivot_longer( cols = ends_with(&quot;02&quot;), names_pattern = &quot;(.*)_disc(.*)_02&quot;, names_to = c(&quot;name&quot;, &quot;.value&quot;) ) tab &lt;- obs %&gt;% full_join(people) %&gt;% left_join(cl) %&gt;% arrange(country, wp_intervention, sample_group, desc(name)) %&gt;% ungroup %&gt;% mutate( across( everything(), ~ as.character(.) ), across( -c(people, tcr, fcr), ~ case_when( name == &quot;est&quot; ~ ., TRUE ~ &quot;&quot; ) ) ) %&gt;% select(-c(name, country)) table &lt;- kable( tab, format = &quot;latex&quot;, escape = F, align = &quot;c&quot;, booktabs = T, col.names = linebreak( c(&quot; &quot;, &quot;Sample group&quot;, &quot;\\\\#WP&quot;, &quot;\\\\#HH&quot;, &quot;\\\\#WP&quot;, &quot;People using\\nDSW/ILC\\n(95\\\\% CI)&quot;, &quot;\\\\#WP&quot;, &quot;\\\\#HH&quot;, &quot;TCR\\n(95\\\\% CI)&quot;, &quot;FCR\\n(95\\\\% CI)&quot;), align = &quot;c&quot; ), caption = &quot;Primary outcomes estimated using the water point as the unit of reference&quot;, label = &quot;headlines-wp-by-group&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 8) %&gt;% pack_rows(&quot;Uganda&quot;, 9, 12) %&gt;% add_header_above( c( &quot; &quot; = 2, &quot;Household census&quot; = 2, &quot;Country-level estimates&quot; = 2, &quot;Percent of color wheel readings ≥ 0.2 ppm&quot; = 4 ) ) %&gt;% add_header_above(c(&quot; &quot;, &quot; &quot;, paste0(&quot;(&quot;, 1:8,&quot;)&quot;)), line = FALSE) writeLines( table, &quot;output/tables/headlines-wp-by-group.tex&quot; ) "],["monitoring-headline-results.html", "6 Monitoring headline results 6.1 Number of people reached 6.2 Chlorination rates 6.3 Table", " 6 Monitoring headline results Code packages &lt;- c( &quot;stringr&quot;, &quot;sf&quot;, &quot;tidyverse&quot;, &quot;viridis&quot;, &quot;glue&quot;, &quot;patchwork&quot;, &quot;tidyr&quot;, &quot;dplyr&quot;, &quot;knitr&quot;, &quot;kableExtra&quot;, &quot;vtable&quot;, &quot;stargazer&quot;, &quot;ggplot2&quot;, &quot;haven&quot;, &quot;estimatr&quot;, &quot;janitor&quot;, &quot;survey&quot; ) pacman::p_load( packages, character.only = TRUE ) 6.1 Number of people reached 6.1.1 Average number of households per water point Code hh_per_wp &lt;- wp_census %&gt;% dplyr::filter( wp_func, intervention != &quot;Non-program&quot;, !is.na(pm_users) ) %&gt;% group_by( country, sample_group, intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;pm_users&quot;), dummy = FALSE, design = svydesign( id = ~ village_id, # cluster IDs strata = ~ sample_group, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, sample_group, wp_intervention, av_hhs = mean, av_hhs_se = se) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability 6.1.2 Average number of people per household Code people_per_hh &lt;- mon_survey %&gt;% dplyr::filter( wp_func, wp_intervention != &quot;Non-program&quot; ) %&gt;% group_by( country, sample_group, wp_intervention ) %&gt;% dplyr::filter(n() &gt; 2) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;hh_members&quot;), dummy = FALSE, design = svydesign( id = ~ village_id, # cluster IDs strata = ~ sample_group, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique ) ) %&gt;% bind_rows() %&gt;% select(country, sample_group, wp_intervention, av_size = mean, av_size_se = se) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## .x, : No weights or probabilities supplied, assuming equal probability 6.1.3 Total number of people per group Code total_people &lt;- hh_per_wp %&gt;% left_join(people_per_hh) %&gt;% # Calculate people per WP and its SE using delta method mutate( av_people = av_hhs * av_size, # delta method: SE(X*Y) = sqrt((Y^2 * SE_X^2) + (X^2 * SE_Y^2)) # assuming X and Y are independent av_people_se = sqrt( (av_size^2) * (av_hhs_se^2) + (av_hhs^2) * (av_size_se^2) ) ) %&gt;% # join with population water points - sum across sample_groups left_join( wp_sample_sizes ) %&gt;% # scale up to population mutate( total_people = av_people * pop_points, # SE scales linearly with constant: SE(c*X) = c * SE(X) total_people_se = av_people_se * pop_points, # 95% CI for popn_users total_people_lb = total_people - 1.96 * total_people_se, total_people_ub = total_people + 1.96 * total_people_se ) ## Joining with `by = join_by(country, sample_group, wp_intervention)` ## Joining with `by = join_by(country, sample_group, wp_intervention)` 6.1.4 Total number of people per country Code total_country &lt;- total_people %&gt;% mutate(total_people_se_sq = total_people_se ^ 2) %&gt;% group_by(country, wp_intervention) %&gt;% summarise( across( c(total_people, total_people_se_sq), ~ sum(.) ) ) %&gt;% mutate( total_people_se = sqrt(total_people_se_sq), total_people_lb = total_people - 1.96 * total_people_se, total_people_ub = total_people + 1.96 * total_people_se, ) %&gt;% dplyr::filter(!(country == &quot;Uganda&quot; &amp; wp_intervention == &quot;ILC&quot;)) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. 6.1.5 Does it make sense to assume independence? Code cor_data &lt;- hh_survey %&gt;% bind_rows(mon_survey) %&gt;% select(household_id, village_id, country, sample_group, wp_intervention, survey, wp_id, hh_members) %&gt;% left_join( wp_census %&gt;% select(wp_id, pm_users) ) %&gt;% dplyr::filter( !is.na(hh_members), !is.na(pm_users) ) ## Joining with `by = join_by(wp_id)` Code cor(cor_data$hh_members, cor_data$pm_users) ## [1] 0.00712846 Code cor_data &lt;- mon_survey %&gt;% select(household_id, village_id, country, sample_group, wp_intervention, survey, wp_id, hh_members) %&gt;% left_join( wp_census %&gt;% select(wp_id, pm_users) ) %&gt;% dplyr::filter( !is.na(hh_members), !is.na(pm_users) ) ## Joining with `by = join_by(wp_id)` Code cor(cor_data$hh_members, cor_data$pm_users) ## [1] 0.01820092 Code cor.test(cor_data$hh_members, cor_data$pm_users)$conf.int ## [1] -0.04790596 0.08414904 ## attr(,&quot;conf.level&quot;) ## [1] 0.95 6.2 Chlorination rates we should not remove households that are not using program water points! Code chlorine_am &lt;- mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id, nest = TRUE, data = mon_survey %&gt;% dplyr::filter( wp_func, country == &quot;Uganda&quot; ) ) ) ## Warning in svydesign.default(id = ~village_id, nest = TRUE, data = mon_survey ## %&gt;% : No weights or probabilities supplied, assuming equal probability Code chlorine_am &lt;- mon_survey %&gt;% dplyr::filter( wp_func, wp_intervention != &quot;Non-program&quot;, !is.na(wp_intervention), !(ilc &amp; sample_group != &quot;ILC&quot;) ) %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id, data = .x, nest = TRUE): No ## weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, data = .x, nest = TRUE): No ## weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, data = .x, nest = TRUE): No ## weights or probabilities supplied, assuming equal probability 6.3 Table Code cl &lt;- chlorine_am %&gt;% mutate( across( c(mean, lb, ub), ~ (. * 100) %&gt;% round(1) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, lb, &quot;, &quot;, ub, &quot;)&quot;) , hhs = hhs %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% select(country, wp_intervention, outcome, hhs, est = mean, ci) %&gt;% pivot_wider( values_from = c(est, ci), names_from = outcome ) %&gt;% pivot_longer( cols = ends_with(&quot;02&quot;), names_pattern = &quot;(.*)_disc(.*)_02&quot;, names_to = c(&quot;name&quot;, &quot;.value&quot;) ) people &lt;- total_country %&gt;% left_join( wp_sample_sizes %&gt;% group_by(country, wp_intervention) %&gt;% summarise(pop = sum(pop_points)) ) %&gt;% mutate( across( c(total_people, total_people_lb, total_people_ub, pop), ~ . %&gt;% round %&gt;% format(big.mark = &quot;,&quot;) %&gt;% str_remove_all(&quot; &quot;) ), ci = paste0(&quot;(&quot;, total_people_lb, &quot;, &quot;, total_people_ub, &quot;)&quot;) ) %&gt;% select( country, wp_intervention, pop, est = total_people, ci ) %&gt;% pivot_longer( cols = c(est, ci), values_to = &quot;people&quot; ) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(country, wp_intervention)` Code obs &lt;- wp_census %&gt;% dplyr::filter( promoter_surveyed, intervention != &quot;Non-program&quot;, !(country == &quot;Uganda&quot; &amp; intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, intervention) %&gt;% summarise( wps = n(), listed_hhs = sum(pm_users, na.rm = TRUE) %&gt;% format(big.mark = &quot;,&quot;) ) %&gt;% mutate(name = &quot;est&quot;) %&gt;% rename(wp_intervention = intervention) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. Code tab &lt;- obs %&gt;% mutate(wp_intervention = as.character(wp_intervention)) %&gt;% full_join(people) %&gt;% left_join(cl) %&gt;% arrange(country, wp_intervention, desc(name)) %&gt;% ungroup %&gt;% mutate( across( everything(), ~ as.character(.) ), across( -c(people, tcr, fcr), ~ case_when( name == &quot;est&quot; ~ ., TRUE ~ &quot;&quot; ) ) ) %&gt;% dplyr::filter(!is.na(country))%&gt;% select(-c(name, country)) ## Joining with `by = join_by(country, wp_intervention, name)` ## Joining with `by = join_by(country, wp_intervention, name)` Code table &lt;- kable( tab, format = &quot;latex&quot;, escape = F, align = &quot;c&quot;, booktabs = T, col.names = linebreak( c(&quot;Intervention&quot;, &quot;\\\\#WP&quot;, &quot;\\\\#HH&quot;, &quot;\\\\#WP&quot;, &quot;People using\\nDSW/ILC\\n(95\\\\% CI)&quot;, &quot;\\\\#HH&quot;, &quot;TCR\\n(95\\\\% CI)&quot;, &quot;FCR\\n(95\\\\% CI)&quot;), align = &quot;c&quot; ), caption = &quot;Primary outcomes estimated following the monitoring method&quot;, label = &quot;headlines-am&quot; ) %&gt;% kable_styling(latex_options = c(&quot;scale_down&quot;, &quot;HOLD_position&quot;)) %&gt;% pack_rows(&quot;Malawi&quot;, 1, 4) %&gt;% pack_rows(&quot;Uganda&quot;, 5, 6) %&gt;% add_header_above( c( &quot; &quot;, &quot;Promoter survey&quot; = 2, &quot;Country-level estimates&quot; = 2, &quot;Percent of color wheel readings ≥ 0.2 ppm&quot; = 3 ) ) %&gt;% add_header_above(c(&quot; &quot;, &quot; &quot;, paste0(&quot;(&quot;, 1:6,&quot;)&quot;)), line = FALSE) writeLines( table, &quot;output/tables/headlines-am.tex&quot; ) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
