[["index.html", "Estimating Chlorination Take-up in Malawi and Uganda 1 Introduction", " Estimating Chlorination Take-up in Malawi and Uganda 2025-11-05 1 Introduction This notebook presents the code used for analysis in the report to GiveWell. To see the code used to create each exhibit, click on the Code button. "],["inputs.html", "2 Inputs 2.1 Villages 2.2 Water points 2.3 Household census 2.4 Household survey 2.5 Water point census", " 2 Inputs Code pacman::p_load( sf, tidyverse, viridis, fixest, janitor, broom, car, modelsummary, survey ) 2.1 Villages 2.1.1 All villages in admin data Code villages &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;Villages&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;villages.rds&quot; ) ) 2.1.2 Sampled villages DSW villages were replaced at random (e.g. because of disputed village boundaries or because the village could not be identified under the names in the admin data). Therefore, we remove replaced villages from the analysis ILC villages were not replaced at random: these were replaced when no ILC was present in the village or when all of the water collection points were not functioning. Therefore, we consider replaced villages to have zero users. Code sampled_villages &lt;- villages %&gt;% dplyr::filter( (sample_group == &quot;ILC&quot; &amp; visited == &quot;In sample&quot;) | (sample_group != &quot;ILC&quot; &amp; visited == &quot;In sample&quot; &amp; !vil_replaced) ) village_intervention &lt;- sampled_villages %&gt;% crossing(wp_intervention = c(&quot;DSW&quot;, &quot;ILC&quot;)) %&gt;% dplyr::filter(!(wp_intervention == &quot;ILC&quot; &amp; sample_group != &quot;ILC&quot;)) 2.1.3 Calculate village sample sizes for weighing Code sample_sizes &lt;- villages %&gt;% mutate(sampled_village = village_id %in% sampled_villages$village_id) %&gt;% group_by(country, sample_group) %&gt;% summarise( n_villages = n_distinct(village_id), visited_villages = sum(visited == &quot;In sample&quot; &amp; !vil_replaced), sampled_villages = sum(sampled_village) ) ## `summarise()` has grouped output by &#39;country&#39;. You can override using the ## `.groups` argument. 2.2 Water points Code wp_sample_sizes &lt;- tribble( ~ country, ~ sample_group, ~ wp_intervention, ~ pop_points, &quot;Uganda&quot;, &quot;Expansion&quot;, &quot;DSW&quot;, 12262, &quot;Uganda&quot;, &quot;Footprint&quot;, &quot;DSW&quot;, 5456, &quot;Malawi&quot;, &quot;Expansion&quot;, &quot;DSW&quot;, 11292, &quot;Malawi&quot;, &quot;Footprint&quot;, &quot;DSW&quot;, 3844, &quot;Malawi&quot;, &quot;ILC&quot;, &quot;DSW&quot;, 1062, &quot;Malawi&quot;, &quot;ILC&quot;, &quot;ILC&quot;, 2024 ) 2.3 Household census Code hh_census &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;HouseholdCensus&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;hh-census.rds&quot; ) ) %&gt;% st_drop_geometry() %&gt;% # To account for non-responses, we calculate the village-level non-response rate group_by(village_id) %&gt;% mutate( response_rate = mean(response), intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) %&gt;% ungroup 2.4 Household survey Code hh_survey &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;HouseholdSurvey&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;hh-survey.rds&quot; ) ) %&gt;% dplyr::filter( survey == &quot;Household Survey&quot; ) %&gt;% mutate( intervention_selfreport = case_when( hh_dsw ~ &quot;DSW&quot;, hh_ilc ~ &quot;ILC&quot; ), intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) 2.5 Water point census Code wp_census &lt;- read_rds( file.path( path_box, &quot;Data&quot;, &quot;WaterPointCensus&quot;, &quot;DataSets&quot;, &quot;Final&quot;, &quot;wp-census.rds&quot; ) ) %&gt;% st_drop_geometry %&gt;% mutate( intervention_fo = case_when( wp_dsw ~ &quot;DSW&quot;, wp_ilc ~ &quot;ILC&quot; ) ) "],["village-level-headline-results.html", "3 Village-level headline results 3.1 People using DSW/ILC water points 3.2 Chlorine detection rates", " 3 Village-level headline results Code pacman::p_load( sf, tidyverse, viridis, fixest, janitor, broom, car, modelsummary, survey ) 3.1 People using DSW/ILC water points 3.1.1 Prepare data To calculate the number of people using water points with DSW or ILC, we use self-reported data from the household census on what is the household’s primary water point. This information is combined with data from the water point census to determine whether these water points are served by DSW or ILC. We start by restricting the household census data to households using water points with DSW or ILC located inside the sampled villages. We also exclude households using ILC in Uganda because we did not design the survey to be representative of this population. Code users_data &lt;- hh_census %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) The relevant variable to calculate the number of people using water points with DSW or ILC is the number of people living in households that report their primary water source has DSW or ILC. Due to a coding mistake, this variable was not collected in the first few days of data collection in Uganda. Therefore, we need to impute values for the households where this information is missing. Code users_data %&gt;% dplyr::filter(!is.na(wp_intervention_type), is.na(hh_members)) %&gt;% tabyl(date, country) %&gt;% adorn_totals() ## date Uganda ## 2025-07-02 4 ## 2025-07-03 35 ## 2025-07-04 3 ## 2025-07-07 13 ## 2025-07-08 255 ## 2025-07-09 158 ## 2025-07-10 28 ## 2025-07-11 37 ## 2025-07-14 130 ## 2025-07-15 21 ## 2025-07-16 1 ## Total 685 There are 8 villages in Uganda with no observations for this variable, so we cannot impute it as the village average. Therefore, we impute it are the sample group level. Code users_data &lt;- users_data %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) To account for the villages where all the water points with ILC were out of order, we add them to the data, but with zero households using water points with ILC. Code users_data &lt;- users_data %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` Since the unit of reference for our analysis is the village, we calculate the number of people whose primary water source has DSW or ILC by adding the number of household members across all such households in a village. Code users_village &lt;- users_data %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using ## the `.groups` argument. To scale to the country level, we combine this data with the number of sampled villages and the number of villages in the admin data per group. Code users_village &lt;- users_village %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% ungroup ## Joining with `by = join_by(country, sample_group)` There is one village in Malawi with only one household using ILC: Code users_village %&gt;% dplyr::filter(hhs == 1) ## # A tibble: 43 × 12 ## village_id country sample_group wp_intervention response_rate hhs users ## &lt;chr&gt; &lt;chr&gt; &lt;ord&gt; &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; ## 1 2011503007 Malawi ILC DSW NA 1 0 ## 2 2011707046 Malawi ILC ILC NA 1 0 ## 3 2011802006 Malawi ILC DSW NA 1 0 ## 4 2020110099 Malawi ILC DSW NA 1 0 ## 5 2020110101 Malawi ILC DSW NA 1 0 ## 6 2020205040 Malawi ILC ILC NA 1 0 ## 7 2020317075 Malawi ILC ILC NA 1 0 ## 8 2030106036 Malawi ILC ILC NA 1 0 ## 9 2030312057 Malawi ILC ILC NA 1 0 ## 10 2030318092 Malawi ILC ILC NA 1 0 ## # ℹ 33 more rows ## # ℹ 5 more variables: users_increased &lt;dbl&gt;, n_villages &lt;int&gt;, ## # visited_villages &lt;int&gt;, sampled_villages &lt;int&gt;, weight &lt;dbl&gt; To simplify the calculation of standard errors, we remove it from the estimates. Code users_village &lt;- users_village %&gt;% dplyr::filter(hhs &gt; 1) 3.1.2 Sanity check Here we just calculate the total number of people without CIs. The point estimate should be the same as the one calculated with a canned function. Code users_village %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( n = n_distinct(village_id), hhs = mean(hhs), av_people = mean(users), av_people_non = mean(users_increased), sampled_villages = unique(sampled_villages), vil_weight = n/sampled_villages, group_weight = unique(n_villages) ) %&gt;% mutate( total_people = round(av_people * group_weight * vil_weight), total_people_non = round(av_people_non * group_weight * vil_weight) ) ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## # A tibble: 6 × 12 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention n hhs av_people av_people_non ## &lt;chr&gt; &lt;ord&gt; &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 Malawi Footprint DSW 27 46.3 205. 214. ## 2 Malawi Expansion DSW 28 76.5 363. 365. ## 3 Malawi ILC DSW 24 70.5 298. 300. ## 4 Malawi ILC ILC 30 42.1 190. 193. ## 5 Uganda Footprint DSW 30 49.3 265. 286. ## 6 Uganda Expansion DSW 30 115. 620. 721. ## # ℹ 5 more variables: sampled_villages &lt;int&gt;, vil_weight &lt;dbl&gt;, ## # group_weight &lt;int&gt;, total_people &lt;dbl&gt;, total_people_non &lt;dbl&gt; 3.1.3 Final numbers We the total number of users per sample group and the confidence intervals around this number using the package survey to adjust standard errors for the survey design. 3.1.3.1 By program and sample group Code people_per_group &lt;- map( users_village %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, weight = .x %&gt;% pull(weight) %&gt;% unique ) ) %&gt;% bind_rows() %&gt;% select( country, sample_group, wp_intervention, outcome, villages, weight, everything() ) %&gt;% arrange(outcome) people_per_group ## country sample_group wp_intervention outcome villages weight ## 1 Malawi Footprint DSW users_increased 27 41.46429 ## 2 Malawi Expansion DSW users_increased 28 171.75000 ## 3 Malawi ILC DSW users_increased 24 13.27083 ## 4 Malawi ILC ILC users_increased 30 13.27083 ## 5 Uganda Footprint DSW users_increased 30 105.76667 ## 6 Uganda Expansion DSW users_increased 30 133.73333 ## total se lb ub ## 1 239348.12 34604.07 171525.39 307170.8 ## 2 1752944.50 301860.50 1161308.79 2344580.2 ## 3 95706.13 17158.31 62076.46 129335.8 ## 4 77023.59 13048.27 51449.45 102597.7 ## 5 907708.20 127724.20 657373.37 1158043.0 ## 6 2891317.81 381160.98 2144256.02 3638379.6 3.1.3.2 By program Code people_per_country &lt;- map( users_village %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) people_per_country ## country wp_intervention outcome villages total se ## 1 Malawi DSW users_increased 79 2087998.75 385016.05 ## 2 Malawi ILC users_increased 30 77023.59 13048.27 ## 3 Uganda DSW users_increased 60 3799026.01 474919.13 ## lb ub ## 1 1333381.16 2842616.3 ## 2 51449.45 102597.7 ## 3 2868201.63 4729850.4 Code people_per_group %&gt;% bind_rows(people_per_country) %&gt;% write_csv( here(&quot;../output/tables/users-vil.csv&quot;) ) 3.1.4 Sensitivity checks 3.1.4.1 Don’t correct for non-responses Code users_vil_responseonly &lt;- map( users_village %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 3.1.4.2 Include households using water points outside of the village Code users_outside &lt;- hh_census %&gt;% dplyr::filter( !is.na(wp_intervention), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using ## the `.groups` argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_outside &lt;- map( users_outside %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 3.1.4.3 Don’t correct for non-functional ILC Code users_func &lt;- hh_census %&gt;% dplyr::filter( !is.na(wp_intervention), wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using ## the `.groups` argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_func &lt;- map( users_func %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 3.1.4.4 Use raw FO reports Code users_fo &lt;- hh_census %&gt;% mutate(wp_intervention = intervention_fo) %&gt;% dplyr::filter( !is.na(wp_intervention), wp_invillage, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ) ) %&gt;% full_join( village_intervention %&gt;% select(village_id, country, sample_group, wp_intervention) ) %&gt;% mutate( hh_members = replace_na(hh_members, 0) ) %&gt;% group_by(village_id, country, sample_group, wp_intervention) %&gt;% summarise( response_rate = unique(response_rate), hhs = n(), users = sum(hh_members) ) %&gt;% mutate( users_increased = users/response_rate ) %&gt;% left_join(sample_sizes) %&gt;% group_by(country, sample_group) %&gt;% mutate( weight = n_villages/n_distinct(village_id) ) %&gt;% dplyr::filter(hhs &gt; 1) %&gt;% ungroup ## Joining with `by = join_by(village_id, country, sample_group, wp_intervention)` ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;country&#39;, &#39;sample_group&#39;. You can override using ## the `.groups` argument. ## Joining with `by = join_by(country, sample_group)` Code users_vil_fo &lt;- map( users_fo %&gt;% group_by(country, wp_intervention) %&gt;% group_split(), ~ total_ci( var = &quot;users_increased&quot;, design = svydesign( id = ~ village_id, data = .x, weights = ~ weight ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct ) ) %&gt;% bind_rows() %&gt;% select( country, wp_intervention, outcome, villages, everything() ) %&gt;% arrange(outcome) 3.1.4.5 Plot Code plot_data &lt;- list( &quot;Main estimate&quot; = people_per_country, &quot;Including households using water points\\noutside of sampled villages&quot; = users_vil_outside, &quot;Without correction for non-responses&quot; = users_vil_responseonly, &quot;Without corrections to DSW/ILC status\\nfrom admin data&quot; = users_vil_fo, &quot;Without correction for functionality rates&quot; = users_vil_func ) %&gt;% map( ~ .x %&gt;% select(country, wp_intervention, outcome, total, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( main = label == &quot;Main estimate&quot; ) %&gt;% dplyr::filter(wp_intervention != &quot;Non-program&quot;) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = total, label = format(round(total), big.mark = &quot;,&quot;), color = !main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_color_viridis_d() + theme + scale_color_viridis_d() + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + theme(legend.position = &quot;none&quot;) + labs( y = NULL, x = &quot;Number of people using a water point with DSW/ILC as\\nmain source of drinking water&quot; ) ## Scale for colour is already present. ## Adding another scale for colour, which will replace the existing scale. ## Scale for x is already present. ## Adding another scale for x, which will replace the existing scale. 3.2 Chlorine detection rates 3.2.1 Prepare data Code chlorination_data &lt;- hh_survey %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` 3.2.2 Sanity check Code chlorination_data %&gt;% group_by(village_id, sample_group, wp_intervention_type, country) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n() ) %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = sum(hhs), villages = n() ) ## `summarise()` has grouped output by &#39;village_id&#39;, &#39;sample_group&#39;, &#39;wp_intervention_type&#39;. You can ## override using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## # A tibble: 7 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention_type disctcr_02 discfcr_02 hhs villages ## &lt;chr&gt; &lt;ord&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Footprint DSW 0.296 0.209 440 25 ## 2 Malawi Expansion DSW 0.264 0.210 520 28 ## 3 Malawi ILC DSW 0.218 0.187 319 23 ## 4 Malawi ILC ILC water collectio… 0.327 0.123 345 24 ## 5 Malawi ILC ILC water point 0.410 0.335 44 7 ## 6 Uganda Footprint DSW 0.303 0.207 547 30 ## 7 Uganda Expansion DSW 0.321 0.206 574 30 Code chlorination_data %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n(), villages = n_distinct(village_id) ) ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## # A tibble: 7 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention_type disctcr_02 discfcr_02 hhs villages ## &lt;chr&gt; &lt;ord&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Footprint DSW 0.303 0.217 440 25 ## 2 Malawi Expansion DSW 0.270 0.217 520 28 ## 3 Malawi ILC DSW 0.207 0.184 319 23 ## 4 Malawi ILC ILC water collectio… 0.281 0.127 345 24 ## 5 Malawi ILC ILC water point 0.359 0.231 44 7 ## 6 Uganda Footprint DSW 0.280 0.180 547 30 ## 7 Uganda Expansion DSW 0.321 0.207 574 30 3.2.3 Final numbers 3.2.3.1 Separating ILC WP and ILC WCP Code cl_village_noweights_ilc &lt;- chlorination_data %&gt;% group_by(country, sample_group, wp_intervention_type) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention_type) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 3.2.3.2 By sample group and program Code cl_village_noweights_samplegroup &lt;- chlorination_data %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention_type) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 3.2.3.3 Check program differences Before we combine observations in different sample groups, we want to make sure that chlorination rates are not different across them Code feols( disctcr_02 ~ sample_group, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter(country == &quot;Uganda&quot;) ) %&gt;% summary ## NOTE: 144 observations removed because of NA values (LHS: 144). ## The variable &#39;sample_group.Q&#39; has been removed because of collinearity (see $collin.var). ## OLS estimation, Dep. Var.: disctcr_02 ## Observations: 977 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.321285 0.036657 8.764531 2.8255e-12 *** ## sample_group.L 0.058740 0.080230 0.732145 4.6698e-01 ## ... 1 variable was removed because of collinearity (sample_group.Q) ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.458188 Adj. R2: 0.001026 Code feols( disctcr_02 ~ sample_group, cluster = ~ village_id, data = chlorination_data %&gt;% dplyr::filter(country == &quot;Malawi&quot;) ) %&gt;% summary ## NOTE: 37 observations removed because of NA values (LHS: 37). ## OLS estimation, Dep. Var.: disctcr_02 ## Observations: 1,631 ## Standard-errors: Clustered (village_id) ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.274753 0.025410 10.812800 &lt; 2.2e-16 *** ## sample_group.L -0.035606 0.040857 -0.871476 0.38569 ## sample_group.Q 0.006395 0.046955 0.136195 0.89195 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## RMSE: 0.44401 Adj. R2: 8.679e-4 3.2.3.4 By program Code cl_village_noweights_country &lt;- chlorination_data %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., nest = TRUE, strata = ~ sample_group ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = ., nest = TRUE, : ## No weights or probabilities supplied, assuming equal probability Code cl_village_noweights_country %&gt;% write_csv( here(&quot;../output/tables/chlorine-vil.csv&quot;) ) 3.2.4 Sensitivity checks 3.2.4.1 Weighing villages equally Code cl_village_vilweights &lt;- chlorination_data %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., strata = ~ sample_group, prob = ~ weight_equal, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) 3.2.4.2 Weighing villages by number of users Code cl_village_userweights &lt;- chlorination_data %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) data = ., prob = ~ weight_users, strata = ~ sample_group, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) 3.2.4.3 FO reports of intervention Code chlorination_fo &lt;- hh_survey %&gt;% mutate(wp_intervention = intervention_fo) %&gt;% dplyr::filter( !is.na(intervention_fo), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_fo &lt;- chlorination_fo %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, strata = ~sample_group, ## : No weights or probabilities supplied, assuming equal probability 3.2.4.4 Self-reported users Code chlorination_self &lt;- hh_survey %&gt;% mutate(wp_intervention = intervention_selfreport) %&gt;% dplyr::filter( !is.na(wp_intervention), !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_self &lt;- chlorination_self %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability 3.2.4.5 All households surveyed Code chlorination_all &lt;- hh_survey %&gt;% mutate( wp_intervention = case_when( !is.na(wp_intervention) ~ wp_intervention, hh_dsw ~ &quot;DSW&quot;, hh_ilc ~ &quot;ILC&quot;, sample_group != &quot;ILC&quot; ~ &quot;DSW&quot; ) ) %&gt;% dplyr::filter( !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) %&gt;% group_by(village_id) %&gt;% ungroup %&gt;% left_join( hh_census %&gt;% group_by( village_id, wp_intervention ) %&gt;% summarise(pop_users = n_distinct(household_id)/unique(response_rate)) ) %&gt;% group_by(village_id) %&gt;% mutate( # This is if we weigh each village equally weight_equal = n_distinct(household_id)/20, # This is if we apply sampling weights weight_users = n_distinct(household_id)/pop_users, ) ## `summarise()` has grouped output by &#39;village_id&#39;. You can override using the `.groups` argument. ## Joining with `by = join_by(village_id, wp_intervention)` Code cl_village_all &lt;- chlorination_all %&gt;% group_by(country, wp_intervention) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;discfcr_02&quot;, &quot;disctcr_02&quot;), design = svydesign( id = ~ village_id, # PSU (here: villages) strata = ~ sample_group, data = ., nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, hhs = .x %&gt;% pull(household_id) %&gt;% n_distinct, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id, strata = ~sample_group, data = ## ., : No weights or probabilities supplied, assuming equal probability 3.2.4.6 Plot Code plot_data &lt;- list( &quot;Weighing each tested household equally&quot; = cl_village_noweights_country, &quot;Weighing each village equally&quot; = cl_village_vilweights, &quot;Weighing villages by number of users&quot; = cl_village_userweights, &quot;Without corrections to DSW/ILC status\\nfrom admin data&quot; = cl_village_fo, &quot;Using self-report of DSW/ILC status&quot; = cl_village_self, &quot;Including household with unconfirmed\\nDSW/ILC status&quot; = cl_village_all ) %&gt;% map( ~ .x %&gt;% dplyr::filter(outcome == &quot;disctcr_02&quot;) %&gt;% select(country, wp_intervention, outcome, mean, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( across( c(mean, ub, lb), ~ . * 100 ), main = (label == &quot;Weighing each tested household equally&quot;) ) %&gt;% dplyr::filter(wp_intervention != &quot;Non-program&quot;) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = mean, label = round(mean, 1) %&gt;% paste0(&quot;%&quot;), color = !main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_color_viridis_d() + theme + scale_color_viridis_d() + theme(legend.position = &quot;none&quot;) + labs( y = NULL, x = &quot;Percent of tested households where color wheel\\nTCR reading was at least 0.2 ppm&quot; ) ## Scale for colour is already present. ## Adding another scale for colour, which will replace the existing scale. "],["water-point-level-headline-results.html", "4 Water point-level headline results 4.1 Number of people using DSW/ILC 4.2 Chlorination rates", " 4 Water point-level headline results 4.1 Number of people using DSW/ILC 4.1.1 Prepare data Code hh_census_wp &lt;- hh_census %&gt;% left_join(wp_sample_sizes) ## Joining with `by = join_by(country, sample_group, wp_intervention)` 4.1.1.1 Main treatment Code users_data &lt;- hh_census_wp %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;), # These are households using water points outside of the village # that were found to have DSW. Since we don&#39;t have a water point ID # for them, we cannot used them fow water point-level estimtes !is.na(wp_id) ) %&gt;% left_join( wp_census %&gt;% dplyr::filter(dsw | ilc_wcp) %&gt;% rename(wp_intervention = intervention) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( func_rate = mean(wp_func, na.rm = TRUE) ) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% mutate( func_points = func_rate * pop_points, weight = n_distinct(wp_id)/func_points, weight_nofunc = n_distinct(wp_id)/pop_points ) %&gt;% ungroup ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group, wp_intervention)` Code users_data &lt;- users_data %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ), hh_members_increased = hh_members/response_rate ) 4.1.1.2 Raw treatment variable Code users_fo &lt;- hh_census %&gt;% dplyr::filter( !is.na(intervention_fo), !(sample_group != &quot;ILC&quot; &amp; intervention_fo == &quot;ILC&quot;), !is.na(wp_id) ) %&gt;% left_join( wp_sample_sizes %&gt;% rename(intervention_fo = wp_intervention), unmatched = &quot;error&quot; ) %&gt;% group_by(country, sample_group) %&gt;% mutate( hh_members = if_else( !is.na(hh_members), hh_members, mean(hh_members, na.rm = TRUE) ), hh_members_increased = hh_members/response_rate ) %&gt;% ungroup %&gt;% left_join( wp_census %&gt;% dplyr::filter( !is.na(intervention_fo), !(sample_group != &quot;ILC&quot; &amp; intervention_fo == &quot;ILC&quot;) ) %&gt;% group_by(country, sample_group, intervention_fo) %&gt;% summarise( func_rate = mean(wp_func, na.rm = TRUE) ) %&gt;% mutate(sample_group = as.character(sample_group)) %&gt;% ungroup, unmatched = &quot;error&quot; ) %&gt;% group_by(country, sample_group, intervention_fo) %&gt;% mutate( func_points = func_rate * pop_points, weight = n_distinct(wp_id)/func_points ) %&gt;% ungroup ## Joining with `by = join_by(country, sample_group, intervention_fo)` ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## Joining with `by = join_by(country, sample_group, intervention_fo)` 4.1.2 Sanity check Code group &lt;- users_data %&gt;% group_by( wp_id, wp_intervention, sample_group, country, pop_points, func_points ) %&gt;% summarise( users = sum(hh_members), users_increased = sum(hh_members_increased) ) %&gt;% group_by( country, sample_group, wp_intervention, pop_points, func_points ) %&gt;% summarise( across( c(users, users_increased), ~ mean(.) ) ) %&gt;% mutate( across( c(users, users_increased), ~ . * pop_points, .names = &quot;{.col}_total&quot; ), across( c(users, users_increased), ~ . * func_points, .names = &quot;{.col}_func&quot; ) ) ## `summarise()` has grouped output by &#39;wp_id&#39;, &#39;wp_intervention&#39;, &#39;sample_group&#39;, &#39;country&#39;, ## &#39;pop_points&#39;. You can override using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;, &#39;wp_intervention&#39;, &#39;pop_points&#39;. You ## can override using the `.groups` argument. Code group ## # A tibble: 6 × 11 ## # Groups: country, sample_group, wp_intervention, pop_points [6] ## country sample_group wp_intervention pop_points func_points users ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 Malawi Expansion DSW 11292 11159. 126. ## 2 Malawi Footprint DSW 3844 3618. 116. ## 3 Malawi ILC DSW 1062 1046. 116. ## 4 Malawi ILC ILC 2024 1743. 40.8 ## 5 Uganda Expansion DSW 12262 11471. 185. ## 6 Uganda Footprint DSW 5456 5367. 188. ## # ℹ 5 more variables: users_increased &lt;dbl&gt;, users_total &lt;dbl&gt;, ## # users_increased_total &lt;dbl&gt;, users_func &lt;dbl&gt;, users_increased_func &lt;dbl&gt; Code group %&gt;% group_by(wp_intervention, country) %&gt;% summarise( across( c(contains(&quot;users_&quot;)), ~ sum(.) ) ) %&gt;% select(-users_increased) ## `summarise()` has grouped output by &#39;wp_intervention&#39;. You can override using ## the `.groups` argument. ## # A tibble: 3 × 6 ## # Groups: wp_intervention [2] ## wp_intervention country users_total users_increased_total users_func ## &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 DSW Malawi 1988801. 2015929. 1944004. ## 2 DSW Uganda 3290930. 3725906. 3128090. ## 3 ILC Malawi 82521. 84086. 71073. ## # ℹ 1 more variable: users_increased_func &lt;dbl&gt; 4.1.3 Final numbers Code users_wp &lt;- users_data %&gt;% group_by( country, sample_group, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, sample_group, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) Code users_wp_country &lt;- users_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) Code users_wp %&gt;% bind_rows(users_wp_country) %&gt;% write_csv( here( &quot;../output/tables/users-wp.csv&quot; ) ) 4.1.4 Sensitivty cehcks 4.1.4.1 Disregarding non-responses Code users_wp_responseonly &lt;- users_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) 4.1.4.2 Not adjusting for functionality rates Code users_wp_nofunc &lt;- users_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight_nofunc, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) 4.1.4.3 Using raw intervention data Code users_wp_fo &lt;- users_fo %&gt;% group_by(country, intervention_fo) %&gt;% group_split %&gt;% map( ~ total_cis( outcomes = c(&quot;hh_members_increased&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs strata = ~ sample_group, prob = ~ weight, data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(intervention_fo) %&gt;% unique, villages = .x %&gt;% pull(village_id) %&gt;% n_distinct, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(outcome) 4.1.4.4 Plot Code plot_data &lt;- list( &quot;Main estimate&quot; = users_wp_country, &quot;Without correction for non-responses&quot; = users_wp_responseonly, &quot;Without corrections to DSW/ILC status\\nfrom admin data&quot; = users_wp_fo, &quot;Without correction for functionality\\nrates&quot; = users_wp_nofunc ) %&gt;% map( ~ .x %&gt;% select(country, wp_intervention, outcome, total, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( main = label == &quot;Main estimate&quot; ) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = total, label = format(round(total), big.mark = &quot;,&quot;), color = !main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_color_viridis_d() + theme + theme(legend.position = &quot;none&quot;) + labs( y = NULL, x = &quot;Number of people using a water point with DSW/ILC as\\nmain source of drinking water&quot; ) 4.2 Chlorination rates 4.2.1 Prepare data Code hh_survey_wp &lt;- hh_survey %&gt;% left_join(wp_sample_sizes) ## Joining with `by = join_by(country, sample_group, wp_intervention)` Code chlorination_data &lt;- hh_survey_wp %&gt;% dplyr::filter( wp_intervention_type != &quot;Non-program&quot;, !(sample_group != &quot;ILC&quot; &amp; wp_intervention == &quot;ILC&quot;) ) Code chlorination_data &lt;- chlorination_data %&gt;% # Sampling weights group_by(wp_id) %&gt;% mutate( n_cl = n_distinct(household_id) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% mutate( n_cat = n_distinct(wp_id) ) %&gt;% # Weight by number of users left_join( hh_census %&gt;% group_by(wp_id) %&gt;% summarise( n_users = n_distinct(household_id) ) ) %&gt;% ungroup %&gt;% mutate( # Number of households using this water point represented by the observation weight_obs = n_users/n_cl, # Weighting all water points equally, weight_wp = 1/n_cl ) ## Joining with `by = join_by(wp_id)` 4.2.2 Sanity check Code chlorination_data %&gt;% group_by(wp_id, wp_intervention, sample_group, country) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n_distinct(household_id) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = sum(hhs), wp_id = n_distinct(wp_id) ) ## `summarise()` has grouped output by &#39;wp_id&#39;, &#39;wp_intervention&#39;, &#39;sample_group&#39;. You can override ## using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## # A tibble: 6 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention disctcr_02 discfcr_02 hhs wp_id ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Expansion DSW 0.231 0.171 520 75 ## 2 Malawi Footprint DSW 0.293 0.198 440 45 ## 3 Malawi ILC DSW 0.230 0.175 319 55 ## 4 Malawi ILC ILC 0.248 0.0999 389 95 ## 5 Uganda Expansion DSW 0.316 0.189 574 95 ## 6 Uganda Footprint DSW 0.271 0.173 547 55 4.2.3 Final numbers 4.2.3.1 By program and sample group Code cl_wp_sample &lt;- chlorination_data %&gt;% group_by( country, wp_intervention, sample_group ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, sample_group, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.3.2 Separate ILC Code cl_wp_ilc &lt;- chlorination_data %&gt;% dplyr::filter(sample_group == &quot;ILC&quot;) %&gt;% group_by( country, wp_intervention_type ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention_type) %&gt;% unique, sample_group = .x %&gt;% pull(sample_group) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, sample_group, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.3.3 By program Code cl_wp_noweights &lt;- chlorination_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability Code cl_wp_noweights %&gt;% bind_rows(cl_wp_ilc) %&gt;% bind_rows(cl_wp_sample) %&gt;% write_csv( here(&quot;../output/tables/chlorine-wp.csv&quot;) ) 4.2.4 Sensitivity checks 4.2.4.1 Mean of means (no CI) Code chlorination_data %&gt;% group_by(wp_id, wp_intervention, sample_group, country) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = n_distinct(household_id) ) %&gt;% group_by(country, sample_group, wp_intervention) %&gt;% summarise( across( c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), ~ mean(., na.rm = TRUE) ), hhs = sum(hhs), wp_id = n_distinct(wp_id) ) ## `summarise()` has grouped output by &#39;wp_id&#39;, &#39;wp_intervention&#39;, &#39;sample_group&#39;. You can override ## using the `.groups` argument. ## `summarise()` has grouped output by &#39;country&#39;, &#39;sample_group&#39;. You can override using the `.groups` ## argument. ## # A tibble: 6 × 7 ## # Groups: country, sample_group [5] ## country sample_group wp_intervention disctcr_02 discfcr_02 hhs wp_id ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; ## 1 Malawi Expansion DSW 0.231 0.171 520 75 ## 2 Malawi Footprint DSW 0.293 0.198 440 45 ## 3 Malawi ILC DSW 0.230 0.175 319 55 ## 4 Malawi ILC ILC 0.248 0.0999 389 95 ## 5 Uganda Expansion DSW 0.316 0.189 574 95 ## 6 Uganda Footprint DSW 0.271 0.173 547 55 4.2.4.2 Weighing by number of users Code cl_wp_weight_users &lt;- chlorination_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, weight = ~ weight_obs, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) cl_wp_weight_users ## country wp_intervention outcome mean se lb ub ## 1 Malawi DSW disctcr_02 0.2312205 0.02574533 0.18076054 0.2816804 ## 2 Malawi ILC disctcr_02 0.2537625 0.04884484 0.15802836 0.3494966 ## 3 Uganda DSW disctcr_02 0.2701411 0.03404463 0.20341490 0.3368674 ## 4 Malawi DSW discfcr_02 0.1797730 0.02308713 0.13452310 0.2250230 ## 5 Malawi ILC discfcr_02 0.1299531 0.03382939 0.06364875 0.1962575 ## 6 Uganda DSW discfcr_02 0.1547683 0.02329837 0.10910434 0.2004323 ## wps households ## 1 175 1279 ## 2 95 389 ## 3 150 1121 ## 4 175 1279 ## 5 95 389 ## 6 150 1121 4.2.4.3 Weighing water points equally Code cl_wp_weight_wp &lt;- chlorination_data %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, weight = ~ weight_wp, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) 4.2.4.4 Using self-reports Code chlorination_self &lt;- hh_survey_wp %&gt;% dplyr::filter( !is.na(wp_id), !is.na(intervention_selfreport), !(sample_group != &quot;ILC&quot; &amp; intervention_selfreport == &quot;ILC&quot;) ) Code cl_wp_self &lt;- chlorination_self %&gt;% group_by( country, intervention_selfreport ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(intervention_selfreport) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.4.5 Using raw intervention variable Code chlorination_fo &lt;- hh_survey_wp %&gt;% dplyr::filter( !is.na(wp_id), !is.na(intervention_fo), !(sample_group != &quot;ILC&quot; &amp; intervention_fo == &quot;ILC&quot;) ) Code cl_wp_fo &lt;- chlorination_fo %&gt;% mutate(wp_intervention = intervention_fo) %&gt;% group_by( country, wp_intervention ) %&gt;% group_split %&gt;% map( ~ mean_cis( outcomes = c(&quot;disctcr_02&quot;, &quot;discfcr_02&quot;), design = svydesign( id = ~ village_id + wp_id, # cluster IDs data = .x, nest = TRUE ) ) %&gt;% mutate( country = .x %&gt;% pull(country) %&gt;% unique, wp_intervention = .x %&gt;% pull(wp_intervention) %&gt;% unique, wps = .x %&gt;% pull(wp_id) %&gt;% n_distinct, households = .x %&gt;% pull(household_id) %&gt;% n_distinct, ) ) %&gt;% bind_rows() %&gt;% select(country, wp_intervention, outcome, everything()) %&gt;% arrange(desc(outcome)) ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability ## Warning in svydesign.default(id = ~village_id + wp_id, data = .x, nest = TRUE): ## No weights or probabilities supplied, assuming equal probability 4.2.4.6 Plot Code plot_data &lt;- list( &quot;Weighing each tested household equally&quot; = cl_wp_noweights, &quot;Weighing each water point equally&quot; = cl_wp_weight_wp, &quot;Weighing water points by number of users&quot; = cl_wp_weight_users ) %&gt;% map( ~ .x %&gt;% dplyr::filter(outcome == &quot;disctcr_02&quot;) %&gt;% select(country, wp_intervention, outcome, mean, ub, lb) ) %&gt;% bind_rows(.id = &quot;label&quot;) %&gt;% mutate( across( c(mean, ub, lb), ~ . * 100 ), main = label == &quot;Weighing each tested household equally&quot; ) plot_data %&gt;% ggplot( aes( y = label, xmin = lb, xmax = ub, x = mean, label = round(mean, 1) %&gt;% paste0(&quot;%&quot;), color = !main ) ) + geom_errorbar(width = .3) + geom_point(size = 2) + geom_text( color = &quot;black&quot;, size = 3, vjust = -1 ) + facet_grid( country ~ wp_intervention, scales = &quot;free_x&quot; ) + scale_x_continuous(labels = ~ format(., big.mark = &quot;,&quot;, scientific = FALSE)) + scale_color_viridis_d() + theme + scale_color_viridis_d() + theme(legend.position = &quot;none&quot;) + labs( y = NULL, x = &quot;Percent of tested households where color wheel\\nTCR reading was at least 0.2 ppm&quot; ) ## Scale for colour is already present. ## Adding another scale for colour, which will replace the existing scale. "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
