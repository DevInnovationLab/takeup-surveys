---
output: rmdformats::robobook
title: "Comparison of chlorine adoption estimates"
---


```{r}
pacman::p_load(
  tidyverse,
  broom,
  fixest,
  estimatr,
  stargazer,
  modelsummary,
  kableExtra,
  sf, 
  vtable,
  janitor,
  ggtext
)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
```

```{r, echo=FALSE, results='asis'}
cat('<style>
/* Target the tinytable container */
.container:has(table.table-borderless) {
  display: flex !important;
  justify-content: center !important;
  width: 100% !important;
  overflow-x: auto !important;
}

/* Ensure the table itself scales properly */
table.table-borderless {
  width: auto !important;
  margin: 0 auto !important;
  font-size: 1em !important;  /* Changed from 0.85em to 1em (normal size) */
}

/* Make sure table cells have adequate padding */
.table-borderless td, .table-borderless th {
  white-space: nowrap !important;
}
</style>')
```

To-dos: 

- write this more carefully
- add sample sizes
- polish graphs
- think about right level to cluster SEs for each figure

Other notes:
- the small difference between TCR and FCR in EvAc data points to people haing chlorinated recently

```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry  %>%
  mutate(
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    closer = (ilc_wcp & str_detect(ea_id, "001^")) | ilc_wp
  )
```

```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  group_by(household_id, survey) %>%
  mutate(
    intervention_selfreport = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC"
    ),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    resp_fem = resp_sex == "Female",
    resp_primary_educ = resp_educ >= "Primary",
    hhh_fem = hhh_sex == "Female",
    hhh_primary_educ = hhh_educ >= "Primary",
    collect_primary = where_collect == "From the water point primary water point (${wp_name_pl})",
    waterprep_12minus = howlong_waterprep == "Less than 12 hrs ago [today]",
    collect_child = str_detect(who_collected, "18"),
    collect_resp = who_collected == "The respondent",
    across(
      c(hh_pregnant, hh_under2, hh_under5),
      ~ . > 0
    )
  ) %>%
  dplyr::filter(
    wp_intervention == "DSW",
    sample_group != "ILC"
  )
```

```{r}
promoter_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  ) %>%
  mutate(pm_wp = wp_id_c) %>%
  select(household_id, pm_wp)

pm_survey_clean <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Clean",
      "pm-survey-clean.rds"
    )
  )

randomization <- 
  pm_survey_clean %>% 
  dplyr::select(
    wp_id, village_id, country,
    contains("rand_hh")
  ) %>%
  pivot_longer(
    cols = starts_with("rand_hh"),
    names_prefix = "rand_hh_",
    names_to = "rank",
    values_to = "household_name",
    values_drop_na = TRUE
  ) %>%
  mutate(household_name = household_name %>% str_squish %>% str_trim)

hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  select(
    household_id,
    promoter_surveyed,
    promoter_list,
    inclusion,
    #visit,
    dsw,
    country,
    wp_count_pastmonth
  )

hh_names <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Constructed",
      "hh-census-constructed.rds"
    )
  ) %>%
  select(village_id, household_id, household_name, self_wp = wp_id_c) %>%
  dplyr::filter(!is.na(household_name)) %>%
  unique

randomization_id <-
  randomization %>%
  left_join(hhc) %>%
  mutate(pm_right = self_wp == wp_id)

hh_survey_matched <- 
  hh_survey %>%
  left_join(
    randomization_id %>% 
      select(household_id, rank),
    by = "household_id",
    relationship = "many-to-many"
  ) %>%
  left_join(
    hh_census %>% 
      select(
        household_id, 
        inclusion
      ),
    by = "household_id",
    relationship = "many-to-many"
  )

max_rank_surveyed <-
  hh_survey_matched %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(village_id) %>%
  summarise(max_rank = max(rank, na.rm = TRUE))

matched <-
  hh_survey_matched %>%
  left_join(
    promoter_survey,
    relationship = "many-to-many"
  ) %>%
  left_join(
    wp_census %>%
      transmute(pm_wp = wp_id, pm_wp_intervention = intervention)
  ) %>%
  left_join(max_rank_surveyed) %>%
  group_by(village_id, survey) %>%
  mutate(not_first_day = date > min(date)) %>%
  group_by(household_id) %>%
  mutate(
    in_monitoring = any(survey == "Monitoring Survey"),
    in_household = any(survey == "Household Survey")
  ) %>%
  ungroup %>%
  mutate(
    program = case_when(
      survey == "Household Survey" ~ wp_intervention,
      survey == "Monitoring Survey" ~ pm_wp_intervention
    ),
    rank = as.numeric(rank),
    replacement = rank > 4,
    replaced = rank < max_rank,
    replacement_status = case_when(
      replaced & !in_monitoring & survey == "Household Survey" ~  "Replaced",
      replacement & survey == "Monitoring Survey" ~  "Replacement",
    ),
    promoter_right = pm_wp == wp_id
  ) 

by_country <-
  matched %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda"))

averages <- function(data, x, cluster) {
  c("disctcr_02", "discfcr_02") %>%
    map(
      ~ feols(
        paste(., "~ 0 +", x) %>% as.formula,
        cluster = paste("~ ", cluster),
        data = data
      )
    ) %>%
    set_names(c("TCR", "FCR"))
}

marginal_effects <- function(data, x, cluster) {
  c("disctcr_02", "discfcr_02") %>%
    map(
      ~ feols(
        paste(., "~", x) %>% as.formula,
        cluster = paste("~ ", cluster),
        data = data
      )
    ) %>%
    set_names(c("TCR", "FCR"))
}
```

```{r}
balance_vars <-
  c(
    "resp_age",
    "resp_fem",
    "resp_primary_educ",
    "hhh_age", 
    "hhh_fem", 
    "hhh_primary_educ",
    "hh_members", 
    "hh_pregnant", 
    "hh_under2",
    "hh_under5",
    "wp_dist", 
    "evac_dist",
    #"pm_dist",
    "wp_pay",
    #"wp_func", 
    "wp_dsw_chlorine", 
    "wp_disctcr_02", 
    "wp_discfcr_02",
    "prep_different", 
    "prep_different_cl",
    "waterprep_12minus", 
    "mix", 
    "watertreat_any", 
    "watertreat_boil", 
    "watertreat_dispcl", 
    "watertreat_othercl",
    "collect_primary", 
    "collect_resp", 
    "collect_child",
    "int_warned", 
    "int_promoter",
    "disctcr_02", 
    "discfcr_02"
  )
```


# Summary

This analysis aims to identify at least some of the factors leading to different estimates of chlorine adoption.
  - In 2023, we identified that data from KSWTCS led to very different estimates of chlorine adoption rates than those presented by Evidence Action
  - We investigated potential reasons for this and concluded that even after accounting for all of them, Evidence Action's estimates still led to estimates that were at least three times as high as those coming from KSWTCS data ([see report](https://drive.google.com/file/d/1Os9CRFzak8-3V0BKWoa66rfHfzIFPlDa/view))
  - Evidence Action then collected more data in Kenya to estimate chlorination rates following the KSWTCS and Adoption Monitoring strategies. They found that
    - Chlorine adoption estimates based on the monitoring methodology (36%) was around twice as high as those from the census methodlogy (16%)
    - chlorine adoption estimates from the regular monitoring (44%) were around three times as high
    - comparing the same hosueholds, independent surveyors found a chlorination rate of 21%, while EvAc staff found a chlorination rate of 38%. Discount = 55%

Between July and October 2025, DIL conducted a similar exercise in Uganda and Malawi.
  - We collected data based on a census of households and based on the promoter's list. 
  - The objective was to compare whether with independent surveyors the differences in methodology would lead to different estimates of chlorine adoption
  
The resulting chlorine detection rates are presented in [Table 1](#tab:discount).
  - **Comparing census estimates with EvAc monitoring estimates for the same period are roughly consistent with those from EvAc's Kenya exercise**: Census methodology conducted independently are 52-58% lower than the monitoring estimates conducted by Evidence Action staff based on the promoter list.
  - **Based on field observations of DSW use, we believe the lower numbers are more likely to be correct**. We asked field teams to observe the people using the water points while they were collecting data. Field teams remained around water points with filled dispensers for about an hour to conduct all the necessary testing
    - In Malawi, the they observed people using 163 water points with dispensers, but only observed anyone using the dispenser in 14 of them
    - In Uganda, they observed people using 155 water points with dispensers, but only observed people using the dispenser in 21 of them
    
Within DIL's data, estimates obtained by following EvAc's protocol are higher than those obtained by DIL's protocol in Uganda, but not in Malawi ([Figure 1](#fig:hh-vs-mon), [Table 2](#tab:hh-vs-mon-tab))
  - This is consistent with the fact that households included in the two surveys are comparable in Malawi ([Table 3](#tab:balance-mw)), but not in Uganda ([Table 4](#tab:balance-ug))
  - In Uganda, households included in the Monitoring Survey are more likely to pay to use their primary water point, and twice as likely to have been warned by the promoter about the upcoming survey than those in the Household Survey.
    
The remainder of this document explores the differences between our monitoring and household survey estimates, indicating when these differences could also explain differences between DIL and EvAc estimates.
  - These comparisons are speculative and often use small sample sizes.
  - We believe differences are due to sample selection of water points and households being warned by promoters of the future surveys.
  - Annecdotal evidence points to more interference from EvAc in Uganda


# Methodology

This Section describes the methodology followed for each of these estimates

## Evidence Action

- Evidence Action samples water points
- They send their own staff to survey promoters
- They get a list from the promoter
- They randomly select households from this list to be surveyed
- They measure four housheolds from this list

## DIL

- 60 DSW villages were sampled in Uganda, and 60 in Malawi
- In each village, we conducted a census of all water points in the village and identified those with dispensers
- In each village, we then conducted a census of all households in the village and asked them which of the water points mapped during the census they used
- We then sampled 20 households that self-reported using water points with a DSW dispenser to be tested. This is what we call the "Household survey". Three attempts where made to survey each of this households, and if they could not be surveyed after that, they were replaced.
- After all households sampled for the household survey were tested, we surveyed the promoter for each water point. Promoters were asked to provide a list of the households using the water points they are responsible for.
- From each promoter list, four households were sampled for testing. This is what we call the "Monitoring survey". These households were only visited once, and if they were not available, they were replaced.
- If a household was already surveyed in the household survey, they are not re-surveyed.

# Potential explanations of differences between DIL and Evidence Action estimates

## Surveyors' independence

IPA (independent) vs EvAc (surveyor may have a relationship with the promoter, promoter wants to maintain a good relationship with EvAc, surveyor has more interest in EvAc succeeding). We would expect this to bias EvAc estimates upward. 

In the Kenya exercise, Evidence Action found that even when considering the exact same households, estimates from the household survey (taken by independent surveyors), which indicated 21% of the households tested in both survey tested positive for chlorine residual, represented only 55% of those from the monitoring survey (taken by Evidence Action staff), which pointed to a chlorine detection rate of 38%.

The comparison between the same estimates in Malawi and Uganda are consistent with these results  ([Table 1](#tab:discount)). In Malawi, the household survey estimate (XX%) represents 52% of that from Evidence Action monitoring (XX%). In Uganda, the household survey estimate (XX%) represents 58% of that from Evidence Action monitoring (YY%).

**We believe this to be the main driver of the differences observed between Columns 1 and 3 of [Table 1](#tab:discount).**
  
## Sampled water points

```{r}
wp_counts <-
  wp_census %>%
  dplyr::filter(
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    count = sum(promoter_surveyed),
    pct = (mean(promoter_surveyed) %>% round(3)) * 100
  )
```

IPA only interviewed promoters, while EvAc interviews any village member who is knowledgeable.

In Malawi, we identified `r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(N)` water points with DSW, and conducted surveys with the promoters responsible for `r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(count)` (`r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(pct)`%) of them. 

In Uganda, we identified `r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(N)` water points with DSW, and conducted surveys with the promoters responsible for `r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(count)` (`r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(pct)`%) of them. 

Therefore, the Evidence Action estimate is likely to be more representative. However, this would bias DIL's monitoring estimates upward, since promoters are likely better at identifying households using the water points as well as households that chlorinate the water than other households, and also have more incentives to prioritize the latter.

Taking all of these considerations into account, **the difference between water points included in DIL's Monitoring Survey and Evidence Action's Q3 Monitoring is unlikely to explain the difference in the resulting estimates, and any bias due to this factor should lead to a reduction in the difference between the two estimates.** 

## Timing

In both cases, promoters are only supposed to be contacted when the surveyors arrive at the village. However, EvAc's monitoring staff is only in the village for a day, while IPA teams were in the village for on average five, with the monitoring surveys taking place in the very last day.

There is some indication that households surveyed later are more likely to have chlorine detected. [Figure](#fig:timing) shows that, among households included in the Household Survey, those tested in the first day are less likely to have chlorine detected both in Malawi and in Uganda. However, this difference is only statistically significant in Uganda, and even so, only at the 90% confidence level (#tab:timing). Additionally, we do not observe the same in the Monitoring Survey [Figure](#fig:timing-mon).

**As a result, we do not believe this factor to be causing meaningful bias in our estimates. Even if they were, they would bias the estimates in the direction of reducing the difference between DIL and Evidence Action estimates.**

## Other factors
  
The following factors may be leading part of the differences, but we are not able to test for them:
- **Sampled villages**: We did not visit the same water points.
- **Time since training**: IPA surveyors were trained between a week and four months before the interviews took place, but we don't know the last time EvAc staff was retrained. 
- **State of the equipment**: Our equipment was procured for this data collection, and all of the reagents were new. We don't know about EvAc's. Discolored color wheel would bias estimates upward. Degraded DPD reagents would bias estimates downward.
- **Deviations from the randomization protocol**: during DIL's surveys, the randomization of households into the testing sample was recorded in the data, and we can observe whether a sampled households was replaced or not. In EvAc's, it is recorded in a piece of paper, leaving more room for enumerators to choose who they are surveying (e.g. households closer to the promoter's house, household indicated by the promoter). **We cannot test if this happens in the EvAc data, but we may be able to test for this in our data. Add distance to promoter household.**

# Protential explanations for differences between Household survey and Monitoring survey

Differences in Uganda are large, as shown in [Figure](#fig:hh-vs-mon). YY percentage points.

## Sample selection of water points

We had meant for the only difference between the water point and the monitoring surveys to be the methodology. However, we also observe that the water points included in both surveys are different, and **which water points are included in each survey explains a small part of the differences observed**.

```{r}
wp_cl_counts <-
  hh_survey %>%
  group_by(country, survey) %>%
  summarise(
    promoter_surveyed = round((1 - mean(promoter_surveyed, na.rm = TRUE)) * 100, 1),
    wps = n_distinct(wp_id)
  )
```

In **Malawi**, out of the `r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(N)` water points with DSW in our sample, `r wp_cl_counts %>% dplyr::filter(country == "Malawi", survey == "Household Survey") %>% pull(wps)` are represented in the Household Survey, and `r wp_cl_counts %>% dplyr::filter(country == "Malawi", survey == "Monitoring Survey") %>% pull(wps)` in the monitoring survey. However, only  `r wp_cl_counts %>% dplyr::filter(country == "Malawi", survey == "Household Survey") %>% pull(promoter_surveyed)`% of the households in the Household Survey sample are using water points not included in the promoter survey. 

In **Uganda**, out of the `r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(N)` water points with DSW in our sample, `r wp_cl_counts %>% dplyr::filter(country == "Uganda", survey == "Household Survey") %>% pull(wps)` are represented in the Household Survey, and `r wp_cl_counts %>% dplyr::filter(country == "Uganda", survey == "Monitoring Survey") %>% pull(wps)` in the monitoring survey. Additionally, `r wp_cl_counts %>% dplyr::filter(country == "Uganda", survey == "Household Survey") %>% pull(promoter_surveyed)`% of the households in the Household Survey sample are using water points not included in the promoter survey. 


[Figure](#fig:wp-selection) shows that households using water points not included in the promoter survey are less likely to have chlorine detected in both countries. Although this difference is large and significant ([Table](#tab:wp-selection)), the weight of theses households in the Househodl Survey estimates in Malawi is small enough that the differences between Household and Monitoring estimates are also small. In Uganda, on the other hand, since the proportion of households in the Household Census is almost three times that of Malawi, the difference between the two estimates are notable.

Nevertheless, as shown in [Figure](#fig:wp-promoter), this does not account for all of the difference between Household Survey and Monitoring Survey estimates in Uganda: even if we restrict the Household Survye sample to households using water points included in the promoter survey, there is still a difference of 12.8 percentage points in the chlorination rates.


```{r eval = FALSE}
hh_survey %>%
  dplyr::filter(
    !is.na(promoter_surveyed),
    survey == "Household Survey"
  ) %>%
  group_by(country, promoter_surveyed) %>%
  summarise(
    hhs = n_distinct(household_id),
    wps = n_distinct(wp_id)
  )
```

```{r}
hh_survey %>%
  dplyr::filter(
    !is.na(promoter_surveyed),
    survey == "Household Survey"
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    mean(promoter_surveyed)
  )
```

## Sample selection of households

```{r}
in_list <-
  hh_census %>%
  dplyr::filter(
    promoter_surveyed
  ) %>%
  pull(promoter_list) %>%
  mean(na.rm = TRUE) %>%
  round(3)
```

```{r}
self_report <-
  hh_census %>%
  dplyr::filter(
    promoter_surveyed,
    promoter_list
  ) %>%
  pull(dsw) %>%
  mean(na.rm = TRUE) %>%
  round(3)
```

```{r}
using_dsw <-
  hh_census %>%
  dplyr:::filter(promoter_list) %>%
  group_by(country) %>%
  summarise(
    hhs = n_distinct(household_id),
    dsw = mean(dsw, na.rm = TRUE) %>% round(3) * 100,
    multiple_wps = mean(wp_count_pastmonth > 1, na.rm = TRUE) %>% round(3) * 100
  )
```

```{r}
randomization_id %>%
  pull(pm_right) %>%
  mean(na.rm = TRUE) %>%
  round(3)
```

The list of people included in the promoter survey is different from the list of people who self report using the water points. Promoters are good at identifying households using water points with a dispenser: among the households listed by the promoters as using a water point with a dispenser that were also included in the household census, `r self_report * 100`% also self-reported using a water point with DSW as their primary water point, **and Y% said they were using the exact same water point that the promoter indicated**.

However, they are not good at identifying all of the users: among all households mapped in the household census who self-reported using the water points in the promoter survey as their primary source of drinking water, only `r in_list * 100`% are also included in the promoter list.

Some of the households identified by the promoter would not be included in the Household Survey, since the promoter (1) lists households that use the water point, whether as their primary water source or not, and (2) lists households that use the water point regardless of whether they live in the village or not.

In Malawi, out of the `r using_dsw %>% dplyr::filter(country == "Malawi") %>% pull(hhs)` households included in the promoter list who were identified in the household census, `r  %>% dplyr::filter(country == "Malawi") %>% pull(dsw)`% self-report using a water point with a dispenser as their primary source of drinking water, and `r  %>% dplyr::filter(country == "Malawi") %>% pull(multiple_wps)`% report using more than one water points to collect drinking water in the past month.

In Uganda, out of the `r using_dsw %>% dplyr::filter(country == "Uganda") %>% pull(hhs)` households included in the promoter list who were identified in the household census, `r  %>% dplyr::filter(country == "Uganda") %>% pull(dsw)`% self-report using a water point with a dispenser as their primary source of drinking water, and `r  %>% dplyr::filter(country == "Uganda") %>% pull(multiple_wps)`% report using more than one water points to collect drinking water in the past month.

- **Source of report:** self-report vs promoter report. 
  - They may only list people who are more socially connected to them (upward bias). **Test for this**
  
  
## Replacements

[Figure](#fig:inhh-replacement) compares the chlorine detection rates among households that were sampled for the Monitoring Survey and replaced because they had already been surveyed in the Household Survey and replacement households in the Monitoring Survey. These differences are not statistically significant [Table](#tab:inhh-replacement), but they are large in Uganda.

Note that households could be replaced for two reasons:
1. Because the had already been surveyed. Then households in the Monitoring Survey would have been surveyed later, and therefore could have higher chlorination rates.
2. Because they were not available when visited for the Monitoring Survey. This would happen if the households who are easier to find are also more likely to chlorinate or more likely to have collected water more recently.
  
- **Timing:** Because the monitoring surveys happened later and after surveying the promoters, there is higher potential for priming (upward bias). 
  - The ideal way to test for this would be to compare the same households surveyed in the household and the monitoring survey. However, given our protocol, there are too few such observations for the analysis to be meaningful.
  - **Can we test this in some other way?**

```{r}
matched %>%
  group_by(country, survey) %>%
  summarise(
    N = n(),
    hhs = n_distinct(household_id),
    within_N = sum(!is.na(inclusion)),
    within = mean(inclusion == "Within village boundaries", na.rm = TRUE)
  )
```

- **Village boundaries:** The household census only included people living inside village boundaries or within 200m of these boundaries, while the promoter survey included anyone using the water points, regardless of where they live. **This does not see to contribute to the differences we observe**.
  - Households living outside of the villages boundaries present lower chlorination rates in the Household Survey ([Table](#tab:boundaries-diff)). However, these households represent a higher proportion of households surveyed in the Household Survey than in the Monitoring Survey. There, if anything, this would bias estimates in the opposite direction than the one we observe.
  - The difference between estimates from the Household and the Monitoring Survey still persist if we restrict the comparison only to households living within village boundaries ([Table](#tab:boundaries-restric))

- **Replacements:**
  - do replaced households live closer to the water point?

- **Reference unit:** household vs water point 
  - **Think about this**

## SCRAP

```{r}
p_vals <-
  by_country %>% 
  map(
    ~ .x %>%
      dplyr::filter(
        (survey == "Household Survey" & replaced) |
          (survey == "Monitoring Survey" & !is.na(rank))
      )
  ) %>%
  map(
    ~ marginal_effects(
      .x,
      x = "survey",
      cluster = "wp_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ bind_cols(tidy(.), "N" = nobs(.))) %>%
  bind_rows(.id = "reg") %>%
  dplyr::filter(str_detect(term, "survey")) %>%
  mutate(p.value = p.value %>% round(3))
```


- **Timing and replacements:** 
  - [Figure 1](#fig:replacements) restricts the sample to households that were listed in both the household census and the promoter survey and randomly selected to be surveyed as part of the Monitoring Survey, comparing the chlorination rates among those surveyed earlier, as part of the Household Survey, and those that were surveyed later, as part of the Monitoring Survey.
  - None of the differences shown are statistically significant (the minimum p-value observed is `r p_vals %>% pull(p.value) %>% min`), but the difference for TCR in Uganda, in particular (of `r p_vals[p_vals$reg == "Uganda.TCR" , "estimate"] %>% round(3) * 100` percentage points), is equivalent to more than half of the difference between Household and Monitoring Survey estimates.
  - Our estimates cannot separate these effects from those of the difference in replacement protocol between the Household and Monitoring surveys. Note that timing could not explain the difference between our estimates and EvAc's, given the protocol.
  - Promoters were more active in Uganda villages, and more likely to talk to households after observing the presence of the field team, so we think this is pointed to priming over time. That said, in Malawi most of the replacements happened because households had already been surveyed in the Household Survey, while in Uganda around 40% of replacements happened because households weren't available

> Use household census to see how easy it is to find someone in the household






# Tables

## Table 1 - Adoption estimates from difference sources {#discount}

| Country  | (1) Census | (2) Promoter | (3) Evidence Action | (4) Discount (1/3) |
|----------|------------|--------------|---------------------|--------------------|
| Malawi   | 26.6%      | 30.8%        | 51%                 | 52%                |
| Uganda   | 30.1%      | 45.6%        | 52%                 | 58%                |


## Table 2 - Difference in chlorine detections rates in Household and Monitoring surveys  {#hh-vs-mon-tab}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = ., 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("surveyMonitoring Survey" = "Monitoring Survey"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table 3 - Comparison of households in Household and Monitoring surveys for Malawi {#balance-mw}

```{r}
matched %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    ),
  ) %>%
  dplyr::filter(country == "Malawi") %>%
  sumtable(
    vars = balance_vars,
    group = "survey",
    group.test = TRUE
  )
```

## Table 4 - Comparison of households in Household and Monitoring surveys for Malawi {#balance-ug}

```{r}
matched %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    ),
  ) %>%
  dplyr::filter(country == "Uganda") %>%
  sumtable(
    vars = balance_vars,
    group = "survey",
    group.test = TRUE
  )
```

> SELECTION ON WATER POINTS
> Check why functionality is 1 
> Investigate int_promoter variable

# Figures 

## Figure 1 - Chlorine detection rates in Household and Monitoring surveys {#hh-vs-mon}

```{r}
hh_vs_monitoring <-
  by_country %>%
  map(
    ~ averages(data = ., x = "survey", cluster = "village_id")
  ) %>%
  unlist(recursive = FALSE)

hh_vs_monitoring_tidy <-
  hh_vs_monitoring %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = str_remove_all(term, "survey"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

hh_vs_monitoring_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

## Figure - Chlorine detection rates among households sampled for Monitoring Survey {#replacement}

```{r}
mon_mw <-
  matched %>%
  dplyr::filter(
    country == "Malawi",
    survey == "Monitoring Survey",
    !is.na(rank)
  ) %>%
  pull(household_id) %>%
  n_distinct()

replaced_mw <-
  matched %>%
  dplyr::filter(
    country == "Malawi",
    survey == "Household Survey",
    replaced
  ) %>%
  pull(household_id) %>%
  n_distinct()

replaced_ug <-
  matched %>%
  dplyr::filter(
    country == "Uganda",
    survey == "Household Survey",
    replaced
  ) %>%
  pull(household_id) %>%
  n_distinct()

mon_ug <-
  matched %>%
  dplyr::filter(
    country == "Uganda",
    survey == "Monitoring Survey",
    !is.na(rank)
  ) %>%
  pull(household_id) %>%
  n_distinct()

replacement_mw <-
  matched %>%
  dplyr::filter(
    country == "Malawi",
    survey == "Monitoring Survey",
    !is.na(rank),
    replacement
  ) %>%
  pull(household_id) %>%
  n_distinct()

replacement_ug <-
  matched %>%
  dplyr::filter(
    country == "Uganda",
    survey == "Monitoring Survey",
    !is.na(rank),
    replacement
  ) %>%
  pull(household_id) %>%
  n_distinct()

randomized <-
  matched %>%
  dplyr::filter(
    survey == "Household Survey",
    replaced
  ) %>%
  averages( 
    data = .,
    x = "country", 
    cluster = "village_id"
  ) %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "test") %>%
  mutate(survey = "Household Survey")

monitoring <-
  matched %>%
  dplyr::filter(
    survey == "Monitoring Survey",
    !is.na(rank)
  ) %>%
  averages( 
    data = .,
    x = "country", 
    cluster = "village_id"
  ) %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "test")  %>%
  mutate(survey = "Monitoring Survey")

rank_tidy <-
  randomized %>%
  bind_rows(monitoring) %>%
  mutate(
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    ),
    term = str_remove_all(term, "country")
  )

rank_tidy  %>%
  ggplot(
    aes(
      x = survey,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = survey
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ term) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust = 0)
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = paste0(
      "Notes:\n",
      "1. In Malawi, the Monitoring Survey includes ", mon_mw, " households who were surveyed as part of the household census, ", replacement_mw, " of which are replacements. Of all the\n replacements,", replaced_mw, " happened because households had already being surveyed in the Household Survey.\n",
      "2. In Uganda, the Monitoring Survey includes ", mon_ug, " households, ", replacement_ug, " of which are replacements. Of all the\n replacements, ", replaced_ug, " happened because households had already being surveyed in the Household Survey."
    )
  )
```

# Descriptives

## Are promoters good at identifying households?

## How are households in the promoter list different from other households using DSW/ILC water points?


## Sample selection of water points

```{r}
matched %>% 
  dplyr::filter(survey == "Household Survey") %>%
  tabyl(country, promoter_surveyed)
```


This is definitely happening, and likely explain all of the difference.

However, this only explains the differences that we see in our HH and mon survey, not the differences between our surveys are EvAc's

## Figure - Sample selection of water points {#wp-selection}

```{r}
wp_selection <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% dplyr::filter(survey == "Household Survey"), 
      x = "promoter_surveyed", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

wp_selection_tidy <-
  wp_selection %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = 
      if_else(
        str_detect(term, "TRUE"),
        "In promoter survey",
        "Not in promoter survey"
      ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

wp_selection_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

## Figure - Comparison of chlorine detection rates among household using water points included in the promoter survey {#wp-promoter}

```{r}
hh_selection <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(
          promoter_surveyed,
        ), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

hh_selection_tidy <-
  hh_selection %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = str_remove_all(term, "survey"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

hh_selection_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```


<!-- ## Priming  -->

<!-- To test for priming, we consider households that were included in both surveys and tested twice.  -->

```{r eval = FALSE}
matched %>%
  group_by(household_id) %>%
  dplyr::filter(
    n_distinct(survey) > 1
  ) %>%
  lm(formula = disctcr_02 ~ 0 + survey) %>% 
  tidy(conf.int = TRUE) %>%
  mutate(
    term = str_remove_all(term, "survey"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

## Figure - Chlorine detection rates among replaced and replacement households {#fig:inhh-replacements}

```{r}
replacements <-
  by_country %>%
  map(
    ~ averages(
      data = .x, 
      x = "replacement_status", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

replacements_tidy <-
  replacements %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = str_remove_all(term, "replacement_status"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

replacements_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```


```{r}
matched %>%
  dplyr::filter(
    country == "Malawi"
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    group = "replacement_status",
    group.test = TRUE
  )
```

```{r}
matched %>%
  dplyr::filter(
    country == "Uganda"
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    group = "replacement_status",
    group.test = TRUE
  )
```


### What is everyone who was randomized into monitoring was surveyed?

Then the estimates are still pretty much the same as when it's just the monitoring 



this also points to no priming, I think.

## Sample selection of households

Promoters could be listing households that are more likely to be chlorinating.

to-do: how often does the promoter get it right?

```{r}
hh_selection <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(
          promoter_surveyed
        ), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

hh_selection_tidy <-
  hh_selection %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = if_else(
      str_detect(term, "TRUE"),
      "In promoter list",
      "Not in promoter list"
    ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )
```

```{r}
hh_selection <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(
          survey == "Household Survey",
          promoter_surveyed
        ), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

hh_selection_tidy <-
  hh_selection %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = if_else(
      str_detect(term, "TRUE"),
      "In promoter list",
      "Not in promoter list"
    ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

hh_selection_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

This doesn't seem to be super relevant. It seems to be more of a factor in Malawi.
And would be less important for the EA regular monitoring, since they also survey non-promoters for the list of users

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(
          survey == "Household Survey",
          promoter_surveyed
        ), 
      x = "promoter_list",
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("promoter_surveyedTRUE" = "In promoter survey"),
    notes = "Standard errors are clustered at the village level."
  )
```


## Source of information

```{r}
hh_census %>%
  dplyr:::filter(
    in_pm_list
  ) %>%
  group_by(country) %>%
  summarise(mean(promoter_right, na.rm = TRUE))
```

## Figure - Chlorine detection rates by timing of survey {#fig:timing}

```{r}
hh_date <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% dplyr::filter(survey == "Household Survey"), 
      x = "not_first_day", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

hh_date_tidy <-
  hh_date %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = factor(
      term,
      levels = c("not_first_dayFALSE", "not_first_dayTRUE"),
      labels = c("Surveyed in the first day", "Surveyed after the first day"),
      ordered = TRUE
    ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

hh_date_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

## Figure - Chlorine detection rates by timing of survey {#timing-mon}

```{r}
hh_date <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% dplyr::filter(survey == "Monitoring Survey"), 
      x = "not_first_day", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

hh_date_tidy <-
  hh_date %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = factor(
      term,
      levels = c("not_first_dayFALSE", "not_first_dayTRUE"),
      labels = c("Surveyed in the first day", "Surveyed after the first day"),
      ordered = TRUE
    ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

hh_date_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

## Figure - Chlorine detection rates by contact with promoter

```{r}
pm_interference <-
  by_country %>%
  map(
    ~ averages(
      data = .x %>% dplyr::filter(survey == "Household Survey"), 
      x = "int_promoter", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE)

pm_interference_tidy <-
  pm_interference %>% 
  map(
    ~ tidy(., conf.int = TRUE)
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    term = 
      if_else(
        str_detect(term, "TRUE"),
        "Informed by promoter",
        "Not informed by promoter"
      ),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )

pm_interference_tidy  %>%
  ggplot(
    aes(
      x = term,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(test ~ country) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL
  )
```

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(
          survey == "Household Survey"
        ), 
      x = "int_promoter",
      cluster = "wp_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("int_promoterTRUE" = "Informed by promoter"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table - Differences in TCR {#discount}

| Country  | (1) Census | (2) Promoter | (3) Diff |
|----------|------------|--------------|----------|
| Malawi   | 26.6%      | 30.8%        | 4.2 pp   |
| Restricted to water points in the promoter survey | 30.8% | 31% | 0.2 pp |
| Uganda   | 30.1%      | 45.6%        | 15.5 pp  |
| Restricted to water points in the promoter survey | 33.8% | 46.6% | 12.8pp |




## Table - Comparison of chlorine detection rates between replaced and replacement households {#tab:inhh-replacement}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x, 
      x = "replacement_status", 
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("replacement_statusReplacement" = "Replacement household"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table - Comparison of chlorination rates among households using water points included the promoter survey {#wp-selection-tab}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(promoter_surveyed), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("surveyMonitoring Survey" = "Monitoring Survey"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table - Comparison of chlorination rates among households using water points included and not included in the promoter survey {#wp-selection-tab}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "promoter_surveyed", 
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("promoter_surveyedTRUE" = "In promoter survey"),
    notes = "Standard errors are clustered at the village level."
  )
```


## Table - Comparision of chlorine detection rates in the Household Survey between households living inside and outside of village boundaries {#boundaries-diff}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(
          survey == "Household Survey"
        ), 
      x = "inclusion",
      cluster = "wp_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("inclusionUp to 200m outside of village boundaries" = "Up to 200m outside of village boundaries	"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table - Comparision of chlorine detection rates by survey among households living within village boundaries {#boundaries-restrict}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(
          inclusion == "Within village boundaries"
        ), 
      x = "survey",
      cluster = "wp_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("surveyMonitoring Survey" = "Monitoring Survey"),
    notes = "Standard errors are clustered at the village level."
  )
```

## Table - Comparison of households using water points included in the promoter survey in Household and Monitoring surveys for Malawi {#balance-mw-pm}

```{r}
matched %>%
  dplyr::filter(
    country == "Malawi",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    group = "survey",
    group.test = TRUE
  )
```

## Table - Comparison of households using water points included in the promoter survey {#balance-ug-pm}

```{r}
matched %>%
  dplyr::filter(
    country == "Uganda",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    group = "survey",
    group.test = TRUE
  )
```

## Table - Comparison of households using water points included in the promoter survey in Household and Monitoring surveys for Malawi {#balance-mw-pm}

```{r eval = FALSE}
hh_census %>%
  dplyr::filter(
    country == "Malawi",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = c(
      "visit_outcome",
      "response"               "inclusion"             
 [15] "hhh_resp"               "hhh_gender"            
 [17] "hhh_age"                "hhh_educ"              
 [19] "hh_hhsincompound"       "hh_members"            
 [21] "hh_adults"              "hh_males"              
 [23] "hh_females"             "any_children"          
 [25] "hh_pregnant"            "hh_under5n"            
 [27] "hh_under5yn"            "hh_under2n"            
 [29] "hh_under2yn"
      "wp_source"             
 [31] "wp_freq"                "wp_sec_notworking"     
 [33] "wp_sec_inadequate"      "wp_sec_intermitent"    
 [35] "wp_sec_notfixed"        "wp_sec_crowded"        
 [37] "wp_sec_other"           "wp_sec_specify"        
 [39] "wp_secweek"             "wp_secweekno"          
 [41] "wp_count_pastmonth"     "vil_dsw_selfreport" 
      "promoter_list_mentions"
      "wp_func"
      "wp_turbidity"  
      "wp_dist"               
[105] "nearest_dist"           "evac_dist" 
      "wp_turbidity"           "wp_pay"                
 [79] "wp_disp_func"           "wp_disp_filled"        
 [81] "wp_dsw_dose"            "wp_meterfcr"           
 [83] "wp_metertcr"            "wp_discfcr"            
 [85] "wp_disctcr"             "wp_meterfcr_un"        
 [87] "wp_metertcr_un"         "wp_discfcr_un"         
 [89] "wp_disctcr_un"          "wp_meterfcr_01"        
 [91] "wp_metertcr_01"         "wp_meterfcr_un_01"     
 [93] "wp_metertcr_un_01"      "wp_meterfcr_02"        
 [95] "wp_metertcr_02"         "wp_discfcr_02"         
 [97] "wp_disctcr_02"          "wp_meterfcr_un_02"     
 [99] "wp_metertcr_un_02"      "wp_discfcr_un_02"      
[101] "wp_disctcr_un_02" 
    ),
    group = "survey",
    group.test = TRUE
  )
```

## Table - Comparison of households using water points included in the promoter survey {#balance-ug-pm}

```{r}
matched %>%
  dplyr::filter(
    country == "Uganda",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    group = "survey",
    group.test = TRUE
  )
```

## Table - Comparision of chlorine detection rates in the Household Survey between households living inside and outside of village boundaries {#timing-tab}

```{r}
by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(
          survey == "Household Survey"
        ), 
      x = "not_first_day",
      cluster = "village_id"
    )
  ) %>%
  modelsummary(
    stars = TRUE,
    shape = "cbind",
    gof_map = c("nobs", "r.squared", "adj.r.squared"),
    coef_rename = c("not_first_dayTRUE" = "Household surveyed after the first day"),
    notes = "Standard errors are clustered at the village level."
  )
```