---
output: rmdformats::robobook
title: "Comparison of chlorine adoption estimates"
---


```{r}
pacman::p_load(
  tidyverse,
  broom,
  broom.helpers,
  fixest,
  estimatr,
  stargazer,
  modelsummary,
  kableExtra,
  sf, 
  vtable,
  janitor,
  ggtext
)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
```

```{r, echo=FALSE, results='asis'}
cat('<style>
/* Target the tinytable container */
.container:has(table.table-borderless) {
  display: flex !important;
  justify-content: center !important;
  width: 100% !important;
  overflow-x: auto !important;
}

/* Ensure the table itself scales properly */
table.table-borderless {
  width: auto !important;
  margin: 0 auto !important;
  font-size: 1em !important;  /* Changed from 0.85em to 1em (normal size) */
}

/* Make sure table cells have adequate padding */
.table-borderless td, .table-borderless th {
  white-space: nowrap !important;
}
</style>')
```
# To-dos

- the small difference between TCR and FCR in Evidence Action data points to people haing chlorinated recently
- bring weights from main analysis so that numbers become the same

```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry  %>%
  mutate(
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    closer = (ilc_wcp & str_detect(ea_id, "001^")) | ilc_wp
  )
```

```{r}
promoter_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  ) %>%
  select(-village_id)
```

```{r}
hh_census_all <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  mutate(
    hhh_fem = hhh_gender == "Female",
    hhh_primary_educ = !(hhh_educ %in% c("No formal education / Never attended school", "None", "Pre-primary", "Some Primary School (Did not complete Standard 8)")),
    inclusionyn = str_detect(inclusion, "Within"),
    wp_source = wp_source == "From a water point in this village",
    any_rank = household_id %in% (promoter_survey %>% dplyr::filter(!is.na(rank)) %>% pull(household_id))
  )

hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  select(
    household_id,
    inclusion,
    #visit,
    dsw,
    country,
    wp_count_pastmonth
  )

```


```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  group_by(village_id, survey) %>%
  mutate(not_first_day = date > min(date)) %>%
  group_by(household_id, survey) %>%
  mutate(
    intervention_selfreport = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC"
    ),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    resp_fem = resp_sex == "Female",
    resp_primary_educ = resp_educ >= "Primary",
    hhh_fem = hhh_sex == "Female",
    hhh_primary_educ = !(hhh_educ %in% c("No formal education / Never attended school", "None", "Pre-primary", "Some Primary School (Did not complete Standard 8)")),
    collect_primary = where_collect == "From the water point primary water point (${wp_name_pl})",
    waterprep_12minus = howlong_waterprep == "Less than 12 hrs ago [today]",
    collect_child = str_detect(who_collected, "18"),
    collect_resp = who_collected == "The respondent",
    across(
      c(hh_pregnant, hh_under2, hh_under5),
      ~ . > 0
    ),
    promoter_list = household_id %in% promoter_survey$household_id,
    rank_u5 = household_id %in% (promoter_survey %>% dplyr::filter(rank <= 4) %>% pull(household_id)),
    any_rank = household_id %in% (promoter_survey %>% dplyr::filter(!is.na(rank)) %>% pull(household_id)),
    in_monitoring = any(survey == "Monitoring Survey"),
    in_household = any(survey == "Household Survey")
  ) %>%
  left_join(hh_census) %>%
  dplyr::filter(
    !(survey == "Household Survey" & wp_intervention != "DSW"),
    wp_intervention != "ILC",
    sample_group != "ILC"
  )
```

```{r}

matched <- 
  hh_survey %>%
  left_join(
    promoter_survey,
    by = "household_id",
    relationship = "many-to-many"
  ) %>%
  left_join(
    hh_census %>% 
      select(
        household_id, 
        inclusion
      ),
    by = "household_id",
    relationship = "many-to-many"
  ) %>%
  left_join(
    wp_census %>%
      transmute(
        wp_pm = wp_id, 
        wp_pm_intervention = intervention
      )
  ) %>%
  group_by(wp_pm) %>%
  mutate(max_rank = max(rank, na.rm = TRUE)) %>%
  group_by(village_id, survey) %>%
  mutate(not_first_day = date > min(date)) %>%
  group_by(household_id) %>%
  mutate(
    in_monitoring = any(survey == "Monitoring Survey"),
    in_household = any(survey == "Household Survey")
  ) %>%
  ungroup %>%
  mutate(
    program = case_when(
      survey == "Household Survey" ~ wp_intervention,
      survey == "Monitoring Survey" ~ wp_pm_intervention
    ),
    rank = as.numeric(rank),
    replacement = rank > 4,
    replaced = rank < max_rank,
    replacement_status = case_when(
      replaced & !in_monitoring & survey == "Household Survey" ~  "Replaced",
      replacement & survey == "Monitoring Survey" ~  "Replacement",
    ),
    promoter_right = wp_pm == wp_id,
    across(
      c(hh_pregnant, hh_under2, hh_under5),
      ~ . > 0
    )
  ) 

by_country <-
  matched %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda"))

averages <- function(data, x, cluster) {
  c("disctcr_02") %>%
    map(
      ~ feols(
        paste(., "~ 0 +", x) %>% as.formula,
        cluster = paste("~ ", cluster),
        data = data
      )
    ) 
}

marginal_effects <- function(data, x, cluster) {
  c("disctcr_02") %>%
    map(
      ~ feols(
        paste(., "~", x) %>% as.formula,
        cluster = paste("~ ", cluster),
        data = data
      )
    ) 
}
```

```{r}
balance_vars <-
  c(
    # "resp_age",
    # "resp_fem",
    # "resp_primary_educ",
    "Age of household head (years)" = "hhh_age", 
    "Household head is a woman" = "hhh_fem", 
    "Household head completed primary education" = "hhh_primary_educ",
    "Number of household members" = "hh_members", 
    "At least one household member is pregnant" = "hh_pregnant", 
    "At least one household member is under 2 yo" = "hh_under2",
    "At least one household member is under 2 yo" = "hh_under5",
    "Inclusion criterion" = "inclusion",
    "Distance to primary source of drinkig water (m)" = "wp_dist", 
    "Distance to nearest water point with DSW (m)" = "evac_dist",
    #"pm_dist",
    "Household pays to use the primary source of drinking water" = "wp_pay",
    #"wp_func", 
    "Dispenser was filled" = "wp_dsw_chlorine", 
    "Dispenser had TCR > 0.2 ppm" = "wp_disctcr_02", 
    "Dispenser had FCR > 0.2 ppm" = "wp_discfcr_02",
    "Water for children is prepared differently" = "prep_different", 
    "Water was prepared less than 12h before testing" = "waterprep_12minus", 
    "Water tested was combined with old or untreated water" = "mix", 
    "Tested water was collected from primary water source" = "collect_primary", 
    "Tested water was collected by the respondent" = "collect_resp", 
    "Tested water was collected by a child" = "collect_child",
    "Household was aware of upcoming data collection" = "int_warned", 
    "Promoter informed the household of upcoming data collection" = "int_promoter"
  )
```


```{r}
balance_vars_census <-
  c(
    "Age of household head (years)" = "hhh_age", 
    "Household head is a woman" = "hhh_fem", 
    "Household head completed primary education" = "hhh_primary_educ",
    "Number of household members" = "hh_members", 
    "At least one household member is pregnant" = "hh_pregnant", 
    "At least one household member is under 2 yo" = "hh_under2yn",
    "At least one household member is under 2 yo" = "hh_under5yn",
    "Within village boundaries" = "inclusionyn",
    "Distance to primary source of drinkig water (m)" = "wp_dist", 
    "Distance to nearest water point with DSW (m)" = "evac_dist",
    #"pm_dist",
    "Primary source of drinking water within village boundaries" = "wp_source",
    "Uses more than one water source for drinking water" = "wp_secweek",
    "Number of water sources used in the past month" = "wp_count_pastmonth",
    "Household pays to use the primary source of drinking water" = "wp_pay",
    "Primary water point is functional" = "wp_func", 
    "Dispenser was filled" = "wp_disp_filled", 
    "Dispenser had TCR > 0.2 ppm" = "wp_disctcr_02", 
    "Dispenser had FCR > 0.2 ppm" = "wp_discfcr_02",
    "Number of promoter lists mentioned" = "promoter_list_mentions"
  )
```

This Section compares adoption estimates calculated using different methodologies and discusses potential reasons for the differences between them. This is an exploratory analysis of a descriptive nature meant to compare how likely different hypotheses are to explains the differences. It relies on comparisons of different subsamples that are often small in size. Although it is helpful in discarding some hypotheses, it cannot conclusively point to the causes behind the different estiamtes. 

[Table 1](#tab:discount) compares the TCR detection rates as estimated based on the Household Survey and the Monitoring survey. It also includes the estimates from Evidence Action's Adoption Monitoring for the same period, as well as for the Simultaneous Census and Monitoring exercise conducted by Evidence Action in Kenya in 2024. [Figure 1](#fig:hh-vs-mon) includes confidence intervals for the Household and Monitoring Survey estimates.

Evidence Action's Q3 monitoring estimates are roughly twice as high as DIL's Household Survey estimates (our preferred method). Section 1 discusses some hypotheses that may explain this difference. However, we lack the data to adequately test them. Based on the fact that our Household Survey estimates are equivalent to 52% and 58% of Q3 Monitoring estimates, a proportion consistent with the SCM that relying on measurements taken by independent surveyors results in chlorination rates that represented 55% of those calculated based on estimates by Evidence Action staff, we believe that a combination of sampling variation and surveyor incentives are the most likely explanation for these differences.

The estimates from both DIL surveys are not statistically different in Malawi. This indicates that, although a few different factors may bias estimates obtained under the Monitoring methodology, a full census of the villages served may not be necessary to obtain reliable estimates of adoption. In Uganda, on the other hand, the estimates are significantly different. Section 2 discusses the different potential sources of bias. We believe a combination of sample selection, timing of surveys, and interactions with promoters are leading Monitoring estimates to be biasing Monitoring Survey estimates up in Uganda.

- In 2024, Evidence Action conducted a new data collection in Kenya to estimate and compare chlorination rates obtained following the same methods as KSWTCS and and those obtained by following their regular Adoption Monitoring strategy in the same set of villages. They found that
  - Chlorine adoption estimates based on their Adoption Monitoring methodology (36%) were around twice as high as those obtained following the same methods as KSWTCS (16%)
  - When sampling the same households, independent surveyors found a chlorination rate of 21%, while Evidence Action staff found a chlorination rate of 38%
  - Chlorine adoption estimates from the regular monitoring activities, outside of this data collection exercise, were around three times as high, at 44%

## delete

  - **Comparing census estimates with Evidence Action's regular adoption monitoring estimates for the same period, our findings are roughly consistent with those from the exercise conducted in Kenya**: the Household Survey estimates represent 52-58% of those from Evidence Action's Adoption Monitoring for the third quarter of 2025.
  
  <!-- - **Based on field observations of DSW use, we believe the lower numbers are more likely to be correct**. We asked field teams to observe the people using the water points while they were collecting data. Field teams remained around water points with filled dispensers for about an hour to conduct all the necessary testing -->
  <!--   - In Malawi, the they observed people using 163 water points with dispensers, but only observed anyone using the dispenser in 14 of them -->
  <!--   - In Uganda, they observed people using 155 water points with dispensers, but only observed people using the dispenser in 21 of them -->
    
Within DIL's data, estimates from the Monitoring Survey are higher than those from the Household Survey in Uganda, but not in Malawi ([Figure 1](#fig:hh-vs-mon), [Table 2](#tab:hh-vs-mon-tab))

  - This is consistent with the fact that households included in the two surveys are comparable in Malawi ([Table 3](#tab:balance-mw)), but not in Uganda ([Table 4](#tab:balance-ug))
  - In Uganda, households included in the Monitoring Survey are more likely to pay to use their primary water point, and twice as likely to have been warned by the promoter about the upcoming survey than those in the Household Survey.
    
The remainder of this document explores the differences between the estimates from the Household Survey and the Monitoring Survey, indicating when these differences could also explain differences between the Household Survey and Evidence Action's Q3 Monitoring estimates.

  - It is not selection on water points: Households using water points included in the promoter survey have higher chlorination rates (Figure 3). However, if we compare the monitoring estimates to household survey estimates among households using the same water points, the difference between the two surveys is large (Figure 4)
  - It is not selection into the household list by promoters: Apart from using the same water points, they'd need to be listed by the promoter. In the household survey, households using the water points listed by the promoter have the same chlorination rates as those that don't (Table 6, Figure 5). 
  - Is it because these households are being replaced?
  - Is it because households that are easier to find are more likely to chlorinate?
  
  - We believe differences are due to sample selection of water points and households being warned by promoters of the future surveys.
  - Annecdotal evidence points to more interference from Evidence Action in Uganda

# 1 Potential explanations of differences between DIL and Evidence Action estimates

## 1.1 Surveyors' independence

A key methodological difference between DIL and Evidence Action protocols is that the data used for **DIL's estimates was collected by independent enumerators hired by IPA, while Evidence Action relies on their own local staff**. This means surveyors and promoters may be responding to different incentives. 

  - Evidence Action surveyors may have existing relationships with the promoter or with the implementation teams, wishing to portray them in a positive light
  - Promoters were chosen by their communities to be the point of contact with Evidence Action, and therefore may seek to maintain a positive relationship with Evidence Action
  - Evidence Action staff may have an interest in the continuation of the program, which in turn depends on it having positive results
 
 
All of these factors would create potential incentives for surveyors and promoters to seek outcomes favorable to program success, which **we would expect to bias Evidence Action estimates upward relative to independent surveys**.

  - **Empirical evidence from Kenya supports this hypothesis**: when Evidence Action examined identical households using both measurement approaches, the independent household survey found that 21% of households tested positive for chlorine residual, while the Evidence Action monitoring survey reported 38%. This means the independent survey estimate represented only 55% of the Evidence Action figure.
  - **Results from the DIL exercise in Malawi and Uganda are also consistent with this hypothesis** ([Table 1](#tab:discount)). In Malawi, the independent household survey estimate (26.6%) represents 52% of the Evidence Action monitoring figure (51%). Similarly, in Uganda, the independent estimate (30.1%) represents 58% of the Evidence Action monitoring result (52%).

## 1.2 Represented water points

```{r}
wp_counts <-
  wp_census %>%
  dplyr::filter(
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    count = sum(promoter_surveyed),
    pct = (mean(promoter_surveyed) %>% round(3)) * 100
  )
```

The water points included in Evidence Action's Adoption Monitoring Survey and the DIL Monitoring Survey estimates are also systematically different, due to who provided the list of users from which tested households were sampled. 

  - **DIL's protocol determined that only promoters who work with Evidence Action to refill dispensers, maintain them, and promote chlorine adoption in the village could provide a list of water point users**. When Evidence Action did not provide the contact information for a promoter or one could not be identified by asking villagers, no list of users was obtained and no households were included in the Monitoring Survey for that water point.
  - **Evidence Action, on the other hand, surveys any village member who is knowlegdeable about a water point when the promoter cannot be found**.
  - This difference in sampling strategy has implications for representativeness of DIL's Monitoring Survey and may bias estimates.
  
<!-- The coverage of water points included in DIL's Monitoring Surveys varied by country.  -->

<!--   - In Malawi, `r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(pct)`% (`r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(count)`) of the `r wp_counts %>% dplyr::filter(country == "Malawi") %>% pull(N)` water points with with DSW identified in sampled villages are represented. -->
<!--   - In Uganda, `r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(pct)`% (`r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(count)`) of the `r wp_counts %>% dplyr::filter(country == "Uganda") %>% pull(N)` water points with DSW identified are included in the Monitoring Survey. -->
  
This difference should bias DIL estimates upward, thereby reducing rather than explaining the observed gap between the two surveys.

  - Evidence Action's broader respondent pool likely produces more representative estimates of overall program reach. 
  - However, DIL's promoter-focused approach would be expected to introduce upward bias into monitoring estimates. Promoters are better positioned than typical village members to identify both households using the water points and households that chlorinate their water, and they may also be more motivated to prioritize these successfully adopting households when selecting survey respondents.
  - Given that DIL's adoption estimates in the Monitoring Survey are lower than those in Evidence Action's Q3 Monitoring, and that in Malawi, where it is more representative, the Monitoring Survey estimates are closer to the Household Survey's, **the difference in water point representativeness is unlikely to explain the overall divergence in estimates**. 

## 1.3 Survey timing and duration

Both DIL and Evidence Action protocols stipulate that promoters should only be contacted upon surveyors' arrival in the village. However, the surveys differed substantially in duration: Evidence Action monitoring staff spent only one day in each village, while IPA teams remained for an average of five days, conducting monitoring surveys on the final day.

**The extended presence of IPA field teams may bias chlorine adoption estimates in the Household and Monitoring Surveys upward**, as promoters have the opportunity to refill dispensers and remind households to add chlorine to their drinking water.

  - [Figure 2](#fig:timing) indicates that among households included in the Household Survey, those tested on the first day were show a higher rate of TCR detection both in Malawi and in Uganda.
  - However, **there limited statistical support for this hypothesis**, as the difference is significant only in Uganda, and only at the 90% confidence level. 
  - This pattern does not observed in the Monitoring Survey, but this may be explained by the fact that there were fewer interviews to be made, and therefore this activity may not have been extended for as many days.

## 1.4 Other factors
  
The following factors may be leading part of the differences, but we are not able to test for them:

- **Sampled villages**: IPA and Evidence Action did not visit the same water points, and sampling variation may explain part of the difference.
- **Time since training**: IPA surveyors were trained between a week and four months before the interviews took place, but we don't know the last time Evidence Action staff was retrained. This would introduce noise into the measurement, but it is unclear whether it was bias estimates.
- **State of the equipment**: The equipment used during the Household and Monitoring Surveys was procured for this data collection, and all of the reagents were new. We do not have data about how long the equipment used by Evidence Action has been in use, or when reagents were procured. The direction of the bias introduced by this in unclear. For example, discolored color wheels would bias estimates upward, while degraded DPD reagents would bias estimates downward.
- **Deviations from the randomization protocol**: during the Household and Monitoring surveys, the randomization of households into the testing sample was recorded in the data, and we can observe whether a sampled households was replaced or not. In Evidence Action's, it is recorded in a piece of paper, leaving more room for enumerators to choose who they are surveying (e.g. households closer to the promoter's house, household indicated by the promoter). 

# 2 Potential explanations for differences between Household survey and Monitoring survey

This Section discusses potential explanations for the differences in the estimates shown in [Figure 2](#fig:hh-vs-mon). [Figure 3](#fig:decomposition) presents TCR detection rates in different subsamples of the households tested during the Household Survey in an attempt to decompose the sources of the differences.

As expected given the similarities between estimates from the Moniotoring and the Household Survey in Malawi, there is no meaningful variation across subsamples in this country. In Uganda, although the estimates in [Figure 2](#fig:hh-vs-mon) are significantly different and the point estimates in the Household Survey subsamples become more similar to those from the Monitoring Survey as we apply similar sample selection criteria, there is considerable noise in the estimates across subsamples, and they are not significantly different from one another. As such, the discussion in this Section is inconclusive.

## 2.1 Sample selection of water points

When designing the survey protocols, we intended for both the Household Survey and the Monitoring Survey to be representative of all DSW water points in sampled villages. However, as discussed in Section 1.2, the field team was not able to identify promoters for all of the water points found, meaning that the water points covered by the Monitoring Survey are may be systematically different from and less representative than those in the Household Survey. 

Tables [2](#tab:wp-balance-mw) and [3](#tab:wp-balance-ug) compares the characteristics of the water for which promoter were surveyed and those for which no promoter was found in Malawi and Uganda, respectively. Promoter surveys were conducted in `r round(11500/136, 1)`% of the water points with 136 DSW identified in Malawi, and in `r round(11600/185, 1)`% of the 185 water points in Uganda. In both countries, an F-test for joint orthogonality indicates that the water points left out of the promoter survey are not significantly different from those covered, however, there are imbalance in individual characteristics, particularly those linked to functionality of the dispensers.

```{r}
wp_cl_counts <-
  hh_survey %>%
  group_by(country, survey) %>%
  summarise(
    promoter_surveyed = round((1 - mean(promoter_surveyed, na.rm = TRUE)) * 100, 1),
    wps = n_distinct(wp_id)
  )
```
The difference in water point characteristics could be translated into households included in the Monitoring Survey having more access to chlorine than those in the Household Survey. In fact, [Figure 4](#fig:wp-selection) shows that TCR detection rates are significantly higher among households using water points covered by the promoter survey.

Although this difference is large and significant, the weight of theses households in the Household Survey estimates in Malawi is small (only `r wp_cl_counts %>% dplyr::filter(country == "Malawi", survey == "Household Survey") %>% pull(promoter_surveyed)`% of the households in the Household Survey sample are using water points not included in the promoter survey), and so are the differences between Household and Monitoring estimates. 

In Uganda, on the other hand, only `r wp_cl_counts %>% dplyr::filter(country == "Uganda", survey == "Household Survey") %>% pull(promoter_surveyed)`% of the households in the Household Survey sample are using water points included in the promoter survey. This also noticeable in the reduction in sample size between columns (1) and (2) in [Figure 3](#fig:decomposition). Nonetheless, restricting the Household Survey sample to households using water points included in the promoter survey does not increase the TCR detection rate by much.


## 2.2 Sample selection of households


```{r}
notlisted <-
  hh_census_all %>%
  dplyr:::filter(
    sample_group != "ILC",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  group_by(country) %>%
  summarise(
    hhs = n_distinct(household_id),
    listed = mean(promoter_list, na.rm = TRUE) %>% round(3) * 100
  )
```

```{r}
using_dsw <-
  hh_census_all %>%
  dplyr:::filter(promoter_list) %>%
  group_by(country) %>%
  summarise(
    hhs = n_distinct(household_id),
    dsw = mean(dsw, na.rm = TRUE) %>% round(3) * 100,
    multiple_wps = mean(wp_count_pastmonth > 1, na.rm = TRUE) %>% round(3) * 100
  )
```

The list of households using the water points provided by the promoter is another potential source of difference. Promoters are expected to be less knowledgeable than households about household's water point usage, and they also respond to incentives.

- Promoters reduced knowledge would introduce noise into the data. For example, in some cases promoters relied on lists of water point users that were recorded in previous years, dating back as far as of dispenser installation. 
- If a households uses more than one water point, promoters may not know whether a water point is a household's primary source of drinking water or not, and including households whose primary source does not have DSW would bias estimates down.
- If the promoter wishes to indicate that a water point is widely used and therefore should keep being treated, the list could also include households whose primary source does not have DSW.
- If, on the other hand, the promoter remembers mostly people with whom they have a closer relationship, or to whom they talked about chlorination recently, the list could lead to an overestimation of chlorination rates.
- If the promoter expects surveyors to talk to the households listed and wishes to show that they have been doing a good job, the list will more likely include households that the promoter know use chlorine, and therefore bias estimates up.
- Finally, promoters would be expected to listt all households using the water point, regardless of where they live, while the household survey limits its sample to hosueholds living within or up to 200m outside of village boundaries.

The data shows that **Promoters are good at identifying households using water points with a dispenser**. In Malawi, out of the `r using_dsw %>% dplyr::filter(country == "Malawi") %>% pull(hhs)` households included in the promoter list who were identified in the household census, `r using_dsw %>% dplyr::filter(country == "Malawi") %>% pull(dsw)`% self-report using a water point with a dispenser as their primary source of drinking water. In Uganda, out of the `r using_dsw %>% dplyr::filter(country == "Uganda") %>% pull(hhs)` households included in the promoter list who were identified in the household census, `r  using_dsw %>% dplyr::filter(country == "Uganda") %>% pull(dsw)`% self-report using a water point with a dispenser as their primary source of drinking water

**However, they are not as good at identifying all of the users**: among all households mapped in the household census who self-reported using the water points in the promoter survey as their primary source of drinking water in Malawi, `r notlisted %>% dplyr::filter(country == "Malawi") %>% pull(listed)`% are included in the promoter list, while in Uganda, only `r notlisted %>% dplyr::filter(country == "Uganda") %>% pull(listed)`% are.

As a result, among the households that self-report using water points included in the promoter survey as their primary source of drinking water, those who are included in the promoter list are significatly different from those that aren't in both countries (Tables [4](#tab:hh-selection-mw) and [5](#tab:hh-selection-ug), including with regard to having more access to chlorine. However, when we further restrict the sample to households included in the household survey, these differences are not jointly significant, which is consistent with the results in Figures [3](#fig:decomposition) and [5](#fig:promoter-list). [Figure 3](#fig:decomposition) shows that restricting the Household Survey sample to households included in the pormoter list does not lead to different estimates of adoption, and [Figure 5](#fig:promoter-list) confirms this finding by showing that TCR detection is similar among households included and excluded from the list.

**Although this does not point to differences between the Household Survey and Monitoring estimates, the fact that in the household census they are difference indicates that inclusion in the promoter list does play a factor and may explain EVac differinces**

## 2.3 Interactions with the promoter

- The analysis so far points to inclusion criteria into the mointoring survey not being relevant sources of differences.
- however, we know from Fgure 1 that there are differences in Uganda.
- therefore, these differences must be coming not from the eigibility to be included but from something observed among households actually included
- in figure 2, we see that households randomized into the survey have a higher detection rate. but this is a small sample and the difference is not statistically different from the previous ones

- nonetheless, a comparison of the listed households that were and were not randomly sampled shows that 
- comparing households' characteristics, we see that more househorlds that were sampled say that they were aware of the upcoming data collection, and that it was the promoter who told them about it.
- The same pattern emerges when we compare household survey and monitoring survey househorlds.
- in both cases, the households are not signigicatly different overall, so this is not conclusive. 
- however, we also see that in [Figure 6](#fig:int) household interacting with the promoter are more likely to chlorinate

- the noise comes from the fact that we only added this variable after we saw this happening in Uganda, but annecdotal evidence point to it beiung a factor


## 2.4 Other factors

[Figure](#fig:inhh-replacement) compares the chlorine detection rates among households that were sampled for the Monitoring Survey and replaced because they had already been surveyed in the Household Survey and replacement households in the Monitoring Survey. These differences are not statistically significant [Table](#tab:inhh-replacement), but they are large in Uganda.

Note that households could be replaced for two reasons:
1. Because the had already been surveyed. Then households in the Monitoring Survey would have been surveyed later, and therefore could have higher chlorination rates.
2. Because they were not available when visited for the Monitoring Survey. This would happen if the households who are easier to find are also more likely to chlorinate or more likely to have collected water more recently.
  
- **Timing:** Because the monitoring surveys happened later and after surveying the promoters, there is higher potential for priming (upward bias). 
  - The ideal way to test for this would be to compare the same households surveyed in the household and the monitoring survey. However, given our protocol, there are too few such observations for the analysis to be meaningful.
  - But we see this in [Figure ](#fig:timing)

- **Village boundaries:** The household census only included people living inside village boundaries or within 200m of these boundaries, while the promoter survey included anyone using the water points, regardless of where they live. **This does not see to contribute to the differences we observe**.
  - Households living outside of the villages boundaries present lower chlorination rates in the Household Survey ([Table](#tab:boundaries-diff)). However, these households represent a higher proportion of households surveyed in the Household Survey than in the Monitoring Survey. There, if anything, this would bias estimates in the opposite direction than the one we observe.
  - The difference between estimates from the Household and the Monitoring Survey still persist if we restrict the comparison only to households living within village boundaries ([Table](#tab:boundaries-restric))
  
  

- **Timing and replacements:** 
  - [Figure 1](#fig:replacements) restricts the sample to households that were listed in both the household census and the promoter survey and randomly selected to be surveyed as part of the Monitoring Survey, comparing the chlorination rates among those surveyed earlier, as part of the Household Survey, and those that were surveyed later, as part of the Monitoring Survey.
   - Our estimates cannot separate these effects from those of the difference in replacement protocol between the Household and Monitoring surveys. Note that timing could not explain the difference between our estimates and Evidence Action's, given the protocol.
  - Promoters were more active in Uganda villages, and more likely to talk to households after observing the presence of the field team, so we think this is pointed to priming over time. That said, in Malawi most of the replacements happened because households had already been surveyed in the Household Survey, while in Uganda around 40% of replacements happened because households weren't available


# 3 Conclusion


- there are multiple potatnial sorces of bias
- this is just indicative
- sample selectio ninto the promoter list is a thing in the census, even if not refelcted in the household survey after randomization
- we only see differences in monitoring and household in uganda, and this is where we know there was interference, so that's a likely cause
- enumerator identify (bias plus training, plus equipmaent)
- we don't have a definitive results to say that getting a list from the promoter should be avoided based on this data alone
- but given that in kenya and uganda the estimates were higher than the hosuehold ones, there is also evidence in the other direction

# Tables

## Table 1 - Adoption estimates from difference sources {#tab:discount}

| Country  | (1) Census | (2) Promoter | (3) Evidence Action |
|----------|------------|--------------|---------------------|
| Kenya    | 16%        | 36%          | 44%                 |
| Malawi   | 26.6%      | 30.8%        | 51%                 |
| Uganda   | 30.1%      | 45.6%        | 52%                 |

## Table 2 - Characteristics of water points observed in the Household and Monitoring Survey {#tab:wp-balance-mw}

```{r}
balance_vars_wp <-
  c(
    "Water point is functional" = "wp_func",
    "Dispenser tank is present" = "disp_tank_present",
    "Dispenser is functional" = "disp_func",
    "Dispenser is filled" = "disp_filled",
    "Dose dispensed (mL)" = "disp_dose",
    "TCR > 0.2 ppm" = "disctcr_02",
    "FCR > 0.2 ppm" = "discfcr_02",
    "Users pay to use water point" = "wp_pay"
  )
```

```{r eval = FALSE}
wp_census %>%
  dplyr::filter(
    country == "Malawi",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  feols(
    paste("promoter_surveyed ~", paste(balance_vars_wp, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

```{r}
wp_census %>%
  dplyr::filter(
    country == "Malawi",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  mutate(
    promoter_surveyed = if_else(promoter_surveyed, "Promoter surveyed", "Promoter not surveyed"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_wp,
    labels = names(balance_vars_wp),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

## Table 3 - Characteristics of water points observed in the Household and Monitoring Survey {#tab:wp-balance-ug}

```{r eval = FALSE}
wp_census %>%
  dplyr::filter(
    country == "Uganda",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  feols(
    paste("promoter_surveyed ~", paste(balance_vars_wp, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

```{r}
wp_census %>%
  dplyr::filter(
    country == "Uganda",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  mutate(
    promoter_surveyed = if_else(promoter_surveyed, "Promoter surveyed", "Promoter not surveyed"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_wp,
    labels = names(balance_vars_wp),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

## Table 4 - Comparison of households using water points included in the promoter list in Malawi {#tab:hh-selection-mw}

```{r}
hh_census_all %>%
  dplyr::filter(
    country == "Malawi",
    wp_intervention == "DSW",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_census,
    labels = names(balance_vars_census),
    group = "promoter_list",
    group.test = TRUE
  )


hh_census_all %>%
  dplyr::filter(
   country == "Malawi",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  feols(
    paste("promoter_list ~", paste(balance_vars_census, collapse = "+")) %>% as.formula,
    cluster = ~ village_id
  ) %>%
  fitstat(type = "f")
```

## Table 5 - Comparison of households using water points included in the promoter list in Uganda {#tab:hh-selection-ug}

```{r}
hh_census_all %>%
  dplyr::filter(
    country == "Uganda",
    wp_intervention == "DSW",
    promoter_surveyed
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_census,
    labels = names(balance_vars_census),
    group = "promoter_list",
    group.test = TRUE
  )

hh_census_all %>%
  dplyr::filter(
   country == "Uganda",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  feols(
    paste("promoter_list ~", paste(balance_vars_census, collapse = "+")) %>% as.formula,
    cluster = ~ village_id
  ) %>%
  fitstat(type = "f")
```

## Table 3 - Comparison of households in Household and Monitoring surveys for Malawi {#tab:balance-mw}

```{r}
matched %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    ),
  ) %>%
  dplyr::filter(country == "Malawi") %>%
  sumtable(
    vars = balance_vars,
    labels = names(balance_vars),
    group = "survey",
    group.test = TRUE
  )
```

## Table 4 - Comparison of households in Household and Monitoring surveys for Malawi {#tab:balance-ug}

```{r}
hh_survey %>%
  dplyr::filter(
    country == "Uganda",
    survey == "Monitoring Survey" | promoter_surveyed,
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    labels = names(balance_vars),
    group = "survey",
    group.test = TRUE
  )

hh_survey %>%
  dplyr::filter(
     country == "Uganda",
     survey == "Monitoring Survey" | promoter_surveyed
  ) %>%
  mutate(survey = survey == "Monitoring Survey") %>%
  feols(
    paste("survey ~", paste(balance_vars, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

# Figures 

## Figure 1 - Chlorine detection rates in Household and Monitoring surveys {#fig:hh-vs-mon}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x, 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = ., 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>%
      tidy_add_n
  ) %>%
  bind_rows(.id = "country") %>%
  mutate(
    label = str_remove_all(term, "survey") %>%
      paste0(" (N = ", n_obs, ")") %>%
      str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_wrap(~ country, scales = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups. Household Survey sample is limited to households that self-report using water points with DSW. Monitoring Survey sample is limited to households listed by DSW promoters." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 2 - Chlorine detection rates by timing of survey {#fig:timing}


```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "not_first_day", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "not_first_day", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = if_else(
        str_detect(term, "TRUE"),
        "Surveyed in the first day of the activity",
        "Surveyed after the first day of the activity"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(30),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey that self-report using water points with DSW in all villages in the Expansion and Footprint sample groups." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 3 - Chlorine detection rates in Household Survey by group of households {#fig:decomposition}

```{r}
list(
  "(1) All households" = hh_survey %>% dplyr::filter(survey == "Household Survey"),
  "(2) Using water points in promoter survey" = hh_survey %>% dplyr::filter(survey == "Household Survey", promoter_surveyed),
  "(3) In promoter list" = hh_survey %>% dplyr::filter(survey == "Household Survey", promoter_surveyed, promoter_list),
  "(4) Randomized into monitoring" = hh_survey %>% dplyr::filter(survey == "Household Survey", promoter_surveyed, promoter_list, any_rank)
) %>%
  map(
    ~ averages(
      data = ., 
      x = "country",
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n()
  ) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    country = str_remove_all(term, "country"),
    sample = sample %>% paste0(" (N = ", n_obs, ")") %>% str_wrap(29),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = sample,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_wrap(
    ~ country, 
    ncol = 1,
    scale = "free_x"
  ) +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level."
  )
```

## Figure 4 - Sample selection of water points {#fig:wp-selection}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "promoter_surveyed", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "promoter_surveyed", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>%
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = 
      if_else(
        str_detect(term, "TRUE"),
        "In promoter survey",
        "Not in promoter survey"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(20),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups, and all households that self-report using water points with DSW." %>%
      paste(
        "The p-value of the difference between groups is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 5 - Comparison of chlorine detection rates among household using water points included in the promoter survey {#fig:promoter-list}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_surveyed), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_surveyed), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = if_else(
        str_detect(term, "TRUE"),
        "Not promoter list",
        "Not in promoter list"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups. Household Survey sample is limited to households that self-report using water points with DSW and whose primary water point is covered by the promoter survey" %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```
## Figure 6 - Chlorine detection rates by contact with promoter {#fig:int}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_list), 
      x = "int_promoter", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_list), 
      x = "int_promoter", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = if_else(
        str_detect(term, "TRUE"),
        "Contacted by promoter",
        "Not contacted by promoter"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey that self-report using water points with DSW in all villages in the Expansion and Footprint sample groups and who are listed by the promoter as using that water point." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```



## Figure 7 - Chlorine detection rates among replaced and replacement households {#fig:inhh-replacements}

```{r}
p_vals <-
  by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>%
        group_by(survey, household_id, village_id) %>%
        summarise(
          across(
            c(disctcr_02, replacement_status),
            ~ max(., na.rm = TRUE)
          )
        ), 
      x = "replacement_status",
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

by_country %>%
  map(
    ~ averages(
      data = .x %>%
        group_by(survey, household_id, village_id) %>%
        summarise(
          across(
            c(disctcr_02, replacement_status),
            ~ max(., na.rm = TRUE)
          )
        ),
      x = "replacement_status", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = term %>% 
      str_remove_all("replacement_status") %>%
      paste0(" (N = ", n_obs, ")"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = 'Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups. Household Survey sample ("replaced") is limited to households that self-report using water points with DSW, whose primary water point is covered by the promoter survey, and that were listed by the promoter as using the water point and sampled into the Monitoring Survey. Monitoring Survey sample ("replacement") includes households who are included in the survey as replacements.' %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 8 - Comparision of chlorine detection rates in the Household Survey between households living inside and outside of village boundaries {#fig:boundaries-diff}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "inclusion", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "inclusion", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = str_remove_all(term, "inclusion") %>% 
      paste0(" (N = ", n_obs, ")") %>% 
      str_wrap(20),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey that self-report using water points with DSW in all villages in the Expansion and Footprint sample groups." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 9 - Comparision of chlorine detection rates by survey among households living within village boundaries {#fig:boundaries-restrict}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(str_detect(inclusion, "Within")), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(str_detect(inclusion, "Within")), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = str_remove_all(term, "survey") %>% 
      paste0(" (N = ", n_obs, ")") %>% 
      str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_brewer(palette = "Dark2") +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey and Monitoring Surveys who live within village boundaries." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```
