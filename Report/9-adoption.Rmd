---
title: "Comparison of chlorine adoption estimates"
output:
  pdf_document: default
  word_document: default
---


```{r}
pacman::p_load(
  tidyverse,
  broom,
  broom.helpers,
  fixest,
  estimatr,
  stargazer,
  modelsummary,
  kableExtra,
  sf, 
  vtable,
  janitor,
  ggtext
)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
```

```{r, echo=FALSE, results='asis'}
cat('<style>
/* Target the tinytable container */
.container:has(table.table-borderless) {
  display: flex !important;
  justify-content: center !important;
  width: 100% !important;
  overflow-x: auto !important;
}

/* Ensure the table itself scales properly */
table.table-borderless {
  width: auto !important;
  margin: 0 auto !important;
  font-size: 1em !important;  /* Changed from 0.85em to 1em (normal size) */
}

/* Make sure table cells have adequate padding */
.table-borderless td, .table-borderless th {
  white-space: nowrap !important;
}
</style>')
```

```{r}
hh_census %>%
  group_by(wp_id, wp_intervention, country, sample_group) %>%
  summarise(
    households_census = n()
  ) %>%
  inner_join(
    wp_census %>%
      select(wp_id, pm_users, wp_func, discfcr_02) %>%
      dplyr::filter(!is.na(pm_users))
  ) %>%
  mutate(
    proportion = pm_users/households_census
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    n = n(),
    mean = mean(proportion),
    functional = mean(wp_func),
    FCR = mean(discfcr_02, na.rm = TRUE)
  ) %>%
  dplyr::filter(wp_intervention %in% c("ILC", "DSW"))
```
# To-dos

```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry  %>%
  mutate(
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    closer = (ilc_wcp & str_detect(ea_id, "001^")) | ilc_wp
  )
```

```{r}
promoter_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  ) %>%
  select(-village_id)
```

```{r}
hh_census_all <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  mutate(
    hhh_fem = hhh_gender == "Female",
    hhh_primary_educ = !(hhh_educ %in% c("No formal education / Never attended school", "None", "Pre-primary", "Some Primary School (Did not complete Standard 8)")),
    inclusionyn = str_detect(inclusion, "Within"),
    wp_source = wp_source == "From a water point in this village",
    any_rank = household_id %in% (promoter_survey %>% dplyr::filter(!is.na(rank)) %>% pull(household_id))
  )

hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  select(
    household_id,
    inclusion,
    #visit,
    dsw,
    country,
    wp_count_pastmonth
  )

```


```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  group_by(village_id, survey) %>%
  mutate(not_first_day = date > min(date)) %>%
  group_by(household_id, survey) %>%
  mutate(
    intervention_selfreport = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC"
    ),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    ),
    resp_fem = resp_sex == "Female",
    resp_primary_educ = resp_educ >= "Primary",
    hhh_fem = hhh_sex == "Female",
    hhh_primary_educ = !(hhh_educ %in% c("No formal education / Never attended school", "None", "Pre-primary", "Some Primary School (Did not complete Standard 8)")),
    collect_primary = where_collect == "From the water point primary water point (${wp_name_pl})",
    waterprep_12minus = howlong_waterprep == "Less than 12 hrs ago [today]",
    collect_child = str_detect(who_collected, "18"),
    collect_resp = who_collected == "The respondent",
    across(
      c(hh_pregnant, hh_under2, hh_under5),
      ~ . > 0
    ),
    promoter_list = household_id %in% promoter_survey$household_id,
    rank_u5 = household_id %in% (promoter_survey %>% dplyr::filter(rank <= 4) %>% pull(household_id)),
    any_rank = household_id %in% (promoter_survey %>% dplyr::filter(!is.na(rank)) %>% pull(household_id)),
    in_monitoring = any(survey == "Monitoring Survey"),
    in_household = any(survey == "Household Survey")
  ) %>%
  left_join(hh_census) %>%
  dplyr::filter(
    !(survey == "Household Survey" & wp_intervention != "DSW"),
    wp_intervention != "ILC",
    sample_group != "ILC"
  )
```

```{r}

matched <- 
  hh_survey %>%
  left_join(
    promoter_survey,
    by = "household_id",
    relationship = "many-to-many"
  ) %>%
  left_join(
    hh_census %>% 
      select(
        household_id, 
        inclusion
      ),
    by = "household_id",
    relationship = "many-to-many"
  ) %>%
  left_join(
    wp_census %>%
      transmute(
        wp_pm = wp_id, 
        wp_pm_intervention = intervention
      )
  ) %>%
  group_by(wp_pm) %>%
  mutate(max_rank = max(rank, na.rm = TRUE)) %>%
  group_by(village_id, survey) %>%
  mutate(not_first_day = date > min(date)) %>%
  group_by(household_id) %>%
  mutate(
    in_monitoring = any(survey == "Monitoring Survey"),
    in_household = any(survey == "Household Survey")
  ) %>%
  ungroup %>%
  mutate(
    program = case_when(
      survey == "Household Survey" ~ wp_intervention,
      survey == "Monitoring Survey" ~ wp_pm_intervention
    ),
    rank = as.numeric(rank),
    replacement = rank > 4,
    replaced = rank < max_rank,
    replacement_status = case_when(
      replaced & !in_monitoring & survey == "Household Survey" ~  "Replaced",
      replacement & survey == "Monitoring Survey" ~  "Replacement",
    ),
    promoter_right = wp_pm == wp_id,
    across(
      c(hh_pregnant, hh_under2, hh_under5),
      ~ . > 0
    )
  ) 

by_country <-
  matched %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda"))

marginal_effects <- function(data, x, cluster) {
  c("disctcr_02") %>%
    map(
      ~ feols(
        paste(., "~", x, "| sample_group") %>% as.formula,
        cluster = paste("~ ", cluster),
        data = data
      )
    ) 
}
```

```{r}
balance_vars <-
  c(
    # "resp_age",
    # "resp_fem",
    # "resp_primary_educ",
    "Age of household head (years)" = "hhh_age", 
    "Household head is a woman" = "hhh_fem", 
    "Household head completed primary education" = "hhh_primary_educ",
    "Number of household members" = "hh_members", 
    "At least one household member is pregnant" = "hh_pregnant", 
    "At least one household member is under 2 yo" = "hh_under2",
    "At least one household member is under 2 yo" = "hh_under5",
    "Inclusion criterion" = "inclusion",
    "Distance to primary source of drinkig water (m)" = "wp_dist", 
    "Distance to nearest water point with DSW (m)" = "evac_dist",
    #"pm_dist",
    "Household pays to use the primary source of drinking water" = "wp_pay",
    #"wp_func", 
    "Dispenser was filled" = "wp_dsw_chlorine", 
    "Dispenser had TCR > 0.2 mg/L" = "wp_disctcr_02", 
    "Dispenser had FCR > 0.2 mg/L" = "wp_discfcr_02",
    "Water for children is prepared differently" = "prep_different", 
    "Water was prepared less than 12h before testing" = "waterprep_12minus", 
    "Water tested was combined with old or untreated water" = "mix", 
    "Tested water was collected from primary water source" = "collect_primary", 
    "Tested water was collected by the respondent" = "collect_resp", 
    "Tested water was collected by a child" = "collect_child",
    "Household was aware of upcoming data collection" = "int_warned", 
    "Promoter informed the household of upcoming data collection" = "int_promoter"
  )
```


```{r}
balance_vars_census <-
  c(
    "Age of household head (years)" = "hhh_age", 
    "Household head is a woman" = "hhh_fem", 
    "Household head completed primary education" = "hhh_primary_educ",
    "Number of household members" = "hh_members", 
    "At least one household member is pregnant" = "hh_pregnant", 
    "At least one household member is under 2 yo" = "hh_under2yn",
    "At least one household member is under 2 yo" = "hh_under5yn",
    "Within village boundaries" = "inclusionyn",
    "Distance to primary source of drinkig water (m)" = "wp_dist", 
    "Distance to nearest water point with DSW (m)" = "evac_dist",
    #"pm_dist",
    "Primary source of drinking water within village boundaries" = "wp_source",
    "Uses more than one water source for drinking water" = "wp_secweek",
    "Number of water sources used in the past month" = "wp_count_pastmonth",
    "Household pays to use the primary source of drinking water" = "wp_pay",
    "Primary water point is functional" = "wp_func", 
    "Dispenser was filled" = "wp_disp_filled", 
    "Dispenser had TCR > 0.2 mg/L" = "wp_disctcr_02", 
    "Dispenser had FCR > 0.2 mg/L" = "wp_discfcr_02",
    "Number of promoter lists mentioned" = "promoter_list_mentions"
  )
```

This section compares adoption estimates calculated using different methodologies and discusses potential reasons for the differences between them. This exploratory analysis is descriptive in nature and intended to assess the plausibility of different hypotheses for explaining the observed differences. It relies on comparisons across subsamples that are often small in size. While this approach helps discount some hypotheses, it cannot conclusively identify the causes behind the different estimates. 

[Table 1](#tab:discount) compares the total chlorine residual (TCR) detection rates estimated from the Household Survey and the Monitoring Survey. It also includes estimates from Evidence Action's Adoption Monitoring for the same period, as well as results from the Simultaneous Census and Monitoring (SCM) exercise conducted by Evidence Action in Kenya in 2024. [Figure 1](#fig:hh-vs-mon) displays confidence intervals for the Household and Monitoring Survey estimates.

Evidence Action's Q3 monitoring estimates are roughly twice as high as DIL's Household Survey estimates (our preferred method). Section 1 discusses several hypotheses that may explain this difference, though we lack sufficient data to test them adequately. Our Household Survey estimates represent 52% and 58% of Q3 Monitoring estimates in Malawi and Uganda, respectively—proportions consistent with Kenya's SCM findings, where independent surveyors obtained chlorination rates representing 55% of those calculated by Evidence Action staff. We believe a combination of sampling variation and surveyor incentives most likely explains these differences.

The estimates from DIL's two surveys are not statistically different in Malawi. This suggests that although several factors may bias estimates obtained under the Monitoring methodology, a full census of served villages may not be necessary to obtain reliable adoption estimates. In Uganda, however, the estimates differ significantly. Section 2 discusses potential sources of this bias. We believe a combination of sample selection, survey timing, and interactions with promoters is biasing Monitoring Survey estimates upward in Uganda.

In 2024, Evidence Action conducted new data collection in Kenya to estimate and compare chlorination rates using both the KSWTCS methods and their regular Adoption Monitoring strategy in the same villages. They found that:

- Chlorine adoption estimates based on their Adoption Monitoring methodology (36%) were roughly twice as high as those obtained following KSWTCS methods (16%)
- When sampling identical households, independent surveyors found a chlorination rate of 21%, while Evidence Action staff found 38%
- Chlorine adoption estimates from regular monitoring activities outside this exercise were approximately three times as high, at 44%
    
Within DIL's data, estimates from the Monitoring Survey are higher than those from the Household Survey in Uganda, but not in Malawi ([Figure 1](#fig:hh-vs-mon), [Table 2](#tab:hh-vs-mon-tab)). This pattern is consistent with the comparability of households included in the two surveys. Households are comparable in Malawi ([Table 3](#tab:balance-mw)), but not in Uganda ([Table 4](#tab:balance-ug)). In Uganda, households in the Monitoring Survey are more likely to pay to use their primary water point and twice as likely to have been warned by the promoter about the upcoming survey compared to those in the Household Survey.
    
The remainder of this document explores differences between the Household Survey and Monitoring Survey estimates, indicating when these differences might also explain divergences between the Household Survey and Evidence Action's Q3 Monitoring estimates.

Key findings include:

- Water point selection does not explain the difference: Households using water points included in the promoter survey show higher chlorination rates (Figure 3). However, when comparing monitoring estimates to household survey estimates among households using the same water points, the difference between surveys remains large (Figure 4).
- Selection into the household list by promoters does not explain the difference: Among households in the Household Survey using water points listed by promoters, chlorination rates are identical to those of households not listed by promoters (Table 6, Figure 5).
- We believe differences are primarily due to sample selection of water points and households being warned by promoters about upcoming surveys.
Anecdotal evidence points to greater interference from Evidence Action in Uganda.

# 1 Potential explanations of differences between DIL and Evidence Action estimates

## 1.1 Surveyors' independence

A key methodological difference between DIL and Evidence Action protocols concerns who collects the data. DIL's estimates rely on data collected by independent enumerators hired by IPA, while Evidence Action uses their own local staff. This means surveyors and promoters may respond to different incentives:

- Evidence Action surveyors may have existing relationships with promoters or implementation teams, creating incentives to portray them positively
- Promoters were chosen by their communities to be the point of contact with Evidence Action and may seek to maintain positive relationships with the organization
- Evidence Action staff may have interests in program continuation, which depends on positive results

All these factors create potential incentives for surveyors and promoters to seek outcomes favorable to program success, which we would expect to bias Evidence Action estimates upward relative to independent surveys.

Empirical evidence from Kenya supports this hypothesis. When Evidence Action examined identical households using both measurement approaches, the independent household survey found that 21% of households tested positive for chlorine residual, while the Evidence Action monitoring survey reported 38%. This means the independent survey estimate represented only 55% of the Evidence Action figure.

Results from the DIL exercise in Malawi and Uganda are also consistent with this hypothesis ([Table 1](#tab:discount)). In Malawi, the independent household survey estimate (26.6%) represents 52% of the Evidence Action monitoring figure (51%). Similarly, in Uganda, the independent estimate (30.1%) represents 58% of the Evidence Action monitoring result (52%).

## 1.2 Represented water points

```{r}
wp_counts <-
  wp_census %>%
  dplyr::filter(
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    count = sum(promoter_surveyed),
    pct = (mean(promoter_surveyed) %>% round(3)) * 100
  )
```

The water points included in Evidence Action's Adoption Monitoring Survey and DIL's Monitoring Survey are systematically different due to who provided the list of users from which tested households were sampled.

DIL's protocol specified that only promoters who work with Evidence Action to refill dispensers, maintain them, and promote chlorine adoption could provide a list of water point users. When Evidence Action did not provide contact information for a promoter or one could not be identified by asking villagers, no user list was obtained and no households were included in the Monitoring Survey for that water point.
Evidence Action, by contrast, surveys any knowledgeable village member when the promoter cannot be found.

This difference in sampling strategy has implications for the representativeness of DIL's Monitoring Survey and may bias estimates. However, the direction of bias works against explaining the observed gap:

- Evidence Action's broader respondent pool likely produces more representative estimates of overall program reach
- DIL's promoter-focused approach would be expected to introduce upward bias into monitoring estimates, as promoters are better positioned than typical village members to identify both households using the water points and households that chlorinate their water, and may be more motivated to prioritize successfully adopting households when selecting survey respondents
Given that DIL's Monitoring Survey estimates are lower than Evidence Action's Q3 Monitoring estimates, and that in Malawi—where coverage is more representative—Monitoring Survey estimates are closer to Household Survey estimates, the difference in water point representativeness is unlikely to explain the overall divergence in estimates

## 1.3 Survey timing and duration

Both DIL and Evidence Action protocols stipulate that promoters should only be contacted upon surveyors' arrival in the village. However, the surveys differed substantially in duration: Evidence Action monitoring staff spent only one day in each village, while IPA teams remained for an average of five days, conducting monitoring surveys on the final day.

The extended presence of IPA field teams may bias chlorine adoption estimates in both the Household and Monitoring Surveys upward, as promoters have opportunities to refill dispensers and remind households to add chlorine to their drinking water.

[Figure 2](#fig:timing) indicates that among households included in the Household Survey, those tested on the first day showed higher rates of TCR detection in both Malawi and Uganda. However, there is limited statistical support for this hypothesis—the difference is significant only in Uganda, and only at the 90% confidence level. This pattern is not observed in the Monitoring Survey, though this may be explained by the fewer interviews conducted, meaning this activity may not have extended across as many days.ctivity may not have been extended for as many days.

## 1.4 Other factors
  
The following factors may contribute to the differences, but we are unable to test them adequately:

- Sampled villages: IPA and Evidence Action did not visit the same water points, and sampling variation may explain part of the difference.
- Time since training: IPA surveyors were trained between one week and four months before interviews took place, but the timing of Evidence Action staff retraining is unknown. This would introduce noise into measurements, though the direction of any bias is unclear.
- State of equipment: Equipment used during the Household and Monitoring Surveys was procured specifically for this data collection, and all reagents were new. We lack data about how long Evidence Action's equipment has been in use or when reagents were procured. The direction of bias from this factor is unclear—for example, discolored color wheels would bias estimates upward, while degraded DPD reagents would bias estimates downward.
- Deviations from randomization protocol: During the Household and Monitoring Surveys, household randomization into the testing sample was recorded in the data, allowing us to observe whether sampled households were replaced. In Evidence Action's protocol, this is recorded on paper, leaving more room for enumerators to choose whom they survey (e.g., households closer to the promoter's house or households indicated by the promoter).

# 2 Potential explanations for differences between Household survey and Monitoring survey

This section discusses potential explanations for the differences shown in [Figure 2](#fig:hh-vs-mon). [Figure 3](#fig:decomposition) presents TCR detection rates across different subsamples of households tested during the Household Survey in an attempt to decompose the sources of differences.

As expected given the similarity between Monitoring and Household Survey estimates in Malawi, there is no meaningful variation across subsamples in that country. In Uganda, although the estimates in [Figure 2](#fig:hh-vs-mon) are significantly different and point estimates in Household Survey subsamples become more similar to Monitoring Survey estimates as we apply similar sample selection criteria, there is considerable noise in estimates across subsamples, and they are not significantly different from one another. As such, the discussion in this section is inconclusive.

## 2.1 Sample selection of water points

When designing survey protocols, we intended for both the Household Survey and Monitoring Survey to be representative of all DSW water points in sampled villages. However, as discussed in Section 1.2, the field team was unable to identify promoters for all water points found, meaning water points covered by the Monitoring Survey may be systematically different from and less representative than those in the Household Survey.

Tables [2](#tab:wp-balance-mw) and [3](#tab:wp-balance-ug) compare characteristics of water points for which promoters were surveyed versus those for which no promoter was found in Malawi and Uganda, respectively. Promoter surveys were conducted in `r round(11500/136, 1)`% of the water points with 136 DSW identified in Malawi, and in `r round(11600/185, 1)`% of the 185 water points in Uganda. In both countries, an F-test for joint orthogonality indicates that water points excluded from the promoter survey are not significantly different from those covered. However, there are imbalances in individual characteristics, particularly those linked to dispenser functionality.

```{r}
wp_cl_counts <-
  hh_survey %>%
  group_by(country, survey) %>%
  summarise(
    promoter_surveyed = round((1 - mean(promoter_surveyed, na.rm = TRUE)) * 100, 1),
    wps = n_distinct(wp_id)
  )
```

These differences in water point characteristics could translate into Monitoring Survey households having greater access to chlorine than Household Survey households. Indeed, [Figure 4](#fig:wp-selection) shows that TCR detection rates are significantly higher among households using water points covered by the promoter survey.

Although this difference is large and significant, the weight of these households in Household Survey estimates is small in Malawi (only `r wp_cl_counts %>% dplyr::filter(country == "Malawi", survey == "Household Survey") %>% pull(promoter_surveyed)`% of households in the Household Survey sample use water points not included in the promoter survey) and the differences between Household and Monitoring estimates are correspondingly small. 

In Uganda, by contrast, only `r wp_cl_counts %>% dplyr::filter(country == "Uganda", survey == "Household Survey") %>% pull(promoter_surveyed)`% of households in the Household Survey sample use water points included in the promoter survey. This is also visible in the reduction in sample size between columns (1) and (2) in [Figure 3](#fig:decomposition). Nonetheless, restricting the Household Survey sample to households using water points included in the promoter survey does not substantially increase the TCR detection rate.


## 2.2 Sample selection of households


```{r}
notlisted <-
  hh_census_all %>%
  dplyr:::filter(
    sample_group != "ILC",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  group_by(country) %>%
  summarise(
    hhs = n_distinct(household_id),
    listed = mean(promoter_list, na.rm = TRUE) %>% round(3) * 100
  )
```

```{r}
using_dsw <-
  hh_census_all %>%
  dplyr:::filter(promoter_list) %>%
  group_by(country) %>%
  summarise(
    hhs = n_distinct(household_id),
    dsw = mean(dsw, na.rm = TRUE) %>% round(3) * 100,
    multiple_wps = mean(wp_count_pastmonth > 1, na.rm = TRUE) %>% round(3) * 100
  )
```

The list of households using water points provided by promoters is another potential source of difference. Promoters are expected to have less complete knowledge than households about water point usage patterns, and they also respond to incentives.

Promoters' reduced knowledge would introduce noise into the data. For example, in some cases promoters relied on lists of water point users recorded in previous years, dating back as far as dispenser installation. Several additional factors could bias estimates in different directions:

- If a household uses more than one water point, promoters may not know whether a water point is the household's primary drinking water source, and including households whose primary source lacks DSW would bias estimates downward
- If promoters wish to demonstrate that a water point is widely used and should continue being treated, the list could include households whose primary source lacks DSW
- If promoters remember mostly people with whom they have closer relationships or to whom they recently discussed chlorination, the list could lead to overestimation of chlorination rates
- If promoters expect surveyors to speak with listed households and wish to demonstrate good performance, the list will more likely include households known to use chlorine, biasing estimates upward
Promoters would be expected to list all households using the water point regardless of location, while the household survey limits its sample to households within or up to 200m outside village boundaries

The data shows that promoters are effective at identifying households using water points with dispensers. In Malawi, out of the `r using_dsw %>% dplyr::filter(country == "Malawi") %>% pull(hhs)` households included in the promoter list who were identified in the household census, `r using_dsw %>% dplyr::filter(country == "Malawi") %>% pull(dsw)`% self-report using a water point with a dispenser as their primary source of drinking water.  In Uganda, this figure was `r  using_dsw %>% dplyr::filter(country == "Uganda") %>% pull(dsw)`%  out of `r using_dsw %>% dplyr::filter(country == "Uganda") %>% pull(hhs)` households.

However, promoters are less effective at identifying all of the users. Among the households mapped in the household census who self-reported using water points in the promoter survey as their primary source of drinking water, `r notlisted %>% dplyr::filter(country == "Malawi") %>% pull(listed)`% are included in the promoter list in Malawi, while in Uganda the figure is just `r notlisted %>% dplyr::filter(country == "Uganda") %>% pull(listed)`%.

Among households that self-report using water points listed by the promoter are significantly different from those that are not in both countries (Tables [4](#tab:hh-selection-mw) and [5](#tab:hh-selection-ug)), including with regard to chlorine access. However, when we further restrict the sample to households included in the Household Survey, these differences are not jointly significant. This finding is consistent with results in Figures [3](#fig:decomposition) and [5](#fig:promoter-list). [Figure 3](#fig:decomposition) shows that restricting the Household Survey sample to households included in the promoter list does not lead to different adoption estimates, and [Figure 5](#fig:promoter-list) confirms this by showing that TCR detection is similar among households included in and excluded from the list.

Although this does not point to differences between the Household Survey and Monitoring Survey estimates, the fact that differences exist between listed and not listed households observed in the Household Census indicates that inclusion in the promoter list does play a role and may help explain divergences from Evidence Action estimates.

## 2.3 Interactions with the promoter

The analysis thus far suggests that eligibility criteria for inclusion in the Monitoring Survey are not the primary sources of differences. However, we know from [Figure 1](#fig:hh-vs-mon) that differences exist in Uganda. Therefore, these differences must stem not from eligibility but from something observed among households actually included in the survey.

In [Figure 2](#fig:decomposition) we observe that households randomized into the survey show higher detection rates. While this is a small sample and the difference is not statistically different from previous estimates, a comparison of listed households that were and were not randomly sampled reveals an interesting pattern.

When comparing household characteristics, we find that more sampled households reported being aware of the upcoming data collection and that it was the promoter who informed them. The same is observed when comparing Household Survey and Monitoring Survey households. The noise in these variables stems from the fact that we added this variable only after observing promoters efforts to increase adoption in Uganda after our team arrived. In both cases, households are not significantly different overall, making these findings inconclusive. However, [Figure 6](#fig:int) shows that households interacting with the promoter are more likely to chlorinate.

This may not explain why Household Survey estimates differ from Q3 Monitoring, but it does shed light on the gap between Household Survey and Monitoring Survey estimates. In Malawi, where no anecdotal evidence points to the same involvement among promoters, these estimates are not different.

## 2.4 Other factors

**Replacement protocol:** During the Household Survey, households were only replaced after three failed attempts at a visit. For the Monitoring Survey, the protocol indicated that households could be replaced for two reasons:

1. They had already been surveyed during the Household Survey
2. They were unavailable when visited for the Monitoring Survey. This could lead to bias if households where a member is more likely to be found at home during the data are also more likely to chlorinate or to have collected water more recently.

[Figure 7](#fig:inhh-replacement) compares chlorine detection rates among households sampled for the Monitoring Survey and replaced because they had already been surveyed in the Household Survey versus replacement households in the Monitoring Survey. These differences are not statistically significant, but they are relatively large in Uganda. In Malawi, most replacements occurred because households had already been surveyed in the Household Survey, while in Uganda approximately 40% of replacements occurred because households were unavailable.

**Timing:** Because Monitoring Surveys were the last activity carried out in each village, taking place after promoters were surveyed, there is greater potential for priming (upward bias). The ideal test to determine if timing biases estimates would compare the same households surveyed in both the Household and Monitoring Surveys. However, given our protocol, too few such observations exist for meaningful analysis. Some evidence for the presence of timing effects appears in [Figure 2](#fig:timing). Note, however, that timing could not explain the difference between our estimates and Evidence Action's, given that the Monitoring protocol involves only one day of presence in the village.

**Village boundaries:** The Household Census from which the Household Survey sample was selected included only people living inside village boundaries or within 200m of these boundaries, while the Promoter Survey included anyone using the water points regardless of location. This does not appear to contribute to the observed differences, as households living outside village boundaries show lower chlorination rates in the Household Survey ([Figure 8](#tab:boundaries-diff)), and the difference between Household and Monitoring Survey estimates persists when restricting comparison to households within village boundaries ([Figure 9](#tab:boundaries-restric)). These households represent a higher proportion of the Household Survey sample than the Monitoring Survey sample. Therefore, if anything, this would bias estimates in the opposite direction from what we observe. 


# 3 Conclusion

Multiple potential sources of bias exist, and this analysis is merely correlational. 

We observe sample selection into the promoter list using census-level data, even if not reflected in the Household Survey after randomization. Therefore, we cannot rule it out as a potential source of differences between the Household Survey and the Adoption Monitoring estimates. We also only observe differences between Monitoring and Household Survey estimates in Uganda — precisely where we know interference occurred — suggesting this as a potential cause of differences in estimates given the lack of support to other explanations. Enumerator identity (reflecting differences in bias, training, and equipment) is also likely to play a role.

We lack definitive evidence from this data alone to conclude that obtaining lists from promoters should be avoided. However, given that Monitoring Survey estimates in both Kenya and Uganda were higher than Household Survey estimates, there is also evidence pointing in that direction.

# Tables

## Table 1 - Adoption estimates from difference sources {#tab:discount}

| Country  | (1) Census | (2) Promoter | (3) Evidence Action |
|----------|------------|--------------|---------------------|
| Kenya    | 16%        | 36%          | 44%                 |
| Malawi   | 26.6%      | 30.8%        | 51%                 |
| Uganda   | 30.1%      | 45.6%        | 52%                 |

## Table 2 - Characteristics of DSW water points in Malawi {#tab:wp-balance-mw}

```{r}
balance_vars_wp <-
  c(
    "Water point is functional" = "wp_func",
    "Dispenser tank is present" = "disp_tank_present",
    "Dispenser is functional" = "disp_func",
    "Dispenser is filled" = "disp_filled",
    "Dose dispensed (mL)" = "disp_dose",
    "TCR > 0.2 mg/L" = "disctcr_02",
    "FCR > 0.2 mg/L" = "discfcr_02",
    "Users pay to use water point" = "wp_pay"
  )
```

```{r eval = FALSE}
wp_census %>%
  dplyr::filter(
    country == "Malawi",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  feols(
    paste("promoter_surveyed ~", paste(balance_vars_wp, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

```{r}
wp_census %>%
  dplyr::filter(
    country == "Malawi",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  mutate(
    promoter_surveyed = if_else(promoter_surveyed, "Promoter surveyed", "Promoter not surveyed"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_wp,
    labels = names(balance_vars_wp),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

## Table 3 - Characteristics of Characteristics of DSW water points in Uganda  {#tab:wp-balance-ug}

```{r eval = FALSE}
wp_census %>%
  dplyr::filter(
    country == "Uganda",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  feols(
    paste("promoter_surveyed ~", paste(balance_vars_wp, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

```{r}
wp_census %>%
  dplyr::filter(
    country == "Uganda",
    sample_group != "ILC",
    intervention == "DSW"
  ) %>%
  mutate(
    promoter_surveyed = if_else(promoter_surveyed, "Promoter surveyed", "Promoter not surveyed"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_wp,
    labels = names(balance_vars_wp),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

## Table 4 - Comparison of households using water points covered by the Promoter Survey in Malawi {#tab:hh-selection-mw}

```{r}
hh_census_all %>%
  dplyr::filter(
    country == "Malawi",
    wp_intervention == "DSW",
    promoter_surveyed
  )  %>%
  mutate(
    promoter_list = if_else(promoter_list, "Listed by promoter", "Not listed by promoter"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_census,
    labels = names(balance_vars_census),
    group = "promoter_list",
    group.test = TRUE
  )


hh_census_all %>%
  dplyr::filter(
   country == "Malawi",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  feols(
    paste("promoter_list ~", paste(balance_vars_census, collapse = "+")) %>% as.formula,
    cluster = ~ village_id
  ) %>%
  fitstat(type = "f")
```

## Table 5 - Comparison of households using water points covered by the Promoter Survey in Uganda {#tab:hh-selection-ug}

```{r}
hh_census_all %>%
  dplyr::filter(
    country == "Uganda",
    wp_intervention == "DSW",
    promoter_surveyed
  )  %>%
  mutate(
    promoter_list = if_else(promoter_list, "Listed by promoter", "Not listed by promoter"),
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars_census,
    labels = names(balance_vars_census),
    group = "promoter_list",
    group.test = TRUE
  )

hh_census_all %>%
  dplyr::filter(
   country == "Uganda",
    wp_intervention == "DSW",
    promoter_surveyed
  ) %>%
  feols(
    paste("promoter_list ~", paste(balance_vars_census, collapse = "+")) %>% as.formula,
    cluster = ~ village_id
  ) %>%
  fitstat(type = "f")
```

## Table 6 - Comparison of households in Household and Monitoring surveys for Malawi {#tab:balance-mw}

```{r}
matched %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    ),
  ) %>%
  dplyr::filter(country == "Malawi") %>%
  sumtable(
    vars = balance_vars,
    labels = names(balance_vars),
    group = "survey",
    group.test = TRUE
  )
```

## Table 7 - Comparison of households in Household and Monitoring surveys for Malawi {#tab:balance-ug}

```{r}
hh_survey %>%
  dplyr::filter(
    country == "Uganda",
    survey == "Monitoring Survey" | promoter_surveyed,
  )  %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = balance_vars,
    labels = names(balance_vars),
    group = "survey",
    group.test = TRUE
  )

hh_survey %>%
  dplyr::filter(
     country == "Uganda",
     survey == "Monitoring Survey" | promoter_surveyed
  ) %>%
  mutate(survey = survey == "Monitoring Survey") %>%
  feols(
    paste("survey ~", paste(balance_vars, collapse = "+")) %>% as.formula
  ) %>%
  fitstat(type = "f")
```

# Figures 

## Are estimates different?

```{r}
adoption_mon_hh <-
  hh_survey %>%
  bind_rows(mon_survey) %>%
  dplyr::filter(
    wp_intervention == "DSW", 
    sample_group != "ILC"
  ) 
```

```{r}
adoption_mon_hh %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .,
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))
```

## Chlorine detection rates by timing of survey

```{r}
adoption_data <-
  chlorination_data %>%
  group_by(village_id) %>%
  mutate(first_day = date == min(date)) %>%
  ungroup %>%
  dplyr::filter(
    wp_intervention == "DSW", 
    sample_group != "ILC"
  ) %>%
  left_join(
    hh_survey %>% dplyr::select(household_id, any_rank)
  ) %>%
  left_join(
    hh_census %>% dplyr::select(household_id, inclusion)
  )
```

```{r}
p_vals <-
  adoption_data %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "first_day", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

plot <-
  chlorination_data %>%
  dplyr::filter(
    wp_intervention == "DSW", 
    sample_group != "ILC"
  ) %>%
  group_by(country, first_day) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        first_day = .x %>% pull(first_day) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  bind_rows %>%
  mutate(
    label = if_else(
        first_day,
        "Surveyed in the first day of the activity",
        "Surveyed after the first day of the activity"
      ) %>% 
      paste0(" (N = ", N, ")") %>% str_wrap(30),
    across(
      c(mean, ub, lb),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = first_day
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: Standard errors are clustered at the village level. Sample is restricted to villages in the Expansion and Footprint sample groups and includes all households in the Household Survey with valid chlorine tests that used a water point with DSW as their primary source of drinking water." %>%
      paste(
        "The p-value of the difference between estimates is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )


ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-date.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 5,
  units    = "in",
  dpi      = 300
)

plot
```

## Sample selection

```{r}
plot <-
  list(
    "(1) All households" = adoption_data,
    "(2) Using water points in promoter survey" = adoption_data %>% dplyr::filter(promoter_surveyed),
    "(3) In promoter list" = adoption_data %>% dplyr::filter(promoter_surveyed, promoter_list),
    "(4) Randomized into monitoring" = adoption_data %>% dplyr::filter(promoter_surveyed, promoter_list, any_rank)
  ) %>%
  map(
    ~ .x %>% 
      group_by(country) %>%
      group_split()
  ) %>%
  map_depth(
    2,
    ~ mean_cis(
      outcomes = c("disctcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id,
        data = .x,
        nest = TRUE
      )
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
    )
  ) %>%
  map(~ bind_rows(.)) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    sample = sample %>% paste0(" (N = ", N, ")") %>% str_wrap(29),
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = sample,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_wrap(
    ~ country, 
    ncol = 1,
    scale = "free_x"
  ) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: Standard errors are clustered at the village level. Sample is restricted to villages in the Expansion and Footprint sample groups and includes all households in the Household Survey with valid chlorine tests that used a water point with DSW as their primary source of drinking water. Each subsample further restricts the previous one, meaning subsample 4 is contained in sample 3 and so on." %>% 
      str_wrap(120)
  )

plot

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-selection.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 9,
  units    = "in",
  dpi      = 300
)
```

## Sample selection of water points into the Monitoring Survey

```{r}
p_vals <-
  adoption_data %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x, 
      x = "promoter_surveyed", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

plot <-
  adoption_data %>%
  group_by(country, promoter_surveyed) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        promoter_surveyed = .x %>% pull(promoter_surveyed) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  bind_rows %>%
  mutate(
    label = 
      if_else(
        str_detect(promoter_surveyed, "TRUE"),
        "In promoter survey",
        "Not in promoter survey"
      ) %>% 
      paste0(" (N = ", N, ")") %>% str_wrap(20),
    across(
      c(mean, ub, lb),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = ub,
      ymax = lb,
      fill = promoter_surveyed
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: Standard errors are clustered at the village level. Sample is restricted to villages in the Expansion and Footprint sample groups and includes all households in the Household Survey with valid chlorine tests that used a water point with DSW as their primary source of drinking water." %>%
      paste(
        "The p-value of the difference between estimates is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )

plot

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-selection-wp.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 5,
  units    = "in",
  dpi      = 300
)
```

## Villages boundaries

```{r}
p_vals <-
  adoption_data %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x, 
      x = "inclusion", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

plot <-
  adoption_data %>%
  dplyr::filter(!is.na(inclusion)) %>%
  group_by(country, inclusion) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        inclusion = .x %>% pull(inclusion) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  bind_rows %>%
  mutate(
    label = inclusion %>% 
      paste0(" (N = ", N, ")") %>% 
      str_wrap(20),
    across(
      c(mean, ub, lb),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = ub,
      ymax = lb,
      fill = inclusion
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: Standard errors are clustered at the village level. Sample is restricted to villages in the Expansion and Footprint sample groups and includes all households in the Household Survey with valid chlorine tests that used a water point with DSW as their primary source of drinking water." %>%
      paste(
        "The p-value of the difference between estimates is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )

plot

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-boundary.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 5,
  units    = "in",
  dpi      = 300
)
```

## Households living within village boundaries, by survey

```{r}
p_vals <-
  adoption_mon_hh %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x, 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

plot <-
  adoption_mon_hh %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%
  group_by(country, survey) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        survey = .x %>% pull(inclusion) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  bind_rows %>%
  mutate(
    label = survey %>% 
      paste0(" (N = ", N, ")") %>% 
      str_wrap(20),
    across(
      c(mean, ub, lb),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = ub,
      ymax = lb,
      fill = survey
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: Standard errors are clustered at the village level. Sample is restricted to villages in the Expansion and Footprint sample groups and includes all households in the Household Survey with valid chlorine tests that used a water point with DSW as their primary source of drinking water." %>%
      paste(
        "The p-value of the difference between estimates is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )

plot

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-within.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 5,
  units    = "in",
  dpi      = 300
)
```

## Figure 5 - Chlorine detection rates among households using water points included in the Promoter Survey {#fig:promoter-list}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_surveyed), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_surveyed), 
      x = "promoter_list", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = if_else(
        str_detect(term, "TRUE"),
        "Not promoter list",
        "Not in promoter list"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups. Household Survey sample is limited to households that self-report using water points with DSW and whose primary water point is covered by the promoter survey" %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 6 - Chlorine detection rates by interaction with promoter {#fig:int}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_list), 
      x = "int_promoter", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey", promoter_list), 
      x = "int_promoter", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = if_else(
        str_detect(term, "TRUE"),
        "Contacted by promoter",
        "Not contacted by promoter"
      ) %>% 
      paste0(" (N = ", n_obs, ")") %>% str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey that self-report using water points with DSW in all villages in the Expansion and Footprint sample groups and who are listed by the promoter as using that water point." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```



## Figure 7 - Chlorine detection rates among replaced and replacement households {#fig:inhh-replacements}

```{r}
p_vals <-
  by_country %>%
  map(
    ~ marginal_effects(
      data = .x %>%
        group_by(survey, household_id, village_id) %>%
        summarise(
          across(
            c(disctcr_02, replacement_status),
            ~ max(., na.rm = TRUE)
          )
        ), 
      x = "replacement_status",
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

by_country %>%
  map(
    ~ averages(
      data = .x %>%
        group_by(survey, household_id, village_id) %>%
        summarise(
          across(
            c(disctcr_02, replacement_status),
            ~ max(., na.rm = TRUE)
          )
        ),
      x = "replacement_status", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = term %>% 
      str_remove_all("replacement_status") %>%
      paste0(" (N = ", n_obs, ")"),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462"))scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = 'Note: standard errors are clustered at the village level. Sample includes all villages in the Expansion and Footprint sample groups. Household Survey sample ("replaced") is limited to households that self-report using water points with DSW, whose primary water point is covered by the promoter survey, and that were listed by the promoter as using the water point and sampled into the Monitoring Survey. Monitoring Survey sample ("replacement") includes households who are included in the survey as replacements.' %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Figure 8 - Comparision of chlorine detection rates in the Household Survey between households living inside and outside of village boundaries {#fig:boundaries-diff}

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "inclusion", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(survey == "Household Survey"), 
      x = "inclusion", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = str_remove_all(term, "inclusion") %>% 
      paste0(" (N = ", n_obs, ")") %>% 
      str_wrap(20),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey that self-report using water points with DSW in all villages in the Expansion and Footprint sample groups." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```

## Households living within village boundaries, by survey

```{r}
p_vals <-
  hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ marginal_effects(
      data = .x %>% 
        dplyr::filter(str_detect(inclusion, "Within")), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>%
  map(~ tidy(.)) %>%
  bind_rows(.id = "country") %>%
  dplyr::filter(term != "(Intercept)") %>%
  mutate(p.value = p.value %>% round(3))

hh_survey %>%
  group_by(country) %>%
  group_split() %>%
  set_names(c("Malawi", "Uganda")) %>%
  map(
    ~ averages(
      data = .x %>% 
        dplyr::filter(str_detect(inclusion, "Within")), 
      x = "survey", 
      cluster = "village_id"
    )
  ) %>%
  unlist(recursive = FALSE) %>% 
  map(
    ~ tidy_and_attach(., conf.int = TRUE) %>% 
      tidy_add_n
  ) %>%
  bind_rows(.id = "list") %>%
  separate(
    list,
    into = c("country", "test")
  ) %>%
  mutate(
    label = str_remove_all(term, "survey") %>% 
      paste0(" (N = ", n_obs, ")") %>% 
      str_wrap(18),
    across(
      c(estimate, contains("conf")),
      ~ (. * 100) %>% round(1)
    )
  )  %>%
  ggplot(
    aes(
      x = label,
      y = estimate,
      label = estimate %>% paste0("%"),
      ymin = conf.low,
      ymax = conf.high,
      fill = term
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid(~ country, scale = "free_x") +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme(
    legend.position = "none"
  ) + 
  labs(
    x = NULL,
    y = NULL,
    caption = "Note: standard errors are clustered at the village level. Sample includes all households in the Household Survey and Monitoring Surveys who live within village boundaries." %>%
      paste(
        "The p-value of the difference between survey is",
        p_vals %>% dplyr::filter(country == "Malawi") %>% pull(p.value), "in Malawi and",
        p_vals %>% dplyr::filter(country == "Uganda") %>% pull(p.value), "in Uganda."
        ) %>% 
      str_wrap(120)
  )
```
