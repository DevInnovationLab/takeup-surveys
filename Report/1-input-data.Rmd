# Inputs

```{r}
pacman::p_load(
  sf,
  tidyverse,
  viridis,
  fixest,
  janitor,
  broom,
  car,
  modelsummary,
  survey,
  ggh4x
)
```

## Villages

### All villages in admin data

```{r}
villages <-
  read_rds(
      file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "villages.rds"
    )
  ) %>%
  dplyr::filter(!(country == "Uganda" & !dsw))
```

### Sampled villages

- DSW villages were replaced at random (e.g. because of disputed village boundaries or because the village could not be identified under the names in the admin data). Therefore, we remove replaced villages from the analysis
- ILC villages were not replaced at random: these were replaced when no ILC was present in the village or when all of the water collection points were not functioning. Therefore, we consider replaced villages to have zero users.

```{r}
sampled_villages <-
  villages %>%
  dplyr::filter(
    !vil_dropped,
    (sample_group == "ILC" & visited == "In sample") |
    (sample_group != "ILC" & visited == "In sample" & !vil_replaced)
  )

village_intervention <-
  sampled_villages %>%
  crossing(wp_intervention = c("DSW", "ILC")) %>%
  dplyr::filter(!(wp_intervention == "ILC" & sample_group != "ILC")) 
```

## Household census

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  st_drop_geometry() %>%
  # To account for non-responses, we calculate the village-level non-response rate
  group_by(village_id) %>%
  mutate(
    response_rate = mean(response),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    )
  ) %>% 
  ungroup %>%
  dplyr::filter(
    !(sample_group == "ILC" & country == "Uganda")
  )
```

## Household survey

```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(
    survey == "Household Survey"
  ) %>%
  mutate(
    intervention_selfreport = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC"
    ),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    )
  ) %>%
  dplyr::filter(
    !(sample_group == "ILC" & country == "Uganda")
  )
```

## Monitoring survey

```{r}
mon_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(
    survey == "Monitoring Survey"
  ) %>%
  mutate(
    intervention_selfreport = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC"
    ),
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    )
  ) %>%
  dplyr::filter(
    !(sample_group == "ILC" & country == "Uganda")
  )
```

## Water point census

```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry  %>%
  mutate(
    intervention_fo = case_when(
      wp_dsw ~ "DSW",
      wp_ilc ~ "ILC"
    )
  ) %>%
  dplyr::filter(
    !(sample_group == "ILC" & country == "Uganda")
  )
```

## Promoter survey

```{r}
pm_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Final",
      "pm-survey.rds"
    )
  ) %>%
  left_join(villages) %>%
  st_drop_geometry  %>%
  dplyr::filter(
    !(sample_group == "ILC" & country == "Uganda"),
    !vil_replaced,
    !vil_dropped
  )

pm_list <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  ) %>% 
  inner_join(
    wp_census %>%
      dplyr::filter(wp_func) %>%
      transmute(wp_pm = wp_id)
  )
```
