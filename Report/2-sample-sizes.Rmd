# Sample sizes and descriptives

```{r}
pacman::p_load(
  dplyr,
  readr,
  tidyr,
  glue,
  sf,
  tidyverse,
  viridis,
  fixest,
  janitor,
  broom,
  car,
  modelsummary,
  survey,
  here
)
```

## Population

### Summary table

```{r}
evac <-
  villages %>%
  group_by(
    country, sample_group, ea_program_vil
  ) %>%
  summarise(
    districts = n_distinct(district_id),
    villages = n(),
    dsw = sum(dsw_wpt),
    ilc_wpt = sum(ilc_wpt),
    ilc_wcp = sum(ilc_wcp)
  ) %>%
  ungroup 

headers <-
    c(
      " ",
      "Active\ninterventions",
      "Districts",
      "Villages",
      "DSW water\npoints",
      "ILC water\npoints",
      "ILC water\ncollection points"
    )

evac %>%
  select(-country) %>%
  kable(
    format = "html",
    format.args = list(big.mark = ",", decimal.mark = "."),
    col.names = headers
  ) %>%
  kable_paper("striped", full_width = TRUE) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 8)
```

```{r}
table <-
  evac %>%
  select(-country) %>%
  kable(
    format = "latex",
    format.args = list(big.mark = ",", decimal.mark = "."),
    align = "c", 
    booktabs = T,
    escape = F,
    caption = "Summary of Evidence Action administrative data",
    label = "population",
    col.names = linebreak(headers, align = "c")
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 8) %>%
  add_header_above(c(" ", paste0("(", 1:6,")")), line = FALSE)

writeLines(
  table, 
  "output/appendix-tables/population.tex"
)
```


### Water point-level weights

```{r}
wp_sample_sizes <-
  evac %>%
  group_by(country, sample_group) %>%
  summarise(
    DSW = sum(dsw, na.rm = TRUE),
    ILC = sum(ilc_wcp, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(DSW, ILC),
    names_to = "wp_intervention",
    values_to = "pop_points"
  ) %>%
  dplyr::filter(pop_points > 0)

wp_sample_sizes %>%
  kable(
    format = "html",
    format.args = list(big.mark = ",", decimal.mark = ".")
  ) %>%
  kable_paper("striped", full_width = TRUE) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 8)
```

```{r}
sampled_villages <-
  tribble(
    ~ country, ~ sample_group, ~ wp_intervention, ~ sampled_villages,
    "Malawi" , "Expansion"   , "DSW"            , 28,
    "Malawi" , "Footprint"   , "DSW"            , 28,
    "Malawi" , "ILC"         , "DSW"            , 24,
    "Malawi" , "ILC"         , "ILC"            , 46,
    "Uganda" , "Expansion"   , "DSW"            , 30,
    "Uganda" , "Footprint"   , "DSW"            , 30
  ) %>%
  mutate(
    sample_group = 
      factor(
        sample_group, 
        levels = c("Footprint", "Expansion", "ILC"),
        ordered = TRUE
      )
  )
```

```{r}
sample_sizes <-
  villages %>%
  group_by(country, sample_group) %>%
  summarise(
    DSW = sum(dsw, na.rm = TRUE),
    ILC = sum(ilc & country == "Malawi", na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(DSW, ILC),
    names_to = "wp_intervention",
    values_to = "pop_vil"
  ) %>%
  dplyr::filter(pop_vil > 0) %>%
  left_join(sampled_villages)

sample_sizes %>%
  kable(
    format = "html",
    format.args = list(big.mark = ",", decimal.mark = ".")
  ) %>%
  kable_paper("striped", full_width = TRUE) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6)
```

## Uganda

### Villages

```{r}
villages %>%
  dplyr::filter(country == "Uganda") %>%
  summarise(
    Visited = sum(!is.na(vil_replaced)),
    Replaced = sum(vil_replaced, na.rm = TRUE),
    Included = sum(!vil_replaced & !vil_dropped, na.rm = TRUE),
    Footprint = sum(!vil_replaced & !vil_dropped & sample_group == "Footprint", na.rm = TRUE),
    Expansion = sum(!vil_replaced & !vil_dropped & sample_group == "Expansion", na.rm = TRUE)
  )
```

### Water points

```{r}
wp_census %>% 
  dplyr::filter(country == "Uganda") %>%
  summarise(
    All = n(),
    Eligible = sum(analysis, na.rm = TRUE),
    `ILC WPs` = sum(ilc),
    `ILC Villages` = if_else(ilc, village_id, NA) %>% n_distinct(na.rm = TRUE),
    DSW = sum(dsw),
    Matched = sum(dsw & !is.na(ea_id)),
    Unmatched = sum(dsw & is.na(ea_id)),
    `Unmatched with ID` = sum(dsw & is.na(ea_id) & (!is.na(disp_dsw_id) | !is.na(disp_barcode))),
    `Unmatched with no ID` = sum(dsw & is.na(ea_id) & !wp_func)
  )
```
  - \textcolor{red}{11 water points with DSW mapped to sampled villages in the Evidence Action data could not be matched to water points with DSW in our data}.
    - 4 were located, but no longer had dispensers when the water point census took place.
    - 7 are outside of the village boundaries according to the GPS data.
    
### Water samples tested

```{r}
wp_census %>% 
  dplyr::filter(country == "Uganda", dsw, disp_filled) %>%
  summarise(
    `Filled dispensers` = n(),
    Disc = sum(!is.na(disctcr) | !is.na(discfcr)),
    Colorimeter = sum(!is.na(metertcr) | !is.na(meterfcr))
  )
```

### Household census

```{r}
hh_census %>% 
  dplyr::filter(country == "Uganda") %>%
  summarise(
    All = n(),
    Outside = sum(inclusion == "Up to 200m outside of village boundaries"),
    Responses = sum(response),
    `Responses (%)` = Responses/All
  )
```

```{r}
hh_census %>% 
  dplyr::filter(country == "Uganda", response) %>%
  summarise(
    `WP matched` = sum(!is.na(wp_id)),
    `WP matched (%)` = mean(!is.na(wp_id)),
    `DSW users` = sum(wp_dsw, na.rm = TRUE),
    `DSW users (%)` = mean(wp_dsw, na.rm = TRUE),
    Outside = sum(inclusion == "Up to 200m outside of village boundaries"),
    Responses = sum(response)
  )
```

### Household survey

```{r}
hh_survey %>% 
  dplyr::filter(country == "Uganda") %>%
  summarise(
    All = n(),
    DSW = sum(wp_dsw, na.rm = TRUE),
    `DSW (%)` = DSW/All,
    `Non-program (%)` = sum(wp_intervention == "Non-program", na.rm = TRUE)/All,
    `No WP (%)` = sum(is.na(wp_id), na.rm = TRUE)/All,
    `Water sample` = sum(water_sample, na.rm = TRUE),
    `Water sample (% DSW)` = `Water sample`/DSW,
    `Color wheel` = sum(!is.na(disctcr) | !is.na(discfcr)),
    Colorimeter = sum(!is.na(metertcr) | !is.na(meterfcr))
  )
```

### Promoter survey

```{r}
pm_survey %>%
  dplyr::filter(country == "Uganda", sample_group != "ILC") %>%
  nrow
```

```{r}
wp_census %>%
  dplyr::filter(country == "Uganda", wp_id %in% pm_survey$wp_id) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
wp_census %>%
  dplyr::filter(country == "Uganda", sample_group != "ILC", dsw) %>%
  summarise(mean(promoter_surveyed))
```

```{r}
wp_census %>%
  dplyr::filter(country == "Uganda", sample_group != "ILC", wp_id %in% pm_survey$wp_id) %>%
  group_by(intervention) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
wp_census %>%
  dplyr::filter(country == "Uganda", wp_id %in% pm_survey$wp_id, pm_ea_list) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
wp_census %>%
  dplyr::filter(country == "Uganda") %>%
  group_by(pm_ea_list) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
mon_survey %>%
  dplyr::filter(country == "Uganda", sample_group != "ILC") %>%
  nrow
```


## Malawi

### Villages

```{r}
villages %>%
  dplyr::filter(country == "Malawi") %>%
  summarise(
    Visited = sum(!is.na(vil_replaced)),
    Replaced = sum(vil_replaced, na.rm = TRUE),
    Included = sum(!vil_replaced & !vil_dropped, na.rm = TRUE),
    Footprint = sum(!vil_replaced & !vil_dropped & sample_group == "Footprint", na.rm = TRUE),
    Expansion = sum(!vil_replaced & !vil_dropped & sample_group == "Expansion", na.rm = TRUE),
    ILC = sum(!vil_replaced & !vil_dropped & sample_group == "ILC", na.rm = TRUE)
  )
```

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", sample_group == "ILC") %>%
  group_by(village_id) %>%
  summarise(
    ILC = any(ilc_wcp),
    DSW = any(dsw),
    `ILC & DSW` = ILC & DSW
  ) %>%
  ungroup %>%
  summarise(
    across(
      -village_id,
      ~ sum(.)
    )
  )
```

### ILC villages

With ILC water collection points

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", ilc_wcp) %>%
  summarise(
    WCPs = n(),
    Villages = n_distinct(village_id)
  ) %>%
  kable
```

With DSW

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", dsw, sample_group == "ILC") %>%
  summarise(
    WPs = n(),
    Villages = n_distinct(village_id)
  ) %>%
  kable
```
### Water point census

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", dsw) %>%
  summarise(
    All = n(),
    `ILC sample group` = sum(sample_group == "ILC"),
     Matched = sum(dsw & !is.na(ea_id)),
    Unmatched = sum(dsw & is.na(ea_id)),
    `Unmatched with ID` = sum(dsw & is.na(ea_id) & (!is.na(disp_dsw_id) | !is.na(disp_barcode)))
  )
```

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", ilc, !is.na(ea_ilc_wpt)) %>%
  summarise(
    Clusters = n_distinct(ea_ilc_wpt),
    WP = sum(ilc_wp),
    WCP = sum(ilc_wcp)
  )
```

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", ilc) %>%
  group_by(ea_ilc_wpt) %>%
  summarise(
    Tested = any(!is.na(disctcr)),
    Closer = sum(closer),
    `Closer tested` = sum((!is.na(disctcr) | is.na(discfcr)) & closer),
    Count = sum(!is.na(disctcr))
  ) %>%
  summarise(
    across(
      -ea_ilc_wpt,
      ~sum(.)
    )
  )
```

### Household census

```{r}
hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  summarise(
    Listed = n(),
    Surveyed = sum(response),
    `Surveyed (%)` = Surveyed/Listed,
    DSW = sum(wp_dsw, na.rm = TRUE),
    `DSW (%)` = DSW/Surveyed,
    ILC = sum(wp_ilc, na.rm = TRUE),
    `ILC (%)` = ILC/Surveyed
  ) %>%
  kable
```

### Household survey

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  summarise(
    Total = n(),
    Villages = n_distinct(village_id),
    `Water available` = sum(water_sample),
    Tested = sum(!is.na(disctcr) | !is.na(discfcr))
  ) %>%
  kable
```

### Promoter survey

```{r}
pm_survey %>%
  dplyr::filter(country == "Malawi") %>%
  nrow
```

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", wp_id %in% pm_survey$wp_id) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", wp_id %in% pm_survey$wp_id) %>%
  group_by(intervention, sample_group) %>%
  summarise(sum(promoter_surveyed))
```

```{r}
mon_survey %>%
  dplyr::filter(country == "Malawi") %>%
  nrow
```
## Descriptive statistics

### Average village sizes

```{r}
hh_census %>%
  group_by(village_id, country, sample_group) %>%
  summarise(size = n()) %>%
  group_by(country, sample_group) %>%
  summarise(mean(size))
```
### Households living inside the village

```{r}
hh_census %>%
  group_by(country, sample_group) %>%
  summarise(within = mean(inclusion == "Within village boundaries"))
```

### Households using water points inside the village

```{r}
hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(wp_source, sample_group) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting()
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda") %>%
  tabyl(wp_source, sample_group) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting()
```

### Use of water points served by Evidence Action

```{r}
hh_census %>%
  tabyl(country, wp_intervention) %>%
  adorn_percentages() %>%
  adorn_pct_formatting()
```
```{r}
hh_census %>%
  dplyr::filter(country == "Uganda") %>%
  tabyl(wp_intervention, sample_group) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting()
```
```{r}
hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(wp_intervention, sample_group) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting()
```

### Number of water sources

```{r}
hh_census <-
  hh_census %>%
  mutate(
    wp_single = wp_count_pastmonth == 1,
    wp_nonprogram = wp_intervention == "Non-program",
    wp_intervention = fct_relevel(wp_intervention, "Non-program")
  )

hh_census %>%
  dplyr::filter(!wp_nonprogram) %>%
  summarise(
    single = mean(wp_single, na.rm = TRUE),
    av_count = if_else(!wp_single, wp_count_pastmonth, NA) %>% mean(na.rm = TRUE)
  )
```

```{r}
hh_census %>%
  dplyr::filter(!wp_nonprogram) %>%
  group_by(country, sample_group) %>%
  summarise(
    mean = mean(wp_secweek, na.rm = TRUE)
  )
```

Difference between interventions

```{r}
feols(
  wp_single ~ wp_nonprogram | sample_group + country,
  data = hh_census,
  cluster = ~ village_id
)
```

No difference between countries

```{r}
feols(
  wp_single ~ country | sample_group + wp_intervention,
  data = hh_census %>% dplyr::filter(!wp_nonprogram),
  cluster = ~ village_id
)
```

No difference between groups in Uganda

```{r}
feols(
  wp_single ~ sample_group | wp_intervention,
  data = hh_census %>% dplyr::filter(country == "Uganda"),
  cluster = ~ village_id
)
```







### Average household size

```{r}
hh_census %>%
  group_by(country, sample_group) %>%
  summarise(
    mean = mean(hh_members, na.rm = TRUE)
  )
```

```{r}
feols(
  hh_members ~ country | sample_group,
  data = hh_census,
  cluster = ~ village_id
)
```

```{r}
feols(
  hh_members ~ sample_group,
  data = hh_census %>% dplyr::filter(country == "Malawi"),
  cluster = ~ village_id
)
```

```{r}
feols(
  hh_members ~ dsw | country,
  data = hh_census %>% dplyr::filter(sample_group == "Expansion"),
  cluster = ~ village_id
)
```

```{r}
feols(
  hh_members ~ dsw | country,
  data = hh_census %>% dplyr::filter(sample_group == "Footprint"),
  cluster = ~ village_id
)
```



```{r}
feols(
  hh_members ~ wp_intervention | country,
  data = hh_census %>% dplyr::filter(sample_group == "ILC") %>% mutate(wp_intervention = fct_relevel(wp_intervention, "Non-program")),
  cluster = ~ village_id
)
```