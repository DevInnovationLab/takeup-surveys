# Sample sizes

```{r}
pacman::p_load(
  dplyr,
  readr,
  tidyr,
  glue,
  sf,
  tidyverse,
  viridis,
  fixest,
  janitor,
  broom,
  car,
  modelsummary,
  survey,
  here
)
```

## Uganda

- `r villages %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(vil_replaced)) %>% nrow` villages were visited.
  - `r villages %>% dplyr::filter(country == "Uganda", sample_group != "ILC", vil_replaced) %>% nrow` villages were replaced, one because no dispensers were found, and the other three because the field team observed upon arrival that the chairpeople or the promoters had been informed about the surveys in advance.
  - `r villages %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !vil_replaced) %>% nrow` are included in our analysis
    - `r villages %>% dplyr::filter(country == "Uganda", sample_group == "Footprint", !vil_replaced) %>% nrow` of these were from the Footprint sample group, and `r villages %>% dplyr::filter(country == "Uganda", sample_group == "Expansion", !vil_replaced) %>% nrow` from the Expansion sample group.
- `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC") %>% nrow` water points were identified in these villages.
  - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", analysis) %>% nrow` were used for drinking by more than one household, and therefore eligible to be included in the water point census.
  - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", ilc) %>% nrow` water points from `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", ilc) %>% pull(village_id) %>% n_distinct` distinct villages were served by ILC. These water points are excluded from our analysis. 
- The field team identified `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw) %>% nrow` water points with DSW.\footnote\textcolor{red}The correspondence between water point census IDs and Evidence Action IDs can be found in \href{this document}{https://docs.google.com/spreadsheets/d/1Nb_ZgIIEIxLdFtRAb-BdVcoQGqHqXLKBGduU_um9BeA/edit?pli=1&gid=1590291999#gid=1590291999}.} 
  - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw, !is.na(ea_id)) %>% nrow` were matched to the Evidence Action data using dispensersâ€™ IDs and GPS location
  - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw, is.na(ea_id)) %>% nrow` could not be matched to water points in the Evidence Action data
    - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw, is.na(ea_id), !is.na(disp_dsw_id) | !is.na(disp_barcode)) %>% nrow` had pictures available from the water point census which confirmed their presence. The field team also took pictures of the barcodes so the dispensers could be identified.
    - `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw, is.na(ea_id), !wp_func) %>% nrow` were installed in non-functional water points and data on dispenser identification was not collected.
  - \textcolor{red}{11 water points with DSW mapped to sampled villages in the Evidence Action data could not be matched to water points with DSW in our data}.
    - 4 were located, but no longer had dispensers when the water point census took place.
    - 7 are outside of the village boundaries according to the GPS data.
  - Treated water from all `r wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw, disp_filled) %>% nrow` water points with DSW where the dispenser was dispensing chlorine were tested with both a colorimeter and a color wheel.
- A total of `r hh_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC") %>% nrow %>% format(big.mark = ",")` households were listed in these villages.
  - `r hh_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", inclusion == "Up to 200m outside of village boundaries") %>% nrow %>% format(big.mark = ",")` of them lived up to 200m outside of village boundaries.
  - `r hh_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", response) %>% nrow %>% format(big.mark = ",")` of the listed households were surveyed in the household census.
    - `r hh_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", response, wp_dsw) %>% nrow %>% format(big.mark = ",")` (`r (hh_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", response) %>% pull(wp_dsw) %>% mean(na.rm = TRUE) %>% round(3)) * 100`%) of these used water points with DSW as their primary source of drinking water.
- `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC") %>% nrow %>% format(big.mark = ",")` households were surveyed as part of the household survey.
  - `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", wp_dsw) %>% nrow %>% format(big.mark = ",")` were using water points that were confirmed to have DSW (the remaining could not be verified). Our main estimates of chlorine adoption include only these households, \textcolor{red}{although we also report estimates will all households surveyed in the sensitivity analysis}.
  - `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC") %>% nrow %>% format(big.mark = ",")` of the households surveyed (and `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", wp_dsw) %>% nrow %>% format(big.mark = ",")` of those using water points that were confirmed to have DSW) had drinking water available at the time of the survey.
  - A total of `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(disctcr_02)) %>% nrow %>% format(big.mark = ",")` color wheel and `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(metertcr_02)) %>% nrow %>% format(big.mark = ",")` colorimeter tests were conducted (`r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(disctcr_02), wp_dsw) %>% nrow %>% format(big.mark = ",")` and `r hh_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(metertcr_02), wp_dsw) %>% nrow %>% format(big.mark = ",")` of which are included in our main estimate, respectively)
- \textcolor{red}{117 promoter surveys were conducted}, representing `r (117/(wp_census %>% dplyr::filter(country == "Uganda", sample_group != "ILC", dsw) %>% nrow) * 100) %>% round(1)`% of the water points with DSW identified
  - Evidence Action provided information for \textcolor{red}{119} promoters responsible for \textcolor{red}{118} unique water points. All of these water points are included in the water point census, and promoter surveys were conducted in  \textcolor{red}{110} (\textcolor{red}{`r (10000/118) %>% round(1)`%}) of them.
  - The field team also identified another \textcolor{red}{7} promoters for water points that were not included the Evidence Action contact list.
  - \textcolor{red}{1} of the promoters was responsible for a water points that is no longer being served by DSW. \textcolor{red}{Observations linked to this water point is not included in our analysis.}
- `r mon_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC") %>% nrow %>% format(big.mark = ",")` households listed by promoters as using water points with ILC completed the household survey.
  - `r mon_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", wp_dsw) %>% nrow %>% format(big.mark = ",")` of them report using a water point with DSW as their primary source of drinking water.
  - `r mon_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", water_sample) %>% nrow %>% format(big.mark = ",")` of them had water available in the household at the time of the survey
  - `r mon_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(disctcr_02)) %>% nrow %>% format(big.mark = ",")` had the water sample tested with a color wheel, and `r mon_survey %>% dplyr::filter(country == "Uganda", sample_group != "ILC", !is.na(metertcr_02)) %>% nrow %>% format(big.mark = ",")` with a colorimeter
  
## Malawi

```{r}
mw_villages <-
  wp_census %>% 
  dplyr::filter(country == "Malawi") %>%
  pull(village_id) %>%
  n_distinct()

mw_foot_villages <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "Footprint") %>%
  pull(village_id) %>%
  n_distinct()

mw_exp_villages <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "Expansion") %>%
  pull(village_id) %>%
  n_distinct()

mw_ilc_villages <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC") %>%
  pull(village_id) %>%
  n_distinct()

mw_ilc_villages_ilc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", ilc) %>%
  pull(village_id) %>%
  n_distinct()

mw_ilc_villages_ilc_func <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", ilc, wp_func) %>%
  pull(village_id) %>%
  n_distinct()

mw_ilc_villages_wcpnotfunc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", ilc_wcp) %>%
  group_by(village_id) %>%
  dplyr::filter(!any(wp_func)) %>%
  ungroup %>%
  summarise(
    villages = n_distinct(village_id),
    wps = n()
  )

mw_ilc_villages_wcpnotfunc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", ilc_wp) %>%
  group_by(village_id) %>%
  dplyr::filter(!any(wp_func)) %>%
  ungroup %>%
  summarise(
    villages = n_distinct(village_id),
    wps = n()
  )

mw_ilc_villages_dsw <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", dsw) %>%
  pull(village_id) %>%
  n_distinct()
```




```{r}
mw_dsw_wps <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw) %>%
  nrow

mw_dsw_wps_ilc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", sample_group == "ILC", dsw) %>%
  nrow

mw_dsw_wps_ea <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw, !is.na(ea_id)) %>%
  nrow

mw_dsw_wps_barcode <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw, is.na(ea_id), !is.na(disp_barcode)) %>%
  nrow

mw_dsw_wps_chlorine <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw, disp_filled) %>%
  nrow

mw_dsw_wps_disc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw, disp_filled, !is.na(disctcr_02)) %>%
  nrow

mw_dsw_wps_meter <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", dsw, disp_filled, !is.na(metertcr_02)) %>%
  nrow
```

```{r}
mw_ilc_wps <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", ilc_wp) %>%
  nrow

mw_ilc_wcps <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", ilc_wcp) %>%
  nrow

mw_ilc_clusters <-
  wp_census %>% 
  dplyr::filter(country == "Malawi") %>%
  pull(ea_ilc_wpt) %>%
  n_distinct

mw_ilc_clusters <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", !is.na(ea_ilc_wpt), ilc_wcp) %>%
  group_by(ea_ilc_wpt) %>%
  summarise(
    wcp = n(), 
    village = n_distinct(village_id)
  ) %>%
  summarise(
    across(
      everything(),
      ~ max(.)
    )
  )

mw_ilc_wcp_disc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", ilc_wcp, !is.na(discid)) %>%
  nrow

mw_ilc_wcp_meter <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", ilc_wcp, !is.na(meterid)) %>%
  nrow

mw_ilc_cluster_disc <-
  wp_census %>% 
  dplyr::filter(country == "Malawi", ilc, !is.na(discid)) %>%
  pull(ea_ilc_wpt) %>%
  n_distinct
```

```{r}
mw_hhc <-
  hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  nrow

hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(inclusion)

hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(response)

hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(sample_group)

hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(wp_intervention)

hh_census %>%
  dplyr::filter(country == "Malawi", wp_dsw) %>%
  tabyl(sample_group)
```
```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(sample_group) %>%
  adorn_totals()

hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  pull(village_id) %>%
  n_distinct()
```

```{r}
villages %>%
  tabyl(country, dsw)
```


```{r}
villages %>%
  dplyr::filter(country == "Uganda") %>%
  pull(district) %>%
  n_distinct()
```
### ILC villages

With ILC water collection points

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", ilc_wcp) %>%
  summarise(
    WCPs = n(),
    Villages = n_distinct(village_id)
  ) %>%
  kable
```

With DSW

```{r}
wp_census %>%
  dplyr::filter(country == "Malawi", dsw, sample_group == "ILC") %>%
  summarise(
    WPs = n(),
    Villages = n_distinct(village_id)
  ) %>%
  kable
```

### Household census

```{r}
hh_census %>%
  dplyr::filter(country == "Malawi") %>%
  summarise(
    Listed = n(),
    Surveyed = sum(response),
    DSW = sum(wp_dsw, na.rm = TRUE),
    ILC = sum(wp_ilc, na.rm = TRUE)
  ) %>%
  kable
```

### Household survey

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  summarise(
    Total = n(),
    Villages = n_distinct(village_id),
    `Water available` = sum(water_sample),
    Tested = sum(!is.na(disctcr_02))
  ) %>%
  kable
```