# Inputs

```{r}
pacman::p_load(
  sf,
  tidyverse,
  viridis,
  fixest,
  janitor,
  broom,
  car,
  modelsummary,
  survey
)
```

## People using DSW/ILC water points

### Prepare data

To calculate the number of people using water points with DSW or ILC, we use self-reported data from the household census on what is the household's primary water point. This information is combined with data from the water point census to determine whether these water points are served by DSW or ILC.

We start by restricting the household census data to households using water points with DSW or ILC located inside the sampled villages. We also exclude households using ILC in Uganda because we did not design the survey to be representative of this population.

```{r}
users_data <-
  hh_census %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    wp_invillage,
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) 
```

The relevant variable to calculate the number of people using water points with DSW or ILC is the number of people living in households that report their primary water source has DSW or ILC. Due to a coding mistake, this variable was not collected in the first few days of data collection in Uganda. Therefore, we need to impute values for the households where this information is missing.

```{r}
users_data %>% 
  dplyr::filter(!is.na(wp_intervention_type), is.na(hh_members)) %>%
  tabyl(date, country) %>%
  adorn_totals()
```

There are 8 villages in Uganda with no observations for this variable, so we cannot impute it as the village average. Therefore, we impute it are the sample group level. 

```{r}
users_data <-
  users_data %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  )
```

To account for the villages where all the water points with ILC were out of order, we add them to the data, but with zero households using water points with ILC.

```{r}
users_data <-
  users_data %>%
  full_join(
    village_intervention %>% 
      select(village_id, country, sample_group, wp_intervention)
  ) %>%
  mutate(
    hh_members = replace_na(hh_members, 0)
  )
```

Since the unit of reference for our analysis is the village, we calculate the number of people whose primary water source has DSW or ILC by adding the number of household members across all such households in a village.

```{r}
users_village <-
  users_data %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  )
```

To scale to the country level, we combine this data with the number of sampled villages and the number of villages in the admin data per group.

```{r}
users_village <-
  users_village %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group) %>%
  mutate(
    weight = n_villages/n_distinct(village_id)
  ) %>%
  ungroup
```

There is one village in Malawi with only one household using ILC:

```{r}
users_village %>%
  dplyr::filter(hhs == 1)
```

To simplify the calculation of standard errors, we remove it from the estimates. 

```{r}
users_village <-
  users_village %>%
  dplyr::filter(hhs > 1)
```

### Sanity check

Here we just calculate the total number of people without CIs. The point estimate should be the same as the one calculated with a canned function.

```{r}
users_village %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    n = n_distinct(village_id),
    hhs = mean(hhs),
    av_people = mean(users),
    av_people_non = mean(users_increased),
    sampled_villages = unique(sampled_villages),
    vil_weight = n/sampled_villages,
    group_weight = unique(n_villages)
  ) %>%
  mutate(
    total_people = round(av_people * group_weight * vil_weight),
    total_people_non = round(av_people_non * group_weight * vil_weight)
  )
```

### With CIs

We the total number of users per sample group and the confidence intervals around this number using the package `survey` to adjust standard errors for the survey design.

```{r}
people_per_group <-
  map(
    users_village %>%
      group_by(country, sample_group, wp_intervention) %>%
      group_split(),
    ~ total_cis(
        outcomes = c("users", "users_increased"),
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        weight = .x %>% pull(weight) %>% unique
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, sample_group, wp_intervention, 
    outcome, 
    villages, weight, 
    everything()
  ) %>%
  arrange(outcome)

people_per_group
```

```{r}
people_per_country <-
  map(
    users_village %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_cis(
        outcomes = c("users", "users_increased"),
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)

people_per_country
```

group_total_increased <-
  map(
    users_village %>%
      group_by(country, sample_group, wp_intervention) %>%
      group_split(),
    ~ total_cis(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = ., 
          weights = ~ weight
        )
      )
  ) %>% 
    bind_rows() 

country_total <-
  map(
    users_village %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_cis(
        var = "users",
        design = svydesign(
            id = ~ village_id,
            data = ., 
            weights = ~ weight
          )
      )
  ) %>% 
    bind_rows()

country_total_increased <-
  map(
    users_village %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_cis(
        var = "users_increased",
        design = svydesign(
            id = ~ village_id,
            data = ., 
            weights = ~ weight
          )
      )
  ) %>% 
    bind_rows()
```

```{r}
group_total %>%
  left_join(group_total_increased)
  bind_rows(
    country_total %>% left_join(country_total_increased)
  ) %>%
  mutate(
    across(
      c(total, lb, ub),
      ~ round(.) %>% format(big.mark = ",")
    ),
    ci = paste0("(", lb,", ", ub, ")"),
    sample_group = sample_group %>%
      factor(
        levels = c("Footprint", "Expansion", "ILC", "Total"),
        ordered = TRUE
      )
  ) %>%
  arrange(country, sample_group, wp_intervention) %>%
  select(
    sample_group, wp_intervention, total, ci
  ) %>%
  kable(
    col.names = c(
      "Village group",
      "Intervention",
      "Country estimate",
      "95% CI"
    ),
    format = "html",
    align = "c"
  ) %>%
  pack_rows("Malawi", 1, 5) %>%
  pack_rows("Uganda", 6, 8)  %>%
  kable_paper("striped", full_width = F)
```

## Chlorine detection rates

```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(
    survey == "Household Survey",
    wp_intervention_type != "Non-program",
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(village_id) %>%
  ungroup %>%
  left_join(
    hh_census %>%
      group_by(
        village_id,
        wp_intervention
      ) %>%
      summarise(pop_users = n_distinct(household_id))
  )
```

### Sanity check

```{r}
hh_survey %>%
  group_by(village_id, sample_group, wp_intervention_type, country) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    )
  ) %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_survey %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    )
  )
```

### With CIs

```{r}
hh_survey_grouped <-
  hh_survey  %>%
  group_by(village_id) %>%
  mutate(
    weight_equal = n_distinct(household_id)/20,
    weight_users = n_distinct(household_id)/pop_users,
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  group_split
```

```{r}
treatment <-
  hh_survey_grouped %>%
  map(
    ~ mean_ci(
        var = "disctcr_02",
        dummy = TRUE,
        design = svydesign(
          id = ~ village_id + household_id,      # PSU (here: villages)
          data = .x,
          prob = ~ weight_equal,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
  ) %>%
  bind_rows %>%
  select(country, sample_group, wp_intervention, mean, lb, ub)

treatment
```

```{r}
hh_survey_grouped %>%
  map(
    ~ mean_ci(
        var = "disctcr_02",
        dummy = TRUE,
        design = svydesign(
          id = ~ village_id + household_id,      # PSU (here: villages)
          data = .x,
          prob = ~ weight_users,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
  ) %>%
  bind_rows %>%
  select(country, sample_group, wp_intervention, mean, lb, ub)
```

```{r}
hh_survey_grouped %>%
  map(
    ~ mean_ci(
        var = "disctcr_02",
        dummy = TRUE,
        design = svydesign(
          id = ~ village_id + household_id,      # PSU (here: villages)
          data = .x,
          prob = ~ weight_users,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_type) %>% unique
      )
  ) %>%
  bind_rows %>%
  select(country, sample_group, wp_intervention, mean, lb, ub)
```



```{r warning = FALSE}
hh_survey_grouped <-
  hh_survey %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(village_id, wp_intervention) %>%
  dplyr::filter(n() > 1) %>%
  group_by(country, sample_group, wp_intervention) %>%
  group_split
  
treatment <-
  hh_survey_grouped %>%
  map(
    ~ village_mean_ci(
      data = .x,
      outcomes = c("watertreat_dispcl", test_vars),
      dummy = TRUE
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
  ) %>%
  bind_rows %>%
  mutate(
    outcome = outcome %>%
      factor(
        levels = c(
          "watertreat_dispcl",
          "disctcr_02", "metertcr_02", "metertcr_01",
          "discfcr_02", "meterfcr_02", "meterfcr_01"
        ),
        ordered = TRUE
      )
  )

treatment %>%
  mutate(
    mean = round(mean * 100, 1) %>% as.character,
    ci = paste0("(", round(lb * 100, 1),", ", round(ub * 100, 1), ")")
  ) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  select(country, outcome, sample_group, wp_intervention, name, value) %>%
  pivot_wider(
    values_from = value,
    names_from = outcome
  ) %>%
  mutate(
    across(
      c(sample_group, wp_intervention),
      ~ if_else(name == "ci", "", .)
    )
  ) %>%
  select(
    sample_group, 
    wp_intervention,
    watertreat_dispcl,
    disctcr_02, discfcr_02,
    metertcr_02, meterfcr_02,
    metertcr_01, meterfcr_01
  ) %>%
  kable(
    col.names = c(
      "Village group",
      "Intervention",
      "Self-report",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.1 ppm", "FCR >= 0.1 ppm"
    ),
    format = "html",
    align = "c"
  ) %>%
  pack_rows("Malawi", 1, 8) %>%
  pack_rows("Uganda", 9, 12) %>%
  add_header_above(c(" " = 3, "Color disc" = 2, "Colorimeter" = 4)) %>%
  kable_paper("striped", full_width = TRUE) %>%
  footnote(general = "Sample considers only households using water points with DSW as their primary water points in Expansion and Footprint villages, and only households using water points with ILC as their primary water points in ILC villages.")
```

```{r warning = FALSE}
hh_survey_grouped <-
  hh_survey %>%
  dplyr::filter(
    wp_intervention != "Non-program",
    !(wp_intervention == "ILC" & sample_group != "ILC")
  ) %>%
  group_by(village_id, wp_intervention) %>%
  dplyr::filter(n() > 1) %>%
  group_by(country, wp_intervention) %>%
  group_split
  
treatment <-
  hh_survey_grouped %>%
  map(
    ~ village_mean_ci(
      data = .x,
      outcomes = c("watertreat_dispcl", test_vars),
      dummy = TRUE
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
  ) %>%
  bind_rows %>%
  mutate(
    outcome = outcome %>%
      factor(
        levels = c(
          "watertreat_dispcl",
          "disctcr_02", "metertcr_02", "metertcr_01",
          "discfcr_02", "meterfcr_02", "meterfcr_01"
        ),
        ordered = TRUE
      )
  )

treatment %>%
  mutate(
    mean = round(mean * 100, 1) %>% as.character,
    ci = paste0("(", round(lb * 100, 1),", ", round(ub * 100, 1), ")")
  ) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  select(country, outcome, wp_intervention, name, value) %>%
  pivot_wider(
    values_from = value,
    names_from = outcome
  ) %>%
  mutate(sample_group = if_else(name == "ci", "", wp_intervention)) %>%
  select(
    sample_group, 
    watertreat_dispcl,
    disctcr_02, discfcr_02,
    metertcr_02, meterfcr_02,
    metertcr_01, meterfcr_01
  ) %>%
  kable(
    col.names = c(
      "Village group",
      "Self-report",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.1 ppm", "FCR >= 0.1 ppm"
    ),
    format = "html",
    align = "c"
  ) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(c(" " = 2, "Color disc" = 2, "Colorimeter" = 4)) %>%
  kable_paper("striped", full_width = F) %>%
  footnote(general = "Sample considers only households using water points with DSW as their primary water points in Expansion and Footprint villages, and only households using water points with ILC as their primary water points in ILC villages.")
```

```{r warning = FALSE}
hh_survey_grouped <-
  hh_survey %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    !(wp_intervention_type == "DSW" & sample_group == "ILC"),
    !(str_detect(wp_intervention_type, "ILC") & sample_group == "DSW"),
    sample_group != "ILC"
  ) %>%
  group_by(village_id) %>%
  dplyr::filter(n() > 1) %>%
  group_by(country, sample_group) %>%
  group_split
  
treatment <-
  hh_survey_grouped %>%
  map(
    ~ village_mean_ci(
      data = .x,
      outcomes = c("watertreat_dispcl", test_vars),
      dummy = TRUE
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique
      )
  ) %>%
  bind_rows %>%
  mutate(
    outcome = outcome %>%
      factor(
        levels = c(
          "watertreat_dispcl",
          "disctcr_02", "metertcr_02", "metertcr_01",
          "discfcr_02", "meterfcr_02", "meterfcr_01"
        ),
        ordered = TRUE
      )
  )

treatment %>%
  mutate(
    mean = round(mean * 100, 1) %>% as.character,
    ci = paste0("(", round(lb * 100, 1),", ", round(ub * 100, 1), ")")
  ) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  select(country, outcome, sample_group, name, value) %>%
  pivot_wider(
    values_from = value,
    names_from = outcome
  ) %>%
  mutate(sample_group = if_else(name == "ci", "", sample_group)) %>%
  select(
    sample_group, 
    watertreat_dispcl,
    disctcr_02, discfcr_02,
    metertcr_02, meterfcr_02,
    metertcr_01, meterfcr_01
  ) %>%
  kable(
    col.names = c(
      "Village group",
      "Self-report",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.2 ppm", "FCR >= 0.2 ppm",
      "TCR >= 0.1 ppm", "FCR >= 0.1 ppm"
    ),
    format = "html",
    align = "c"
  ) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 8) %>%
  add_header_above(c(" " = 2, "Color disc" = 2, "Colorimeter" = 4)) %>%
  kable_paper("striped", full_width = F) %>%
  footnote(general = "Sample considers only households using water points with DSW as their primary water points in Expansion and Footprint villages, and only households using water points with ILC as their primary water points in ILC villages.")
```


