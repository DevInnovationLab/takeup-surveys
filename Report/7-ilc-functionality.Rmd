# ILC water points


```{r}
pacman::p_load(
  tidyverse,
  sf,
  janitor
)
```

```{r}
ilc_villages <-
  wp_census %>%
  dplyr::filter(
    country == "Malawi",
    sample_group == "ILC"
  )
```

## Clusters

```{r}
cluster_data <-
  ilc_villages %>%
  group_by(ea_ilc_wpt) %>%
  summarise(
    wp_id = if_else(ilc_wp, wp_id, NA) %>% na.omit %>% paste0(., collapse = "; ") %>% str_trim,
    wp_functional = any(wp_func, na.rm = TRUE),
    ilcdevice_func = any(ilc_devicefunc, na.rm = TRUE),
    wcps = sum(ilc_wcp)
  )
```

## Functionality table


```{r}
wp <-
  data.frame(
    "type" = "Water points",
    "N" = 31,
    "communal" = 27,
    "func_available" = 29,
    "functional" = 24,
    "functional_pct" = 24/29,
    "presence_available" = 25,
    "presence" = 23,
    "presence_pct" = 23/25,
    "devfunc_available" = 18,
    "devfunc" = 16,
    "devfunc_pct" = 16/18
  )

wcp <-
  ilc_villages %>%
  dplyr::filter(ilc_wcp) %>%
  summarise(
    type = "Water collection points",
    N = 176,
    communal = 171,
    func_available = sum(!is.na(wp_func)),
    functional = sum(wp_func, na.rm = TRUE),
    functional_pct = functional/func_available,
    presence_available = 163,
    presence = 161,
    presence_pct = presence/presence_available,
    devfunc_available = 150,
    devfunc = 100,
    devfunc_pct = devfunc/devfunc_available
  ) 

table <-
  wp %>%
  bind_rows(wcp) %>%
  mutate(
    across(
      ends_with("pct"),
      ~ paste0("(", round(. * 100, 1), "%)")
    )
  ) %>%
  mutate(
    functional = paste(functional, functional_pct),
    presence = paste(presence, presence_pct),
    devfunc = paste(devfunc, devfunc_pct)
  ) %>%
  select(-ends_with("pct")) %>%
  set_names(
    c(" ", "N", "Communal", "Observed", "Functional", "Observed", "Present", "Observed", "Functional")
  )
```

```{r}
footnote_text <-
  "Some of the water points for observed clusters were located far from the villages sampled, and are not observed in our data. However, functionality can be inferred for these cases when we observe at least one functional water collection point. Data on ILC device presence and functionality was sometimes obtained from an operator or vilalge guide when the water point was not visited or could not be observed from the ground. These survey protocols result in non-measurable noise in the percentages presented in the table."

kable(
  table, 
  format = "latex",
  caption = "ILC functionality indicators",
  label = "ilc-func",
  align = "c", 
  booktabs = T
) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  add_header_above(
    c(
      " " = 3, 
      "Water point functionality" = 2,
      "ILC device presence" = 2,
      "ILC device functionality" = 2
    )
  ) %>%
  add_header_above(c(" ", paste0("(", 1:8,")")), line = FALSE) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  writeLines(
    "output/tables/ilc-func.tex"
  )

kable(
  table, 
  format = "html",
  caption = "ILC functionality indicators"
) %>%
  kable_paper("striped", full_width = TRUE) %>%
  add_header_above(
    c(
      " " = 3, 
      "Water point functionality" = 2,
      "ILC device presence" = 2,
      "ILC device functionality" = 2
    )
  ) %>%
  add_header_above(c(" ", paste0("(", 1:8,")")), line = FALSE) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  )
```


## Chlorination

```{r}
table <-
  list(
    "All water collection points" = ilc_villages %>% dplyr::filter(ilc_wcp),
    "Closest water collection point" = ilc_villages %>% dplyr::filter(ilc_wcp, closer),
    "Other water collection point" = ilc_villages %>% dplyr::filter(ilc_wcp, !closer)
  ) %>%
    map(
      ~ summarise(
        .,
        across(
          c(disctcr_02, discfcr_02, metertcr_02, meterfcr_02, metertcr_01, meterfcr_01),
          list(
            n = ~ sum(!is.na(.)),
            pct = ~ round((mean(., na.rm = TRUE) * 100), 1) %>% paste0("%")
          )
        )
      )
    ) %>%
    bind_rows(.id = "group") %>%
  select(
    -c(discfcr_02_n, meterfcr_02_n, metertcr_01_n, meterfcr_01_n)
  ) %>%
  set_names(
    c(" ", "N", "TCR ≥ 0.2 mg/L", "FCR ≥ 0.2 mg/L", "N", "TCR ≥ 0.2 mg/L", "FCR ≥ 0.2 mg/L", "TCR ≥ 0.1 mg/L", "FCR ≥ 0.1 mg/L")
  )
    
footnote_text <-
  "In each village, the closest and the furthest water collection point from the ILC device are tested. The sample in the first line includes all water collection points tested. The sample in the second line includes only the water collection points that were the closest to the tank in their cluster. The third line excludes the water collection points that were the closest to the tank in their cluster. Large clusters cover multiple villages. Therefore, there may be multiple water collection points in a single cluster included in lines one and three."

kable(
  table, 
  format = "html"
) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  kable_paper("striped", full_width = TRUE) %>%
  add_header_above(
    c(
      " ", 
      "Color wheel" = 3, 
      "Colorimeter" = 5
    )
  ) %>%
  add_header_above(c(" ", paste0("(", 1:8,")")), line = FALSE) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  )
```

```{r}
kable(
  table %>% select(1:4), 
  format = "latex",
  align = "c", 
  booktabs = T,
  caption = "Chlorine detection rates at water collection points connected to ILC",
  label = "ilc-cl"
) %>%
  kable_styling(latex_options = c("HOLD_position")) %>%
  add_header_above(c(" ", paste0("(", 1:3,")")), line = FALSE) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  writeLines(
    "output/tables/ilc-cl.tex"
  )
```

## Text

```{r}
wp_census %>%
  dplyr::filter(
    intervention == "DSW",
    !disp_filled
  ) %>%
  select(wp_id) %>%
  inner_join(hh_survey) %>%
  group_by(sample_group, country) %>%
  summarise(
    across(
      c(disctcr_02, discfcr_02),
      list(
        n = ~ sum(!is.na(.)),
        mean = ~ mean(., na.rm = TRUE)
      )
    )
  )
```

