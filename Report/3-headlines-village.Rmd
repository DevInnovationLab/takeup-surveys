# Village-level headline results

```{r}
pacman::p_load(
  dplyr,
  readr,
  tidyr,
  glue,
  sf,
  tidyverse,
  viridis,
  fixest,
  janitor,
  broom,
  car,
  modelsummary,
  survey,
  here
)
```

## People using DSW/ILC water points

### Prepare data

To calculate the number of people using water points with DSW or ILC, we use self-reported data from the household census on what is the household's primary water point. This information is combined with data from the water point census to determine whether these water points are served by DSW or ILC.

We start by restricting the household census data to households using water points with DSW or ILC located inside the sampled villages. We also exclude households using ILC in Uganda because we did not design the survey to be representative of this population.

```{r}
users_data <-
  hh_census %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    wp_invillage,
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) 
```

The relevant variable to calculate the number of people using water points with DSW or ILC is the number of people living in households that report their primary water source has DSW or ILC. Due to a coding mistake, this variable was not collected in the first few days of data collection in Uganda. Therefore, we need to impute values for the households where this information is missing.

```{r}
users_data %>% 
  dplyr::filter(!is.na(wp_intervention_type), is.na(hh_members)) %>%
  tabyl(date, country) %>%
  adorn_totals()
```

There are `r users_data %>% dplyr::filter(is.na(hh_members)) %>% pull(village_id) %>% n_distinct` villages in Uganda with no observations for this variable, so we cannot impute it as the village average. Therefore, we impute it are the sample group level. 

```{r}
users_data <-
  users_data %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  )
```

Since the unit of reference for our analysis is the village, we calculate the number of people whose primary water source has DSW or ILC by adding the number of household members across all such households in a village.

```{r}
users_village <-
  users_data %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  )
```

There is one village in Malawi with only one household using ILC:

```{r}
users_village %>%
  dplyr::filter(hhs == 1)
```

To simplify the calculation of standard errors, we remove it from the estimates. In practice, this means we're assigning zero users to this village.

```{r}
users_village <-
  users_village %>%
  dplyr::filter(hhs > 1)
```

To scale to the country level, we combine this data with the number of sampled villages and the number of villages in the admin data per group. To account for the villages where all the water points with ILC were out of order, we weigh each village using the number of villages in the group divided by the number of _sampled_ villages in the group, including those that were replaced because there were no users.

```{r}
users_village <-
  users_village %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group, wp_intervention) %>%
  mutate(
    weight = pop_vil/sampled_villages
  ) %>%
  ungroup
```


### Sanity check

Here we just calculate the total number of people without CIs. The point estimate should be the same as the one calculated with a canned function.

```{r}
sanity_users <-
  users_village %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    n = n_distinct(village_id),
    av_people = mean(users),
    av_people_non = mean(users_increased),
    across(
      c(pop_vil, sampled_villages),
      ~ unique(.)
    )
  ) %>%
  mutate(
    total_people = round(av_people * pop_vil * n / sampled_villages),
    total_people_non = round(av_people_non * pop_vil * n / sampled_villages)
  ) %>%
  select(country, sample_group, wp_intervention, sampled_villages, villages = n, pop_vil, av_people_non, total_people_non, av_people, total_people)
```

```{r}
sanity_users %>%
  select(-country) %>%
  kable_by_group
```


```{r}
sanity_users %>%
  group_by(country, wp_intervention) %>%
  summarise(
    villages = sum(villages),
    total_people = sum(total_people)
  ) %>%
  ungroup %>%
  select(-country) %>%
  kable_by_country
```


### Final numbers

We the total number of users per sample group and the confidence intervals around this number using the package `survey` to adjust standard errors for the survey design.

#### By program and sample group

```{r}
people_per_group <-
  map(
    users_village %>%
      group_by(country, sample_group, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        households = .x %>% pull(hhs) %>% sum,
        weight = .x %>% pull(weight) %>% unique
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, sample_group, wp_intervention, 
    outcome, 
    villages, weight, 
    everything()
  ) %>%
  arrange(outcome)

people_per_group %>%
  select(sample_group, wp_intervention, villages, households, weight, total) %>%
  kable_by_group()
```

#### By program 

```{r}
people_per_country <-
  map(
    users_village %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        hhs = .x %>% pull(hhs) %>% sum,
        pop = .x %>% pull(pop_vil) %>% unique %>% sum
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)

people_per_country
```

### Sensitivity checks

#### Don't correct for non-responses

```{r}
users_vil_responseonly <-
  map(
    users_village %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Include households using water points outside of the village

```{r}
users_outside <-
  hh_census %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  ) %>%
  full_join(
    village_intervention %>% 
      select(village_id, country, sample_group, wp_intervention)
  ) %>%
  mutate(
    hh_members = replace_na(hh_members, 0)
  ) %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  ) %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group) %>%
  mutate(
    weight = pop_vil/sampled_villages
  ) %>%
  dplyr::filter(hhs > 1) %>%
  ungroup
```

```{r}
users_vil_outside <-
  map(
    users_outside %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Exclude households living outside of village boundaries

```{r}
users_vilboundary <-
  hh_census %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    wp_invillage,
    inclusion == "Within village boundaries"
  ) %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  ) %>%
  full_join(
    village_intervention %>% 
      select(village_id, country, sample_group, wp_intervention)
  ) %>%
  mutate(
    hh_members = replace_na(hh_members, 0)
  ) %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  ) %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group) %>%
  mutate(
    weight = pop_vil/sampled_villages
  ) %>%
  dplyr::filter(hhs > 1) %>%
  ungroup
```

```{r}
users_vil_boundary <-
  map(
    users_vilboundary %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Correct for missed water points

```{r}
users_vil_misspoints <-
  map(
    users_village %>%
      mutate(
        users_increased = 
          case_when(
            wp_intervention == "DSW" ~ users_increased * 1.12,
            wp_intervention == "ILC" ~ users_increased * 1.05
          )
      ) %>%
      dplyr::filter(country == "Malawi") %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Don't correct for non-functional ILC

```{r}
users_func <-
  hh_census %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    wp_invillage
  ) %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  ) %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  ) %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group) %>%
  mutate(
    weight = pop_vil/sampled_villages
  ) %>%
  dplyr::filter(hhs > 1) %>%
  ungroup
```

```{r}
users_vil_func <-
  map(
    users_func %>%
      dplyr::filter(wp_intervention != "Non-program") %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Use raw FO reports

```{r}
users_fo <-
  hh_census %>%
  mutate(wp_intervention = intervention_fo) %>%
  dplyr::filter(
    !is.na(wp_intervention),
    wp_invillage,
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  ) %>%
  full_join(
    village_intervention %>% 
      select(village_id, country, sample_group, wp_intervention)
  ) %>%
  mutate(
    hh_members = replace_na(hh_members, 0)
  ) %>%
  group_by(village_id, country, sample_group, wp_intervention) %>%
  summarise(
    response_rate = unique(response_rate),
    hhs = n(),
    users = sum(hh_members)
  ) %>%
  mutate(
    users_increased = users/response_rate
  ) %>%
  left_join(sample_sizes) %>%
  group_by(country, sample_group) %>%
  mutate(
    weight = pop_vil/sampled_villages
  ) %>%
  dplyr::filter(hhs > 1) %>%
  ungroup
```

```{r}
users_vil_fo <-
  map(
    users_fo %>%
      group_by(country, wp_intervention) %>%
      group_split(),
    ~ total_ci(
        var = "users_increased",
        design = svydesign(
          id = ~ village_id,
          data = .x, 
          weights = ~ weight
        )
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct
      )
  ) %>% 
  bind_rows() %>%
  select(
    country, wp_intervention, 
    outcome, 
    villages,
    everything()
  ) %>%
  arrange(outcome)
```

#### Plot

```{r warning = FALSE}
plot_data <-
  list(
    "Main estimate" = people_per_country,
    "(1) Including households using water points\noutside of sampled villages" = users_vil_outside,
    "(2) Excluding households living outside of\nthe village boundaries" = users_vil_boundary,
    "(3) Without correction for non-responses" = users_vil_responseonly,
    "(4) Without corrections to DSW/ILC status\nfrom admin data" = users_vil_fo,
    "(5) Without correction for water point\nfunctionality" = users_vil_func,
    "(6) Correcting for potentially missed \nwater points" = users_vil_misspoints
  ) %>%
    map(
      ~ .x %>%
        select(country, wp_intervention, outcome, total, ub, lb)
    ) %>%
    bind_rows(.id = "label") %>%
    mutate(
      main = label == "Main estimate"
    ) %>%
    dplyr::filter(wp_intervention != "Non-program")

plot_data %>%
  ggplot(
    aes(
      y = label,
      xmin = lb,
      xmax = ub,
      x = total,
      label = format(round(total), big.mark = ","),
      color = main
    )
  ) +
  geom_errorbar(width = .3) +
  geom_point(size = 2) +
  geom_text(
    color = "black", 
    size = 3,
    vjust = -1
  ) +
  facet_grid(
    country ~ wp_intervention,
    scales = "free"
  ) +
  scale_x_continuous(labels = ~ format(., big.mark = ",", scientific = FALSE)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_brewer(palette = "Dark2") +
  theme + 
  scale_x_continuous(labels = ~ format(., big.mark = ",", scientific = FALSE)) +
  theme(legend.position = "none") +
  labs(
    y = NULL,
    x = "Number of people using a water point with DSW/ILC as\nmain source of drinking water"
  )
```

#### Save Plot
```{r}
ggplot2::ggsave(
  filename = "output/graphs/users-vil.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)
```


## Chlorine detection rates

### Prepare data

```{r}
chlorination_data <-
  hh_survey %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  ungroup %>%
  left_join(
    hh_census %>%
      group_by(
        village_id,
        wp_intervention
      ) %>%
      summarise(pop_users = n_distinct(household_id)/unique(response_rate))
  ) %>%
  group_by(village_id) %>%
  mutate(
    # This is if we weigh each village equally
    weight_equal = n_distinct(household_id)/20,
    # This is if we apply sampling weights
    weight_users = n_distinct(household_id)/pop_users,
  ) %>% 
  ungroup
```

### Sanity check

```{r}
chlorination_data %>%
  group_by(village_id, sample_group, wp_intervention_type, country) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = n()
  ) %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = sum(hhs),
    villages = n()
  )
```

```{r}
chlorination_data %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = n(), 
    villages = n_distinct(village_id)
  )
```

### Final numbers

#### Separating ILC WP and ILC WCP

```{r}
cl_village_noweights_ilc <-
  chlorination_data %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_type) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### By sample group and program

```{r}
cl_village_noweights_samplegroup <-
  chlorination_data %>%
  group_by(country, sample_group, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Check program differences

Before we combine observations in different sample groups, we want to make sure that chlorination rates are not different across them

```{r}
feols(
  disctcr_02 ~ sample_group,
  cluster = ~ village_id,
  data = chlorination_data %>%
    dplyr::filter(country == "Uganda")
) %>% 
  summary
```

```{r}
feols(
  disctcr_02 ~ sample_group,
  cluster = ~ village_id,
  data = chlorination_data %>%
    dplyr::filter(country == "Malawi")
) %>% 
  summary
```
```{r}
model <-
  feols(
    disctcr_02 ~ sample_group,
    cluster = ~ village_id,
    data = chlorination_data %>%
      dplyr::filter(
        country == "Malawi"
      )
  )

summary(model)
```
```{r}
fitstat(model, type = "f") 
```


```{r}
feols(
  discfcr_02 ~ wp_intervention_type,
  cluster = ~ village_id,
  data = chlorination_data %>%
    dplyr::filter(
      country == "Malawi",
      wp_intervention == "ILC"
    )
) %>% 
  summary
```

```{r}
feols(
  discfcr_02 ~ wp_intervention,
  cluster = ~ village_id,
  data = chlorination_data %>%
    dplyr::filter(
      country == "Malawi",
      sample_group == "ILC"
    )
) %>% 
  summary
```

```{r}
feols(
  discfcr_02 ~ sample_group,
  cluster = ~ village_id,
  data = chlorination_data %>%
    dplyr::filter(
      country == "Malawi",
      wp_intervention == "DSW"
    )
) %>% 
  summary
```



#### By program

```{r}
cl_village_noweights_country <-
  chlorination_data %>%
  group_by(country, wp_intervention) %>%
  group_split() %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          nest = TRUE,
          strata = ~ sample_group
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

### Sensitivity checks

#### Assinging no chlorination if not tested

```{r}
cl_village_nottested <-
  chlorination_data %>%
  mutate(
    across(
      c("discfcr_02", "disctcr_02"),
      ~ case_when(
        !water_sample ~ FALSE,
        TRUE ~ .
      )
    )
  ) %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          strata = ~ sample_group,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Weighing villages equally

```{r}
cl_village_vilweights <-
  chlorination_data %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          strata = ~ sample_group,
          prob = ~ weight_equal,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Weighing villages by number of users

```{r}
cl_village_userweights <-
  chlorination_data %>% 
  dplyr::filter(!is.na(weight_users)) %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          prob = ~ weight_users,
          strata = ~ sample_group,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Exclude villages where it was raining

```{r}
cl_village_rain <-
  chlorination_data %>%
  dplyr::filter(is.na(vil_rain), country == "Uganda") %>%
  group_by(country, wp_intervention) %>%
  group_split() %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          nest = TRUE,
          strata = ~ sample_group
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Exclude villages with potential interference from promoters

```{r}
cl_village_int <-
  chlorination_data %>%
  dplyr::filter(
    !(village_id %in% 
        (villages %>% 
           dplyr::filter(potential_interference) %>% 
           pull(village_id)
         )
      ),
    country == "Uganda"
  ) %>%
  group_by(country, wp_intervention) %>%
  group_split() %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          data = .,
          nest = TRUE,
          strata = ~ sample_group
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### FO reports of intervention

```{r}
chlorination_fo <-
  hh_survey %>%
  mutate(wp_intervention = intervention_fo) %>%
  dplyr::filter(
    !is.na(intervention_fo),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(village_id) %>%
  ungroup %>%
  left_join(
    hh_census %>%
      group_by(
        village_id,
        wp_intervention
      ) %>%
      summarise(pop_users = n_distinct(household_id)/unique(response_rate))
  ) %>%
  group_by(village_id) %>%
  mutate(
    # This is if we weigh each village equally
    weight_equal = n_distinct(household_id)/20,
    # This is if we apply sampling weights
    weight_users = n_distinct(household_id)/pop_users,
  )
```

```{r}
cl_village_fo <-
  chlorination_fo %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id + wp_id,      # PSU (here: villages)
          strata = ~ sample_group,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Self-reported users

```{r}
chlorination_self <-
  hh_survey %>%
  mutate(wp_intervention = intervention_selfreport) %>%
  dplyr::filter(
    !is.na(wp_intervention),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(village_id) %>%
  ungroup %>%
  left_join(
    hh_census %>%
      group_by(
        village_id,
        wp_intervention
      ) %>%
      summarise(pop_users = n_distinct(household_id)/unique(response_rate))
  ) %>%
  group_by(village_id) %>%
  mutate(
    # This is if we weigh each village equally
    weight_equal = n_distinct(household_id)/20,
    # This is if we apply sampling weights
    weight_users = n_distinct(household_id)/pop_users,
  )
```

```{r}
cl_village_self <-
  chlorination_self %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id,      # PSU (here: villages)
          strata = ~ sample_group,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### All households surveyed

```{r}
chlorination_all <-
  hh_survey %>%
  mutate(
    wp_intervention = case_when(
      !is.na(wp_intervention) ~ wp_intervention,
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC",
      sample_group != "ILC" ~ "DSW"
    )
  ) %>%
  dplyr::filter(
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(village_id) %>%
  ungroup %>%
  left_join(
    hh_census %>%
      group_by(
        village_id,
        wp_intervention
      ) %>%
      summarise(pop_users = n_distinct(household_id)/unique(response_rate))
  ) %>%
  group_by(village_id) %>%
  mutate(
    # This is if we weigh each village equally
    weight_equal = n_distinct(household_id)/20,
    # This is if we apply sampling weights
    weight_users = n_distinct(household_id)/pop_users,
  )
```

```{r}
cl_village_all <-
  chlorination_all %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("discfcr_02", "disctcr_02"),
        design = svydesign(
          id = ~ village_id,      # PSU (here: villages)
          strata = ~ sample_group,
          data = .,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Plot


```{r warning = FALSE}
plot_data <-
  list(
    "Main estimate" = cl_village_noweights_country,
    "(1) Weighing each village equally" = cl_village_vilweights,
    "(2) Weighing villages by number of users" = cl_village_userweights,
    "(3) Using ield office report of DSW/ILC\npresence" = cl_village_fo,
    "(4) Using self-report of DSW/ILC presence" = cl_village_self,
    "(5) Including households with unconfirmed\nDSW/ILC status" = cl_village_all,
    "(6) Including households with no stored water\n(assuming no chlorine detected)" = cl_village_nottested,
    "(7) Excluding villages with unseasonable rain" = cl_village_rain,
    "(8) Excluding villages with potential \npromoter interference" = cl_village_int
  ) %>%
    map(
      ~ .x %>%
        dplyr::filter(outcome == "disctcr_02") %>%
        select(country, wp_intervention, outcome, mean, ub, lb)
    ) %>%
    bind_rows(.id = "label") %>%
    mutate(
      across(
        c(mean, ub, lb),
        ~ . * 100
      ),
      main = (label == "Main estimate")
  ) %>%
  dplyr::filter(wp_intervention != "Non-program")
  
plot_data %>%
  ggplot(
    aes(
      y = label,
      xmin = lb,
      xmax = ub,
      x = mean,
      label = round(mean, 1) %>% paste0("%"),
      color = main
    )
  ) +
  geom_errorbar(width = .3) +
  geom_point(size = 2) +
  geom_text(
    color = "black", 
    size = 3,
    vjust = -1
  ) +
  facet_grid(
    country ~ wp_intervention,
    scales = "free"
  ) +
  scale_x_continuous(labels = ~ format(., big.mark = ",", scientific = FALSE)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_brewer(palette = "Dark2") +
  theme +
  labs(
    y = NULL,
    x = "Percent of tested households where color wheel\nTCR reading was at least 0.2 mg/L"
  )
```

#### Save Plot

```{r}
ggplot2::ggsave(
  filename = "output/graphs/chlorine-vil.png",  
  plot     = ggplot2::last_plot(),            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)
```

## Table

### By program

```{r, message = FALSE, warning = FALSE}
obs <-
  users_village %>%
    group_by(
      country, wp_intervention
    ) %>%
    summarise(
      visited_villages = sum(hhs != 0),
      census = sum(hhs) %>% format(big.mark = ",")
    ) %>%
    mutate(
      name = "est"
    )

people <-
  people_per_country %>%
  left_join(
    sample_sizes %>%
      group_by(country, wp_intervention) %>%
      summarise(pop = sum(pop_vil))
  ) %>%
  mutate(
    across(
      c(total, lb, ub, pop),
      ~ . %>% 
        round %>% 
        format(big.mark = ",") %>%
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") 
  ) %>%
  select(
    country, wp_intervention, pop, est = total, ci
  ) %>%
  pivot_longer(
    cols = c(est, ci),
    values_to = "people"
  ) 

cl <-
  cl_village_noweights_country %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% 
        round(1) %>% 
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") ,
    hhs = hhs %>% format(big.mark = ",")
  ) %>%
  select(country, wp_intervention, outcome, villages, hhs, est = mean, ci) %>%
  pivot_wider(
    values_from = c(est, ci),
    names_from = outcome
  ) %>%
  pivot_longer(
    cols = ends_with("02"),
    names_pattern = "(.*)_disc(.*)_02",
    names_to = c("name", ".value")
  )

tab <- 
  obs %>%
  full_join(people) %>%
  left_join(cl) %>%
  arrange(country, wp_intervention, desc(name)) %>%
  mutate(
    across(
      everything(),
      ~ as.character(.)
    ),
    across(
      -c(people, tcr, fcr),
      ~ case_when(
        name == "est" ~ .,
        TRUE ~ ""
      )
    )
  ) %>%
  ungroup %>%
  select(-c(name, country))

table <-
  kable(
    tab, 
    format = "latex",
    escape = F,
    align = "c", 
    booktabs = T,
    col.names = linebreak(
      c("Intervention", "\\#Vil", "\\#HH", "\\#Vil", "People using\nDSW/ILC\n(95\\% CI)", "\\#Vil", "\\#HH", "TCR\n(95\\% CI)", "FCR\n(95\\% CI)"),
      align = "c"
    ),
    caption = "Primary outcomes estimated using the village as the unit of reference",
    label = "headlines-vil"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(
    c(
      " ", 
      "Household census" = 2, 
      "Country-level estimates" = 2, 
      "Percent of color wheel readings ≥ 0.2 mg/L" = 4
    )
  ) %>%
  add_header_above(c(" ", paste0("(", 1:8,")")), line = FALSE)

writeLines(
  table, 
  "output/tables/headlines-vil.tex"
)
```

```{r}
table %>%
  kable_by_country
```


### By program and sample group

```{r, message = FALSE, warning = FALSE}
obs <-
  users_village %>%
    group_by(
      country, wp_intervention, sample_group
    ) %>%
    summarise(
      visited_villages = sum(hhs != 0),
      census = sum(hhs) %>% format(big.mark = ",")
    ) %>%
    mutate(
      name = "est"
    )

people <-
  people_per_group %>%
  left_join(
    sample_sizes %>%
      group_by(country, wp_intervention, sample_group) %>%
      summarise(pop = sum(pop_vil))
  ) %>%
  mutate(
    across(
      c(total, lb, ub, pop),
      ~ . %>% 
        round %>% 
        format(big.mark = ",") %>%
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") 
  ) %>%
  select(
    country, wp_intervention, sample_group, pop, est = total, ci
  ) %>%
  pivot_longer(
    cols = c(est, ci),
    values_to = "people"
  ) 

cl <-
  cl_village_noweights_samplegroup %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% 
        round(1) %>% 
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") ,
    hhs = hhs %>% format(big.mark = ",")
  ) %>%
  select(country, wp_intervention, sample_group, outcome, villages, hhs, est = mean, ci) %>%
  pivot_wider(
    values_from = c(est, ci),
    names_from = outcome
  ) %>%
  pivot_longer(
    cols = ends_with("02"),
    names_pattern = "(.*)_disc(.*)_02",
    names_to = c("name", ".value")
  )

tab <- 
  obs %>%
  full_join(people) %>%
  left_join(cl) %>%
  arrange(country, wp_intervention, sample_group, desc(name)) %>%
  ungroup %>%
  mutate(
    across(
      everything(),
      ~ as.character(.)
    ),
    across(
      -c(people, tcr, fcr),
      ~ case_when(
        name == "est" ~ .,
        TRUE ~ ""
      )
    )
  ) %>%
  select(-c(name, country)) 

table <-
  kable(
    tab, 
    format = "latex",
    escape = F,
    align = "c", 
    booktabs = T,
    col.names = linebreak(
      c(" ", "Sample group", "\\#Vil", "\\#HH", "\\#Vil", "People using\nDSW/ILC\n(95\\% CI)", "\\#Vil", "\\#HH", "TCR\n(95\\% CI)", "FCR\n(95\\% CI)"),
      align = "c"
    ),
    caption = "Primary outcomes estimated using the village as the unit of reference",
    label = "headlines-vil-by-group"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 8) %>%
  pack_rows("Uganda", 9, 12) %>%
  add_header_above(
    c(
      " " = 2, 
      "Household census" = 2, 
      "Country-level estimates" = 2, 
      "Percent of color wheel readings ≥ 0.2 mg/L" = 4
    )
  ) %>%
  add_header_above(c(" ", " ", paste0("(", 1:8,")")), line = FALSE)

writeLines(
  table, 
  "output/tables/headlines-vil-by-group.tex"
)
```