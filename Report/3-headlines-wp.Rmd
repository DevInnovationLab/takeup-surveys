# Water point-level headline results

## Number of people using DSW/ILC

### Prepare data

```{r}
hh_census_wp <-
  hh_census %>%
  left_join(wp_sample_sizes) 
```
#### Main treatment
 
```{r}
users_data <-
  hh_census_wp %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    # These are households using water points outside of the village
    # that were found to have DSW. Since we don't have a water point ID
    # for them, we cannot used them fow water point-level estimtes
    !is.na(wp_id)
  ) %>%
  left_join(
    wp_census %>%
      dplyr::filter(dsw | ilc_wcp) %>%
      rename(wp_intervention = intervention) %>%
      group_by(country, sample_group, wp_intervention) %>%
      summarise(
        func_rate = mean(wp_func, na.rm = TRUE)
      )
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  mutate(
    func_points = func_rate * pop_points,
    weight = n_distinct(wp_id)/func_points,
    weight_nofunc = n_distinct(wp_id)/pop_points
  ) %>% 
  ungroup
```

```{r}
users_data <-
  users_data %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    ),
    hh_members_increased = hh_members/response_rate
  ) 
```

#### Raw treatment variable
 
```{r}
users_fo <-
  hh_census %>%
  dplyr::filter(
    !is.na(intervention_fo),
    !(sample_group != "ILC" & intervention_fo == "ILC"),
    !is.na(wp_id)
  ) %>%
  left_join(
    wp_sample_sizes %>% 
      rename(intervention_fo = wp_intervention),
    unmatched = "error"
  ) %>%
  group_by(country, sample_group) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    ),
    hh_members_increased = hh_members/response_rate
  ) %>%
  ungroup %>%
  left_join(
    wp_census %>%
      dplyr::filter(
        !is.na(intervention_fo),
        !(sample_group != "ILC" & intervention_fo == "ILC")
      ) %>%
      group_by(country, sample_group, intervention_fo) %>%
      summarise(
        func_rate = mean(wp_func, na.rm = TRUE)
      ) %>%
      mutate(sample_group = as.character(sample_group)) %>% 
      ungroup,
    unmatched = "error"
  ) %>%
  group_by(country, sample_group, intervention_fo) %>%
  mutate(
    func_points = func_rate * pop_points,
    weight = n_distinct(wp_id)/func_points
  ) %>% 
  ungroup 
```

### Sanity check

```{r}
group <-
  users_data %>%
  group_by(
    wp_id, wp_intervention, sample_group, country, pop_points, func_points
  ) %>%
  summarise(
    users = sum(hh_members),
    users_increased = sum(hh_members_increased)
  ) %>%
  group_by(
    country, sample_group, wp_intervention, pop_points, func_points
  ) %>%
  summarise(
    across(
      c(users, users_increased),
      ~ mean(.)
    )
  ) %>%
  mutate(
    across(
      c(users, users_increased),
      ~ . * pop_points,
      .names = "{.col}_total"
    ),
    across(
      c(users, users_increased),
      ~ . * func_points,
      .names = "{.col}_func"
    )
  )

group
```

```{r}
group %>%
  group_by(wp_intervention, country) %>%
  summarise(
    across(
      c(contains("users_")),
      ~ sum(.)
    )
  ) %>%
  select(-users_increased)
```

### Final numbers

```{r}
users_wp <-
  users_data %>%
  group_by(
    country, sample_group, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ total_cis(
      outcomes = c("hh_members_increased"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        strata = ~ sample_group,
        prob = ~ weight,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(outcome)
```

```{r}
users_wp_country <-
  users_data %>%
  group_by(
    country, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ total_cis(
      outcomes = c("hh_members_increased"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        strata = ~ sample_group,
        prob = ~ weight,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(outcome)
```

```{r}
users_wp %>%
  bind_rows(users_wp_country) %>%
  write_csv(
    here(
      "../output/tables/users-wp.csv"
    )
  )
```


### Comparisons

#### Disregarding non-responses

```{r}
users_wp_responseonly <-
  users_data %>%
  group_by(
    country, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ total_cis(
      outcomes = c("hh_members"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        strata = ~ sample_group,
        prob = ~ weight,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(outcome)
```

#### Not adjusting for functionality rates

```{r}
users_wp_nofunc <-
  users_data %>%
  group_by(
    country, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ total_cis(
      outcomes = c("hh_members_increased"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        strata = ~ sample_group,
        prob = ~ weight_nofunc,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(outcome)
```

#### Using raw intervention data

```{r}
users_wp_fo <-
  users_fo %>%
  group_by(country, intervention_fo) %>%
  group_split %>%
  map(
    ~ total_cis(
      outcomes = c("hh_members_increased"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        strata = ~ sample_group,
        prob = ~ weight,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(intervention_fo) %>% unique,
        villages = .x %>% pull(village_id) %>% n_distinct,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(outcome)
```

#### Plot

```{r warning = FALSE}
plot_data <-
  list(
    "Main estimate" = users_wp_country,
    "Without correction for non-responses" = users_wp_responseonly,
    "Ignoring admin data for DSW/ILC classification" = users_wp_fo,
    "Without correction for functionality rates" = users_wp_nofunc
  ) %>%
    map(
      ~ .x %>%
        select(country, wp_intervention, outcome, total, ub, lb)
    ) %>%
    bind_rows(.id = "label") %>%
    mutate(
      main = label == "Main estimate"
    )

plot_data %>%
  ggplot(
    aes(
      y = label,
      xmin = lb,
      xmax = ub,
      x = total,
      color = label,
      label = format(round(total), big.mark = ",")
    )
  ) +
  geom_errorbar(width = .3, size = .7) +
  geom_point(size = 2) +
  geom_text(data = plot_data %>% dplyr::filter(!main), color = "black", size = 3, vjust = -1) +
  geom_errorbar(data = plot_data %>% dplyr::filter(main), width = .3, size = 1) +
  geom_point(data = plot_data %>% dplyr::filter(main), size = 3) +
  geom_text(data = plot_data %>% dplyr::filter(main), color = "black", size = 3, vjust = -1, fontface = "bold")  +
  facet_wrap(~ country + wp_intervention, scales = "free_x", ncol = 1) +
  theme +
  scale_color_viridis_d() +
  scale_x_continuous(labels = ~ format(., big.mark = ",", scientific = FALSE)) +
  theme(legend.position = "none") +
  labs(
    y = NULL,
    x = "Number of people using a water point with DSW/ILC as\nmain source of drinking water"
  )
```

## Chlorination rates

### Prepare data

```{r}
hh_survey_wp <-
  hh_survey %>%
  left_join(wp_sample_sizes)
```

#### Main treatment variable

```{r}
chlorination_data <-
  hh_survey_wp %>%
  dplyr::filter(
    wp_intervention_type != "Non-program",
    !(sample_group != "ILC" & wp_intervention == "ILC")
  )
```

```{r}
chlorination_data <-
  chlorination_data %>%
  # Sampling weights
  group_by(wp_id) %>%
  mutate(
    n_cl = n_distinct(household_id)
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  mutate(
    n_cat = n_distinct(wp_id)
  ) %>%
  # Weight by number of users
  left_join(
    hh_census %>%
      group_by(wp_id) %>%
      summarise(
        n_users = n_distinct(household_id)
      )
  ) %>%
  ungroup %>%
  mutate(
    # Number of households using this water point represented by the observation
    weight_obs = n_users/n_cl,
    # Weighting all water points equally,
    weight_wp = 1/n_cl
  )
```
#### Use self-reported access to water points instead of verified access

```{r}
chlorination_self <-
  hh_survey_wp %>%
  dplyr::filter(
    !is.na(wp_id),
    !is.na(intervention_selfreport),
    !(sample_group != "ILC" & intervention_selfreport == "ILC")
  )
```

#### Use enumerator report of DSW/ILC

```{r}
chlorination_fo <-
  hh_survey_wp %>%
  dplyr::filter(
    !is.na(wp_id),
    !is.na(intervention_fo),
    !(sample_group != "ILC" & intervention_fo == "ILC")
  )
```


### Sanity check


```{r}
chlorination_data %>%
  group_by(wp_id, wp_intervention, sample_group, country) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = n_distinct(household_id)
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = sum(hhs),
    wp_id = n_distinct(wp_id)
  )
```

### Combining ILC WP and ILC WCP

#### Sanity check

```{r}
chlorination_data %>%
  group_by(wp_id, wp_intervention, sample_group, country) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = n_distinct(household_id)
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = sum(hhs),
    wp_id = n_distinct(wp_id)
  )
```

#### No weights

Each observation has weight 1

```{r}
cl_wp_noweights <-
  chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))

cl_wp_noweights
```

#### Weighing by number of users

```{r}
cl_wp_weight_users <-
  chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        weight = ~ weight_obs,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))

cl_wp_weight_users
```


#### Weighing water points equally

```{r}
cl_wp_weight_wp <-
  chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        weight = ~ weight_wp,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))

cl_wp_weight_wp
```

#### Using self-reports

```{r}
cl_wp_self <-
  chlorination_self %>%
  group_by(
    country, sample_group, intervention_selfreport
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(intervention_selfreport) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))

cl_wp_self
```

#### Using enumerator

```{r}
cl_wp_fo <-
  chlorination_fo %>%
  group_by(
    country, sample_group, intervention_fo
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(intervention_fo) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))

cl_wp_self
```

#### Comparison

```{r warning = FALSE}
plot_data <-
  list(
    "Weigh each household equally" = cl_wp_noweights,
    "Weigh each water point equally" = cl_wp_weight_wp,
    "Weigh water points by number of users" = cl_wp_weight_users
  ) %>%
    map(
      ~ .x %>%
        dplyr::filter(outcome == "disctcr_02") %>%
        select(country, sample_group, wp_intervention, outcome, mean, ub, lb)
    ) %>%
    bind_rows(.id = "label") %>%
    mutate(
      across(
        c(mean, ub, lb),
        ~ . * 100
      ),
      main = label == "Weigh each household equally"
  )
  
plot_data %>%
  ggplot(
    aes(
      y = label,
      xmin = lb,
      xmax = ub,
      x = mean,
      color = label,
      label = round(mean, 1) %>% paste0("%")
    )
  ) +
  geom_errorbar(width = .3, size = .7) +
  geom_point(size = 2) +
  geom_text(data = plot_data %>% dplyr::filter(!main), color = "black", size = 2.5, vjust = -1) +
  geom_errorbar(data = plot_data %>% dplyr::filter(main), width = .3, size = 1) +
  geom_point(data = plot_data %>% dplyr::filter(main), size = 3) +
  geom_text(data = plot_data %>% dplyr::filter(main), color = "black", size = 2.5, vjust = -1, fontface = "bold")  +
  facet_grid(country ~ sample_group + wp_intervention) +
  theme +
  scale_color_viridis_d() +
  theme(legend.position = "none") +
  labs(
    y = NULL,
    x = "Percent of tested households where color wheel\nTCR reading was at least 0.2 ppm"
  )
  
```


### Separating ILC WP and ILC WCP

#### Sanity check

```{r}
chlorination_data %>%
  group_by(wp_id, wp_intervention_type, sample_group, country) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = n_distinct(household_id)
  ) %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    across(
      c("disctcr_02", "discfcr_02"),
      ~ mean(., na.rm = TRUE)
    ),
    hhs = sum(hhs),
    wp_id = n_distinct(wp_id)
  )
```

#### No weights

Each observation has weight 1

```{r}
chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention_type
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_type) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

#### Weighing by number of users

```{r}
chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention_type
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        weight = ~ weight_obs,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_type) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```


#### Weighing water points equally

```{r}
chlorination_data %>%
  group_by(
    country, sample_group, wp_intervention_type
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("disctcr_02", "discfcr_02"),
      design = svydesign(
        id = ~ village_id + wp_id, # cluster IDs
        data = .x,
        weight = ~ weight_wp,
        nest = TRUE
      ) 
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_type) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        households = .x %>% pull(household_id) %>% n_distinct,
      )
  ) %>% 
  bind_rows() %>%
  select(country, sample_group, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

