# Monitoring headline results

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue",
    "patchwork",
    "tidyr",
    "dplyr",
    "knitr",
    "kableExtra",
    "vtable",
    "stargazer",
    "ggplot2",
    "haven",
    "estimatr",
    "janitor",
    "survey"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

## Number of people reached

### Average number of households per water point

```{r}
hh_per_wp <-
  wp_census %>%
  dplyr::filter(
    wp_func,
    intervention != "Non-program", 
    !is.na(pm_users)
  ) %>%
  group_by(
    country, sample_group, intervention
  ) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("pm_users"),
      dummy = FALSE,
      design = svydesign(
        id = ~ village_id, # cluster IDs
        strata = ~ sample_group,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>%
  bind_rows() %>%
  select(country, sample_group, wp_intervention, av_hhs = mean, av_hhs_se = se)
```

### Average number of people per household

```{r}
people_per_hh <-
  mon_survey %>%
  dplyr::filter(
    wp_func
  ) %>%
  group_by(
    country, sample_group
  ) %>%
  dplyr::filter(n() > 2) %>%
  group_split %>%
  map(
    ~ mean_cis(
      outcomes = c("hh_members"),
      dummy = FALSE,
      design = svydesign(
        id = ~ village_id, # cluster IDs
        strata = ~ sample_group,
        data = .x,
        nest = TRUE
      )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique
      )
  ) %>%
  bind_rows() %>%
  select(country, sample_group, av_size = mean, av_size_se = se)
```

### Total number of people per group

```{r}
total_people <- 
  hh_per_wp %>%
  left_join(people_per_hh) %>%
  # Calculate people per WP and its SE using delta method
  left_join(
    wp_census %>%
      dplyr::filter(dsw | ilc_wcp) %>%
      rename(wp_intervention = intervention) %>%
      group_by(country, sample_group, wp_intervention) %>%
      summarise(
        func_rate = mean(wp_func, na.rm = TRUE)
      )
  ) %>%
  mutate(
    av_people = av_hhs * av_size,
    # delta method: SE(X*Y) = sqrt((Y^2 * SE_X^2) + (X^2 * SE_Y^2))
    # assuming X and Y are independent
    av_people_se = sqrt(
      (av_size^2) * (av_hhs_se^2) + 
      (av_hhs^2) * (av_size_se^2)
    )
  ) %>%
  # join with population water points - sum across sample_groups
  left_join(
    wp_sample_sizes
  ) %>%
  # scale up to population
  mutate(
    total_people = av_people * pop_points * func_rate,
    # SE scales linearly with constant: SE(c*X) = c * SE(X)
    total_people_se = av_people_se * pop_points * func_rate,
    # 95% CI for popn_users
    total_people_lb = total_people - 1.96 * total_people_se,
    total_people_ub = total_people + 1.96 * total_people_se
  )
```

### Total number of people per country

```{r}
total_country <-
  total_people %>%
  mutate(total_people_se_sq = total_people_se ^ 2) %>%
  group_by(country, wp_intervention) %>%
  summarise(
    across(
      c(total_people, total_people_se_sq),
      ~ sum(.)
    )
  ) %>%
  mutate(
    total_people_se = sqrt(total_people_se_sq),
    total_people_lb = total_people - 1.96 * total_people_se,
    total_people_ub = total_people + 1.96 * total_people_se,
  ) %>%
  dplyr::filter(!(country == "Uganda" & wp_intervention == "ILC"))
```

### Does it make sense to assume independence?

```{r}
cor_data <-
  hh_survey %>% 
  bind_rows(mon_survey) %>%
  select(household_id, village_id, country, sample_group, wp_intervention, survey, wp_id, hh_members) %>%
  left_join(
    wp_census %>%
      select(wp_id, pm_users)
  ) %>%
  dplyr::filter(
    !is.na(hh_members),
    !is.na(pm_users)
  )

cor(cor_data$hh_members, cor_data$pm_users)

cor_data <-
  mon_survey %>%
  select(household_id, village_id, country, sample_group, wp_intervention, survey, wp_id, hh_members) %>%
  left_join(
    wp_census %>%
      select(wp_id, pm_users)
  ) %>%
  dplyr::filter(
    !is.na(hh_members),
    !is.na(pm_users)
  )

cor(cor_data$hh_members, cor_data$pm_users)

cor.test(cor_data$hh_members, cor_data$pm_users)$conf.int
```


## Chlorination rates

```{r}
feols(
  discfcr_02 ~ wp_intervention,
  cluster = ~ village_id,
  data = mon_survey %>%
    dplyr::filter(
      country == "Malawi",
      sample_group == "ILC",
      !is.na(wp_intervention)
    )
) %>% 
  summary
```


```{r}
mon_survey %>%
  tabyl(sample_group, wp_intervention)
```

```{r}
mon_survey %>%
  tabyl(sample_group, wp_intervention) %>%
  adorn_percentages() %>%
  adorn_pct_formatting()
```

```{r}
mon_survey %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    n = sum(!is.na(disctcr_02)),
    mean = mean(disctcr_02, na.rm = TRUE)
  )
```

we should not remove households that are not using program water points!

```{r}
mon_survey_cl <-
  mon_survey %>%
  dplyr::filter(
    !(ilc & sample_group != "ILC"),
    !(!(wp_intervention %in% c("DSW", "ILC")) & sample_group == "ILC")
  ) %>%
  mutate(
    wp_intervention = 
      case_when(
        sample_group != "ILC" ~ "DSW",
        TRUE ~ wp_intervention
      )
  )
```

```{r}
chlorine_am <-
  mon_survey_cl %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ mean_cis(
        outcomes = c("disctcr_02", "discfcr_02"),
        design = svydesign(
          id = ~ village_id,
          data = .x,
          nest = TRUE
        )
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
  ) %>%
  bind_rows %>%
  select(country, wp_intervention, outcome, everything()) %>%
  arrange(desc(outcome))
```

## Table

```{r}
cl <-
  chlorine_am %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% 
        round(1) %>% 
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") ,
    hhs = hhs %>% format(big.mark = ",")
  ) %>%
  select(country, wp_intervention, outcome, hhs, est = mean, ci) %>%
  pivot_wider(
    values_from = c(est, ci),
    names_from = outcome
  ) %>%
  pivot_longer(
    cols = ends_with("02"),
    names_pattern = "(.*)_disc(.*)_02",
    names_to = c("name", ".value")
  )

people <-
  total_country %>%
  left_join(
    wp_sample_sizes %>%
      group_by(country, wp_intervention) %>%
      summarise(pop = sum(pop_points))
  ) %>%
  mutate(
    across(
      c(total_people, total_people_lb, total_people_ub, pop),
      ~ . %>% 
        round %>% 
        format(big.mark = ",") %>%
        str_remove_all(" ")
    ),
    ci = paste0("(", total_people_lb, ", ", total_people_ub, ")") 
  ) %>%
  select(
    country, wp_intervention, pop, est = total_people, ci
  ) %>%
  pivot_longer(
    cols = c(est, ci),
    values_to = "people"
  ) 

obs <-
  wp_census %>%
  dplyr::filter(
    promoter_surveyed,
    intervention != "Non-program",
    !(country == "Uganda" & intervention == "ILC")
  ) %>%
  group_by(country, intervention) %>%
  summarise(
    wps = n(),
    listed_hhs = sum(pm_users, na.rm = TRUE) %>% format(big.mark = ",")
  ) %>%
  mutate(name = "est") %>%
  rename(wp_intervention = intervention)

tab <- 
  obs %>% 
  mutate(wp_intervention = as.character(wp_intervention)) %>%
  full_join(people) %>%
  left_join(cl) %>%
  arrange(country, wp_intervention, desc(name)) %>%
  ungroup %>%
  mutate(
    across(
      everything(),
      ~ as.character(.)
    ),
    across(
      -c(people, tcr, fcr),
      ~ case_when(
        name == "est" ~ .,
        TRUE ~ ""
      )
    )
  ) %>%
  dplyr::filter(!is.na(country))%>%
  select(-c(name, country)) 

table <-
  kable(
    tab, 
    format = "latex",
    escape = F,
    align = "c", 
    booktabs = T,
    col.names = linebreak(
      c("Intervention", "\\#WP", "\\#HH", "\\#WP", "People using\nDSW/ILC\n(95\\% CI)", "\\#HH", "TCR\n(95\\% CI)", "FCR\n(95\\% CI)"),
      align = "c"
    ),
    caption = "Primary outcomes estimated following the monitoring method",
    label = "headlines-am"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(
    c(
      " ", 
      "Promoter survey" = 2, 
      "Country-level estimates" = 2, 
      "Percent of color wheel readings â‰¥ 0.2 mg/L" = 3
    )
  ) %>%
  add_header_above(c(" ", " ", paste0("(", 1:6,")")), line = FALSE)

writeLines(
  table, 
  "output/tables/headlines-am.tex"
)
```


<!-- ## Sample -->

<!-- ```{r} -->
<!-- wp_table <-  -->
<!--   wp_census %>% -->
<!--   rename(wp_intervention = intervention) %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   summarise( -->
<!--     wp_census = n_distinct(wp_id), -->
<!--     wp_functional = sum(wp_func), -->
<!--     promoter_surveyed_f = sum(promoter_surveyed & wp_func), -->
<!--     promoter_surveyed = sum(promoter_surveyed), -->
<!--     ea_list = sum(pm_ea_list, na.rm = TRUE) -->
<!--   )%>% -->
<!--   left_join( -->
<!--     wp_sample_sizes,  -->
<!--     by = c("country", "sample_group", "wp_intervention") -->
<!--   ) %>% -->
<!--   dplyr::filter(!is.na(pop_points)) -->

<!-- wp_table -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # generate latex table -->
<!-- wp_table_latex <- wp_table %>% -->
<!--   mutate( -->
<!--     ea_list_count = coalesce(ea_list_malawi_count, ea_list_uganda_count) -->
<!--   ) %>% -->
<!--   select(country, sample_group, wp_intervention, pop_points, wp_census, wp_functional, ea_list_count, promoter_surveyed, promoter_surveyed_f) -->

<!-- malawi_footprint <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Malawi", sample_group == "Footprint", wp_intervention == "DSW") %>% -->
<!--   mutate(sample_group = "Footprint") -->

<!-- malawi_expansion <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Malawi", sample_group == "Expansion", wp_intervention == "DSW") %>% -->
<!--   mutate(sample_group = "Expansion") -->

<!-- malawi_dsw_ilc <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Malawi", sample_group == "ILC", wp_intervention == "DSW") %>% -->
<!--   mutate(sample_group = "DSW in ILC vill.") -->

<!-- malawi_ilc <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Malawi", sample_group == "ILC", wp_intervention == "ILC") %>% -->
<!--   mutate(sample_group = "ILC") -->

<!-- malawi_data <- bind_rows(malawi_footprint, malawi_expansion, malawi_dsw_ilc, malawi_ilc) %>% -->
<!--   select(-country, -wp_intervention) -->

<!-- uganda_footprint <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Uganda", sample_group == "Footprint", wp_intervention == "DSW") %>% -->
<!--   mutate(sample_group = "Footprint") -->

<!-- uganda_expansion <- wp_table_latex %>% -->
<!--   dplyr::filter(country == "Uganda", sample_group == "Expansion", wp_intervention == "DSW") %>% -->
<!--   mutate(sample_group = "Expansion") -->

<!-- uganda_data <- bind_rows(uganda_footprint, uganda_expansion) %>% -->
<!--   select(-country, -wp_intervention) -->

<!-- malawi_total <- malawi_data %>% -->
<!--   summarise( -->
<!--     sample_group = "\\textbf{Total EA points}", -->
<!--     pop_points = sum(pop_points, na.rm = TRUE), -->
<!--     wp_census = sum(wp_census, na.rm = TRUE), -->
<!--     wp_functional = sum(wp_functional, na.rm = TRUE), -->
<!--     ea_list_count = sum(ea_list_count, na.rm = TRUE), -->
<!--     promoter_surveyed = sum(promoter_surveyed, na.rm = TRUE), -->
<!--     promoter_surveyed_f = sum(promoter_surveyed_f, na.rm = TRUE) -->
<!--   ) -->

<!-- uganda_total <- uganda_data %>% -->
<!--   summarise( -->
<!--     sample_group = "\\textbf{Total EA points}", -->
<!--     pop_points = sum(pop_points, na.rm = TRUE), -->
<!--     wp_census = sum(wp_census, na.rm = TRUE), -->
<!--     wp_functional = sum(wp_functional, na.rm = TRUE), -->
<!--     ea_list_count = sum(ea_list_count, na.rm = TRUE), -->
<!--     promoter_surveyed = sum(promoter_surveyed, na.rm = TRUE), -->
<!--     promoter_surveyed_f = sum(promoter_surveyed_f, na.rm = TRUE) -->
<!--   ) -->

<!-- malawi_section <- bind_rows(malawi_data, malawi_total) -->
<!-- uganda_section <- bind_rows(uganda_data, uganda_total) -->

<!-- malawi_section <- malawi_section %>% -->
<!--   mutate(across(where(is.numeric), ~format(.x, big.mark = ",", scientific = FALSE, trim = TRUE))) -->

<!-- uganda_section <- uganda_section %>% -->
<!--   mutate(across(where(is.numeric), ~format(.x, big.mark = ",", scientific = FALSE, trim = TRUE))) -->

<!-- cat("\\begin{table}[htbp]\\centering\n") -->
<!-- cat("\\def\\sym#1{\\ifmmode^{#1}\\else\\(^{#1}\\)\\fi}\n") -->
<!-- cat("\\begin{tabular}{l*{6}c}\n") -->
<!-- cat("\\hline\\hline\n") -->
<!-- cat("& (1) & (2) & (3) & (4) & (5) & (6)\\\\\n") -->
<!-- cat("                   & Country Total & WP Census & \\shortstack{WP Census \\\\Functional} & \\shortstack{Evidence Action \\\\ Promoter List} & \\shortstack{DIL Promoter \\\\Survey} & \\shortstack{DIL Promoter \\\\Survey Functional}\\n") -->
<!-- cat("\\hline\n") -->
<!-- cat("\\textbf{Malawi}                  &            &           &        &        &         &         \\\\\n") -->
<!-- cat("\\hline\n") -->

<!-- for(i in 1:nrow(malawi_section)) { -->
<!--   row <- malawi_section[i,] -->
<!--   cat(sprintf("%s & %s & %s & %s & %s & %s & %s \\\\\n", -->
<!--               row$sample_group, row$pop_points, row$wp_census,  -->
<!--               row$wp_functional, row$ea_list_count, row$promoter_surveyed,  -->
<!--               row$promoter_surveyed_f)) -->
<!-- } -->

<!-- cat("\\hline\n") -->
<!-- cat("\\textbf{Uganda}                  &            &          &        &        &        &        \\\\\n") -->
<!-- cat("\\hline\n") -->

<!-- for(i in 1:nrow(uganda_section)) { -->
<!--   row <- uganda_section[i,] -->
<!--   cat(sprintf("%s & %s & %s & %s & %s & %s & %s \\\\\n", -->
<!--               row$sample_group, row$pop_points, row$wp_census,  -->
<!--               row$wp_functional, row$ea_list_count, row$promoter_surveyed, -->
<!--               row$promoter_surveyed_f)) -->
<!-- } -->

<!-- cat("\\hline\\hline\n") -->
<!-- cat("\\end{tabular}\n") -->
<!-- cat("\\end{table}\n") -->
<!-- ``` -->

<!-- #### uganda text -->
<!-- ```{r} -->
<!-- ea_promoters_uganda <- -->
<!--   ea_promoters_uganda %>% -->
<!--   dplyr::filter(villageid %in% sampled_villages$village_id) %>% -->
<!--   dplyr::filter(wp_intervention != "ILC") -->

<!-- # Calculate metrics -->
<!-- n_promoters <- nrow(ea_promoters_uganda) -->
<!-- n_unique_wps <- ea_promoters_uganda %>% -->
<!--   pull(i102_wpt_id) %>% -->
<!--   n_distinct() -->

<!-- n_in_wp_census <- ea_promoters_uganda %>% -->
<!--   dplyr::filter(i102_wpt_id %in% wp_census$ea_id) %>% -->
<!--   distinct(i102_wpt_id) %>% -->
<!--   nrow() -->

<!-- n_promoter_surveyed <- wp_census %>% -->
<!--   dplyr::filter(ea_id %in% ea_promoters_uganda$i102_wpt_id, promoter_surveyed == TRUE) %>% -->
<!--   distinct(ea_id) %>% -->
<!--   nrow() -->

<!-- n_surveyed_no_ea_info <- wp_census %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE,  -->
<!--          !ea_id %in% ea_promoters_uganda$i102_wpt_id, -->
<!--          country == "Uganda") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- n_total_promoter_surveys <- wp_census %>% -->
<!--   group_by(sample_group, wp_intervention) %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE, country == "Uganda") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- n_program_promoter_surveys <- wp_census %>% -->
<!--   group_by(sample_group, wp_intervention) %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE, country == "Uganda") %>% -->
<!--   dplyr::filter(wp_intervention == "Non-program") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- glue("In Uganda, Evidence Action provided information for {n_promoters} promoters of non-ILC water points in the sampled villages, representing {n_unique_wps} unique water points. Out of these, {n_in_wp_census} are in the water point census, and {n_promoter_surveyed} are included in the promoter survey. There are {n_surveyed_no_ea_info} promoter surveys for water points for which Evidence Action did not provide contact information, for a total of {n_total_promoter_surveys} promoter surveys in Uganda, of which {n_program_promoter_surveys} concerned a water point that was deemed Non-program.") -->
<!-- ``` -->

<!-- #### malawi text -->
<!-- ```{r} -->
<!-- ea_promoters_malawi <- ea_promoters_malawi %>% -->
<!--   # select(-wcp102_wpt_id) %>% -->
<!--   dplyr::filter(villageid %in% sampled_villages$village_id) %>% -->
<!--   unique -->

<!-- # Calculate metrics -->
<!-- n_promoters_ <- nrow(ea_promoters_malawi) -->
<!-- n_unique_wps <- ea_promoters_malawi %>% -->
<!--   pull(i102_wpt_id) %>% -->
<!--   n_distinct() -->

<!-- n_in_wp_census <- ea_promoters_malawi %>% -->
<!--   dplyr::filter(i102_wpt_id %in% wp_census$ea_id) %>% -->
<!--   distinct(i102_wpt_id) %>% -->
<!--   nrow() -->

<!-- n_in_wp_census_program <- ea_promoters_malawi %>% -->
<!--   dplyr::filter(i102_wpt_id %in% wp_census$ea_id) %>% -->
<!--   dplyr::filter(wp_intervention == "DSW" | wp_intervention == "ILC") %>% -->
<!--   distinct(i102_wpt_id) %>% -->
<!--   nrow() -->

<!-- n_promoter_surveyed <- wp_census %>% -->
<!--   dplyr::filter(ea_id %in% ea_promoters_malawi$i102_wpt_id, promoter_surveyed == TRUE) %>% -->
<!--   distinct(ea_id) %>% -->
<!--   nrow() -->

<!-- n_surveyed_no_ea_info <- wp_census %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE,  -->
<!--          !ea_id %in% ea_promoters_malawi$i102_wpt_id, -->
<!--          country == "Malawi") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- n_total_promoter_surveys <- wp_census %>% -->
<!--   group_by(sample_group, wp_intervention) %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE, country == "Malawi") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- n_program_promoter_surveys <- wp_census %>% -->
<!--   group_by(sample_group, wp_intervention) %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE, country == "Malawi") %>% -->
<!--   dplyr::filter(wp_intervention == "Non-program") %>% -->
<!--   distinct(wp_id) %>% -->
<!--   nrow() -->

<!-- glue("In Malawi, Evidence Action provided information for {n_promoters} promoters in the sampled villages, representing {n_unique_wps} unique water points. Out of these, {n_in_wp_census} are in the water point census, and {n_promoter_surveyed} are included in the promoter survey. There are {n_surveyed_no_ea_info} promoter surveys for water points for which Evidence Action did not provide contact information (primarily ILC water collection points), for a total of {n_total_promoter_surveys} promoter surveys in Malawi, of which {n_program_promoter_surveys} concerned a water point that was deemed Non-program.") -->
<!-- ``` -->

<!-- ### hhs outside  -->
<!-- ```{r} -->
<!-- hh_outside <- wp_census %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE) %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   group_by(country, sample_group, wp_intervention, wp_id) %>% -->
<!--   summarize( -->
<!--     hh_outside = sum(pm_users_outside, na.rm = TRUE), -->
<!--     hh_users = sum(pm_users, na.rm = TRUE), -->
<!--     hh_outside_share = hh_outside/hh_users -->
<!--   ) %>% -->
<!--   group_by(country) %>% -->
<!--   summarize( -->
<!--     hh_outside_avg = mean(hh_outside), -->
<!--     hh_users_avg = mean(hh_users), -->
<!--     hh_outside_share = mean(hh_outside_share, na.rm = TRUE) -->
<!--   )  -->
<!-- hh_outside -->

<!-- hh_outside_all <- hh_census %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   group_by(country, sample_group, wp_intervention, wp_id) %>% -->
<!--   summarize( -->
<!--     hh_outside = sum(inclusion == "Up to 200m outside of village boundaries"), -->
<!--     hh_users = n_distinct(household_id), -->
<!--     hh_outside_share = hh_outside/hh_users -->
<!--   ) %>% -->
<!--   group_by(country) %>% -->
<!--   summarize( -->
<!--     hh_outside_avg = mean(hh_outside), -->
<!--     hh_users_avg = mean(hh_users), -->
<!--     hh_outside_share = mean(hh_outside_share, na.rm = TRUE) -->
<!--   )  -->

<!-- hh_outside_all   -->
<!-- ``` -->

<!-- ### sample selection -->

<!-- ## Users per water point -->

<!-- ```{r} -->
<!-- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_func,  -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   group_by(wp_id, village_id, sample_group, country, wp_intervention) %>% -->
<!--   summarise(users = n()) %>% -->
<!--   mutate( -->
<!--     promoter_surveyed = wp_id %in% wp_census_pm$wp_id -->
<!--   ) %>% -->
<!--   feols( -->
<!--     users ~ promoter_surveyed | sample_group + country + wp_intervention, -->
<!--     cluster = ~ village_id -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_func,  -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   group_by(wp_id, village_id, sample_group, country, wp_intervention) %>% -->
<!--   summarise(users = n()) %>% -->
<!--   mutate( -->
<!--     promoter_surveyed = wp_id %in% wp_census_pm$wp_id -->
<!--   ) %>% -->
<!--   group_by(country) %>% -->
<!--   group_split() %>% -->
<!--   map( -->
<!--     ~ feols( -->
<!--       users ~ promoter_surveyed | sample_group + wp_intervention, -->
<!--       cluster = ~ village_id, -->
<!--       data = . -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->


<!-- ## Household size -->

<!-- ```{r} -->
<!-- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_func,  -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     promoter_surveyed = wp_id %in% wp_census_pm$wp_id -->
<!--   ) %>% -->
<!--   feols( -->
<!--     hh_members ~ promoter_surveyed | sample_group + country + wp_intervention, -->
<!--     cluster = ~ village_id -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_func,  -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     promoter_surveyed = wp_id %in% wp_census_pm$wp_id -->
<!--   ) %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   group_split() %>% -->
<!--   map( -->
<!--     ~ feols( -->
<!--       hh_members ~ promoter_list, -->
<!--       cluster = ~ wp_id, -->
<!--       data = . -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

<!-- ## Household size across samples -->

<!-- ```{r} -->
<!-- hh_survey %>% -->
<!--   bind_rows(mon_survey) %>% -->
<!--   dplyr::filter(wp_id %in% wp_census_pm$wp_id) %>% -->
<!--   feols( -->
<!--     hh_members ~ survey | sample_group + country + wp_intervention, -->
<!--     cluster = ~ village_id -->
<!--   ) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- hh_survey %>% -->
<!--   bind_rows(mon_survey) %>% -->
<!--   dplyr::filter(wp_id %in% wp_census_pm$wp_id) %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   dplyr::filter(n() > 2) %>% -->
<!--   group_split() %>% -->
<!--   map( -->
<!--     ~ feols( -->
<!--       hh_members ~ survey, -->
<!--       cluster = ~ village_id, -->
<!--       data = . -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_func,  -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     promoter_surveyed = wp_id %in% wp_census_pm$wp_id -->
<!--   ) %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   group_split() %>% -->
<!--   map( -->
<!--     ~ feols( -->
<!--       hh_members ~ promoter_list, -->
<!--       cluster = ~ wp_id, -->
<!--       data = . -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

<!-- ####hh size -->
<!-- #####by promoter list -->
<!-- ```{r} -->
<!-- hh_size_promoter <- hh_census %>% -->
<!--   dplyr::filter(promoter_list == TRUE) %>% -->
<!--   dplyr::filter(wp_func == "TRUE") %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   mutate(hh_weight = 1) -->

<!-- # calculate CIs -->
<!-- hh_size_promoter_avg <- calculate_mean_ci(hh_size_promoter, "hh_members", hh_weight) -->

<!-- hh_size_nonpromoter <- hh_census %>% -->
<!--   dplyr::filter(promoter_list == FALSE) %>% -->
<!--   dplyr::filter(wp_func == "TRUE") %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   mutate(hh_weight = 1) -->

<!-- # calculate CIs -->
<!-- hh_size_nonpromoter_avg <- calculate_mean_ci(hh_size_nonpromoter, "hh_members", hh_weight) -->

<!-- hh_size_promoter_avg -->
<!-- hh_size_nonpromoter_avg -->

<!-- # combine the two datasets and run t-tests -->
<!-- hh_size_comparison <- bind_rows( -->
<!--   hh_size_promoter_avg %>% mutate(promoter_list = TRUE), -->
<!--   hh_size_nonpromoter_avg %>% mutate(promoter_list = FALSE) -->
<!-- ) -->

<!-- # run t-tests for each country/sample_group/intervention combination -->
<!-- hh_size_ttest <- hh_size_comparison %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   group_split() %>% -->
<!--   map_df( -->
<!--     ~ { -->
<!--       # extract the two means and SEs -->
<!--       promoter_row <- .x %>% dplyr::filter(promoter_list == TRUE) -->
<!--       nonpromoter_row <- .x %>% dplyr::filter(promoter_list == FALSE) -->

<!--       # calculate n from original datasets -->
<!--       n_prom <- hh_size_promoter %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->
<!--       n_nonprom <- hh_size_nonpromoter %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->

<!--       # calculate z-statistic (using normal approximation since we have SEs) -->
<!--       diff <- promoter_row$mean - nonpromoter_row$mean -->
<!--       se_diff <- sqrt(promoter_row$se^2 + nonpromoter_row$se^2) -->
<!--       z_stat <- diff / se_diff -->
<!--       p_value <- 2 * (1 - pnorm(abs(z_stat))) -->

<!--       tibble( -->
<!--         country = unique(.x$country), -->
<!--         sample_group = unique(.x$sample_group), -->
<!--         wp_intervention = unique(.x$wp_intervention), -->
<!--         mean_promoter = promoter_row$mean, -->
<!--         mean_nonpromoter = nonpromoter_row$mean, -->
<!--         n_promoter = n_prom, -->
<!--         n_nonpromoter = n_nonprom, -->
<!--         difference = diff, -->
<!--         se_difference = se_diff, -->
<!--         z_statistic = z_stat, -->
<!--         p_value = p_value, -->
<!--         significant = p_value < 0.1 -->
<!--       ) -->
<!--     } -->
<!--   ) -->

<!-- hh_size_ttest -->
<!-- ``` -->

<!-- ###### LaTeX table -->
<!-- ```{r} -->
<!-- # function to add significance stars -->
<!-- add_stars <- function(p_value) { -->
<!--   if (p_value < 0.01) return("\\sym{***}") -->
<!--   if (p_value < 0.05) return("\\sym{**}") -->
<!--   if (p_value < 0.10) return("\\sym{*}") -->
<!--   return("") -->
<!-- } -->

<!-- # prepare data for table -->
<!-- table_data <- hh_size_ttest %>% -->
<!--   mutate( -->
<!--     stars = map_chr(p_value, add_stars), -->
<!--     # format the numbers to 2 decimal places -->
<!--     mean_promoter_fmt = sprintf("%.2f", mean_promoter), -->
<!--     mean_nonpromoter_fmt = sprintf("%.2f", mean_nonpromoter), -->
<!--     difference_fmt = paste0(sprintf("%.2f", difference), stars) -->
<!--   ) %>% -->
<!--   # create row labels -->
<!--   mutate( -->
<!--     row_label = case_when( -->
<!--       wp_intervention == "DSW" & sample_group == "Footprint" ~ "Footprint", -->
<!--       wp_intervention == "DSW" & sample_group == "Expansion" ~ "Expansion", -->
<!--       wp_intervention == "DSW" & sample_group == "ILC" ~ "DSW in ILC vill.", -->
<!--       wp_intervention == "ILC" & sample_group == "ILC" ~ "ILC", -->
<!--       TRUE ~ paste(sample_group, wp_intervention) -->
<!--     ) -->
<!--   ) %>% -->
<!--   arrange(country, match(sample_group, c("Footprint", "Expansion", "ILC"))) -->

<!-- # start building latex table -->
<!-- latex_lines <- c( -->
<!--   "\\begin{table}[htbp]\\centering", -->
<!--   "\\caption{Difference in mean household size according to Household Census by whether household is in any promoter's list}", -->
<!--   "\\label{tab:hh_size_pmsurvey}", -->
<!--   "\\def\\sym#1{\\ifmmode^{#1}\\else\\(^{#1}\\)\\fi}", -->
<!--   "\\begin{tabular}{l*{5}c}", -->
<!--   "\\hline\\hline", -->
<!--   "& \\multicolumn{2}{c}{Listed by Promoter} & \\multicolumn{2}{c}{Not Listed by Promoter} & \\\\", -->
<!--   "\\cmidrule(lr){2-3} \\cmidrule(lr){4-5}", -->
<!--   "& Mean & N & Mean & N & Difference\\\\", -->
<!--   "\\hline" -->
<!-- ) -->

<!-- # add malawi section -->
<!-- latex_lines <- c(latex_lines, "\\textbf{Malawi} & & & & & \\\\", "\\hline") -->
<!-- malawi_data <- table_data %>% dplyr::filter(country == "Malawi") -->
<!-- for (i in 1:nrow(malawi_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       malawi_data$row_label[i], -->
<!--       malawi_data$mean_promoter_fmt[i], -->
<!--       malawi_data$n_promoter[i], -->
<!--       malawi_data$mean_nonpromoter_fmt[i], -->
<!--       malawi_data$n_nonpromoter[i], -->
<!--       malawi_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # add uganda section -->
<!-- latex_lines <- c(latex_lines, "\\hline", "\\textbf{Uganda} & & & & & \\\\", "\\hline") -->
<!-- uganda_data <- table_data %>% dplyr::filter(country == "Uganda") -->
<!-- for (i in 1:nrow(uganda_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       uganda_data$row_label[i], -->
<!--       uganda_data$mean_promoter_fmt[i], -->
<!--       uganda_data$n_promoter[i], -->
<!--       uganda_data$mean_nonpromoter_fmt[i], -->
<!--       uganda_data$n_nonpromoter[i], -->
<!--       uganda_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # close table -->
<!-- latex_lines <- c(latex_lines, -->
<!--   "\\hline\\hline", -->
<!--   "\\multicolumn{6}{l}{\\footnotesize \\sym{*} \\(p<0.10\\), \\sym{**} \\(p<0.05\\), \\sym{***} \\(p<0.01\\)}\\\\", -->
<!--   "\\end{tabular}", -->
<!--   "\\end{table}" -->
<!-- ) -->

<!-- # print the table -->
<!-- cat(latex_lines, sep = "\n") -->
<!-- ``` -->

<!-- #####by monitoring survey -->
<!-- ```{r} -->
<!-- hh_size_monitoring <- hh_survey %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE) %>% -->
<!--   dplyr::filter(survey == "Monitoring Survey") %>% -->
<!--   dplyr::filter(wp_func == "TRUE") %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   mutate(hh_weight = 1) -->

<!-- # calculate CIs -->
<!-- hh_size_monitoring_avg <- calculate_mean_ci(hh_size_monitoring, "hh_members", hh_weight) -->

<!-- hh_size_household <- hh_survey %>% -->
<!--   dplyr::filter(promoter_surveyed == TRUE) %>% -->
<!--   dplyr::filter(survey == "Household Survey") %>% -->
<!--   dplyr::filter(wp_func == "TRUE") %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") %>% -->
<!--   mutate(hh_weight = 1) -->

<!-- # calculate CIs -->
<!-- hh_size_household_avg <- calculate_mean_ci(hh_size_household, "hh_members", hh_weight) -->

<!-- hh_size_monitoring_avg -->
<!-- hh_size_household_avg -->

<!-- # combine the two datasets and run t-tests -->
<!-- hh_size_comparison_survey <- bind_rows( -->
<!--   hh_size_monitoring_avg %>% mutate(survey = "Monitoring Survey"), -->
<!--   hh_size_household_avg %>% mutate(survey = "Household Survey") -->
<!-- ) -->

<!-- # run t-tests for each country/sample_group/intervention combination -->
<!-- hh_size_ttest_survey <- hh_size_comparison_survey %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   group_split() %>% -->
<!--   map_df( -->
<!--     ~ { -->
<!--       # extract the two means and SEs -->
<!--       monitoring_row <- .x %>% dplyr::filter(survey == "Monitoring Survey") -->
<!--       household_row <- .x %>% dplyr::filter(survey == "Household Survey") -->

<!--       # calculate n from original datasets -->
<!--       n_monitoring <- hh_size_monitoring %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->
<!--       n_household <- hh_size_household %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->

<!--       # calculate z-statistic (using normal approximation since we have SEs) -->
<!--       diff <- monitoring_row$mean - household_row$mean -->
<!--       se_diff <- sqrt(monitoring_row$se^2 + household_row$se^2) -->
<!--       z_stat <- diff / se_diff -->
<!--       p_value <- 2 * (1 - pnorm(abs(z_stat))) -->

<!--       tibble( -->
<!--         country = unique(.x$country), -->
<!--         sample_group = unique(.x$sample_group), -->
<!--         wp_intervention = unique(.x$wp_intervention), -->
<!--         mean_monitoring = monitoring_row$mean, -->
<!--         mean_household = household_row$mean, -->
<!--         n_monitoring = n_monitoring, -->
<!--         n_household = n_household, -->
<!--         difference = diff, -->
<!--         se_difference = se_diff, -->
<!--         z_statistic = z_stat, -->
<!--         p_value = p_value, -->
<!--         significant = p_value < 0.05 -->
<!--       ) -->
<!--     } -->
<!--   ) -->

<!-- hh_size_ttest_survey -->
<!-- ``` -->

<!-- ###### LaTeX table -->
<!-- ```{r} -->
<!-- # function to add significance stars -->
<!-- add_stars <- function(p_value) { -->
<!--   if (p_value < 0.01) return("\\sym{***}") -->
<!--   if (p_value < 0.05) return("\\sym{**}") -->
<!--   if (p_value < 0.10) return("\\sym{*}") -->
<!--   return("") -->
<!-- } -->

<!-- # prepare data for table -->
<!-- table_data <- hh_size_ttest_survey %>% -->
<!--   mutate( -->
<!--     stars = map_chr(p_value, add_stars), -->
<!--     # format the numbers to 2 decimal places -->
<!--     mean_monitoring_fmt = sprintf("%.2f", mean_monitoring), -->
<!--     mean_household_fmt = sprintf("%.2f", mean_household), -->
<!--     difference_fmt = paste0(sprintf("%.2f", difference), stars) -->
<!--   ) %>% -->
<!--   # create row labels -->
<!--   mutate( -->
<!--     row_label = case_when( -->
<!--       wp_intervention == "DSW" & sample_group == "Footprint" ~ "Footprint", -->
<!--       wp_intervention == "DSW" & sample_group == "Expansion" ~ "Expansion", -->
<!--       wp_intervention == "DSW" & sample_group == "ILC" ~ "DSW in ILC vill.", -->
<!--       wp_intervention == "ILC" & sample_group == "ILC" ~ "ILC", -->
<!--       TRUE ~ paste(sample_group, wp_intervention) -->
<!--     ) -->
<!--   ) %>% -->
<!--   arrange(country, match(sample_group, c("Footprint", "Expansion", "ILC"))) -->

<!-- # start building latex table -->
<!-- latex_lines <- c( -->
<!--   "\\begin{table}[htbp]\\centering", -->
<!--   "\\caption{Difference in mean household size by survey type among promoter survey water points}", -->
<!--   "\\label{tab:hh_size_survey_comparison}", -->
<!--   "\\def\\sym#1{\\ifmmode^{#1}\\else\\(^{#1}\\)\\fi}", -->
<!--   "\\begin{tabular}{l*{5}c}", -->
<!--   "\\hline\\hline", -->
<!--   "& \\multicolumn{2}{c}{Monitoring Survey} & \\multicolumn{2}{c}{Household Survey} & \\\\", -->
<!--   "\\cmidrule(lr){2-3} \\cmidrule(lr){4-5}", -->
<!--   "& Mean & N & Mean & N & Difference\\\\", -->
<!--   "\\hline" -->
<!-- ) -->

<!-- # add malawi section -->
<!-- latex_lines <- c(latex_lines, "\\textbf{Malawi} & & & & & \\\\", "\\hline") -->
<!-- malawi_data <- table_data %>% dplyr::filter(country == "Malawi") -->
<!-- for (i in 1:nrow(malawi_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       malawi_data$row_label[i], -->
<!--       malawi_data$mean_monitoring_fmt[i], -->
<!--       malawi_data$n_monitoring[i], -->
<!--       malawi_data$mean_household_fmt[i], -->
<!--       malawi_data$n_household[i], -->
<!--       malawi_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # add uganda section -->
<!-- latex_lines <- c(latex_lines, "\\hline", "\\textbf{Uganda} & & & & & \\\\", "\\hline") -->
<!-- uganda_data <- table_data %>% dplyr::filter(country == "Uganda") -->
<!-- for (i in 1:nrow(uganda_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       uganda_data$row_label[i], -->
<!--       uganda_data$mean_monitoring_fmt[i], -->
<!--       uganda_data$n_monitoring[i], -->
<!--       uganda_data$mean_household_fmt[i], -->
<!--       uganda_data$n_household[i], -->
<!--       uganda_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # close table -->
<!-- latex_lines <- c(latex_lines, -->
<!--   "\\hline\\hline", -->
<!--   "\\multicolumn{6}{l}{\\footnotesize \\sym{*} \\(p<0.10\\), \\sym{**} \\(p<0.05\\), \\sym{***} \\(p<0.01\\)}\\\\", -->
<!--   "\\end{tabular}", -->
<!--   "\\end{table}" -->
<!-- ) -->

<!-- # print the table -->
<!-- cat(latex_lines, sep = "\n") -->
<!-- ``` -->

<!-- #### hh count -->
<!-- ```{r} -->
<!-- # household count for promoter surveyed -->
<!-- hh_count_promoter_from_census <- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     promoter_surveyed == TRUE, -->
<!--     wp_func == TRUE, -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   # count unique households per water point -->
<!--   group_by(country, sample_group, wp_intervention, wp_id) %>% -->
<!--   summarise( -->
<!--     village_id = dplyr::first(village_id), -->
<!--     # hh_count = n_distinct(household_id), -->
<!--     hh_count = n(), -->
<!--     .groups = "drop" -->
<!--   ) -->

<!-- # now calculate mean CI on these counts -->
<!-- hh_count_promoter_avg <- calculate_mean_ci(hh_count_promoter_from_census, "hh_count", 1) -->

<!-- hh_count_promoter_avg -->

<!-- # for non-promoter surveyed WPs, calculate HH count from household census -->
<!-- hh_count_nonpromoter_from_census <- hh_census %>% -->
<!--   dplyr::filter( -->
<!--     promoter_surveyed == FALSE, -->
<!--     wp_func == TRUE, -->
<!--     wp_intervention != "Non-program" -->
<!--   ) %>% -->
<!--   # count unique households per water point -->
<!--   group_by(country, sample_group, wp_intervention, wp_id) %>% -->
<!--   summarise( -->
<!--     village_id = dplyr::first(village_id), -->
<!--     # hh_count = n_distinct(household_id), -->
<!--     hh_count = n(), -->
<!--     .groups = "drop" -->
<!--   ) -->

<!-- # now calculate mean CI on these counts -->
<!-- hh_count_nonpromoter_avg <- calculate_mean_ci(hh_count_nonpromoter_from_census, "hh_count", 1) -->

<!-- hh_count_nonpromoter_avg -->

<!-- # combine with promoter data and run t-tests -->
<!-- hh_count_comparison <- bind_rows( -->
<!--   hh_count_promoter_avg %>% mutate(promoter_surveyed = TRUE), -->
<!--   hh_count_nonpromoter_avg %>% mutate(promoter_surveyed = FALSE) -->
<!-- ) -->

<!-- # run t-tests for each country/sample_group/intervention combination -->
<!-- # run t-tests for each country/sample_group/intervention combination -->
<!-- hh_count_ttest <- hh_count_comparison %>% -->
<!--   group_by(country, sample_group, wp_intervention) %>% -->
<!--   group_split() %>% -->
<!--   map_df( -->
<!--     ~ { -->
<!--       # extract the two means and SEs -->
<!--       promoter_row <- .x %>% dplyr::filter(promoter_surveyed == TRUE) -->
<!--       nonpromoter_row <- .x %>% dplyr::filter(promoter_surveyed == FALSE) -->

<!--       # calculate n from original datasets -->
<!--       n_prom <- hh_count_promoter_from_census %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->
<!--       n_nonprom <- hh_count_nonpromoter_from_census %>% -->
<!--         dplyr::filter(country == unique(.x$country), -->
<!--                      sample_group == unique(.x$sample_group), -->
<!--                      wp_intervention == unique(.x$wp_intervention)) %>% -->
<!--         nrow() -->

<!--       # calculate z-statistic (using normal approximation since we have SEs) -->
<!--       diff <- promoter_row$mean - nonpromoter_row$mean -->
<!--       se_diff <- sqrt(promoter_row$se^2 + nonpromoter_row$se^2) -->
<!--       z_stat <- diff / se_diff -->
<!--       p_value <- 2 * (1 - pnorm(abs(z_stat))) -->

<!--       tibble( -->
<!--         country = unique(.x$country), -->
<!--         sample_group = unique(.x$sample_group), -->
<!--         wp_intervention = unique(.x$wp_intervention), -->
<!--         mean_promoter = promoter_row$mean, -->
<!--         mean_nonpromoter = nonpromoter_row$mean, -->
<!--         n_promoter = n_prom, -->
<!--         n_nonpromoter = n_nonprom, -->
<!--         difference = diff, -->
<!--         se_difference = se_diff, -->
<!--         z_statistic = z_stat, -->
<!--         p_value = p_value, -->
<!--         significant = p_value < 0.1 -->
<!--       ) -->
<!--     } -->
<!--   ) -->

<!-- hh_count_ttest -->
<!-- ``` -->

<!-- #####LaTeX table -->
<!-- ```{r} -->
<!-- # function to add significance stars -->
<!-- add_stars <- function(p_value) { -->
<!--   if (p_value < 0.01) return("\\sym{***}") -->
<!--   if (p_value < 0.05) return("\\sym{**}") -->
<!--   if (p_value < 0.10) return("\\sym{*}") -->
<!--   return("") -->
<!-- } -->

<!-- # prepare data for table -->
<!-- table_data <- hh_count_ttest %>% -->
<!--   mutate( -->
<!--     stars = map_chr(p_value, add_stars), -->
<!--     # format the numbers to 2 decimal places -->
<!--     mean_promoter_fmt = sprintf("%.2f", mean_promoter), -->
<!--     mean_nonpromoter_fmt = sprintf("%.2f", mean_nonpromoter), -->
<!--     difference_fmt = paste0(sprintf("%.2f", difference), stars) -->
<!--   ) %>% -->
<!--   # create row labels -->
<!--   mutate( -->
<!--     row_label = case_when( -->
<!--       wp_intervention == "DSW" & sample_group == "Footprint" ~ "Footprint", -->
<!--       wp_intervention == "DSW" & sample_group == "Expansion" ~ "Expansion", -->
<!--       wp_intervention == "DSW" & sample_group == "ILC" ~ "DSW in ILC vill.", -->
<!--       wp_intervention == "ILC" & sample_group == "ILC" ~ "ILC", -->
<!--       TRUE ~ paste(sample_group, wp_intervention) -->
<!--     ) -->
<!--   ) %>% -->
<!--   arrange(country, match(sample_group, c("Footprint", "Expansion", "ILC"))) -->

<!-- # start building latex table -->
<!-- latex_lines <- c( -->
<!--   "\\begin{table}[htbp]\\centering", -->
<!--   "\\caption{Difference in mean household count per water point according to Household Census by whether water point is in Promoter Survey}", -->
<!--   "\\label{tab:hh_count_pmsurvey}", -->
<!--   "\\def\\sym#1{\\ifmmode^{#1}\\else\\(^{#1}\\)\\fi}", -->
<!--   "\\begin{tabular}{l*{5}c}", -->
<!--   "\\hline\\hline", -->
<!--   "& \\multicolumn{2}{c}{Promoter Survey} & \\multicolumn{2}{c}{Not In Promoter Survey} & \\\\", -->
<!--   "\\cmidrule(lr){2-3} \\cmidrule(lr){4-5}", -->
<!--   "& Mean & N & Mean & N & Difference\\\\", -->
<!--   "\\hline" -->
<!-- ) -->

<!-- # add malawi section -->
<!-- latex_lines <- c(latex_lines, "\\textbf{Malawi} & & & & & \\\\", "\\hline") -->
<!-- malawi_data <- table_data %>% dplyr::filter(country == "Malawi") -->
<!-- for (i in 1:nrow(malawi_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       malawi_data$row_label[i], -->
<!--       malawi_data$mean_promoter_fmt[i], -->
<!--       malawi_data$n_promoter[i], -->
<!--       malawi_data$mean_nonpromoter_fmt[i], -->
<!--       malawi_data$n_nonpromoter[i], -->
<!--       malawi_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # add uganda section -->
<!-- latex_lines <- c(latex_lines, "\\hline", "\\textbf{Uganda} & & & & & \\\\", "\\hline") -->
<!-- uganda_data <- table_data %>% dplyr::filter(country == "Uganda") -->
<!-- for (i in 1:nrow(uganda_data)) { -->
<!--   latex_lines <- c(latex_lines,  -->
<!--     sprintf("%s & %s & %d & %s & %d & %s \\\\",  -->
<!--       uganda_data$row_label[i], -->
<!--       uganda_data$mean_promoter_fmt[i], -->
<!--       uganda_data$n_promoter[i], -->
<!--       uganda_data$mean_nonpromoter_fmt[i], -->
<!--       uganda_data$n_nonpromoter[i], -->
<!--       uganda_data$difference_fmt[i] -->
<!--     ) -->
<!--   ) -->
<!-- } -->

<!-- # close table -->
<!-- latex_lines <- c(latex_lines, -->
<!--   "\\hline\\hline", -->
<!--   "\\multicolumn{6}{l}{\\footnotesize \\sym{*} \\(p<0.10\\), \\sym{**} \\(p<0.05\\), \\sym{***} \\(p<0.01\\)}\\\\", -->
<!--   "\\end{tabular}", -->
<!--   "\\end{table}" -->
<!-- ) -->

<!-- # print the table -->
<!-- cat(latex_lines, sep = "\n") -->
<!-- ``` -->

<!-- ### non primary users -->
<!-- ```{r} -->
<!-- hh_number_wps <- hh_census %>% -->
<!--   group_by(country) %>% -->
<!--   summarize( -->
<!--     multiple_wps = mean(wp_secweek, na.rm = TRUE), -->
<!--     n = n() -->
<!--   ) -->

<!-- hh_number_wps -->

<!-- hh_number_wps_pmlist <- hh_census %>% -->
<!--   dplyr::filter(promoter_list == TRUE) %>% -->
<!--   group_by(country) %>% -->
<!--   summarize( -->
<!--     multiple_wps = mean(wp_secweek, na.rm = TRUE), -->
<!--     n = n() -->
<!--   ) -->

<!-- hh_number_wps_pmlist -->
<!-- ``` -->

<!-- ####what if we count all households that report using more than 1 water point as using DSW/ILC  -->
<!-- ```{r} -->
<!-- users_data_alt <- -->
<!--   hh_census %>% -->
<!--   dplyr::filter( -->
<!--     wp_invillage, -->
<!--     !(sample_group != "ILC" & wp_intervention == "ILC") -->
<!--     ) %>% -->
<!--   mutate( -->
<!--   wp_intervention = if_else( -->
<!--     wp_secweek == TRUE & wp_intervention == "Non-program", -->
<!--     "DSW", -->
<!--     wp_intervention -->
<!--   ) -->
<!--   ) %>% -->
<!--   dplyr::filter(wp_intervention != "Non-program") -->

<!-- users_data_alt <- -->
<!--   users_data_alt %>% -->
<!--   group_by(country, sample_group) %>% -->
<!--   mutate( -->
<!--     hh_members = if_else( -->
<!--       !is.na(hh_members),  -->
<!--       hh_members,  -->
<!--       mean(hh_members, na.rm = TRUE) -->
<!--     ) -->
<!--   ) -->

<!-- users_data_alt <- -->
<!--   users_data_alt %>% -->
<!--   full_join( -->
<!--     village_intervention %>%  -->
<!--       select(village_id, country, sample_group, wp_intervention) -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     hh_members = replace_na(hh_members, 0) -->
<!--   ) -->

<!-- users_village_alt <- -->
<!--   users_data_alt %>% -->
<!--   group_by(village_id, country, sample_group, wp_intervention) %>% -->
<!--   summarise( -->
<!--     response_rate = unique(response_rate), -->
<!--     hhs = n(), -->
<!--     users = sum(hh_members) -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     users_increased = users/response_rate -->
<!--   ) -->

<!-- users_village_alt <- -->
<!--   users_village_alt %>% -->
<!--   left_join(sample_sizes) %>% -->
<!--   group_by(country, sample_group) %>% -->
<!--   mutate( -->
<!--     weight = n_villages/n_distinct(village_id) -->
<!--   ) %>% -->
<!--   ungroup -->

<!-- users_village_alt <- -->
<!--   users_village_alt %>% -->
<!--   dplyr::filter(hhs > 1) -->

<!-- people_per_country_alt <- -->
<!--   map( -->
<!--     users_village_alt %>% -->
<!--       group_by(country, wp_intervention) %>% -->
<!--       group_split(), -->
<!--     ~ total_ci( -->
<!--         var = "users_increased", -->
<!--         design = svydesign( -->
<!--           id = ~ village_id, -->
<!--           data = .x,  -->
<!--           weights = ~ weight -->
<!--         ) -->
<!--       ) %>% -->
<!--       mutate( -->
<!--         country = .x %>% pull(country) %>% unique, -->
<!--         wp_intervention = .x %>% pull(wp_intervention) %>% unique, -->
<!--         villages = .x %>% pull(village_id) %>% n_distinct, -->
<!--         hhs = .x %>% pull(hhs) %>% sum, -->
<!--         pop = .x %>% pull(n_villages) %>% unique %>% sum -->
<!--       ) -->
<!--   ) %>%  -->
<!--   bind_rows() %>% -->
<!--   select( -->
<!--     country, wp_intervention,  -->
<!--     outcome,  -->
<!--     villages, -->
<!--     everything() -->
<!--   ) %>% -->
<!--   arrange(outcome) -->

<!-- table1_alt <- people_per_country_alt %>% -->
<!--   select(country, wp_intervention, total, lb, ub, se) %>% -->
<!--   mutate( -->
<!--     indiv_access_popn = total -->
<!--   ) %>% -->
<!--   select(-total)  -->

<!-- table1_alt -->

<!-- table1country_alt <- table1_alt %>% -->
<!--   group_by(country) %>% -->
<!--   summarise( -->
<!--     indiv_access_popn = sum(indiv_access_popn), -->
<!--     # SE of sum: sqrt(sum of squared SEs) assuming independence -->
<!--     se = sqrt(sum(se^2, na.rm = TRUE)) -->
<!--   ) %>% -->
<!--   # CI -->
<!--   mutate( -->
<!--     lb = indiv_access_popn - 1.96 * se, -->
<!--     ub = indiv_access_popn + 1.96 * se -->
<!--   ) -->

<!-- table1country_alt -->
<!-- ``` -->

<!-- ### double counting -->
<!-- ```{r} -->
<!-- hh_double_count_stats <- hh_census %>% -->
<!--   dplyr::filter(promoter_list == TRUE) %>% -->
<!--   summarise( -->
<!--     total_hh = n_distinct(household_id), -->
<!--     hh_multiple_mentions = sum(promoter_list_mentions > 1, na.rm = TRUE), -->
<!--     share_multiple_mentions = hh_multiple_mentions / total_hh, -->
<!--     share_pct = round(share_multiple_mentions * 100, 1), -->
<!--     # calculate average mentions for those with multiple mentions -->
<!--     avg_mentions = mean(promoter_list_mentions[promoter_list_mentions > 1], na.rm = TRUE), -->
<!--     # wp_secweek is TRUE -> hh reports using additional water sources -->
<!--     hh_report_multiple = sum(promoter_list_mentions > 1 & wp_secweek == TRUE, na.rm = TRUE), -->
<!--     share_report_multiple = hh_report_multiple / hh_multiple_mentions, -->
<!--     share_report_multiple_pct = round(share_report_multiple * 100, 0), -->
<!--     # wp_secweek is FALSE -> hh reports not using any additional water sources (double counted) -->
<!--     hh_double_counted = sum(promoter_list_mentions > 1 & wp_secweek == FALSE, na.rm = TRUE) -->
<!--   ) -->

<!-- # auto-generate text summary -->
<!-- cat(sprintf("Among the %s distinct households listed by promoters across Evidence Action water points that were matched to the household census, we identified %d households (around %s%%) as listed to be using more than one (on average %s) of these water points. Of these %d, only %d%% self-report using more than one water point in the household census: in the remaining %d cases, promoters are double-counting households.\n", -->
<!--             format(hh_double_count_stats$total_hh, big.mark = ","), -->
<!--             hh_double_count_stats$hh_multiple_mentions, -->
<!--             hh_double_count_stats$share_pct, -->
<!--             round(hh_double_count_stats$avg_mentions, 0), -->
<!--             hh_double_count_stats$hh_multiple_mentions, -->
<!--             hh_double_count_stats$share_report_multiple_pct, -->
<!--             hh_double_count_stats$hh_double_counted)) -->
<!-- ``` -->
<!-- ### hhs that report not using DSW/ILC -->
<!-- ```{r} -->
<!-- pm_list_nonprogram <- hh_census %>% -->
<!--   dplyr::filter(promoter_list == TRUE) %>% -->
<!--   group_by(country) %>% -->
<!--   summarize( -->
<!--     non_program = sum(wp_intervention == "Non-program", na.rm = TRUE), -->
<!--     non_program_one = sum(wp_intervention == "Non-program" & wp_secweek == FALSE, na.rm = TRUE), -->
<!--     program = sum(wp_intervention == "DSW" | wp_intervention == "ILC", na.rm = TRUE), -->
<!--     share_non_program = non_program/program, -->
<!--     share_non_program_one = non_program_one/program -->
<!--   ) -->

<!-- pm_list_nonprogram -->
<!-- ``` -->

<!-- ###response rates -->
<!-- ```{r} -->
<!-- hh_census_response <- hh_census %>% -->
<!--   group_by(country) %>% -->
<!--   summarise( -->
<!--     response_rate = mean(response) -->
<!--   ) -->

<!-- hh_census_response -->
<!-- ``` -->

<!-- ##---------------EXPLORATORY--------------- -->
<!-- ## Regressions of chlorination on being listed by promoter -->
<!-- ###  tcr, control for promoter surveyed -->
<!-- ```{r} -->
<!-- library(estimatr) -->

<!-- promoter_wp_households <- hh_survey #%>% -->
<!--   # dplyr::filter(promoter_surveyed == 1)  -->

<!-- uganda_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- malawi_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Malawi") -->

<!-- uganda_model <- lm_robust(disctcr_02 ~ promoter_list + promoter_surveyed,  -->
<!--                           data = uganda_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- malawi_model <- lm_robust(disctcr_02 ~ promoter_list + promoter_surveyed,  -->
<!--                           data = malawi_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- # convert to regular lm objects for stargazer -->
<!-- uganda_lm <- lm(disctcr_02 ~ promoter_list + promoter_surveyed, data = uganda_promoter_wp) -->
<!-- malawi_lm <- lm(disctcr_02 ~ promoter_list + promoter_surveyed, data = malawi_promoter_wp) -->

<!-- stargazer(uganda_lm, malawi_lm, -->
<!--           type = "text", -->
<!--           title = "Association between Being Listed by Promoter, Water Point in Promoter Survey, and Chlorination", -->
<!--           dep.var.labels = "disctcr 02", -->
<!--           # covariate.labels = c("Listed by Promoter"), -->
<!--           column.labels = c("Uganda", "Malawi"), -->
<!--           model.numbers = FALSE, -->
<!--           se = list(uganda_model$std.error, malawi_model$std.error), -->
<!--           p = list(uganda_model$p.value, malawi_model$p.value), -->
<!--           keep.stat = c("n", "rsq", "adj.rsq"), -->
<!--           add.lines = list(c("Clustered SE", "Waterpoint", "Waterpoint"))) -->
<!-- ``` -->

<!-- ### fcr, control for promoter surveyed -->
<!-- ```{r} -->
<!-- library(estimatr) -->

<!-- promoter_wp_households <- hh_survey #%>% -->
<!--   # dplyr::filter(promoter_surveyed == 1)  -->

<!-- uganda_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- malawi_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Malawi") -->

<!-- uganda_model <- lm_robust(discfcr_02 ~ promoter_list + promoter_surveyed,  -->
<!--                           data = uganda_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- malawi_model <- lm_robust(discfcr_02 ~ promoter_list + promoter_surveyed,  -->
<!--                           data = malawi_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- # convert to regular lm objects for stargazer -->
<!-- uganda_lm <- lm(discfcr_02 ~ promoter_list + promoter_surveyed, data = uganda_promoter_wp) -->
<!-- malawi_lm <- lm(discfcr_02 ~ promoter_list + promoter_surveyed, data = malawi_promoter_wp) -->

<!-- stargazer(uganda_lm, malawi_lm, -->
<!--           type = "text", -->
<!--           title = "Association between Being Listed by Promoter, Water Point in Promoter Survey, and Chlorination", -->
<!--           dep.var.labels = "discfcr 02", -->
<!--           # covariate.labels = c("Listed by Promoter"), -->
<!--           column.labels = c("Uganda", "Malawi"), -->
<!--           model.numbers = FALSE, -->
<!--           se = list(uganda_model$std.error, malawi_model$std.error), -->
<!--           p = list(uganda_model$p.value, malawi_model$p.value), -->
<!--           keep.stat = c("n", "rsq", "adj.rsq"), -->
<!--           add.lines = list(c("Clustered SE", "Waterpoint", "Waterpoint"))) -->
<!-- ``` -->

<!-- ### tcr, no controls -->
<!-- ```{r} -->
<!-- library(estimatr) -->

<!-- uganda_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- malawi_promoter_wp <- hh_survey %>% -->
<!--   dplyr::filter(country == "Malawi") -->

<!-- uganda_model <- lm_robust(disctcr_02 ~ promoter_list,  -->
<!--                           data = uganda_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- malawi_model <- lm_robust(disctcr_02 ~ promoter_list,  -->
<!--                           data = malawi_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- # convert to regular lm objects for stargazer -->
<!-- uganda_lm <- lm(disctcr_02 ~ promoter_list, data = uganda_promoter_wp) -->
<!-- malawi_lm <- lm(disctcr_02 ~ promoter_list, data = malawi_promoter_wp) -->

<!-- stargazer(uganda_lm, malawi_lm, -->
<!--           type = "text", -->
<!--           title = "Association between Being Listed by Promoter and Chlorination", -->
<!--           dep.var.labels = "disctcr 02", -->
<!--           # covariate.labels = c("Listed by Promoter"), -->
<!--           column.labels = c("Uganda", "Malawi"), -->
<!--           model.numbers = FALSE, -->
<!--           se = list(uganda_model$std.error, malawi_model$std.error), -->
<!--           p = list(uganda_model$p.value, malawi_model$p.value), -->
<!--           keep.stat = c("n", "rsq", "adj.rsq"), -->
<!--           add.lines = list(c("Clustered SE", "Waterpoint", "Waterpoint"))) -->
<!-- ``` -->

<!-- ### tcr, limit sample to promoter surveyed -->
<!-- ```{r} -->
<!-- library(estimatr) -->

<!-- promoter_wp_households <- hh_survey %>% -->
<!--   dplyr::filter(promoter_surveyed == 1) -->

<!-- uganda_promoter_wp <- promoter_wp_households %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- malawi_promoter_wp <- promoter_wp_households %>% -->
<!--   dplyr::filter(country == "Malawi") -->

<!-- uganda_model <- lm_robust(disctcr_02 ~ promoter_list,  -->
<!--                           data = uganda_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- malawi_model <- lm_robust(disctcr_02 ~ promoter_list,  -->
<!--                           data = malawi_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- # convert to regular lm objects for stargazer -->
<!-- uganda_lm <- lm(disctcr_02 ~ promoter_list, data = uganda_promoter_wp) -->
<!-- malawi_lm <- lm(disctcr_02 ~ promoter_list, data = malawi_promoter_wp) -->

<!-- stargazer(uganda_lm, malawi_lm, -->
<!--           type = "text", -->
<!--           title = "Association between Being Listed by Promoter and Chlorination among Promoter Survey Water Point Users", -->
<!--           dep.var.labels = "disctcr 02", -->
<!--           # covariate.labels = c("Listed by Promoter"), -->
<!--           column.labels = c("Uganda", "Malawi"), -->
<!--           model.numbers = FALSE, -->
<!--           se = list(uganda_model$std.error, malawi_model$std.error), -->
<!--           p = list(uganda_model$p.value, malawi_model$p.value), -->
<!--           keep.stat = c("n", "rsq", "adj.rsq"), -->
<!--           add.lines = list(c("Clustered SE", "Waterpoint", "Waterpoint"))) -->
<!-- ``` -->

<!-- ### tcr continuous (as opposed to disctcr_02) -->
<!-- ```{r} -->
<!-- library(estimatr) -->

<!-- promoter_wp_households <- hh_survey %>% -->
<!--   dplyr::filter(promoter_surveyed == 1) -->

<!-- uganda_promoter_wp <- promoter_wp_households %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- malawi_promoter_wp <- promoter_wp_households %>% -->
<!--   dplyr::filter(country == "Malawi") -->

<!-- uganda_model <- lm_robust(disctcr ~ promoter_list,  -->
<!--                           data = uganda_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- malawi_model <- lm_robust(disctcr ~ promoter_list,  -->
<!--                           data = malawi_promoter_wp, -->
<!--                           clusters = wp_id) -->

<!-- # convert to regular lm objects for stargazer -->
<!-- uganda_lm <- lm(disctcr ~ promoter_list, data = uganda_promoter_wp) -->
<!-- malawi_lm <- lm(disctcr ~ promoter_list, data = malawi_promoter_wp) -->

<!-- stargazer(uganda_lm, malawi_lm, -->
<!--           type = "text", -->
<!--           title = "Association between Being Listed by Promoter and Chlorination among Promoter Survey Water Point Users", -->
<!--           dep.var.labels = "disctcr", -->
<!--           # covariate.labels = c("Listed by Promoter"), -->
<!--           column.labels = c("Uganda", "Malawi"), -->
<!--           model.numbers = FALSE, -->
<!--           se = list(uganda_model$std.error, malawi_model$std.error), -->
<!--           p = list(uganda_model$p.value, malawi_model$p.value), -->
<!--           keep.stat = c("n", "rsq", "adj.rsq"), -->
<!--           add.lines = list(c("Clustered SE", "Waterpoint", "Waterpoint"))) -->
<!-- ``` -->

<!-- ## Do households surveyed after the promoter respond differently? -->
<!-- ### load rank dataset -->
<!-- ```{r} -->
<!-- pm_survey_clean <- -->
<!--   read_rds( -->
<!--     file.path( -->
<!--       path_box, -->
<!--       "Data", -->
<!--       "PromoterSurvey", -->
<!--       "DataSets", -->
<!--       "Clean", -->
<!--       "pm-survey-clean.rds" -->
<!--     ) -->
<!--   ) -->

<!-- randomization <- pm_survey_clean %>%  -->
<!--   dplyr::select( -->
<!--     wp_id, village_id, country, -->
<!--     contains("rand_hh") -->
<!--   ) %>% -->
<!--   pivot_longer( -->
<!--     cols = starts_with("rand_hh"), -->
<!--     names_prefix = "rand_hh_", -->
<!--     names_to = "rank", -->
<!--     values_to = "household_name", -->
<!--     values_drop_na = TRUE -->
<!--   ) %>% -->
<!--   mutate(household_name = household_name %>% str_squish %>% str_trim) -->


<!-- hhc <- -->
<!--   read_rds( -->
<!--     file.path( -->
<!--       path_box, -->
<!--       "Data", -->
<!--       "HouseholdCensus", -->
<!--       "DataSets", -->
<!--       "Constructed", -->
<!--       "hh-census-constructed.rds" -->
<!--     ) -->
<!--   ) %>% -->
<!--   select(village_id, household_id, household_name) -->

<!-- randomization_id <- -->
<!--   randomization %>% -->
<!--   left_join(hhc) -->

<!-- hh_survey <- hh_survey %>% -->
<!--   left_join( -->
<!--     randomization_id %>% select(household_id, rank), -->
<!--     by = "household_id" -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- table(hh_survey$survey, hh_survey$rank, useNA = "always") -->
<!-- ``` -->

<!-- ### test -->
<!-- ```{r} -->
<!-- chlor <- hh_survey %>% -->
<!--   dplyr::filter(!is.na(rank)) %>% # only HHs randomized into monitoring -->
<!--   dplyr::filter(survey == "Household Survey" & rank < 5 | survey == "Monitoring Survey")  -->

<!-- table <- chlor_uganda %>% -->
<!--   group_by(survey) %>% -->
<!--   summarize( -->
<!--     disctcr_02 = mean(disctcr_02, na.rm = TRUE), -->
<!--     discfcr_02 = mean(discfcr_02, na.rm = TRUE) -->
<!--   ) -->

<!-- table -->

<!-- chlor_uganda <- chlor %>% -->
<!--   dplyr::filter(country == "Uganda") -->

<!-- # run regressions -->
<!-- model1 <- lm_robust(disctcr_02 ~ survey, -->
<!--                     data = chlor_uganda, -->
<!--                     clusters = wp_id) -->

<!-- model2 <- lm_robust(discfcr_02 ~ survey, -->
<!--                     data = chlor_uganda, -->
<!--                     clusters = wp_id) -->

<!-- # extract components from lm_robust objects -->
<!-- coef1 <- model1$coefficients -->
<!-- se1 <- model1$std.error -->
<!-- coef2 <- model2$coefficients -->
<!-- se2 <- model2$std.error -->

<!-- # fit regular lm models (just for stargazer structure) -->
<!-- model1_lm <- lm(disctcr_02 ~ survey, data = chlor_uganda) -->
<!-- model2_lm <- lm(discfcr_02 ~ survey, data = chlor_uganda) -->

<!-- # create stargazer table with clustered SEs from lm_robust -->
<!-- stargazer(model1_lm, model2_lm, -->
<!--           se = list(se1, se2), -->
<!--           type = "text", -->
<!--           title = "Uganda Association between Survey and Chlorination (Monitoring vs Household Survey & Rank <=4)", -->
<!--           column.labels = c("DISCTCR", "DISCFCR"), -->
<!--           covariate.labels = c("Monitoring Survey"), -->
<!--           dep.var.labels = c(" ", " ")) -->
<!-- ``` -->


