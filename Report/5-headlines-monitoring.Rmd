# Monitoring headline results

```{r}
mon_survey_cl <-
  mon_survey %>%
  left_join(pm_list) %>%
  mutate(
    wp_pm = case_when(
      household_id == "BAY458081MW2" ~ "2011503007001",
      household_id == "BAEO16224MW2" ~ "2011503007003",
      household_id == "BAI346179MW2" ~ "2011503007003",
      household_id == "BASN33451MW2" ~ "2011503007003",
      household_id == "BAY458081MW4" ~ "2011503007003",
      household_id == "BA5Y361410MW2" ~ "2011503007004",
      household_id == "BAY458081MW3" ~ "2011503007004",
      household_id == "BA1E582610MW2" ~ "2011515073007",
      household_id == "BAWX412210MW2" ~ "2011707039003",
      household_id == "BLFJ09035MW2" ~ "2020110100002",
      household_id == "BLG724165MW2" ~ "2020205040001",
      household_id == "BLG724165MW3" ~ "2020205040004",
      household_id == "MA3S55308MW2" ~ "2040905012001",
      household_id == "MAPC56488MW2" ~ "2040905012001",
      household_id == "MAXG56304MW2" ~ "2040905012001",
      household_id == "MW5E39032MW2" ~ "2060102007008",
      household_id == "NEQA47541MW2" ~ "2070204024002",
      household_id == "NET446577MW2" ~ "2070204024002",
      household_id == "NE7K54189MW2" ~ "2070204024004",
      household_id == "NEDO245610MW2" ~ "2070204024004",
      household_id == "NEXA58232MW2" ~ "2070204024004",
      household_id == "NEPP33065MW2" ~ "2070301001029",
      household_id == "ZO4W13465MW3" ~ "2100235211002",
      household_id == "ZO4W13465MW4" ~ "2100235211002",
      household_id == "ZO4W13465MW2" ~ "2100235211003",
      household_id == "ZOI5575710MW2" ~ "2101357361002",
      household_id == "BA6D16248MW2" ~ "2101433260009",
      TRUE ~ wp_pm
    )
  ) %>%
  left_join(
    wp_census %>%
    transmute(wp_pm = wp_id, intervention = intervention %>% as.character())
  ) %>%
  mutate(
    wp_intervention_mon = case_when(
      ea_program_vil != "DSW & ILC" ~ ea_program_vil,
      TRUE ~ intervention
    )
  ) %>%
  dplyr::filter(
    !is.na(wp_intervention_mon), 
    !(wp_intervention_mon == "ILC" & sample_group != "ILC"),
    !(village_id %in% c("2011503007", "1051001007", "1211104003")) # only one color wheel test
  ) 
```

## Number of people reached

### Average number of households per water point

```{r}
hh_per_wp <-
  wp_census %>%
  dplyr::filter(
    wp_func,
    intervention != "Non-program", 
    !is.na(pm_users)
  ) %>%
  mutate(weight = 1) %>%
  group_by(
    country, sample_group, intervention
  ) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "pm_users",
      dummy = FALSE,
      data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention_mon = .x %>% pull(intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>%
  select(country, sample_group, wp_intervention_mon, av_hhs = mean, av_hhs_se = se)
```

### Average number of people per household

```{r}
people_per_hh <-
  mon_survey_cl %>%
  group_by(
    country, sample_group
  ) %>%
  dplyr::filter(n() > 2) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "hh_members",
      dummy = FALSE,
      data = .x
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      sample_group = .x %>% pull(sample_group) %>% unique
    )
  ) %>%
  select(country, sample_group, av_size = mean, av_size_se = se)
```

### Total number of people per group

```{r}
total_people <- 
  hh_per_wp %>%
  left_join(
    people_per_hh
  ) %>%
  # Calculate people per WP and its SE using delta method
  left_join(
    wp_census %>%
      dplyr::filter(dsw | ilc_wcp) %>%
      rename(wp_intervention_mon = intervention) %>%
      group_by(country, sample_group, wp_intervention_mon) %>%
      summarise(
        func_rate = mean(wp_func, na.rm = TRUE)
      )
  ) %>%
  mutate(
    av_people = av_hhs * av_size,
    # delta method: SE(X*Y) = sqrt((Y^2 * SE_X^2) + (X^2 * SE_Y^2))
    # assuming X and Y are independent
    av_people_se = sqrt(
      (av_size^2) * (av_hhs_se^2) + 
      (av_hhs^2) * (av_size_se^2)
    )
  ) %>%
  # join with population water points - sum across sample_groups
  left_join(
    wp_sample_sizes %>%
      rename(wp_intervention_mon = wp_intervention)
  ) %>%
  # scale up to population
  mutate(
    total_people = av_people * pop_points * func_rate,
    # SE scales linearly with constant: SE(c*X) = c * SE(X)
    total_people_se = av_people_se * pop_points * func_rate,
    # 95% CI for popn_users
    total_people_lb = total_people - 1.96 * total_people_se,
    total_people_ub = total_people + 1.96 * total_people_se
  )
```

### Total number of people per country

```{r}
total_country <-
  total_people %>%
  mutate(total_people_se_sq = total_people_se ^ 2) %>%
  group_by(country, wp_intervention_mon) %>%
  summarise(
    across(
      c(total_people, total_people_se_sq),
      ~ sum(.)
    )
  ) %>%
  mutate(
    total_people_se = sqrt(total_people_se_sq),
    total_people_lb = total_people - 1.96 * total_people_se,
    total_people_ub = total_people + 1.96 * total_people_se,
  ) %>%
  dplyr::filter(!(country == "Uganda" & wp_intervention_mon == "ILC"))
```

### Does it make sense to assume independence?

```{r}
cor_data <-
  hh_survey %>% 
  bind_rows(mon_survey_cl) %>%
  select(household_id, village_id, country, sample_group, wp_intervention_mon, survey, wp_id, hh_members) %>%
  left_join(
    wp_census %>%
      select(wp_id, pm_users)
  ) %>%
  dplyr::filter(
    !is.na(hh_members),
    !is.na(pm_users)
  )

cor(cor_data$hh_members, cor_data$pm_users)

cor_data <-
  mon_survey_cl %>%
  select(household_id, village_id, country, sample_group, wp_intervention_mon, survey, wp_id, hh_members) %>%
  left_join(
    wp_census %>%
      select(wp_id, pm_users)
  ) %>%
  dplyr::filter(
    !is.na(hh_members),
    !is.na(pm_users)
  )

cor(cor_data$hh_members, cor_data$pm_users)

cor.test(cor_data$hh_members, cor_data$pm_users)$conf.int
```



## Chlorination rates

```{r}
feols(
  discfcr_02 ~ wp_intervention_mon,
  cluster = ~ village_id,
  data = mon_survey_cl %>%
    dplyr::filter(country == "Malawi")
) %>% 
  summary
```


```{r}
mon_survey_cl %>%
  tabyl(sample_group, wp_intervention_mon)
```

```{r}
mon_survey_cl %>%
  tabyl(sample_group, wp_intervention_mon) %>%
  adorn_percentages() %>%
  adorn_pct_formatting()
```

```{r}
mon_survey_cl %>%
  group_by(country, sample_group, wp_intervention_mon) %>%
  summarise(
    n = sum(!is.na(disctcr_02)),
    mean = mean(disctcr_02, na.rm = TRUE)
  )
```


```{r}
chlorine_am <-
  mon_survey_cl %>%
  mutate(weight = 1) %>%
  group_by(country, wp_intervention_mon) %>%
  group_split %>%
  map_dfr(
    ~ map_dfr(
      c("discfcr_02", "disctcr_02"),
      \(outcome) mean_ci(
        .x, 
        var = outcome
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention_mon = .x %>% pull(wp_intervention_mon) %>% unique,
        hhs = .x %>% pull(household_id) %>% n_distinct,
        villages = .x %>% pull(village_id) %>% n_distinct,
      )
    )
  ) %>%
  select(country, wp_intervention_mon, outcome, everything()) %>%
  arrange(desc(outcome))
```

## Table

```{r}
footnote_text <-
  c(
    "Confidence intervals are calculated based on standard errors clustered at the village level.",
    "We limit the sample to functional water points present in the Promoter Survey for water point data, and to households in the Monitoring Survey for household data. In both cases, we exclude households using water points with ILC in DSW villages, since we did not design the sample to be representative of these cases.",
    "The number of people using water points with DSW or ILC in the country is estimated by multiplying (1) the average number of households per water point, by (2) the average household size of a household using a water point, and by (3) the country number of water points of a given intervention.",
    "In calculating the average number of households per water point for a given intervention, we take a simple average of the number of households per water point among water points of a given category. This means that each water point has weight 1. In calculating the average household size of households using water points in a given category, we take a simple average of the household sizes of households using water points in a given category. This means that each household with an observation receives a weight of 1.",
    "To calculate the number of people using ILC water points in Malawi, we scale the country number of ILC water points (2024) by a factor of 0.85 (2025 × 0.85 = 1720). This is to account for the fact that in our data collection process, if an ILC village had a non-functional water point, it was replaced. The functionality rate we identified was 85%. We want to avoid biasing our estimates by not having villages with non-functional ILC in our sample of visited villages. We assume that the share of villages with non-functional ILC is the same in the population as it was in our sample. These villages will have 0 users and 0% chlorination rates from Evidence Action interventions. Multiplying by 0.85 is thus equivalent to giving a 15% weight to villages with no users and no chlorination.",
    "The chlorination rates express the estimated average share of households with detected chlorine per functional water point, among households reported to be using the water point (by the promoter). We limit the sample to households in the Monitoring Survey. In calculating average chlorination rates, we take a simple mean of the chlorine test outcomes for a given category. This means that each household receives a weight of 1."
  )

cl <-
  chlorine_am %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% 
        round(1) %>% 
        str_remove_all(" ")
    ),
    ci = paste0("(", lb, ", ", ub, ")") ,
    hhs = hhs %>% format(big.mark = ",")
  ) %>%
  select(country, wp_intervention_mon, outcome, hhs, est = mean, ci) %>%
  pivot_wider(
    values_from = c(est, ci),
    names_from = outcome
  ) %>%
  pivot_longer(
    cols = ends_with("02"),
    names_pattern = "(.*)_disc(.*)_02",
    names_to = c("name", ".value")
  )

people <-
  total_country %>%
  left_join(
    wp_sample_sizes %>%
      group_by(country, wp_intervention) %>%
      summarise(pop = sum(pop_points)) %>%
      rename(wp_intervention_mon = wp_intervention)
  ) %>%
  mutate(
    across(
      c(total_people, total_people_lb, total_people_ub, pop),
      ~ . %>% 
        round %>% 
        format(big.mark = ",") %>%
        str_remove_all(" ")
    ),
    ci = paste0("(", total_people_lb, ", ", total_people_ub, ")") 
  ) %>%
  select(
    country, wp_intervention_mon, pop, est = total_people, ci
  ) %>%
  pivot_longer(
    cols = c(est, ci),
    values_to = "people"
  ) 

obs <-
  wp_census %>%
  dplyr::filter(
    promoter_surveyed,
    intervention != "Non-program",
    !(country == "Uganda" & intervention == "ILC")
  ) %>%
  group_by(country, intervention) %>%
  summarise(
    wps = n(),
    listed_hhs = sum(pm_users, na.rm = TRUE) %>% format(big.mark = ",")
  ) %>%
  mutate(name = "est") %>%
  rename(wp_intervention_mon = intervention)

tab <- 
  obs %>% 
  mutate(wp_intervention_mon = as.character(wp_intervention_mon)) %>%
  full_join(people) %>%
  left_join(cl) %>%
  arrange(country, wp_intervention_mon, desc(name)) %>%
  ungroup %>%
  mutate(
    across(
      everything(),
      ~ as.character(.)
    ),
    across(
      -c(people, tcr, fcr),
      ~ case_when(
        name == "est" ~ .,
        TRUE ~ ""
      )
    )
  ) %>%
  dplyr::filter(!is.na(country))%>%
  select(-c(name, country)) 

table <-
  latex_table(
    tab, 
    escape = F,
    align = "lccccccc", 
    col.names = linebreak(
      c("Intervention", "\\#WP", "\\#HH", "\\#WP", "People using\nDSW/ILC\n(95\\% CI)", "\\#HH", "TCR\n(95\\% CI)", "FCR\n(95\\% CI)"),
      align = "c"
    ),
    caption = "Primary outcomes estimated following the Adoption Monitoring method",
    label = "headlines-am",
    numbered_footnote = footnote_text
  ) %>%
  pack_intervention_se %>%
  add_header_above(
    c(
      " ", 
      "Promoter survey" = 2, 
      "Country-level estimates" = 2, 
      "Percent of color wheel readings ≥ 0.2 mg/L" = 3
    )
  ) %>%
  add_header_above(c(" ", paste0("(", 1:7,")")), line = FALSE)

writeLines(
  table, 
  "output/tables/headlines-am.tex"
)
```
