# Reach estimates comparisons

```{r}
mon_survey_cl %>%
  tabyl(wp_intervention_mon, wp_intervention) %>%
  adorn_percentages %>%
  adorn_pct_formatting()
```

```{r}
hh_census %>%
  group_by(wp_id, wp_intervention, country, sample_group) %>%
  summarise(
    households_census = n()
  ) %>%
  inner_join(
    wp_census %>%
      transmute(
        wp_id, 
        pm_users, 
        outside = pm_users_outside/pm_users
      ) %>%
      dplyr::filter(!is.na(pm_users))
  ) %>%
  mutate(
    proportion = pm_users/households_census
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    n = n(),
    users_prop = mean(proportion),
    n_outside = sum(!(is.na(outside))),
    outside_pop = mean(outside, na.rm = TRUE)
  ) %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  )
```



## All estimates

```{r}
monitoring <-
  total_country %>% 
  rename(
    total = total_people, 
    ub = total_people_ub, 
    lb = total_people_lb, 
    wp_intervention = wp_intervention_mon
  )
```


```{r}
plot_data <-
  list(
    "(1)\nCensus Sample,\nvillage-level\n(main estimate)" = people_per_country,
    "(2)\nCensus Sample,\nwater point-level" = users_wp_country,
    "(3)\nPromoter Sample\n(Adoption Monitoring\nmethod)" = monitoring
  ) %>%
  bind_rows(.id = "sample") %>%
  mutate(main = str_detect(sample, "main")) %>%
  dplyr::filter(!(country == "Uganda" & wp_intervention == "ILC")) 

plot <-
  plot_data %>%
  ggplot(
    aes(
      x = sample,
      y = total,
      label = total %>% round %>% format(big.mark = ","),
      ymin = lb,
      ymax = ub,
      fill = main
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  facet_grid2(
    wp_intervention ~ country, 
    scale = "free_y"
  ) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL
  )

plot
```

```{r}
ggplot2::ggsave(
  filename = "output/appendix-graphs/reach-comparison.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)
```


## Households located outside of the village boundaries

### Census, WP-level

```{r}
users_outside_census <-
  users_data_wp %>%
  dplyr::filter(inclusion != "Within village boundaries") %>%
  group_by(country) %>%
  group_split %>%
  map_dfr(
    ~ total_ci(
      var = "hh_members_increased",
      data = .x,
      weights = ~ weight,
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique
      )
  ) %>% 
  select(country, outcome, everything()) %>%
  arrange(outcome)
```

### Monitoring 

```{r}
hhoutside_per_wp <-
  wp_census %>%
  dplyr::filter(
    wp_func,
    intervention != "Non-program", 
    !is.na(pm_users)
  ) %>%
  group_by(
    country, sample_group, intervention
  ) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "pm_users_outside",
      dummy = FALSE,
      data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
      )
  ) %>%
  select(country, sample_group, wp_intervention, av_hhs = mean, av_hhs_se = se)
```

```{r}
total_people <- 
  hhoutside_per_wp %>%
  left_join(people_per_hh) %>%
  # Calculate people per WP and its SE using delta method
  mutate(
    av_people = av_hhs * av_size,
    # delta method: SE(X*Y) = sqrt((Y^2 * SE_X^2) + (X^2 * SE_Y^2))
    # assuming X and Y are independent
    av_people_se = sqrt(
      (av_size^2) * (av_hhs_se^2) + 
      (av_hhs^2) * (av_size_se^2)
    )
  ) %>%
  # join with population water points - sum across sample_groups
  left_join(
    wp_sample_sizes
  ) %>%
  # scale up to population
  mutate(
    total_people = av_people * pop_points,
    total_people_se = av_people_se * pop_points,
    total_people_se_sq = total_people_se ^ 2
  ) %>%
  group_by(country) %>%
  summarise(
    across(
      c(total_people),
      ~ sum(., na.rm = TRUE)
    )
  )
```

## Waterfall chart

### Village-level, remove out-of-village households

```{r}
wf_step1 <-
  users_vil_boundary %>%
  dplyr::filter(wp_intervention != "Non-program") %>%
  group_by(country) %>%
  summarise(
    total = sum(total)
  ) %>%
  mutate(step = 1)
```

### Water point-level, remove out-of-village households

```{r}
wf_step2 <-
  users_data_wp %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%
  group_by(country) %>%
  group_split %>%
  map_dfr(
    ~ total_ci(
      var = "hh_members_increased",
      data = .x,
      weights = ~ weight
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique
      )
  ) %>% 
  transmute(country, total, step = 2)

wf_step2
```

### Water point-level, remove out-of-village households, promoter water points

```{r}
pm_wps <-
  wp_census %>%
  dplyr::filter(promoter_surveyed) %>%
  pull(wp_id)
```


```{r}
sampled_points <-
  wp_census %>%
  dplyr::filter(
    dsw | ilc_wcp,
    wp_id %in% pm_wps
  ) %>%
  rename(wp_intervention = intervention) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    pm_sampled_points = n()
  )

wf_step3 <-
  users_data_wp %>% 
  dplyr::filter(
    inclusion == "Within village boundaries",
    wp_id %in% pm_wps
  ) %>%
  left_join(sampled_points) %>%
  mutate(weight = pop_points/pm_sampled_points) %>%
  group_by(country) %>%
  group_split %>%
  map_dfr(
    ~ total_ci(
      var = "hh_members_increased",
      data = .x,
      weights = ~ weight
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique
      )
  ) %>% 
  transmute(country, total, step = 3)

wf_step3
```

### Monitoring data, remove out-of-village households

```{r}
wf_step4 <-
  wp_census %>%
  dplyr::filter(
    wp_func,
    intervention != "Non-program", 
    !is.na(pm_users)
  ) %>%
  mutate(
    pm_users_inside = pm_users - pm_users_outside,
    func_rate = mean(wp_func, na.rm = TRUE)
  ) %>%
  group_by(
    country, sample_group, intervention
  ) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "pm_users_inside",
      dummy = FALSE,
      data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(intervention) %>% unique,
        wps = .x %>% pull(wp_id) %>% n_distinct,
        func_rate = .x %>% pull(func_rate) %>% unique,
      )
  ) %>%
  select(country, sample_group, wp_intervention, av_hhs = mean, av_hhs_se = se, func_rate) %>%
  left_join(people_per_hh) %>%
  # Calculate people per WP and its SE using delta method
  mutate(
    av_people = av_hhs * av_size,
    # delta method: SE(X*Y) = sqrt((Y^2 * SE_X^2) + (X^2 * SE_Y^2))
    # assuming X and Y are independent
    av_people_se = sqrt(
      (av_size^2) * (av_hhs_se^2) + 
      (av_hhs^2) * (av_size_se^2)
    )
  ) %>%
  # join with population water points - sum across sample_groups
  left_join(
    wp_sample_sizes
  ) %>%
  # scale up to population
  mutate(
    total_people = av_people * pop_points * func_rate
  ) %>%
  group_by(country) %>%
  summarise(
    total = sum(av_people * pop_points * func_rate, na.rm = TRUE)
  ) %>%
  mutate(step = 4)
```

### Combine

```{r}
wf_data <-
  people_per_country %>%
  mutate(step = 0) %>%
  bind_rows(wf_step1) %>%
  bind_rows(wf_step2) %>%
  bind_rows(wf_step3) %>%
  bind_rows(wf_step4) %>%
  bind_rows(monitoring %>% select(-ub,-lb) %>% mutate(step = 5)) %>%
  bind_rows(monitoring %>% mutate(step = 6)) %>%
  arrange(country, step) %>%
  group_by(country, step) %>%
  summarise(
    across(
      c(total, ub, lb),
      ~ sum(., na.rm = TRUE) %>% na_if(0)
    )
  ) %>%
  ungroup %>%
  mutate(
    total = round(total/20000) * 20000,
    start = 
      case_when(
        step %in% c(0, 6) ~ 0,
        TRUE ~ dplyr::lag(total, n = 1)
      ),
    end = total,
    diff = end - start,
    color = case_when(
      step == 4 ~ "#FDB462",
      end < start ~ "#d73027",
      TRUE ~ "#4575b4"
    ),
    label = factor(
      step,
      levels = 0:6,
      labels = c(
        "Main results\n(Table 1)",
        "Exclude \ncensus\nout-of-village\nhouseholds",
        "Unit of\nobservation",
        "Sample \nselection\nof water points",
        "Dataset",
        "Promoter\nsurvey\nout-of-village\nhouseholds",
        "Promoter Sample\n(Table 3)"
      ),
      ordered = TRUE
    )
  )
``` 

### Plot

```{r}
wf_uganda <-
  wf_data %>%
  dplyr::filter(country == "Uganda") %>%
  ggplot(
    aes(
      x = label,
      y = end,
      xmin = as.numeric(label) - 0.45,
      xmax = as.numeric(label) + 0.45,
      ymin = start,
      ymax = end,
      fill = color,
      label = scales::comma(abs(diff))
    )
  ) +
  geom_rect() +
  geom_errorbar(
    aes(ymin = lb, ymax = ub),
    width = .3,
    color = "navy"
  ) +
  geom_text(
    vjust = -0.5, 
    size = 3.5
  ) +
  theme_minimal() +
  scale_fill_identity() +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = "Number of people"
  ) +
  scale_y_continuous(labels = scales::comma)
```

```{r}
wf_malawi <-
  wf_data %>%
  dplyr::filter(country == "Malawi") %>%
  ggplot(
    aes(
      x = label,
      y = end,
      xmin = as.numeric(label) - 0.45,
      xmax = as.numeric(label) + 0.45,
      ymin = start,
      ymax = end,
      fill = color,
      label = scales::comma(abs(diff))
    )
  ) +
  geom_rect() +
  geom_errorbar(
    aes(ymin = lb, ymax = ub),
    width = .3,
    color = "navy"
  ) +
  geom_text(
    vjust = -0.5, 
    size = 3.5
  ) +
  theme_minimal() +
  scale_fill_identity() +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = "Number of people"
  ) +
  scale_y_continuous(labels = scales::comma)
```

### Save

```{r}
ggsave(
  "output/graphs/waterfall_uganda.png", 
   plot = wf_uganda, 
   width = 8, 
   height = 6, 
   units = "in"
)

ggsave(
  "output/graphs/waterfall_malawi.png", 
   plot = wf_malawi, 
   width = 8, 
   height = 6, 
   units = "in"
)
```


## Text

```{r}
hh_census %>%
  dplyr::filter(
    wp_func,
    wp_intervention != "Non-program"
    # country == "Malawi", 
    # sample_group == "ILC", 
    # wp_intervention == "ILC"
  ) %>%
  sumtable(
    vars = "hh_members",
    group = "promoter_list",
    group.test = TRUE
  )
  
```

```{r}
hh_census %>%
  dplyr::filter(
    wp_func,
    wp_intervention != "Non-program"
  ) %>%
  mutate(
    group = paste(country, sample_group, wp_intervention, promoter_list)  
  ) %>%
  sumtable(
    vars = "hh_members",
    group = "group",
    group.test = TRUE
  )
```

```{r}
hh_census %>%
  dplyr::filter(
    wp_func,
    wp_intervention != "Non-program"
  ) %>%
  feols(
    hh_members ~ promoter_list | country + sample_group + wp_intervention,
    cluster = ~ village_id
  )
```



