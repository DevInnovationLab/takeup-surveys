## Color wheels vs colorimeters

### Chlorine detection in clear water


### Chlorine detection in untreated water from water points with DSW

cluster by enumerator

```{r}
c(
  "disctcr_un_02", "metertcr_un_02", "metertcr_un_01",
  "discfcr_un_02", "meterfcr_un_02", "meterfcr_un_01"
) %>%
  map(
    ~ feols(
      paste(.x," ~ 1") %>% as.formula,
      data = wp_census,
      cluster = ~ village_id
    ) %>%
      tidy_and_attach() %>%
      tidy_add_n() %>%
      mutate(outcome = .x)
  ) %>%
  bind_rows %>%
  transmute(
    outcome,
    n_obs,
    estimate = round(estimate * 100, 1) %>% paste0("%"),
    ci = paste0("(", round(conf.low * 100, 1), ", ", round(conf.high * 100, 1), ")")
  )
```

### TCR vs FCR

```{r}
hh_survey %>%
  summarise(
    disc_n = sum(!is.na(disctcr) & !is.na(discfcr)),
    disc_pct = sum(disctcr < discfcr, na.rm = TRUE),
    meter_n = sum(!is.na(metertcr) & !is.na(meterfcr)),
    meter_pct = sum(metertcr < meterfcr, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("Instrument", ".value")
  ) %>%
  mutate(pct = round((pct/n) * 100, 1) %>% paste0("%"))
```


### Chlorine detection among households that self report not treating the water

```{r}
obs <-
  hh_survey %>%
  summarise(
    across(
      c(
        "disctcr_02", 'metertcr_02', "metertcr_01",
        "discfcr_02", "meterfcr_02", "meterfcr_01"
      ),
      ~ sum(!is.na(.))
    )
  ) %>%
  pivot_longer(
    everything(),
    names_to = "outcome",
    values_to = "n"
  )
  
c(
  "disctcr_02", 'metertcr_02', "metertcr_01",
  "discfcr_02", "meterfcr_02", "meterfcr_01"
) %>%
  map(
    ~ feols(
      paste(.x," ~ 1") %>% as.formula,
      data = hh_survey %>% dplyr::filter(!watertreat_dispcl),
      cluster = ~ village_id
    ) %>%
      tidy(conf.int = TRUE) %>%
      mutate(outcome = .x)
  ) %>%
  bind_rows %>%
  left_join(obs) %>%
  transmute(
    outcome,
    n,
    estimate = round(estimate * 100, 1) %>% paste0("%"),
    ci = paste0("(", round(conf.low * 100, 1), ", ", round(conf.high * 100, 1), ")")
  )
```

## Chlorination rates under different criteria

```{r}
criteria <-
  c(
    "watertreat_dispcl",
    "disctcr_02", "discfcr_02",
    "metertcr_02", "meterfcr_02",
    "metertcr_01", "meterfcr_01"
  )
```

### Number of observations

```{r}
obs <-
  chlorination_data %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    across(
      all_of(criteria),
      ~ sum(!is.na(.))
    )
  )

obs_long <-
  obs %>%
  pivot_longer(
    cols = all_of(criteria),
    values_to = "N",
    names_to = "outcome"
  ) %>%
  mutate(
    N = format(N, big.mark = ",")
  )
```


### By sample group and program

```{r}
cl_criteria_group <-
  chlorination_data %>%
  group_by(country, sample_group, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ map_dfr(
      criteria,
      \(outcome) mean_ci(
        .x, 
        var = outcome
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
    )
  ) %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1) %>% as.character
    ),
    ci = paste0("(", lb, ", ", ub, ")")
  ) %>%
  select(country, sample_group, wp_intervention, outcome, mean, ci) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  left_join(obs_long) %>%
  select(country, sample_group, wp_intervention, outcome, name, N, value) %>%
  pivot_wider(
    names_from = outcome,
    values_from = c(N, value)
  ) %>%
  mutate(
    across(
      c(wp_intervention, sample_group, starts_with("N")),
      ~ if_else(name == "ci", "", .)
    )
  ) %>%
  ungroup %>%
  select(
    sample_group,
    wp_intervention,
    matches(criteria)
  )

col_names <-
  c(
    "Sample group", "Intervention", 
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)",
    "N", "\\%\n(95\\% CI)"
  )
caption <- "Percent of households where chlorine residual was detected under different thresholds, by sample group and intervention"
header <-
  c(
    " " = 2, 
    "Self-report" = 2,
    "TCR ≥ 0.2 mg/L" = 2,
    "FCR ≥ 0.2 mg/L" = 2,
    "TCR ≥ 0.2 mg/L" = 2,
    "FCR ≥ 0.2 mg/L" = 2,
    "TCR ≥ 0.1 mg/L" = 2,
    "FCR ≥ 0.1 mg/L" = 2
  )

columns_14 <- c(" ", " ", paste0("(", 1:14, ")"))

latex_table(
  cl_criteria_group, 
  align = "llcccccccccccccc", 
  col.names = linebreak(col_names, align = "c"),
  caption = caption,
  escape = FALSE,
  label = "cl-criteria-sample"
) %>%
  pack_sample_se %>%
  add_header_above(header, line = TRUE) %>%
  add_header_above(columns_14, line = FALSE) %>%
  writeLines(
    "output/appendix-tables/cl-criteria-sample.tex"
  )
```

### By country and program

```{r}
obs <-
  obs %>%
  group_by(country, wp_intervention) %>%
  summarise(
    across(
      -sample_group,
      ~ sum(.)
    )
  ) %>%
  pivot_longer(
    cols = -c(country, wp_intervention),
    values_to = "N",
    names_to = "outcome"
  )
  
est <-
  chlorination_data %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ map_dfr(
      criteria,
      \(outcome) mean_ci(
        .x, 
        var = outcome
      ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique
      )
    )
  ) %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1) %>% as.character
    ),
    ci = paste0("(", lb, ", ", ub, ")")
  ) %>%
  select(country, wp_intervention, outcome, mean, ci) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  left_join(obs) %>%
  select(country, wp_intervention, outcome, name, N, value) %>%
  pivot_wider(
    names_from = outcome,
    values_from = c(N, value)
  ) %>%
  mutate(
    across(
      c(wp_intervention, starts_with("N")),
      ~ if_else(name == "ci", "", format(., big.mark = ","))
    )
  ) %>%
  ungroup %>%
  select(
    wp_intervention,
    matches(criteria)
  )
  
caption <- "Percent of households where chlorine residual was detected under different thresholds, by intervention"
  
latex_table(
  est, 
  align = "lcccccccccccccc", 
  col.names = linebreak(col_names[2:16], align = "c"),
  caption = caption,
  escape = FALSE,
  label = "cl-criteria-country"
) %>%
  pack_intervention_se %>%
  add_header_above(c(" ", header[2:8]), line = TRUE) %>%
  add_header_above(columns_14, line = FALSE) %>%
  writeLines(
    "output/appendix-tables/cl-criteria-country.tex"
  )
```

## Text



```{r}
hh_survey %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(country, wp_intervention) %>%
  summarise(
    N = n(),
    across(
      contains("watertreat"),
      ~ mean(. * 100, na.rm = TRUE) %>% round(1)
    )
  )
```

```{r}
hh_survey %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC")
  ) %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    N = n(),
    across(
      contains("watertreat"),
      ~ mean(. * 100, na.rm = TRUE) %>% round(1)
    )
  )
```


```{r}
hh_survey %>%
  dplyr::filter(
    country == "Uganda",
    wp_intervention == "DSW"
  ) %>%
  feols(
    watertreat_any ~ sample_group,
    cluster = ~village_id
  )
```

```{r}
hh_survey %>%
  dplyr::filter(
    country == "Uganda",
    wp_intervention == "DSW"
  ) %>%
  feols(
    watertreat_dispcl ~ sample_group,
    cluster = ~village_id
  )
```

```{r}
hh_survey %>%
  dplyr::filter(country == "Uganda", wp_intervention == "DSW") %>%
  tabyl(watertreat_boil, watertreat_dispcl)
```


```{r}
hh_survey %>%
  dplyr::filter(country == "Uganda", wp_intervention == "DSW") %>%
  tabyl(watertreat_dispcl, disctcr_02) %>%
  adorn_percentages()
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_none)
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_anycl)
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_dispcl)
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_boil)
```

```{r}
hh_survey %>%
  dplyr::filter(wp_intervention != "Non-program") %>%
  mutate(anycl = watertreat_othercl | watertreat_dispcl) %>%
  group_by(country, ea_program_vil) %>%
  summarise(
    n = n(),
    across(
      c(any = watertreat_any, anycl, disp = watertreat_dispcl, boil = watertreat_boil),
      ~ mean(., na.rm = TRUE)
    )
  ) %>%
  mutate(
    across(
      any:boil,
      ~ round(. * 100, 1)
    )
  ) %>%
  dplyr::filter(n > 100)
```

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi", wp_intervention == "DSW") %>%
  mutate(anycl = watertreat_othercl | watertreat_dispcl) %>%
  tabyl(anycl, watertreat_boil) %>%
  adorn_totals()
```

```{r}
hh_census %>%
  dplyr::filter(!(wp_intervention %in% c("DSW", "ILC"))) %>%
  group_by(country, ea_program_vil) %>%
  summarise(
    n = n(),
    any = mean(!wtmt_none, na.rm = TRUE),
    across(
      c(cl = wtmt_anycl, disp = wtmt_dispcl, boil = wtmt_boil),
      ~ mean(., na.rm = TRUE)
    )
  ) %>%
  mutate(
    across(
      any:boil,
      ~ round(. * 100, 1)
    )
  ) %>%
  dplyr::filter(n > 100)
```

```{r}
hh_census %>%
  dplyr::filter(!(wp_intervention %in% c("DSW", "ILC")), sample_group == "ILC") %>%
  group_by(country, ea_program_vil) %>%
  summarise(
    any = mean(!wtmt_none, na.rm = TRUE),
    across(
      c(cl = wtmt_anycl, disp = wtmt_dispcl, boil = wtmt_boil),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_anycl)
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_dispcl)
```

```{r}
hh_census %>%
  dplyr::filter(country == "Uganda", !(wp_intervention %in% c("DSW", "ILC"))) %>%
  tabyl(wtmt_boil)
```

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  mutate(wp = where_collect == "From the water point primary water point (${wp_name_pl})") %>%
  tabyl(wp, disctcr_02) %>%
  adorn_percentages()
```

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(watertreat_dispcl, disctcr_02) %>%
  adorn_percentages()
```


```{r}
hh_survey %>%
  dplyr::filter(wp_intervention == "Non-program") %>%
  group_by(country, sample_group) %>%
  summarise(
    N = n(),
    across(
      contains("tmtever"),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_survey %>%
  group_by(country, sample_group, wp_intervention) %>%
  summarise(
    N = n(),
    across(
      contains("watertreat"),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_survey %>%
  mutate(watertreat_cl = watertreat_dispcl | watertreat_othercl) %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    !is.na(disctcr_02),
    !is.na(watertreat_cl)
  ) %>%
  tabyl(
    watertreat_cl, disctcr_02
  )
```


```{r}
hh_survey %>%
  mutate(watertreat_cl = watertreat_dispcl | watertreat_othercl) %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    !is.na(metertcr_02),
    !is.na(watertreat_cl)
  ) %>%
  tabyl(
    watertreat_cl, metertcr_02
  )
```

```{r}
hh_survey %>%
  mutate(
    watertreat_cl = watertreat_dispcl | watertreat_othercl,
    primary = where_collect == "From the water point primary water point (${wp_name_pl})"
  ) %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    !is.na(metertcr_02),
    !is.na(watertreat_cl)
  ) %>%
  feols(
    disctcr_02 ~ primary | sample_group + country,
    cluster = ~ village_id
  )
```

```{r}
hh_survey %>%
  mutate(watertreat_cl = watertreat_dispcl | watertreat_othercl) %>%
  dplyr::filter(
    wp_intervention %in% c("ILC", "DSW"),
    !(sample_group != "ILC" & wp_intervention == "ILC"),
    !is.na(metertcr_02),
    !is.na(watertreat_cl)
  ) %>%
  tabyl(
    watertreat_cl, metertcr_01
  )
```


