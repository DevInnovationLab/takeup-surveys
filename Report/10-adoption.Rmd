# Comparsion of chlorine adoption estimates

## Prepare data

```{r}
adoption_data <-
  chlorination_data %>%
  group_by(village_id) %>%
  mutate(
    first_day = if_else(
      date == min(date), 
      "First day", 
      "Not first day")
  ) %>%
  ungroup %>%
  left_join(
    hh_survey %>% 
      transmute(
        household_id,
        any_rank = 
          household_id %in% 
          (pm_list %>% 
             dplyr::filter(!is.na(rank)) %>% 
             pull(household_id))
      )
  ) %>%
  left_join(
    hh_census %>% 
      select(household_id, inclusion)
  ) %>%
  dplyr::filter(!(country == "Uganda" & wp_intervention == "ILC"))
```

## Balance test in water points

```{r}
wp_census %>%
  dplyr::filter(intervention == "DSW", country == "Malawi") %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = c(
      "wp_func",
      "wp_turbidity",
      "disp_tank_present",
      "disp_casing_present",
      "disp_pvc_pole_present",
      "disp_func",
      "disp_filled",
      "disp_dose",
      "wp_pay",
      "disctcr_02",
      "disctcr_un_02",
      "discfcr_02",
      "discfcr_un_02"
    ),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention == "DSW", country == "Uganda", wp_func) %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = c(
      "wp_turbidity",
      "disp_tank_present",
      "disp_func",
      "disp_filled",
      "disp_dose",
      "wp_pay",
      "disctcr_02",
      "discfcr_02"
    ),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention == "ILC", country == "Malawi", wp_func) %>%
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  sumtable(
    vars = c(
      "wp_pay",
      "ilc_wcps",
      "ilc_devicefunc",
      "ilc_tabletstock",
      "ilc_wpt_yn",
      "closer",
      "disctcr_02",
      "discfcr_02"
    ),
    group = "promoter_surveyed",
    group.test = TRUE
  )
```


## Are estimates different?

### Plot difference

```{r}
plot_data <-
  list(
    "(1)\nCensus sample,\nvillage-level\n(main estimate)\n" = 
      cl_village_noweights_country %>% 
      rename(N = hhs),
    "(2)\nCensus sample,\nwater point-level\n" = 
      cl_wp_noweights %>% 
      rename(N = households),
    "(3)\nPromoter sample\n(Adoption Monitoring\nmethod)\n" = 
      chlorine_am %>% 
      rename(
        wp_intervention = wp_intervention_mon,
        N = hhs
      )
  ) %>%
  map_dfr(
    ~ .x %>%
      dplyr::filter(outcome == "disctcr_02") %>%
      select(country, wp_intervention, N, outcome, mean, ub, lb),
    .id = "survey"
  ) %>%
  mutate(
    across(
      c(mean, ub, lb),
      ~ . * 100
    ),
    main = str_detect(survey, "main"),
    label = survey %>% 
      paste0("(N = ", N %>% format(big.mark = ","), ")") %>% 
      str_trim
  ) %>%
  dplyr::filter(!(country == "Uganda" & wp_intervention == "ILC")) 

plot <-
  plot_data %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% round(1) %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = main
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid2(
    wp_intervention ~ country,
    scales = "free_x",
    independent = "x"
  ) + 
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme + 
  labs(
    x = NULL,
    y = NULL
  )  +
  scale_y_continuous(labels = scales::comma)

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-comparison.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)

plot
```

### Test differences

```{r}
adoption_data %>%
  bind_rows(
    mon_survey_cl %>%
      mutate(wp_intervention = wp_intervention_mon)
  ) %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ .x %>%
      feols(
        disctcr_02 ~ survey | sample_group,
        cluster = ~ village_id
      ) %>%
      tidy
  ) %>%
  mutate(
    country = c("Malawi", "Malawi", "Uganda"),
    wp_intervention = c("DSW", "ILC", "DSW")
  )
```


## Can promoters identify households correctly?

### Listed households confirmed

```{r}
census <-
  hh_census %>%
  dplyr::filter(promoter_list) %>%
  group_by(country, sample_group) %>%
  summarise(
    list = n() %>% format(big.mark = ","),
    users = mean(wp_intervention %in% c("DSW", "ILC"), na.rm = TRUE) * 100
  ) %>%
  mutate(users = round(users, 1) %>% paste0("%")) %>%
  ungroup %>%
  select(-country)

col_names <- c("", "N", "Confirmed by self-report")
columns <- c(" ", paste0("(", 1:2,")"))
footnote_text <- "Column (1) shows the number of households in the Household Census that were matched to names in a promoter list. Column (2) indicates the percent of these households that also self-reported using a water point with DSW/ILC as their primary source of drinking water. In ILC villages, all water points with DSW/ILC are grouped together, regardless of the intervention."
caption <- "Household Census observations matched to entries in promoter list of users"

census %>%
  kable(
    format = "html",
    col.names = col_names,
    caption = caption
  ) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  kable_paper("striped", full_width = TRUE) %>%
  pack_rows("Malawi", 1, 3) %>%
  pack_rows("Uganda", 4, 5) %>%
  add_header_above(columns, line = FALSE)
```

```{r}
table <-
  census %>%
  kable(
    format = "latex",
    align = "c", 
    booktabs = T,
    col.names = col_names,
    caption = caption,
    label = "adoption-matched"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 3) %>%
  pack_rows("Uganda", 4, 5) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  add_header_above(headers, line = TRUE) %>%
  add_header_above(columns, line = FALSE)

writeLines(
  table, 
  "output/appendix-tables/adoption-matched.tex"
)
```

### Promoter Sample households confirmed

```{r}
confirmed <-
  mon_survey_cl %>%
  mutate(confirmed = wp_intervention == wp_intervention_mon) %>%
  group_by(country, wp_intervention_mon) %>%
  summarise(
    N = sum(!is.na(confirmed)),
    mean = mean(confirmed, na.rm = TRUE)
  ) %>%
  rename(wp_intervention = wp_intervention_mon)
```

```{r}
listed <-
  hh_census %>%
  dplyr::filter(promoter_surveyed) %>%
  group_by(country, wp_intervention) %>%
  summarise(
    pm_wp = sum(!is.na(promoter_list)),
    listed = mean(promoter_list, na.rm = TRUE)
  )
```

```{r}
table <- 
  confirmed %>%
  left_join(listed) %>%
  ungroup %>%
  transmute(
    wp_intervention,
    pm_wp = pm_wp %>% format(big.mark = ","),
    listed,
    N, mean
  ) %>%
  mutate(
    across(
      c(mean, listed),
      ~ round(. * 100, 1) %>% paste0("%")
    )
  )
```

```{r}
col_names <- c("", "N", "Included in the promoter list", "N", "Water point with DSW/ILC is the primary source of drinking water")

headers <- 
  c(
    " ",
    "Households using water points with DSW/ILC" = 2,
    "Households in the Promoter Sample" = 2
  )

columns <- c(" ", paste0("(", 1:4,")"))

footnote_text <- "Column (1) shows the number of households who self-report using a water points with DSW/ILC covered by the Promoter Survey. Column (2) shows the percent of households in this sample who were also matched to households listed by the promoters as using a water points with DSW/ILC. Column (3) shows the number of households in the Promoter Sample of the Household Survey. All of these households confirmed that they use the water point in the Promoter Survey. Column (4) indicates the percent of these households that also say this is their primary source of drinking water. "

table %>%
  kable_by_country(
    col.names = col_names
  ) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  add_header_above(columns, line = FALSE)
```

```{r}
table %>%
  latex_table(
    align = "lcccc", 
    col.names = col_names,
    caption = caption,
    label = "adoption-hhs",
    single_footnote = footnote_text
  ) %>%
  pack_intervention %>%
  add_header_above(headers, line = TRUE) %>%
  add_header_above(columns, line = FALSE) %>%
  column_spec(c(3, 5), width = "4cm") %>%
  writeLines(
    "output/appendix-tables/adoption-hhs.tex"
  )
```



```{r}
plot_data <-
  mon_survey_cl %>%
  mutate(confirmed = wp_intervention == wp_intervention_mon) %>%
  dplyr::filter(confirmed) %>%
  group_by(country, wp_intervention_mon) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "disctcr_02",
      data = .x
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      wp_intervention = .x %>% pull(wp_intervention_mon) %>% unique,
      N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
    )
  ) %>%
  mutate(label = "(2)\nPromoter sample,\nconfirmed to be using\nwater point with DSW/ILC\n") %>%
  bind_rows(
    cl_village_noweights_country %>%
      mutate(
        label = "(1)\nCensus sample\n(main estimate)\n",
        N = hhs
      )
  ) %>%
  bind_rows(
    chlorine_am %>% 
      rename(
        wp_intervention = wp_intervention_mon,
        N = hhs
      ) %>%
      mutate(label = "(3)\nPromoter sample\n")
  ) %>%
  mutate(
    across(
      c(mean, ub, lb),
      ~ . * 100
    ),
    main = str_detect(label, "main"),
    label = label %>% paste0("(N = ", N %>% format(big.mark = ","), ")")
  ) %>%
  dplyr::filter(
    !(country == "Uganda" & wp_intervention == "ILC"),
    outcome == "disctcr_02"
  ) 

plot <-
  plot_data %>%
  ggplot(
    aes(
      x = label,
      y = mean,
      label = mean %>% round(1) %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = main
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid2(
    wp_intervention ~ country,
    scales = "free_x",
    independent = "x"
  ) + 
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme + 
  labs(
    x = NULL,
    y = NULL
  )  +
  scale_y_continuous(labels = scales::comma)

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-cofirmed.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)

plot
```

## Sample selection

### Plot

```{r}
plot <-
  list(
    "(1)\nAll households\n" = adoption_data,
    "(2)\nUsing water\npoints in\npromoter survey\n" = adoption_data %>% dplyr::filter(promoter_surveyed),
    "(3)\nIn promoter list\n" = adoption_data %>% dplyr::filter(promoter_surveyed, promoter_list),
    "(4)\nRandomized\ninto\nmonitoring\n" = adoption_data %>% dplyr::filter(promoter_surveyed, promoter_list, any_rank)
  ) %>%
  map(
    ~ .x %>% 
      group_by(country, wp_intervention) %>%
      group_split()
  ) %>%
  map_depth(
    2,
    ~ mean_ci(
      var = "disctcr_02",
      data = .x
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      wp_intervention = .x %>% pull(wp_intervention) %>% unique,
      N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
    )
  ) %>%
  map(~ bind_rows(.)) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    sample = sample %>% paste0(" (N = ", N %>% format(big.mark = ","), ")"),
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = sample,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3) + 
  facet_grid2(
    wp_intervention ~ country, 
    scale = "free_x",
    independent = "x"
  ) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL
  )

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-selection.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)

plot
```

### Water point selection

```{r}
timing <-
  adoption_data %>%
  group_by(country, wp_intervention, promoter_surveyed) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
        var = "disctcr_02",
        data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        promoter_surveyed = .x %>% pull(promoter_surveyed) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow %>% format(big.mark = ",")
      )
  ) %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ round(. * 100, 1)
    ),
    across(
      c(mean, N),
      ~ as.character(.)
    ),
    mean = paste0(mean, "%"),
    ci = paste0("(", lb, ", ", ub, ")") 
  ) %>%
  select(country, wp_intervention, N, mean, ci, promoter_surveyed) %>%
  pivot_longer(
    cols = c(mean, ci),
    names_to = "est"
  ) %>%
  pivot_wider(
    names_from = promoter_surveyed,
    values_from = c(N, value)
  ) %>%
  mutate(
    across(
      c(wp_intervention, starts_with("N")),
      ~ if_else(est == "mean", ., "")
    )
  ) %>%
  select(country, wp_intervention, matches("TRUE"), matches("FALSE"))

timing_p <-
  adoption_data %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ feols(
      disctcr_02 ~ promoter_surveyed | sample_group,
      data = ., 
      cluster = ~ village_id
    ) %>%
      tidy
  ) %>%
  transmute(
    country = c("Malawi", "Malawi", "Uganda"),
    wp_intervention = c("DSW", "ILC", "DSW"),
    p = round(p.value, 3) %>% 
      as.character()
  )
  
timing_table <-
  timing %>%
  left_join(timing_p) %>%
  select(-country) %>%
  mutate(
    p = p %>% replace_na("")
  )

col_names <- c("", "N", "TCR ≥ 0.2 mg/L", "N", "TCR ≥ 0.2 mg/L", "p-value")
headers <- c(
      " ",
      "Promoter surveyed" = 2,
      "Promoter not surveyed" = 2,
      "Difference"
    )


table <-
  timing_table %>%
  kable(
    format = "latex",
    align = "c", 
    booktabs = T,
    col.names = col_names,
    caption = caption,
    label = "adoption-wp"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)

writeLines(
  table, 
  "output/appendix-tables/adoption-wp.tex"
)

timing_table %>%
  kable_by_group(
    col.names = col_names
  ) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)
```

### Household selection

```{r}
timing <-
  adoption_data %>%
  dplyr::filter(promoter_surveyed, !is.na(disctcr_02)) %>%
  group_by(country, wp_intervention, promoter_list, village_id) %>%
  dplyr::filter(n() > 1) %>%
  group_by(country, wp_intervention, promoter_list) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "disctcr_02",
      data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        promoter_list = .x %>% pull(promoter_list) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ round(. * 100, 1)
    ),
    across(
      c(mean, N),
      ~ as.character(.)
    ),
    mean = paste0(mean, "%"),
    ci = paste0("(", lb, ", ", ub, ")") 
  ) %>%
  select(country, wp_intervention, N, mean, ci, promoter_list) %>%
  pivot_longer(
    cols = c(mean, ci),
    names_to = "est"
  ) %>%
  pivot_wider(
    names_from = promoter_list,
    values_from = c(N, value)
  ) %>%
  mutate(
    across(
      c(wp_intervention, starts_with("N")),
      ~ if_else(est == "mean", ., "")
    )
  ) %>%
  select(country, wp_intervention, matches("TRUE"), matches("FALSE"))

timing_p <-
  adoption_data %>%
  dplyr::filter(promoter_surveyed) %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ feols(
      disctcr_02 ~ promoter_list | sample_group,
      data = ., 
      cluster = ~ village_id
    ) %>%
      tidy
  ) %>%
  transmute(
    country = c("Malawi", "Malawi", "Uganda"),
    wp_intervention = c("DSW", "ILC", "DSW"),
    p = round(p.value, 3) %>% 
      as.character()
  )
  
timing_table <-
  timing %>%
  left_join(timing_p) %>%
  select(-country) %>%
  mutate(
    p = p %>% replace_na("")
  )

col_names <- c("", "N", "TCR ≥ 0.2 mg/L", "N", "TCR ≥ 0.2 mg/L", "p-value")

headers <- 
  c(
    " ",
    "Included in the promoter list" = 2,
    "Not included in the promoter list" = 2,
    "Difference"
  )

footnote_text <- "Sample includes all households in the census sample that self-report using a water point covered by the Promoter Survey. Columns 1 and 2 show the TCR detection rates among households that were also matched to the promoter's list of users, while columns 3 and 4 show rates among households that were not. All estimates cluster standard errors at the village level and control for sample group stratification."

caption <- "Chlorine Residual detection rates among households in the census sample using water points covered by the Promoter Survey"


timing_table %>%
  kable_by_group(
    col.names = col_names,
    caption = caption
  ) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)
```

```{r}
table <-
  timing_table %>%
  kable(
    format = "latex",
    align = "c", 
    booktabs = T,
    col.names = col_names,
    caption = caption,
    label = "adoption-hhselection"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)

writeLines(
  table, 
  "output/appendix-tables/adoption-hhselection.tex"
)
```


## Timing of survey

```{r}
timing <-
  adoption_data %>%
  group_by(country, wp_intervention, first_day) %>%
  group_split %>%
  map_dfr(
    ~ mean_ci(
      var = "disctcr_02",
      data = .x
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      first_day = .x %>% pull(first_day) %>% unique,
      wp_intervention = .x %>% pull(wp_intervention) %>% unique,
      N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
    )
  ) %>%
  mutate(
    across(
      c(mean, lb, ub),
      ~ round(. * 100, 1)
    ),
    across(
      c(mean, N),
      ~ as.character(.)
    ),
    mean = paste0(mean, "%"),
    ci = paste0("(", lb, ", ", ub, ")") 
  ) %>%
  select(country, wp_intervention, N, mean, ci, first_day) %>%
  pivot_longer(
    cols = c(mean, ci),
    names_to = "est"
  ) %>%
  pivot_wider(
    names_from = first_day,
    values_from = c(N, value)
  ) %>%
  mutate(
    across(
      c(wp_intervention, starts_with("N")),
      ~ if_else(est == "mean", ., "")
    )
  ) %>%
  select(country, wp_intervention, matches("(.*)_First"), matches("(.*)_Not"))

timing_p <-
  adoption_data %>%
  group_by(country, wp_intervention) %>%
  group_split %>%
  map_dfr(
    ~ feols(
      disctcr_02 ~ first_day | sample_group,
      data = ., 
      cluster = ~ village_id
    ) %>%
      tidy
  ) %>%
  transmute(
    country = c("Malawi", "Malawi", "Uganda"),
    wp_intervention = c("DSW", "ILC", "DSW"),
    p = round(p.value, 3) %>% 
      as.character()
  )
  
timing_table <-
  timing %>%
  left_join(timing_p) %>%
  select(-country) %>%
  mutate(
    p = p %>% replace_na("")
  )

col_names <- c("", "N", "TCR ≥ 0.2 mg/L", "N", "TCR ≥ 0.2 mg/L", "p-value")
headers <- c(
      " ",
      "First day" = 2,
      "After first day" = 2,
      "Difference"
    )

table <-
  timing_table %>%
  kable(
    format = "latex",
    align = "c", 
    booktabs = T,
    col.names = col_names,
    caption = "TCR detection rates in census sample by day of interview",
    label = "adoption-day"
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  pack_rows("Malawi", 1, 4) %>%
  pack_rows("Uganda", 5, 6) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)

writeLines(
  table, 
  "output/appendix-tables/adoption-day.tex"
)

timing_table %>%
  kable_by_group(
    col.names = col_names
  ) %>%
  add_header_above(
    headers,
    line = TRUE
  ) %>%
  add_header_above(c(" ", paste0("(", 1:5,")")), line = FALSE)
```

## Interaction with promoter

### Who interacts more?

```{r}
census_sample <- 
  adoption_data %>%
  dplyr::filter(!is.na(int_promoter), !is.na(promoter_list)) %>%
  group_by(country, wp_intervention, promoter_list) %>%
  summarise(
    n = n(),
    anyone = mean(int_warned),
    promoter = mean(int_promoter)
  ) %>%
  pivot_wider(
    values_from = c(n, anyone, promoter),
    names_from = promoter_list
  ) %>%
  ungroup %>%
  select(country, wp_intervention, ends_with("FALSE"), ends_with("TRUE"))

monitoring_sample <- 
  mon_survey_cl %>%
  mutate(wp_intervention = wp_intervention_mon) %>%
  dplyr::filter(!is.na(int_promoter), !is.na(promoter_list)) %>%
  group_by(country, wp_intervention) %>%
  summarise(
    n = n(),
    anyone = mean(int_warned),
    promoter = mean(int_promoter)
  )

table <-
  census_sample %>%
  left_join(monitoring_sample) %>%
  select(-country) %>%
  mutate(
    across(
      contains(c("promoter", "anyone")),
      ~ round(. * 100, 1) %>% paste0("\\%")
    )
  )

col_names <- c("", rep(c("N", "Discussed\nsurvey", "Talked to\npromoter"), 3))
headers <- c(
  " ", 
  "Census Sample\nNot in promoter list" = 3 , 
  "Census Sample\nIn promoter list" = 3, 
  "Promoter Sample" = 3
)
caption <-  "Percent of households with available data on priming who discussed the survey or water treatment prior to water testing"
columns <- c(" ", paste0("(", 1:9,")"))
footnote_text <- "Sample in columns (1)-(6) includes all households in the Census Sample with available data on priming. Sample in columns (7)-(9) includes all households in the Promoter Sample with available data on priming."

table %>%
  html_table(
    col.names = col_names,
    caption = caption,
    single_footnote = footnote_text
  ) %>%
  add_header_above(headers, line = TRUE) %>%
  add_header_above(columns, line = FALSE) %>%
  pack_intervention
```

```{r}
table %>%
  latex_table(
    col.names = linebreak(col_names),
    single_footnote = footnote_text,
    caption = caption,
    align = "lccccccccc",
    escape = FALSE,
    label = "adoption-priming"
  ) %>%
  add_header_above(headers, line = TRUE) %>%
  add_header_above(columns, line = FALSE) %>%
  pack_intervention %>%
  writeLines(
    "output/appendix-tables/adoption-priming.tex"
  )
```


### Households that interacted with the promoter show higher chlorination rates

```{r}
plot <-
  list(
    "(1)\nAll households\nwith available data\n" = adoption_data %>% dplyr::filter(!is.na(int_promoter)),
    "(2)\nDiscussed survey\nwith anyone\n" = adoption_data %>% dplyr::filter(int_warned),
    "(3)\nDiscussed water\ntreatment with promoter\n" = adoption_data %>% dplyr::filter(int_promoter)
  ) %>%
  map(
    ~ .x %>%
      group_by(country, wp_intervention) %>%
      group_split
  ) %>%
  map_depth(
    2,
    ~ mean_ci(
        var = "disctcr_02",
        data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  map(~ bind_rows(.)) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    sample = sample %>% paste0(" (N = ", N, ")"),
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = sample,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid2(
    wp_intervention ~ country, 
    scale = "free_x",
    independent = "x"
  ) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL
  )

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-promoter.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)

plot
```

```{r}
design <- function(data) {
  svydesign(
    id = ~ village_id,
    data = data,
    nest = TRUE
  )
} 

plot <-
  list(
    "(1)\nAll households\nwith available data\n" = mon_survey_cl %>% dplyr::filter(!is.na(int_promoter)),
    "(2)\nDiscussed survey\nwith anyone\n" = mon_survey_cl %>% dplyr::filter(int_warned),
    "(3)\nDiscussed water\ntreatment with promoter\n" = mon_survey_cl %>% dplyr::filter(int_promoter)
  ) %>%
  map(
    ~ .x %>%
      dplyr::filter(!is.na(disctcr_02)) %>%
      group_by(country, wp_intervention_mon, sample_group, village_id) %>%
      dplyr::filter(n() > 1) %>%
      group_by(country, wp_intervention_mon) %>%
      group_split
  ) %>%
  map_depth(
    2,
    ~ mean_ci(
        var = "disctcr_02",
        data = .x
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        wp_intervention = .x %>% pull(wp_intervention_mon) %>% unique,
        N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
      )
  ) %>%
  map(~ bind_rows(.)) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    sample = sample %>% paste0(" (N = ", N, ")"),
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1)
    )
  ) %>%
  ggplot(
    aes(
      x = sample,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid2(
    wp_intervention ~ country, 
    scale = "free_x",
    independent = "x"
  ) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL
  )

design <- function(data, ...) {
  svydesign(
    id = ~ village_id,
    data = data, 
    strata = ~ country + sample_group,
    nest = TRUE,
    ...
  )
}

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-promotermon.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)


plot
```

Households in Uganda were three time more likely to have been warned about the upcoming survey and two times more likely to have been warned by the promoter

```{r}
interference <-
  list(
    "Household survey" = adoption_data,
    "Monitoring survey" = mon_survey_cl %>% mutate(wp_intervention = wp_intervention_mon)
) %>%
  map(
    ~ .x %>%
      group_by(country, wp_intervention) %>%
      summarise(
        N = sum(!is.na(int_warned)),
        across(
          c(int_warned, int_promoter),
          ~ mean(. * 100, na.rm = TRUE) %>% round(1) %>% paste0("%")
        ) 
      )
  ) %>%
  bind_cols %>%
  select(c(2:5, 8:10)) 

col_names <- 
  c(
    "Intervention", 
    "N", "With anyone in the village", "With the promoter",
    "N", "With anyone in the village", "With the promoter"
  )
header <- c(" ", "Census sample" = 3, "Promoter sample" = 3)  
caption <- "Chlorine detection rates at water points with DSW"
footnote_text <- NULL

latex_table(
  interference, 
  caption = caption,
  col.names = col_names,
  align = "lcccccc",
  single_footnote = footnote_text
) %>%
  add_header_above(header, line = TRUE) %>%
  add_header_above(c(" ", paste0("(", 1:6,")")), line = FALSE) %>%
  pack_intervention %>%
  writeLines(
    "output/appendix-tables/adoption-promoter.tex"
  )

kable(
  interference, 
  caption = caption,
  format = "html",
  col.names = col_names
) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  kable_paper("striped", full_width = TRUE) %>%
  footnote(
    general = footnote_text,
    threeparttable = TRUE
  ) %>%
  add_header_above(, line = TRUE) %>%
  add_header_above(c(" ", paste0("(", 1:cols,")")), line = FALSE) %>%
  pack_rows("Malawi", 1, 2) %>%
  pack_rows("Uganda", 3, 3)
```


## Household outside of village boundaries

### Do they chlorinate more?

No. They chlorinate less and the difference is significant. There are no households outside of the village using ILC water points.

```{r}
adoption_data %>%
  dplyr::filter(wp_intervention != "ILC") %>% # No households outside of village boundaries included
  group_by(country, wp_intervention) %>%
  group_split %>%
  map(
    ~ .x %>%
      feols(
        disctcr_02 ~ inclusion | sample_group,
        cluster = ~ village_id
      )
  ) %>%
  modelsummary(
    stars = TRUE
  )
```

### Does removing out of village households make estimates more similar?

```{r}
plot_data <-
  list(
    "(1)\nCensus sample\n" = adoption_data %>% dplyr::filter(inclusion == "Within village boundaries"),
    "(2)\nPromoter sample\n" = mon_survey_cl %>% left_join(hh_census %>% select(household_id, inclusion)) %>% dplyr::filter(inclusion == "Within village boundaries") %>% mutate(wp_intervention = wp_intervention_mon)
  ) %>%
  map(
    ~ .x %>% 
      group_by(country, wp_intervention) %>%
      group_split()
  ) %>%
  map_depth(
    2,
    ~ mean_ci(
      var = "disctcr_02",
      data = .x
    ) %>%
    mutate(
      country = .x %>% pull(country) %>% unique,
      wp_intervention = .x %>% pull(wp_intervention) %>% unique,
      N = .x %>% dplyr::filter(!is.na(disctcr_02)) %>% nrow
    )
  ) %>%
  map(~ bind_rows(.)) %>%
  bind_rows(.id = "sample") %>%
  mutate(
    sample = sample %>% paste0(" (N = ", N %>% format(big.mark = ","), ")"),
    across(
      c(mean, lb, ub),
      ~ (. * 100) %>% round(1)
    )
  ) 

plot <- 
  plot_data %>%
  ggplot(
    aes(
      x = sample,
      y = mean,
      label = mean %>% paste0("%"),
      ymin = lb,
      ymax = ub,
      fill = country
    )
  ) +
  geom_col() +
  geom_errorbar(width = .2, color = "gray30") +
  geom_text(vjust = 1.3, hjust = 1.1, size = 3.5) + 
  facet_grid2(
    wp_intervention ~ country, 
    scale = "free_x",
    independent = "x"
  ) +
  scale_fill_manual(values = c("#4575b4", "#FDB462")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "gray80", color = NA)
  ) + 
  labs(
    x = NULL,
    y = NULL
  )

ggplot2::ggsave(
  filename = "output/appendix-graphs/adoption-boundaries.png",  
  plot     = plot,            
  width    = 8,
  height   = 6,
  units    = "in",
  dpi      = 300
)

plot
```


### Are there more households outside of the village boundaries in the monitoring survey? 

No

```{r}
list(
  "Census Sample" = adoption_data,
  "Promoter Sample" = mon_survey_cl %>% left_join(hh_census %>% select(household_id, inclusion)) %>% mutate(wp_intervention = wp_intervention_mon)
) %>%
  map_dfr(
    ~ .x %>%
      mutate(within = (inclusion == "Within village boundaries")) %>%
      group_by(country, wp_intervention) %>%
      summarise(within = mean(within * 100, na.rm = TRUE) %>% round(1) %>% paste0("%")),
    .id = "survey"
  ) %>%
  pivot_wider(
    values_from = within,
    names_from = survey
  ) %>%
  ungroup %>%
  select(-country) %>%
  rename(" " = wp_intervention) %>%
  kable_by_country(
    caption = "Share of households living within village boundaries"
  )
```
