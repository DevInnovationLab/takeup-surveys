# Create final household census data

```{r}
packages <-
  c(
    "tidyverse",
    "here",
    "haven",
    "skimr",
    "kableExtra",
    "sf",
    "assertthat",
    "janitor"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

## Load data

### Household census

```{r}
hhc_clean <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Clean",
      "hh-census-clean.rds"
    )
  )
```

```{r}
hhc_gps <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Spatial",
      "hh-gps.rds"
    )
  ) %>%
  select(-district_id)
```

### Water point census

```{r}
wp <-
  read_rds(
    file.path(
      path_box, 
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Constructed",
      "wp-constructed.rds"
    )
  ) %>%
  transmute(
    wp_id_c,
    dsw, ilc, ilc_wp, ilc_wcp,
    wp_dsw, wp_ilc, wp_ilc_device,
    wp_func,
    wp_intervention = intervention,
    wp_intervention_type = intervention_type,
    wp_sourcetype = sourcetype,
    wp_turbidity,
    wp_pay,
    wp_dsw_valve = jc_valve, 
    wp_dsw_chlorine = jc_chlorine, 
    wp_dsw_dose = jc_mldispensed,
    wp_meterfcr = meterfcr,
    wp_metertcr = metertcr,
    wp_discfcr = discfcr,
    wp_disctcr = disctcr,
    wp_meterfcr_un = meterfcr_un,
    wp_metertcr_un = metertcr_un,
    wp_discfcr_un = discfcr_un,
    wp_disctcr_un = disctcr_un,
    wp_meterfcr_01 = meterfcr_c_01,
    wp_metertcr_01 = metertcr_c_01,
    wp_meterfcr_un_01 = meterfcr_un_c_01,
    wp_metertcr_un_01 = metertcr_un_c_01,
    wp_meterfcr_02 = meterfcr_c_02,
    wp_metertcr_02 = metertcr_c_02,
    wp_discfcr_02 = discfcr_c_02,
    wp_disctcr_02 = disctcr_c_02,
    wp_meterfcr_un_02 = meterfcr_un_c_02,
    wp_metertcr_un_02 = metertcr_un_c_02,
    wp_discfcr_un_02 = discfcr_un_c_02,
    wp_disctcr_un_02 = disctcr_un_c_02,
    promoter_surveyed, pm_ea_list
  ) %>%
  st_drop_geometry() %>%
  unique
```

### Villages

```{r}
villages <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "Villages.rds"
    )
  ) %>%
  select(
    country, village_id, district_id,
    sample_group, sample, vil_replaced, pre_expansion,
    ea_program_vil,
    team
  ) %>%
  mutate(
    team = team %>% factor %>% as.numeric
  )
```

### Promoter households lists
```{r}
pm_survey_households <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  )
```

## Construct final indicators

### Non-responses

```{r}
 hhc_visit <-
  hhc_clean %>%
  dplyr::filter(is.na(visit_reschedule) | visit_reschedule != "Yes, I will schedule a revisit") %>%
  transmute(
    household_id,
    visit_outcome = case_when(
      consent ~ "Surveyed",
      visit_notfound == "No revisit: There is no eligible respondent in the household" ~ "No eligible respondent",
      str_detect(visit_notfound, "inaccessible") ~ "Household not accessible",
      !consent | listing_status == "Respondent Declined" ~ "Declined",
      TRUE ~ "Respondent not available"
    ) %>%
      factor,
    response = visit_outcome == "Surveyed", 
    inclusion = visit_reason
  )
```

### ID variables

```{r}
hhc_ids <-
  hhc_clean %>%
  transmute(
    household_id, date, key,
    village_id
  )
```

### Household head characteristics

Some of these questions were moved from the household survey into the household census toward the end of data collection, to make the household survey shorter.

```{r}
hhc_hhh <-
  hhc_clean %>%
  transmute(
    household_id,
    hhh_resp = resp_relationship,
    hhh_gender = gender_hhh,
    hhh_age,
    hhh_educ = case_when(
      # Uganda
      hh_educ %in% c("Never attended school / did not complete class", "Informal Training") ~ "None",
      hh_educ %in% c("Pre-primary", "P1", "P2", "P3", "P4", "P5", "P6") ~ "Pre-primary",
      hh_educ %in% c("P7", "PLE", "S1", "S2", "S3") ~ "Primary",
      hh_educ %in% c("S4", "O level", "S5", "S6", "A level", "Polytechnic") ~ "Secondary",
      hh_educ %in% c("College (non-University)", "University") ~ "Post-secondary",
      # Malawi
      hh_educ_mw == "No formal education / Never attended school" ~ "None",
      hh_educ_mw == "Some Primary School (Did not complete Standard 8)" ~ "Pre-primary",
      hh_educ_mw %in% c("Primary School Leaving Certificate (PSLCE) (Completed Standard 8)", "Junior Certificate of Education (JCE) (Completed Form 2)") ~ "Primary",
      hh_educ_mw %in% c("Malawi School Certificate of Education (MSCE) (Completed Form 4)", "Vocational/Technical Training (e.g., TEVETA certification)") ~ "Secondary",
      hh_educ_mw %in% c("Diploma (e.g., teaching, nursing, other post-secondary diploma)", "Bachelor's Degree") ~ "Post-secondary"
    ) %>%
      factor
  )
```

### Household composition

These questions were moved into the household census from the household survey a few weeks after data collection had started.

```{r} 
hhc_hhmembers <-
  hhc_clean %>%
  dplyr::filter(!is.na(hh_members)) %>%
  transmute(
    household_id,
    hh_hhsincompound,
    hh_members,
    hh_adults,
    hh_males,
    hh_females,
    any_children = hh_adults < hh_members,
    hh_pregnant = if_else(hh_females == 0, 0, hh_pregnant),
    hh_under5n = if_else(any_children, hh_under5, 0),
    hh_under5yn = hh_under5n > 0,
    hh_under2n = if_else(any_children, hh_under2, 0),
    hh_under2yn = hh_under2n > 0,
  )
  
assert_that(
  hhc_hhmembers %>%
    dplyr::filter(
      !(household_id %in% c("CHPU54248MW2", "ZOZ243113MW2", "MAMX13147MW2")),
      is.na(hh_adults)
    ) %>%
    nrow == 0
)
```

### Water point use

- "Other" options need to be explored
- It seems like some people may not have understood the question, as they are saying why the closest point is not their preferred water point

```{r}
hhc_wpuse <-
  hhc_clean %>%
  select(
    household_id,
    wp_source,
    wp_freq,
    wp_sec_notworking = wp_secwhen_1,
    wp_sec_inadequate = wp_secwhen_2,
    wp_sec_intermitent = wp_secwhen_3,
    wp_sec_notfixed = wp_secwhen_4,
    wp_sec_crowded = wp_secwhen_5,
    wp_sec_other = wp_secwhen__666,
    wp_sec_specify = wp_secwhen_o,
    wp_secweek,
    wp_secweekno
  ) %>%
  mutate(
    wp_sec_crowded = case_when(
      str_detect(
        wp_sec_specify,
        regex("crowd|people|too many|line|queue|que|wait|congestion|congested|population|conjestion", ignore_case = TRUE)
      ) ~ TRUE,
      TRUE ~ as.logical(wp_sec_crowded) 
    ),
    wp_sec_other = if_else(
      wp_sec_crowded, 
      FALSE, 
      wp_sec_other
    ),
    wp_count_pastmonth = case_when(
       wp_secweek ~ wp_secweekno + 1,
      !wp_secweek ~ 1
    )
  )
```

### Primary water points

```{r}
hhc_primarywp <-
  hhc_clean %>%
  transmute(
    household_id,
    village_id,
    wp_id_pl,
    wp_id_c = case_when(
      !is.na(wp_id_pl) ~ paste0(village_id, str_sub(wp_id_pl, str_length(wp_id_pl) - 2, str_length(wp_id_pl)))
    ),
    wp_identified = !is.na(wp_id_c),
    wp_invillage = wp_source == "From a water point in this village"
  ) %>%
  mutate(
    wp_id_c = case_when(
      wp_id_pl == "WP2050904017004" ~ "2101349269002",
      wp_id_pl == "WP2060102007003" ~ "2101338209002",
      wp_id_pl == "WP2050904017005" ~ "2050902005003",
      wp_id_pl == "WP2050902006025" ~ "2010503012001",
      wp_id_pl %in% c("WP008", "WP1471008", "WP2101433260028") ~ NA,
      TRUE ~ wp_id_c
    )
  ) %>%
  select(-wp_id_pl)
```

```{r eval = FALSE}
# This is the code we used to make the manual checks 
hhc_primarywp %>%
  select(household_id, village_id, wp_id_c, wp_id_pl) %>%
  na.omit %>%
  anti_join(wp) %>%
  left_join(
    hhc_clean %>%
      select(wp_id_pl, wp_name_coa) %>%
      unique 
  ) %>%
  unique
```


### Non-users knowledge

"Other" methods need to be cleaned

```{r}
hhc_noevac <-
  hhc_clean %>%
  select(
    household_id, 
    vil_dsw_selfreport = wtmt_dsw_c,
    vil_ilc_selfreport = wtmt_ilc_c,
    wtmt_none = wtmt_method_0,
    wtmt_pretreated = wtmt_method__111,
    wtmt_boil = wtmt_method_1,
    wtmt_dispcl = wtmt_method_2,
    wtmt_othercl = wtmt_method_3,
    wtmt_strain = wtmt_method_4,
    wtmt_filter = wtmt_method_5,
    wtmt_sand = wtmt_method_6,
    wtmt_solar = wtmt_method_7,
    wtmt_decant = wtmt_method_8,
    wtmt_other = wtmt_method__666,
    wtmt_specify = wtmt_method_o
  ) %>%
  mutate(
    # indicator for any chlorination (whether home or dispenser)
    wtmt_anycl = wtmt_dispcl == 1 | wtmt_othercl == 1
  )
```

### Meta data

```{r}
hhc_meta <-
  hhc_clean %>%
  transmute(
    household_id, 
    formdef_version = as.character(formdef_version),
    comments, endcomment, 
    review_comments
  )
```

### Flags

```{r}
hhc_flags <-
  hhc_clean %>%
  select(
    household_id, 
    contains("flag")
  )
```

### Promoter list indicator
```{r}
hhc_promoter <-
  hhc_clean %>%
  transmute(
    household_id,
    promoter_list = household_id %in% pm_survey_households$household_id
  )
```

## Combine and save data

### Only final indicators

```{r}
indexes <-
  hhc_ids %>%
  left_join(villages, relationship = "many-to-one") %>%
  inner_join(hhc_visit, relationship = "one-to-one") %>%
  left_join(hhc_hhh, relationship = "one-to-one") %>%
  left_join(hhc_hhmembers, relationship = "one-to-one") %>%
  left_join(hhc_wpuse, relationship = "one-to-one") %>%
  left_join(hhc_noevac, relationship = "one-to-one") %>%
  left_join(hhc_meta, relationship = "one-to-one") %>%
  left_join(hhc_flags, relationship = "one-to-one") %>%
  left_join(hhc_promoter, relationship = "one-to-one") %>%
  left_join(hhc_primarywp, relationship = "one-to-one") %>%
  left_join(wp, relationship = "many-to-one") %>%
  remove_constant %>%
  remove_empty
```

```{r}
nrow(indexes) == n_distinct(indexes$household_id)
```
```{r}
indexes <-
  indexes %>%
  mutate(
    wp_intervention_type = case_when(
      # If the household is using a water point outside of the village, it is not using one of the village's EvAc water points
#      !wp_invillage ~ "Non-program",
      # If the household is using a water point inside the village, but it wasn't mapped, then it is not an EvAc water point
      wp_invillage & is.na(wp_intervention_type) ~ "Non-program",
      TRUE ~ as.character(wp_intervention_type)
    ) %>% factor
  )
```


### Analysis data

```{r}
final <- 
  indexes %>% 
  set_names(
    names(.) %>% str_remove_all("_c$")
  ) %>%
  dplyr::filter(!vil_replaced) %>%
  select(
    -vil_replaced,
    # These contain PII
    -contains("comments")
  ) %>%
  remove_empty() %>%
  remove_constant()
```


```{r}
path <- 
  file.path(
    "Data",
    "HouseholdCensus",
    "DataSets",
    "Final",
    "hh-census"
  )

final %>%
  write_meta(
    path_data = file.path(path_box, path),
    path_meta = file.path(path_git, path)
  )
```

```{r}
final %>% 
  mutate(
    across(
      where(is.logical),
      ~ as.numeric(.)
    )
  ) %>%
  write_dta(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.dta"
    )
)
```

### All data

```{r}
other_vars <-
  setdiff(
    names(hhc_clean),
    names(indexes)
  )

hhc_constructed <-
  indexes %>%
  left_join(
    hhc_clean %>%
      select(key, all_of(other_vars))
  )
```

```{r}
path <- 
  file.path(
    "Data",
    "HouseholdCensus",
    "DataSets",
    "Constructed",
    "hh-census-constructed"
  )

hhc_constructed %>% 
  write_meta(
    path_data = file.path(path_box, path),
    path_meta = file.path(path_git, path)
  )
```

```{r}
gps_constructed <-
  hhc_gps %>%
  left_join(hhc_constructed)
```

```{r}
path <- 
  file.path(
    "Data",
    "HouseholdCensus",
    "DataSets",
    "Spatial",
    "hh-census-constructed"
  )

gps_constructed %>% 
  write_meta(
    path_data = file.path(path_box, path),
    path_meta = file.path(path_git, path)
  )
```


