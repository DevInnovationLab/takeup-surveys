---
title: "Monitoring Estimates"
output: html_document
---

This is the code to generate the estimates tables using the monitoring (water-point level) approach.

# NOTES
- general approach for NAs in promoter_surveyed and pm_ea_list in wp_census and hh_survey: I have changed NA to FALSE; but this should probably be done in wrangling
- I have used pm_survey to count the number of households in the promoter survey in table 11
- I have used pm_survey to count the number of WPs in the promoter survey in table 9 (and ea_list_uganda and ea_list_malawi for the number of WPs int the EA list in table)
- for table 1 ex households located outside of village, I did a rough number. ideally, i just rerun the table 1 code here but without households that have inclusion as within 200m of village boundary for a more exact number

# load packages
```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue",
    "patchwork",
    "tidyr",
    "dplyr",
    "knitr",
    "kableExtra",
    "vtable",
    "stargazer",
    "ggplot2",
    "haven",
    "estimatr"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

# setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)

# print tables nicely
options(knitr.table.format = "html")
knit_print.data.frame <- function(x, ...) {
  res <- kable(x, format = "html") %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = TRUE,
      position = "left",
      font_size = 11
    ) %>%
    scroll_box(width = "100%", height = "400px") 
  knitr::asis_output(res)
}
registerS3method("knit_print", "data.frame", knit_print.data.frame)
registerS3method("knit_print", "tbl_df", knit_print.data.frame)
```

## define path_box
```{r}
path_box <- "/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup"
```

## load datasets
```{r}
villages <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "villages.rds"
    )
  )

pm_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Final",
      "pm-survey.rds"
    )
  ) %>%
  left_join(wp_census %>%
              select(wp_id, intervention_type, sample_group, country, intervention),
            by = "wp_id")

ea_list_uganda <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_uganda.csv"
    )
  ) %>%
  left_join(wp_census %>%
            mutate(ea_id = as.numeric(ea_id)) %>%
            select(ea_id, intervention_type, country, intervention),
          by = c("i102_wpt_id" = "ea_id"))

ea_list_malawi <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_malawi.csv"
    )
  ) %>%
  left_join(wp_census %>%
            mutate(ea_id = as.numeric(ea_id)) %>%
            select(ea_id, intervention_type, country, intervention),
          by = c("i102_wpt_id" = "ea_id"))
    
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  left_join(wp_census %>%
              select(wp_id, intervention_type, intervention),
            by = "wp_id") %>%
  left_join(hh_census %>%
              select(household_id, inclusion),
            by = "household_id")

hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  left_join(wp_census %>%
              select(wp_id, intervention_type, intervention),
            by = "wp_id")

pm_survey_households <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  ) %>%
  # deleting test village
  pm_survey_households <- pm_survey_households %>%
  dplyr::filter(village_id != "1010602004")

wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  mutate(ea_id = as.character(ea_id))

# Uganda
uganda_wp <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "uganda-water-points.dta")) %>%
  mutate(villageid = as.character(villageid))

uganda_villages <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "uganda-villages.dta")) %>%
  mutate(villageid = as.character(villageid))

uganda_wcp <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "uganda-water-collection-points.dta"))

# Malawi
malawi_wp <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "malawi-water-points.dta")) %>%
  mutate(villageid = as.character(villageid))

malawi_villages <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "malawi-villages.dta")) %>%
  mutate(villageid = as.character(villageid))

malawi_wcp <- read_dta(file.path(path_box, "Data", "EvidenceAction", "Final", "malawi-water-collection-points.dta"))
```

## country totals
I get the same numbers as before if I classify by water point, not by village for expansion and footprint
```{r}
# malawi 
malawi_villages <- malawi_villages %>%
  mutate(
    sample_group = case_when(
      ilc == 1 ~ "ILC",
      ilc == 0 & dsw == 1 & pre_expansion == 1 ~ "Footprint",
      ilc == 0 & dsw == 1 & pre_expansion == 0 ~ "Expansion"
    )
  )

malawi_wp <- malawi_wp %>%
  left_join(malawi_villages %>% select(villageid, sample_group, pre_expansion_village = pre_expansion, ilc, dsw), by = "villageid") %>%
  mutate(
    intervention = case_when(
      program == 1 ~ "DSW",
      program == 2 ~ "ILC",
      TRUE ~ "Non-program" 
    ),
    wp_sample_group = case_when(
      ilc == 1 ~ "ILC",
      ilc == 0 & dsw == 1 & pre_expansion == 1 ~ "Footprint",
      ilc == 0 & dsw == 1 & pre_expansion == 0 ~ "Expansion"
    ), 
    country = "Malawi"
  )

malawi_ilc_wcp_count <- nrow(malawi_wcp)

# uganda
uganda_villages <- uganda_villages %>%
  mutate(
    sample_group = case_when(
      ilc == 1 ~ "ILC",
      ilc == 0 & dsw == 1 & pre_expansion == 1 ~ "Footprint",
      ilc == 0 & dsw == 1 & pre_expansion == 0 ~ "Expansion"
    )
  )

uganda_wp <- uganda_wp %>%
  left_join(uganda_villages %>% select(villageid, sample_group, pre_expansion_village = pre_expansion, ilc, dsw), by = "villageid") %>%
  mutate(
    intervention = case_when(
      program == 1 ~ "DSW",
      program == 2 ~ "ILC water point",
      TRUE ~ "Non-program" 
    ),
     wp_sample_group = case_when(
      ilc == 1 ~ "ILC",
      ilc == 0 & dsw == 1 & pre_expansion == 1 ~ "Footprint",
      ilc == 0 & dsw == 1 & pre_expansion == 0 ~ "Expansion"
     ), 
    country = "Uganda")

uganda_ilc_wcp_count <- nrow(uganda_wcp)

# create country totals table
country_totals <- bind_rows(malawi_wp, uganda_wp) %>%
  count(country, wp_sample_group, intervention, name = "country_total") %>%
  # Add ILC water collection points to the ILC category
  mutate(
    country_total = case_when(
      country == "Malawi" & intervention == "ILC" ~ country_total + malawi_ilc_wcp_count,
      country == "Uganda" & intervention == "ILC" ~ country_total + uganda_ilc_wcp_count,
      TRUE ~ country_total
    )
  ) %>%
  arrange(country, wp_sample_group, intervention) %>%
  mutate(sample_group = wp_sample_group) %>%
  select(-wp_sample_group)

country_totals
```

## create function for SEs
```{r}
compute_se <- function(values, ses = NULL, include_within = FALSE) {
  values <- unlist(values)
  ses <- unlist(ses)

  K <- length(values)
  if (K <= 1) {
    between_var <- 0
  } else {
    mean_val <- mean(values, na.rm = TRUE)
    between_var <- sum((values - mean_val)^2, na.rm = TRUE) / (K * (K - 1))
  }

  within_var <- 0
  if (include_within && K > 0 && length(ses) == K) {
    within_var <- sum(ses^2, na.rm = TRUE) / (K^2)
  }

  total_var <- between_var + within_var
  se <- sqrt(total_var)

  tibble(mean_val = mean(values, na.rm = TRUE), se = se)
}
```

## create function for by water point type table
```{r}
create_summary_table <- function(count_tbl, stats_tbl, totals_tbl, 
                                 group_vars = c("country", "sample_group", "intervention")) {
  
  count_tbl %>%
    left_join(stats_tbl, by = group_vars) %>%
    left_join(totals_tbl, by = group_vars) %>%
    mutate(
      indiv_access_sample = avg_hh_count * avg_hh_size,
      indiv_access_popn   = indiv_access_sample * country_total,
      se_indiv_access_sample = sqrt((avg_hh_size^2) * (se_hh_count^2) + (avg_hh_count^2) * (se_hh_size^2)),
      se_indiv_access_popn   = country_total * se_indiv_access_sample,
      ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
      ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
      ci_lower_chl_rate = avg_chl_rate - 1.96 * se_chl_rate,
      ci_upper_chl_rate = avg_chl_rate + 1.96 * se_chl_rate
    ) %>%
    mutate(across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, 
                    se_hh_count, se_hh_size, se_indiv_access_sample, se_indiv_access_popn,
                    ci_lower_indiv_access_popn, ci_upper_indiv_access_popn),
                  ~ round(.x, 2))) %>%
    arrange(across(all_of(group_vars)))
}
```

## create function for country estimates table
```{r}
compute_country_totals <- function(data, 
                                   group_var = "country",
                                   value_col = "indiv_access_popn",
                                   se_col = "se_indiv_access_popn",
                                   ci_level = 0.95) {
  
  # Calculate z-score for confidence level
  z_score <- qnorm(1 - (1 - ci_level) / 2)
  
  # Create dynamic column names for output
  total_col <- paste0("total_", value_col)
  se_total_col <- paste0("se_total_", value_col)
  ci_lower_col <- paste0("ci_lower_total_", gsub("^indiv_access_popn$", "access", value_col))
  ci_upper_col <- paste0("ci_upper_total_", gsub("^indiv_access_popn$", "access", value_col))
  
  data %>%
    # Replace NAs with 0 in value and SE columns before calculation
    mutate(
      across(all_of(c(value_col, se_col)), ~replace_na(.x, 0))
    ) %>%
    group_by(across(all_of(group_var))) %>%
    summarise(
      !!total_col := sum(.data[[value_col]], na.rm = TRUE),
      !!se_total_col := sqrt(sum(.data[[se_col]]^2, na.rm = TRUE)),
      .groups = "drop"
    ) %>%
    mutate(
      !!ci_lower_col := .data[[total_col]] - z_score * .data[[se_total_col]],
      !!ci_upper_col := .data[[total_col]] + z_score * .data[[se_total_col]]
    ) %>%
    select(all_of(group_var), 
           all_of(total_col), 
           all_of(ci_lower_col), 
           all_of(ci_upper_col))
}
```

# sample tables (9 and 11)
## water points (9)
```{r}
wp_table <- wp_census %>%
  group_by(country, sample_group, intervention_type) %>%
  summarise(
    wp_census = n_distinct(wp_id),
    wp_functional = n_distinct(wp_id[wp_func == TRUE]),
    # promoter_surveyed = n_distinct(wp_id[promoter_surveyed == TRUE]),
    # ea_list = n_distinct(wp_id[pm_ea_list == TRUE]),
    .groups = "drop"
  ) %>%
  left_join(country_totals, by = c("country", "sample_group", "intervention_type")) %>%
  left_join(
    ea_list_malawi %>%
      group_by(country, sample_group, intervention_type) %>%
      summarise(ea_list_malawi_count = n_distinct(i102_wpt_id), .groups = "drop"),
    by = c("country", "sample_group", "intervention_type")
  ) %>%
  left_join(
    ea_list_uganda %>%
      group_by(country, sample_group, intervention_type) %>%
      summarise(ea_list_uganda_count = n_distinct(i102_wpt_id), .groups = "drop"),
    by = c("country", "sample_group", "intervention_type")
  ) %>%
  left_join(
    pm_survey %>%
      group_by(country, sample_group, intervention_type) %>%
      summarise(promoter_survey = n_distinct(wp_id), .groups = "drop"),
    by = c("country", "sample_group", "intervention_type")
  ) 

wp_table
```

Commentary in table caption: 
For Uganda, 2 of the 112 water points in the EA promoter list were identified as Non-program and 1 as ILC, and are not shown. Similarly for Malawi, where 2 out of 137 were identified as Non-program.
```{r}
pm_survey %>%
  dplyr::filter(country == "Malawi") %>%
  dplyr::filter(pm_ea_list == TRUE) %>%
  count(intervention_type)

wp_census %>%
  dplyr::filter(country == "Uganda") %>%
  dplyr::filter(pm_ea_list == TRUE) %>%
  count(intervention_type)
```

## TO DO households (11)
```{r}
# number of water points in the promoter survey
wp_count_pm <- wp_census %>%
  group_by(country, sample_group, intervention_type) %>% 
  summarise(
    wp_count_pm = n_distinct(wp_id[promoter_surveyed = TRUE]),  
    .groups = "drop"
  )

# number of households in the promoter survey
pm_hh_listed <- pm_survey %>%
  mutate(users = as.numeric(users)) %>%
  group_by(country, sample_group, intervention_type) %>% 
  summarise(
    pm_hh_listed = sum(users, na.rm = TRUE),               
    .groups = "drop"
  )

# number of households from the promoter survey that are also in the HH census - represented by the variable cal_hh_count for each WP
pm_hh_census <- hh_census %>%
  mutate(cal_hh_count = as.numeric(cal_hh_count)) %>%
  group_by(country, sample_group, intervention_type) %>% 
  summarise(
    pm_hh_census = sum(cal_hh_count, na.rm = TRUE),               
    .groups = "drop"
  )

# number of households whose self-report in HH census matches the promoter's report
pm_hh_matched <- pm_survey_households_clean %>%
  left_join(pm_survey %>% select(wp_id, sample_group, intervention_type), 
            by = c("wp_id_c" = "wp_id")) %>%
  dplyr::filter(!is.na(wp_category)) %>%
  dplyr::filter(household_id %in% hh_census$household_id) %>%
  left_join(hh_census %>% select(household_id, wp_id), 
            by = "household_id", suffix = c("_pm", "_census")) %>%
  mutate(wp_match = wp_id_c == wp_id_census) %>% 
  group_by(country, wp_category) %>%
  summarise(
    pm_hh_matched = sum(wp_match, na.rm = TRUE),
    .groups = "drop") %>%
  mutate(country = toupper(country))

# number of households outside of the village
pm_hh_outside <- pm_survey %>%
  mutate(hh_outsiden = as.numeric(hh_outsiden)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_hh_outside = sum(hh_outsiden, na.rm = TRUE),               
    .groups = "drop"
  )

# total number of water points in the wp census
wp_count_wp_census <- wp_census %>%
  group_by(country, wp_category) %>% 
  summarise(
    wp_count_wp_census = n_distinct(wp_id),               
    .groups = "drop"
  )

# total number of households that report using the water points in the wp census, regardless of whether they are in the promoter survey or not
census_hh_listed <- hh_census %>%
  dplyr::filter(wp_id %in% wp_census$wp_id) %>%
  group_by(country, wp_category) %>%
  summarise(
    census_hh_listed = n_distinct(household_id),
    .groups = "drop"
  )

# average numbers of households per water point
pm_avg_hh_per_wp <- pm_survey %>%
  mutate(hh_listed = as.numeric(hh_listed)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_avg_hh_per_wp = round(mean(hh_listed, na.rm = TRUE), 2),               
    .groups = "drop"
  )

census_avg_hh_per_wp <- hh_census %>%
  dplyr::filter(wp_id %in% wp_census$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    census_hh_listed = n_distinct(household_id),   # households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    census_avg_hh_per_wp = round(mean(census_hh_listed, na.rm = TRUE), 2),  # avg across wps
    .groups = "drop"
  )

# table
hh_tbl <- wp_count_pm  %>%
  left_join(pm_hh_listed, by = c("country", "wp_category")) %>%
  left_join(pm_hh_outside, by = c("country", "wp_category")) %>%
  left_join(pm_hh_census, by = c("country", "wp_category")) %>%
  left_join(pm_hh_matched, by = c("country", "wp_category")) %>%
  left_join(pm_avg_hh_per_wp, by = c("country", "wp_category")) %>%
  left_join(wp_count_wp_census, by = c("country", "wp_category")) %>%
  left_join(census_hh_listed, by = c("country", "wp_category")) %>%
  left_join(census_avg_hh_per_wp, by = c("country", "wp_category")) %>%
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC")) %>%
  mutate(country = factor(country, levels = c("MALAWI", "UGANDA"))) %>%
  mutate(wp_category = factor(wp_category, levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

hh_tbl
```

# estimates tables
## main monitoring estimates (8)
```{r}
hh_count <- wp_census %>%
  group_by(country, sample_group, intervention) %>%
  # use pm list of users
  summarise(wp_values = list(pm_users[!is.na(pm_users)]), .groups = "drop") %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # use monitoring survey
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    # hh size and chlorination rates
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table8 <- create_summary_table(hh_count, hh_stats, country_totals)
table8

# country estimates table
country_estimates_table8 <- compute_country_totals(table8)
country_estimates_table8
```

## using HH census and HH survey; only using WPs in promoter survey (10)
```{r}
hh_count <- hh_census %>%
  # use water points in promoter survey
  dplyr::filter(promoter_surveyed == 1) %>% 
  group_by(country, sample_group, intervention, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of distinct households per wp
    .groups = "drop"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(
    wp_values = list(hh_count[!is.na(hh_count)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # use household survey
  dplyr::filter(survey == "Household Survey") %>%
  # use water points in promoter survey
  dplyr::filter(promoter_surveyed == 1) %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table10 <- create_summary_table(hh_count, hh_stats, country_totals)
table10

# country estimates table
country_estimates_table10 <- compute_country_totals(table10)
country_estimates_table10
```

## using HH census and HH survey; all water points (12)
```{r}
hh_count <- hh_census %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of distinct households per wp
    .groups = "drop"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(
    wp_values = list(hh_count[!is.na(hh_count)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # use household survey
  dplyr::filter(survey == "Household Survey") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table12 <- create_summary_table(hh_count, hh_stats, country_totals)
table12

# country estimates table
country_estimates_table12 <- compute_country_totals(table12)
country_estimates_table12
```

## excluding HHs outside village (13)
exactly like table 8, but subtract pm_users_outside from pm_users
```{r}
hh_count <- wp_census %>%
  mutate(pm_users_adjusted = pm_users - pm_users_outside) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(wp_values = list(pm_users_adjusted[!is.na(pm_users_adjusted)]), .groups = "drop") %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # use monitoring survey
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    # hh size and chlorination rates
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table13 <- create_summary_table(hh_count, hh_stats, country_totals)
table13

# country estimates table
country_estimates_table13 <- compute_country_totals(table13)
country_estimates_table13
```


## TO DO excluding HHs outside village and double counted HHs (14)
```{r}
# Calculate adjustments based on hh_census duplicates
wp_adjustments <- hh_census %>%
  dplyr::filter(promoter_list_mentions > 1) %>%
  group_by(wp_id) %>%
  summarise(
    # Each duplicate household subtracts (mentions - 1) from other water points
    households_to_subtract = sum(promoter_list_mentions - 1),
    .groups = "drop"
  )

# Then apply to wp_census
wp_census_adjusted <- wp_census %>%
  left_join(wp_adjustments, by = "wp_id") %>%
  mutate(
    households_to_subtract = replace_na(households_to_subtract, 0)
  )

# Now adjust pm_users in wp_census
hh_count <- wp_census %>%
  left_join(wp_adjustments, by = "wp_id") %>%
  mutate(
    households_to_subtract = coalesce(households_to_subtract, 0),
    pm_users_outside = coalesce(pm_users_outside, 0),
    pm_users_adjusted = pm_users - pm_users_outside - households_to_subtract
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(wp_values = list(pm_users_adjusted[!is.na(pm_users_adjusted)]), .groups = "drop") %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # use monitoring survey
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    # hh size and chlorination rates
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table14 <- create_summary_table(hh_count, hh_stats, country_totals)
table14

# country estimates table
country_estimates_table14 <- compute_country_totals(table13)
country_estimates_table14
```

# balance tables
## create function for balance tables
```{r}
create_balance_latex <- function(sumtable_output, 
                                 caption = "Balance checks",
                                 label = "balance_table",
                                 group1_name = "Not in promoter survey",
                                 group2_name = "In promoter survey",
                                 custom_labels = NULL) {
  
  cat("\\begin{table}[htbp]\n")
  cat("\\centering\n")
  cat(paste0("\\caption{", caption, "\\label{", label, "}}\n"))
  cat("\\begin{tabular}{lcccccc}\n")
  cat("\\hline\\hline\n")
  cat(" & \\multicolumn{2}{c}{(1)}  & \\multicolumn{2}{c}{(2)}  & \\multicolumn{2}{c}{(2)-(1)} \\\\\n")
  cat(paste0(" & \\multicolumn{2}{c}{", group1_name, "}  & \\multicolumn{2}{c}{", group2_name, " }  & \\multicolumn{2}{c}{Chi-square test}  \\\\\n"))
  cat(" & N & Percent \"Yes\" & N & Percent \"Yes\" & N & Test statistic \\\\\n")
  cat("\\addlinespace[0.75em]\n")
  cat("\\midrule\n")
  
  if (is.null(custom_labels)) {
    var_labels <- c(
      "Functional water point (wp\\_func)",
      "Tank present (disp\\_tank\\_present)",
      "Tank filled (disp\\_filled)",
      "FCR 0.2ppm measured with colorwheel (discfcr\\_02)",
      "FCR 0.2ppm measured with meter (meterfcr\\_02)",
      "FCR 0.1ppm measured with meter (meterfcr\\_01)",
      "TCR 0.2ppm measured with colorwheel (disctcr\\_02)",
      "TCR 0.2ppm measured with meter (metertcr\\_02)",
      "TCR 0.1ppm measured with meter (metertcr\\_01)"
    )
    var_names <- c("wp_func", "disp_tank_present", "disp_filled", 
                   "discfcr_02", "meterfcr_02", "meterfcr_01",
                   "disctcr_02", "metertcr_02", "metertcr_01")
  } else {
    var_labels <- custom_labels$labels
    var_names <- custom_labels$names
  }
  
  df <- as.data.frame(sumtable_output)
  first_row <- TRUE
  
  for (i in 1:length(var_names)) {
    var_idx <- which(grepl(var_names[i], df[,1]) & !grepl("\\.\\.\\.", df[,1]))
    yes_idx <- var_idx + 2
    
    test_stat <- as.character(df[var_idx, 6])
    
    if (length(test_stat) == 0 || is.na(test_stat) || test_stat == "") {
      next
    }
    
    n1 <- as.numeric(as.character(df[var_idx, 2]))
    pct1 <- as.numeric(gsub("%", "", as.character(df[yes_idx, 3])))
    n2 <- as.numeric(as.character(df[var_idx, 4]))
    pct2 <- as.numeric(gsub("%", "", as.character(df[yes_idx, 5])))
    n_total <- n1 + n2
    
    chi_sq <- as.numeric(gsub("X2=", "", gsub("\\*+", "", test_stat)))
    stars <- ""
    if (grepl("\\*\\*\\*", test_stat)) stars <- "***"
    else if (grepl("\\*\\*", test_stat)) stars <- "**"
    else if (grepl("\\*", test_stat)) stars <- "*"
    
    if (!first_row) {
      cat("\\addlinespace[0.25em]\n")
    }
    
    cat(paste0(var_labels[i], " & ", n1, " & ", pct1, "\\% & ", 
              n2, " & ", pct2, "\\% & ", n_total, " & X2=", 
              round(chi_sq, 3), stars, " \\\\\n"))
    
    first_row <- FALSE
  }
  
  cat("\\hline \\hline \\\\[-1.8ex]\n")
  cat("\\multicolumn{7}{@{} p{\\textwidth}}{Statistical significance markers: * p<0.1; ** p<0.05; *** p<0.01}\n")
  cat("\\end{tabular}\n")
  cat("\\end{table}\n")
}
```

## Uganda DSW Footprint (15)
significant difference in disp_filled
```{r}
balance_table15 <- wp_census %>%
  dplyr::filter(country == "Uganda", sample_group == "Footprint", intervention_type == "DSW") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "disctcr_02", "meterfcr_02", "meterfcr_01", 
             # "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return") 

create_balance_latex(
  balance_table15,
  caption = "Balance checks among Footprint DSW water points in Uganda: promoter survey",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Uganda DSW Footprint, but EA list (16)
difference in disp_filled is not significant
```{r}
balance_table16 <- wp_census %>%
  dplyr::filter(country == "Uganda", sample_group == "Footprint", intervention_type == "DSW") %>%
  mutate(
    pm_ea_list = replace_na(pm_ea_list, FALSE)
  ) %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02",
             # "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "pm_ea_list",
    group.test = TRUE,
    out = "return"
  )

create_balance_latex(
  balance_table16,
  caption = "Balance checks among Footprint DSW water points in Uganda: EA list",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Uganda DSW Expansion (17)
significant difference in disp_filled
```{r}
balance_table17 <- wp_census %>%
  dplyr::filter(country == "Uganda", sample_group == "Expansion", intervention_type == "DSW") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return") 

create_balance_latex(
  balance_table17,
  caption = "Balance checks among Expansion DSW water points in Uganda: promoter survey",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Uganda DSW expansion, but EA list (18)
significant difference in disp_filled
```{r}
balance_table18 <- wp_census %>%
  dplyr::filter(country == "Uganda", sample_group == "Expansion", intervention_type == "DSW") %>%
  mutate(
    pm_ea_list = replace_na(pm_ea_list, FALSE)
  ) %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "pm_ea_list",
    group.test = TRUE,
    out = "return") 

create_balance_latex(
  balance_table18,
  caption = "Balance checks among Expansion DSW water points in Uganda: EA list",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Malawi DSW Footprint (19)
significant difference in meterfcr_02, but because there are just 3 water points in wp_census that the test was conducted for, I don't think this warrants attention
```{r}
balance_table19 <- wp_census %>%
  dplyr::filter(country == "Malawi", sample_group == "Footprint", intervention_type == "DSW") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return") 
    
create_balance_latex(
  balance_table19,
  caption = "Balance checks among Footprint DSW water points in Malawi: promoter survey",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Malawi DSW Expansion (20)
no significant differences
```{r}
balance_table20 <- wp_census %>%
  dplyr::filter(country == "Malawi", sample_group == "Expansion", intervention_type == "DSW") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return") 

create_balance_latex(
  balance_table20,
  caption = "Balance checks among Expansion DSW water points in Malawi: promoter survey",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Malawi DSW in ILC vill. (21)
no significant differences
```{r}
balance_table21 <- wp_census %>%
  dplyr::filter(country == "Malawi", sample_group == "ILC", intervention_type == "DSW") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "disp_filled"), 
             # "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return") 

create_balance_latex(
  balance_table21,
  caption = "Balance checks among DSW water points in ILC villages in Malawi: promoter survey",
  label = "balance_uganda_footprint",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey"
)
```

## Malawi ILC (22)
wp_func significantly different, but this isn't very relevant for us
- doesn't output a latex table exactly as in overleaf (graphically)
```{r}
balance_table22 <- wp_census %>%
  dplyr::filter(country == "Malawi", sample_group == "ILC", intervention_type != "DSW") %>%
  sumtable(
    vars = c("wp_func", "discfcr_01", "discfcr_02", "disctcr_01", "disctcr_02", "meterfcr_02", "metertcr_02"),
    group = "promoter_surveyed",
    group.test = TRUE,
    out = "return")

create_balance_latex(
  balance_table22,
  caption = "Balance checks among ILC water points in Malawi",
  label = "balance_malawi_ilc",
  group1_name = "Not in promoter survey",
  group2_name = "In promoter survey",
  custom_labels = list(
    names = c("wp_func", "discfcr_01", "discfcr_02", "disctcr_01", "disctcr_02", "meterfcr_02", "metertcr_02"),
    labels = c(
      "Functional water point (wp\\_func)",
      "FCR color wheel 0.1 ppm (discfcr\\_01)",
      "FCR color wheel 0.2 ppm (discfcr\\_02)",
      "TCR color wheel 0.1 ppm (disctcr\\_01)",
      "TCR color wheel 0.2 ppm (disctcr\\_02)",
      "FCR meter 0.2 ppm (meterfcr\\_02)",
      "TCR meter 0.2 ppm (metertcr\\_02)"
    )
  )
)
```

# sample selection tables
## water point selection
```{r}
uganda_hh_survey <- hh_survey %>%
  dplyr::filter(country == "Uganda") %>%
  mutate(
    promoter_surveyed = replace_na(promoter_surveyed, FALSE),
    pm_ea_list = replace_na(pm_ea_list, FALSE)
  )

malawi_hh_survey <- hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  mutate(
    promoter_surveyed = replace_na(promoter_surveyed, FALSE),
    pm_ea_list = replace_na(pm_ea_list, FALSE)
  )

# run models
# column 1: promoter survey, Uganda
model1 <- lm(disctcr ~ promoter_surveyed, data = uganda_hh_survey)
# column 2: EA list, Uganda
model2 <- lm(disctcr ~ pm_ea_list, data = uganda_hh_survey)
# column 3: both, Uganda
model3 <- lm(disctcr ~ pm_ea_list + promoter_surveyed, data = uganda_hh_survey)
# column 4: promoter survey, Malawi
model4 <- lm(disctcr ~ promoter_surveyed, data = malawi_hh_survey)
# column 5: EA list, malawi
model5 <- lm(disctcr ~ pm_ea_list, data = malawi_hh_survey)
# column 6: both, Malawi
model6 <- lm(disctcr ~ pm_ea_list + promoter_surveyed, data = malawi_hh_survey)

# generate table
stargazer(model1, model2, model3, model4, model5, model6,
          type = "latex",
          title = "Association between Promoter Survey, EA List and Chlorination",
          label = "tab:regression_results",
          dep.var.labels = "TCR (Colorwheel)",
          covariate.labels = c("Promoter Survey", "EA list"),
          column.labels = c("(1)", "(2)", "(3)", "(4)", "(5)", "(6)"),
          column.separate = c(3, 3),
          add.lines = list(
            c("\\multicolumn{1}{l}{} & \\multicolumn{3}{c}{Uganda} & \\multicolumn{3}{c}{Malawi} \\\\")
          ),
          model.numbers = FALSE,
          keep.stat = c("n", "rsq", "adj.rsq"),
          notes = c("Dependent variable: DISCTCR (Chlorination - Color Wheel TCR)", 
                    "Standard errors in parentheses."),
          notes.append = FALSE,
          notes.align = "l",
          table.placement = "htbp",
          header = FALSE,
          omit.table.layout = "n")
```

## household selection
I regress chlorination on household presence in the promoter lists, limiting the sample to households using water points in the promoter survey. We find a significant positive association between these for both Uganda and Malawi.
```{r}
promoter_wp_households <- hh_survey %>%
  dplyr::filter(promoter_surveyed == 1) 
  # mutate(promoter_list = replace_na(promoter_list, FALSE))

uganda_promoter_wp <- promoter_wp_households %>%
  dplyr::filter(country == "Uganda")

malawi_promoter_wp <- promoter_wp_households %>%
  dplyr::filter(country == "Malawi")

uganda_model <- lm(disctcr ~ promoter_list, data = uganda_promoter_wp)
malawi_model <- lm(disctcr ~ promoter_list, data = malawi_promoter_wp)

stargazer(uganda_model, malawi_model,
          type = "text",
          title = "Association between Being Listed by Promoter and Chlorination",
          dep.var.labels = "DISCTCR",
          covariate.labels = c("Listed by Promoter"),
          column.labels = c("Uganda", "Malawi"),
          model.numbers = FALSE,
          keep.stat = c("n", "rsq", "adj.rsq"))
```

# waterfall charts
## share of households outside village among EA water points
```{r}
share_outside_tbl <- hh_census %>%
  dplyr::filter(intervention != "NON-PROGRAM") %>%
  mutate(
    outside_village = case_when(
      inclusion == "Within village boundaries" ~ 0,
      inclusion == "Up to 200m outside of village boundaries" ~ 1,
      TRUE ~ NA_real_
    )
  ) %>%
  group_by(country, sample_group, wp_id) %>%
  summarize(
    share_outside_wp = mean(outside_village, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(country, sample_group) %>%
  summarize(
    share_outside = mean(share_outside_wp, na.rm = TRUE),
    n_wp = n(),
    .groups  = "drop"
  )

share_outside_tbl
```

## TO DO tables excl outside HHs for waterfall charts
### table 1 excluding outside HHs 
Ideally this would link to our code for table 1, for now I just took the values from the most recent version in overleaf
```{r}
# table 1 numbers for each village type (sample_group)
table1 <- tibble::tribble(
  ~country, ~sample_group, ~indiv_access_popn,
  "MALAWI", "EXPANSION", 1775112,
  "MALAWI", "FOOTPRINT", 247293,
  "MALAWI", "ILC", 189076,
  "UGANDA", "EXPANSION", 2495942,
  "UGANDA", "FOOTPRINT", 879105,
)

table1_exout <- table1 %>%
  left_join(share_outside_tbl, by = c("country", "sample_group")) %>%
  mutate(
    indiv_access_popn = indiv_access_popn * (1 - coalesce(share_outside, 0))
  ) %>%
  select(country, sample_group, indiv_access_popn)

table1_ex_outside
```

### table 12 excluding outside HHs
```{r}
hh_count <- hh_census %>%
# excluding households that were not inside village, but rather within 200m of boundary
  dplyr::filter(inclusion != "Up to 200m outside of village boundaries") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of distinct households per wp
    .groups = "drop"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(
    wp_values = list(hh_count[!is.na(hh_count)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # exclude outside hhs
  dplyr::filter(inclusion != "Up to 200m outside of village boundaries") %>%
  # use household survey
  dplyr::filter(survey == "Household Survey") %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table12_exout <- create_summary_table(hh_count, hh_stats, country_totals)
table12_exout

# country estimates table
country_estimates_table12_exout <- compute_country_totals(table12_exout)
country_estimates_table12_exout
```

### table 10 excluding outside HHs
```{r}
hh_count <- hh_census %>%
  # exclude outside hhs
  dplyr::filter(inclusion != "Up to 200m outside of village boundaries") %>%
  # use water points in promoter survey
  dplyr::filter(promoter_surveyed == 1) %>% 
  group_by(country, sample_group, intervention, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of distinct households per wp
    .groups = "drop"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarise(
    wp_values = list(hh_count[!is.na(hh_count)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(tmp = list(compute_se(wp_values, include_within = FALSE))) %>%
  unnest_wider(tmp, names_sep = "_") %>%
  rename(
    avg_hh_count = tmp_mean_val,
    se_hh_count = tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_count, se_hh_count)

hh_stats <- hh_survey %>%
  # exclude outside hhs
  dplyr::filter(inclusion != "Up to 200m outside of village boundaries") %>%
  # use household survey
  dplyr::filter(survey == "Household Survey") %>%
  # use water points in promoter survey
  dplyr::filter(promoter_surveyed == 1) %>%
  group_by(country, sample_group, intervention, wp_id) %>%
  summarize(
    hh_size = mean(hh_members, na.rm = TRUE),
    chl_rate = mean(disctcr_02, na.rm = TRUE),
    se_chl_rate = sqrt(chl_rate * (1 - chl_rate) / n()),  # within-WP SE
    .groups = "drop_last"
  ) %>%
  group_by(country, sample_group, intervention) %>%
  summarize(
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    wp_rates = list(chl_rate[!is.na(chl_rate)]),
    wp_ses = list(se_chl_rate[!is.na(se_chl_rate)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    hh_tmp = list(compute_se(wp_hh_sizes, include_within = FALSE)),
    chl_tmp = list(compute_se(wp_rates, wp_ses, include_within = TRUE))
  ) %>%
  unnest_wider(hh_tmp, names_sep = "_") %>%
  unnest_wider(chl_tmp, names_sep = "_") %>%
  rename(
    avg_hh_size = hh_tmp_mean_val,
    se_hh_size = hh_tmp_se,
    avg_chl_rate = chl_tmp_mean_val,
    se_chl_rate = chl_tmp_se
  ) %>%
  select(country, sample_group, intervention, avg_hh_size, se_hh_size, avg_chl_rate, se_chl_rate)

# water point type table
table10_exout <- create_summary_table(hh_count, hh_stats, country_totals)
table10_exout

# country estimates table
country_estimates_table10_exout <- compute_country_totals(table10_exout)
country_estimates_table10_exout
```

## make waterfall charts
```{r}
#combine all relevant country totals into 1 table
estimates <- table1 %>%
  group_by(country) %>%
  summarise(table1 = sum(indiv_access_popn, na.rm = TRUE)) %>%
  left_join(
    table1_ex_outside %>% group_by(country) %>% summarise(table1_ex_outside = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table12_ex_outside %>% group_by(country) %>% summarise(table12_ex_outside = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table10_ex_outside %>% group_by(country) %>% summarise(table10_ex_outside = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table14 %>% group_by(country) %>% summarise(table14 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table13 %>% group_by(country) %>% summarise(table13 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table8 %>% group_by(country) %>% summarise(table8 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table12 %>% group_by(country) %>% summarise(table12 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table10 %>% group_by(country) %>% summarise(table10 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) 

estimates <- estimates%>%
  mutate(
    pm_to_census_ratio = table8 / table1
  )

# calculate differences for waterfall chart
create_waterfall <- function(country_name, country_data) {
  
  df <- data.frame(
     category = c("Table 1", 
                 "Exclude \ncensus\nout-of-village\nhouseholds", 
                 "Unit of\nobservation",
                 "Sample \nselection\nof water points",
                 "Dataset",
                 "Double \n-counting",
                 "Promoter\nsurvey\nout-of-village\nhouseholds",
                 "Table 8"),
    amount = c(
      country_data$table1,
      country_data$table1_ex_outside - country_data$table1,
      country_data$table12_ex_outside - country_data$table1_ex_outside,
      country_data$table10_ex_outside - country_data$table12_ex_outside,
      country_data$table14 - country_data$table10_ex_outside,
      country_data$table13 - country_data$table14,
      country_data$table8 - country_data$table13,
      country_data$table8
    )
  )
  
  # round (to 50k)
  df <- df %>%
    mutate(amount_rounded = round(amount / 50000) * 50000)
  
  df$category <- factor(df$category, levels = df$category)
  
  df <- df %>%
    mutate(
      id = row_number(),
      type = case_when(
        id == 1 | id == n() ~ "total",
        id == 5 ~ "dataset",                     
        amount_rounded < 0 ~ "decrease",
        TRUE ~ "increase"
      ),
      end = cumsum(amount_rounded),
      start = lag(end, default = 0)
    ) %>%
    mutate(
      start = ifelse(type == "total", 0, start),
      end = ifelse(type == "total", amount_rounded, end)
    )
  
# create waterfall charts
  ggplot(df, aes(x = category, fill = type)) +
    geom_rect(aes(xmin = id - 0.45, xmax = id + 0.45, 
                  ymin = start, ymax = end)) +
    geom_text(aes(x = id, y = end, label = scales::comma(abs(amount_rounded))), 
              vjust = -0.5, size = 4, fontface = "bold") +
    scale_fill_manual(values = c("decrease" = "#d73027", 
                                  "increase" = "#4575b4",
                                  "dataset" = "#FDB462",    # yellow for unexplained part
                                  "total" = "#4575b4")) +   
    labs(
      # title = paste("Breaking down the difference between census and monitoring\nestimates for", country_name),
         y = "People with access",
         x = NULL) +
    theme_minimal() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10),
      # plot.title = element_text(size = 14, face = "bold"),
      panel.grid.major.x = element_blank()
    ) +
    scale_y_continuous(limits = c(0, max(df$end) * 1.1), 
                       labels = scales::comma)
}

# create plots for each country
uganda_data <- estimates %>% filter(country == "UGANDA")
malawi_data <- estimates %>% filter(country == "MALAWI")

waterfall_uganda <- create_waterfall("Uganda", uganda_data)
waterfall_malawi <- create_waterfall("Malawi", malawi_data)

ggsave("output/waterfall_uganda.pdf", 
       plot = waterfall_uganda, 
       width = 8, 
       height = 6, 
       units = "in",
       device = "pdf")

ggsave("output/waterfall_malawi.pdf", 
       plot = waterfall_malawi, 
       width = 8, 
       height = 6, 
       units = "in",
       device = "pdf")
```

# diff in means tests
## test for difference between table 1 and 8
Again, ideally T1 numbers would automatically come from T1 calculations file

difference is statistically significant
```{r}
# UGANDA
# t1 uganda
mean_t1_uganda <- 3375048
ci_lower_t1_uganda <- 3295005
ci_upper_t1_uganda <- 3455090
# upper CI - lower CI = 2 * 1.96 * SE
# => SE = (upper CI - lower CI) / (2*1.96)
se_t1_uganda <- (ci_upper_t1_uganda - ci_lower_t1_uganda) / (2 * 1.96)

# t8 uganda
mean_t8_uganda <- country_estimates_table8$total_indiv_access_popn[country_estimates_table8$country == "Uganda"]
ci_lower_t8_uganda <- country_estimates_table8$ci_lower_total_access[country_estimates_table8$country == "Uganda"]
ci_upper_t8_uganda <- country_estimates_table8$ci_upper_total_access[country_estimates_table8$country == "Uganda"]
se_t8_uganda <- (ci_upper_t8_uganda - ci_lower_t8_uganda) / (2 * 1.96)

# test
diff_means_uganda <- mean_t1_uganda - mean_t8_uganda
se_diff_uganda <- sqrt(se_t1_uganda^2 + se_t8_uganda^2)
z_stat_uganda <- diff_means_uganda / se_diff_uganda
p_value_uganda <- 2 * (1 - pnorm(abs(z_stat_uganda)))

# MALAWI
# t1 malawi
mean_t1_malawi <- 2211481
ci_lower_t1_malawi <- 2134790
ci_upper_t1_malawi <- 2288172
se_t1_malawi <- (ci_upper_t1_malawi - ci_lower_t1_malawi) / (2 * 1.96)

# t8 malawi
mean_t8_malawi <- country_estimates_table8$total_indiv_access_popn[country_estimates_table8$country == "Malawi"]
ci_lower_t8_malawi <- country_estimates_table8$ci_lower_total_access[country_estimates_table8$country == "Malawi"]
ci_upper_t8_malawi <- country_estimates_table8$ci_upper_total_access[country_estimates_table8$country == "Malawi"]
se_t8_malawi <- (ci_upper_t8_malawi - ci_lower_t8_malawi) / (2 * 1.96)

# test
diff_means_malawi <- mean_t1_malawi - mean_t8_malawi
se_diff_malawi <- sqrt(se_t1_malawi^2 + se_t8_malawi^2)
z_stat_malawi <- diff_means_malawi / se_diff_malawi
p_value_malawi <- 2 * (1 - pnorm(abs(z_stat_malawi)))

# p-values
cat("Uganda p-value:", format(p_value_uganda, scientific = FALSE, digits = 10), "\n")
cat("Malawi p-value:", format(p_value_malawi, scientific = FALSE, digits = 10), "\n")
```

## test for difference between table 1 and 12
difference is not statistically significant
```{r}
#t12 uganda
mean_t12_uganda <- country_estimates_table12$total_indiv_access_popn[country_estimates_table12$country == "Uganda"]
ci_lower_t12_uganda <- country_estimates_table12$ci_lower_total_access[country_estimates_table12$country == "Uganda"]
ci_upper_t12_uganda <- country_estimates_table12$ci_upper_total_access[country_estimates_table12$country == "Uganda"]
se_t12_uganda <- (ci_upper_t12_uganda - ci_lower_t12_uganda) / (2 * 1.96)

#t12 malawi
mean_t12_malawi <- country_estimates_table12$total_indiv_access_popn[country_estimates_table12$country == "Malawi"]
ci_lower_t12_malawi <- country_estimates_table12$ci_lower_total_access[country_estimates_table12$country == "Malawi"]
ci_upper_t12_malawi <- country_estimates_table12$ci_upper_total_access[country_estimates_table12$country == "Malawi"]
se_t12_malawi <- (ci_upper_t12_malawi - ci_lower_t12_malawi) / (2 * 1.96)

# test
diff_means_uganda <- mean_t1_uganda - mean_t12_uganda
se_diff_uganda <- sqrt(se_t1_uganda^2 + se_t12_uganda^2)
z_stat_uganda <- diff_means_uganda / se_diff_uganda
p_value_uganda <- 2 * (1 - pnorm(abs(z_stat_uganda)))

# test
diff_means_malawi <- mean_t1_malawi - mean_t12_malawi
se_diff_malawi <- sqrt(se_t1_malawi^2 + se_t12_malawi^2)
z_stat_malawi <- diff_means_malawi / se_diff_malawi
p_value_malawi <- 2 * (1 - pnorm(abs(z_stat_malawi)))

# p-values
cat("Uganda p-value:", format(p_value_uganda, scientific = FALSE, digits = 10), "\n")
cat("Malawi p-value:", format(p_value_malawi, scientific = FALSE, digits = 10), "\n")
```

# statistics referenced in-text
## share of households in hh census identified by promoters
```{r}
hh_census %>%
  inner_join(pm_survey_households_clean, by = c("household_id")) %>%
  mutate(pm_matched = wp_id.x == wp_id_c) %>%
  group_by(
    `country.x`, sample_group, intervention
  ) %>%
  summarise(
    mean(pm_matched, na.rm = TRUE)
  )
```

## share of pm survey WPs with some households outside
approximately 30% in both countries, a bit higher in Uganda (33% vs 28%)
```{r}
hh_outside_share <- wp_census %>%
  group_by(country) %>%
  dplyr::filter(!is.na(pm_users)) %>% # filter for WPs with response to number of users
  # group_by(country, sample_group, intervention) %>%
  summarise(
    n_water_points = n(),
    wp_with_outside_hh = sum(pm_users_outside > 0, na.rm = TRUE),
    share_wp_with_outside = round(wp_with_outside_hh / n_water_points * 100, 1),
    .groups = "drop"
  )

print(hh_outside_share)
```

## number of water points used per household - households in promoter lists
```{r}
# filter for HHs in promoter lists
hh_census_pm_list <- hh_census %>%
  dplyr::filter(promoter_list == TRUE)  

wp_distribution_census <- hh_census_pm_list %>%
  # number of secondary water points plus one = total number of water points
  mutate(total_wp_used = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(total_wp_used) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

# sample (used in caption)
total_households_census <- length(unique(trimws(as.character(hh_census_pm_list$household_id))))

# plot
ggplot(wp_distribution_census, aes(x = as.factor(total_wp_used), y = n, fill = as.factor(total_wp_used))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used in Past Month per Household",
    subtitle = "Limited to households in PM survey data",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = paste0("Note: N= ",total_households_census," households included (filtered by PM survey participation).")) +
  # theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

# number of water points used per household - households NOT in promoter lists
```{r}
# filter for HHs in promoter lists
hh_census_not_pm_list <- hh_census %>%
  dplyr::filter(promoter_list != TRUE)  

wp_distribution_census <- hh_census_not_pm_list %>%
  # number of secondary water points plus one = total number of water points
  mutate(total_wp_used = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(total_wp_used) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

# sample (used in caption)
total_households_census <- length(unique(trimws(as.character(hh_census_not_pm_list$household_id))))

# plot
ggplot(wp_distribution_census, aes(x = as.factor(total_wp_used), y = n, fill = as.factor(total_wp_used))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used in Past Month per Household",
    subtitle = "Limited to households in PM survey data",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = paste0("Note: N= ",total_households_census," households included (not in PM survey).")) +
  # theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

