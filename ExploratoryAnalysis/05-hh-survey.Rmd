# Household survey

```{r}
library(stringr)
library(sf)
library(tidyverse)
library(modelsummary)
library(fixest)
library(glue)
```


```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(promoter_household == 0)
```

## Number of observations

```{r}
hh_survey %>%
  group_by(country) %>%
  summarise(
    N = n(), 
    `Color wheel TCR > 0.2` = mean(disctcr > 0.2, na.rm = TRUE),
    `Color wheel FCR > 0.2` = mean(discfcr > 0.2, na.rm = TRUE),
    `Colorimeter TCR > 0.2` = mean(metertcr > 0.2, na.rm = TRUE),
    `Colorimeter FCR > 0.2` = mean(meterfcr > 0.2, na.rm = TRUE)
  ) %>%
  mutate(
    across(
      -c(country, N),
      ~ paste0(round(. * 100, 1), "%")
    ),
    across(everything(), ~ as.character(.))
  ) %>%
  pivot_longer(cols = -country)
```

## Number of water points per household

LW: move this to hh survey

```{r}
wp_distribution <- 
  hh_survey %>%
  mutate(wp_count = if_else(is.na(wp_count), 1L, wp_count + 1L)) %>%
  count(wp_count) %>%
  mutate(percentage = round(n / sum(n) * 100, 1),
        label = paste0(percentage, "%")
  )

total_households <- hh_survey %>%
  mutate(wp_count = if_else(is.na(wp_count), 1L, wp_count + 1L)) %>%
  count(wp_count) %>%
  summarise(total = sum(n)) %>%
  pull(total)

ggplot(wp_distribution, aes(x = "", y = n, fill = as.factor(wp_count))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(
    aes(label = label),
    position = position_stack(vjust = 0.5),
    color = "black"                   
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
    labs(
  title = "Distribution of Water Points Used per Household",
  caption = glue("Note: This data includes observations from {total_households} households included to date in the Household Survey."
  )) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(hjust = 0, face = "italic") 
  )
```

## Household composition

```{r}
hh_survey %>%
  group_by(country) %>%
  summarise(
    across(
      c(hh_under5, hh_under2),
      ~ mean((.) > 1, na.rm = TRUE)
    )
  )
```
