# Household survey

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue",
    "patchwork",
    "tidyr",
    "dplyr",
    "knitr",
    "kableExtra",
    "vtable",
    "stargazer",
    "ggplot2",
    "haven",
    "estimatr",
    "modelsummary",
    "fixest",
    "haven"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```


```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(survey == "Household Survey")

hh_survey_constructed <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Constructed",
      "hh-survey-constructed.rds"
    )
  ) %>%
  dplyr::filter(survey == "Household Survey")
```

## Sample size

```{r}
hh_survey %>%
  group_by(country, sample_group, wp_intervention_type) %>%
  summarise(
    Villages = n_distinct(village_id),
    Households = n_distinct(household_id),
    `Households with drinking water available` = sum(water_sample, na.rm = TRUE),
    `Drinking water from primary water source` = sum(str_detect(where_collect, "primary"), na.rm = TRUE),
    `Water tested with color wheel` = sum(!is.na(disctcr) | !is.na(discfcr), na.rm = TRUE),
    `Water tested with colorimeter` = sum(!is.na(metertcr) | !is.na(meterfcr), na.rm = TRUE)
  )
```

```{r}
hh_survey %>%
  group_by(country) %>%
  summarise(
    Villages = n_distinct(village_id),
    Households = n_distinct(household_id),
    `Households served by EvAc` = sum(wp_intervention_type != "Non-program", na.rm = TRUE),
    `Households with drinking water available` = sum(water_sample, na.rm = TRUE),
    `Drinking water from primary water source` = sum(str_detect(where_collect, "primary"), na.rm = TRUE),
    `Water tested with color wheel` = sum(!is.na(disctcr) | !is.na(discfcr), na.rm = TRUE),
    `Water tested with colorimeter` = sum(!is.na(metertcr) | !is.na(meterfcr), na.rm = TRUE)
  )
```

## Number of observations

```{r}
hh_survey %>%
  group_by(country) %>%
  summarise(
    N = n(), 
    `Color wheel TCR > 0.2` = mean(disctcr > 0.2, na.rm = TRUE),
    `Color wheel TCR > 0.2` = mean(disctcr > 0.2, na.rm = TRUE),
    `Color wheel FCR > 0.2` = mean(discfcr > 0.2, na.rm = TRUE),
    `Color wheel FCR > 0.2` = mean(discfcr > 0.2, na.rm = TRUE),
    `Colorimeter TCR > 0.2` = mean(metertcr > 0.2, na.rm = TRUE),
    `Colorimeter TCR > 0.2` = mean(metertcr > 0.2, na.rm = TRUE),
    `Colorimeter FCR > 0.2` = mean(meterfcr > 0.2, na.rm = TRUE),
    `Colorimeter FCR > 0.2` = mean(meterfcr > 0.2, na.rm = TRUE)
  ) %>%
  mutate(
    across(
      -c(country, N),
      ~ paste0(round(. * 100, 1), "%")
    ),
    across(everything(), ~ as.character(.))
  ) %>%
  pivot_longer(cols = -country)
```

## Number of water points per household

```{r}
wp_distribution <- 
  hh_survey %>%
  mutate(wp_count = if_else(is.na(wp_count), 1L, wp_count + 1L)) %>%
  count(wp_count) %>%
  mutate(percentage = round(n / sum(n) * 100, 1),
        label = paste0(percentage, "%")
  )

total_households <- hh_survey %>%
  mutate(wp_count = if_else(is.na(wp_count), 1L, wp_count + 1L)) %>%
  count(wp_count) %>%
  summarise(total = sum(n)) %>%
  pull(total)

ggplot(wp_distribution, aes(x = "", y = n, fill = as.factor(wp_count))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(
    aes(label = label),
    position = position_stack(vjust = 0.5),
    color = "black"                   
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
    labs(
  title = "Distribution of Water Points Used per Household",
  caption = glue("Note: This data includes observations from {total_households} households included to date in the Household Survey."
  )) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(hjust = 0, face = "italic") 
  )
```

## chlorination among promoters in hh survey
```{r}
chlorination_promoters <- hh_survey_constructed %>%
  group_by(country, promoter_household) %>%
  summarise(
    chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

chlorination_promoters
```

## box plot of chlorine test results by color of water
```{r}
hh_survey_constructed %>% 
  dplyr::filter(metertcr < 3) %>%
  ggplot(
  aes(x=metertcr_color, y=metertcr)
  ) + geom_boxplot()

hh_survey_constructed %>% 
  dplyr::filter(meterfcr < 3) %>%
  ggplot(
  aes(x=meterfcr_color, y=meterfcr)
  ) + geom_boxplot()

hh_survey_constructed %>% 
  dplyr::filter(disctcr < 3) %>%
  ggplot(
  aes(x=disctcr_color, y=disctcr)
  ) + geom_boxplot()

hh_survey_constructed %>% 
  dplyr::filter(discfcr < 3) %>%
  ggplot(
  aes(x=discfcr_color, y=discfcr)
  ) + geom_boxplot()
```

## Are chlorination rates more similar across colorimeter and color wheel among people who report treating the water?
```{r}
test_vars_c <-
  c(
        "discfcr_c_02", "disctcr_c_02", 
        "meterfcr_c_02", "metertcr_c_02",
        "meterfcr_c_01", "metertcr_c_01"
      )

# note: currently wp_lookup is being created in 08-section-5. it should probably be earlier on so it can be referenced here
hh_survey_constructed <- hh_survey_constructed %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "group_cat", "ea_id"))) %>%
  left_join(wp_lookup, by = "wp_id")

hh_survey_constructed %>%
  group_by(make_watersafe_2, intervention_type) %>%
  summarize(
      across(all_of(test_vars_c), ~mean(.,na.rm = TRUE))) %>%
  dplyr::filter(intervention_type == "DSW")
```

## Are chlorination rates more similar across colorimeter and color wheel when the water is not clear?
```{r}
# TCR, and using metertcr_color (could also use disctcr_color)
hh_survey_constructed %>%
  group_by(metertcr_color, intervention_type) %>%
  summarize(
    metertcr_c_01 = mean(metertcr_c_01, na.rm = TRUE),
    metertcr_c_02 = mean(metertcr_c_01, na.rm = TRUE),
    disctcr_c_02 = mean(disctcr_c_02, na.rm = TRUE)
  ) %>%
  dplyr::filter(!is.na(intervention_type)) %>%
  dplyr::filter(!is.na(metertcr_color))

# FCR, and using meterfcr_color (could also use disctcr_color)
hh_survey_constructed %>%
  group_by(meterfcr_color, intervention_type) %>%
  summarize(
    meterfcr_c_01 = mean(meterfcr_c_01, na.rm = TRUE),
    meterfcr_c_02 = mean(meterfcr_c_01, na.rm = TRUE),
    discfcr_c_02 = mean(discfcr_c_02, na.rm = TRUE)
  ) %>%
  dplyr::filter(!is.na(intervention_type)) %>%
  dplyr::filter(!is.na(meterfcr_color))
```

## Crowding out by ILC?
among all households in HH survey - but obviously it's lower in ILC villages since there's no dispensers to use for chlorination
```{r}
hh_survey <- hh_survey %>%
  mutate(make_watersafe_anycl = make_watersafe_2 == TRUE | make_watersafe_3 == TRUE)

summary_data <- hh_survey %>%
  st_drop_geometry() %>%
  mutate(
    category = case_when(
      ea_program_vil == "DSW" ~ "Village: DSW Only",
      ea_program_vil == "ILC" ~ "Village: ILC Only",
      ea_program_vil == "DSW & ILC" ~ "Village: Both DSW & ILC",
      TRUE ~ "Village: Neither"
    )
  ) %>%
  group_by(category) %>%
  summarise(
    total_n = n(),
    used_cl = sum(make_watersafe_anycl == TRUE, na.rm = TRUE),
    pct = round(100 * used_cl / total_n, 1)
  ) %>%
  mutate(
    label = "Used Chlorine Treatment",
    category_label = paste0(category, "\n(n = ", total_n, ")")
  )

ggplot(summary_data, aes(x = label, y = pct, fill = label)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(label = paste0(pct, "%")),
    vjust = -0.4,
    color = "black",
    size = 3.5
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  facet_wrap(~category_label, ncol = 2) +
  labs(
    title = "Share of Households Reporting Home Chlorine Use by Village Program",
    x = NULL,
    y = "Share of All Households (%)",
    caption = paste0("Note: Denominator includes all households (n = ", sum(summary_data$total_n), 
                     "), regardless of whether they responded to chlorine questions.")
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 10)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

```{r}
hh_survey <- hh_survey %>%
  mutate(make_watersafe_anycl = make_watersafe_2 == TRUE | make_watersafe_3 == TRUE)

summary_data <- hh_survey %>%
  dplyr::filter(intervention_type == "DSW") %>%
  # dplyr::filter(intervention_type == "NON-PROGRAM") %>%
  st_drop_geometry() %>%
  mutate(
    category = case_when(
      ea_program_vil == "DSW" ~ "Village: DSW Only",
      ea_program_vil == "ILC" ~ "Village: ILC Only",
      ea_program_vil == "DSW & ILC" ~ "Village: Both DSW & ILC",
      TRUE ~ "Village: Neither"
    )
  ) %>%
  group_by(category) %>%
  summarise(
    total_n = n(),
    used_cl = sum(make_watersafe_anycl == TRUE, na.rm = TRUE),
    pct = round(100 * used_cl / total_n, 1)
  ) %>%
  mutate(
    label = "Used Chlorine Treatment",
    category_label = paste0(category, "\n(n = ", total_n, ")")
  )

ggplot(summary_data, aes(x = label, y = pct, fill = label)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(label = paste0(pct, "%")),
    vjust = -0.4,
    color = "black",
    size = 3.5
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  facet_wrap(~category_label, ncol = 2) +
  labs(
    title = "Share of Households Reporting Chlorine Use by Village Program",
    x = NULL,
    y = "Share of Households Using DSW WPs (%)",
    caption = paste0(" ")
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 10)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

## Water treatment

```{r}
hh_survey %>%
  group_by(country, sample_group) %>%
  mutate(
    across(
      matches("make_watersafe_[1-9]"),
      ~ case_when(water_sample ~ replace_na(., FALSE))
    )
  ) %>%
  summarise(
    any = mean(watertreat_any, na.rm = TRUE),
    boil = mean(make_watersafe_1, na.rm = TRUE),
    disp = mean(make_watersafe_2, na.rm = TRUE),
    cl = mean(make_watersafe_3, na.rm = TRUE),
    filter = mean(make_watersafe_4 | make_watersafe_5 |make_watersafe_6, na.rm = TRUE),
    sodis = mean(make_watersafe_7, na.rm = TRUE),
    decant = mean(make_watersafe_8, na.rm = TRUE)
  )
```

```{r}
hh_survey %>%
  mutate(cl_any = make_watersafe_2 | make_watersafe_3) %>%
  group_by(country, sample_group, cl_any) %>%
  summarise(
    across(
      all_of(test_vars),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_survey %>%
  mutate(
    cl_any = make_watersafe_2 | make_watersafe_3,
    cldisp = make_watersafe_2 %>% replace_na(FALSE)
  ) %>%
  group_by(country, sample_group, cldisp) %>%
  summarise(
    across(
      all_of(test_vars),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi", sample_group == "Expansion") %>%
  mutate(dsw_source = wp_intervention_type == "DSW" & str_detect(where_collect, "primary")) %>%
  group_by(dsw_source) %>%
  summarise(
    n = n(),
    mean(disctcr_02, na.rm = TRUE)
  )
  feols(
    disctcr_02 ~ dsw_source,
    cluster = ~ village_id,
    data = .
  )
```


```{r}
hh_survey %>%
  dplyr::filter(country == "Malawi", sample_group == "Expansion") %>%
  mutate(
    cldisp = make_watersafe_2 %>% replace_na(FALSE)
  ) %>%
  tabyl(cldisp, disctcr_02) %>%
  adorn_percentages()
```

# spot checks and back checks 
in both, it seems survey_type is identifying between census/survey or household/monitoring

## load relevant files
```{r}
library(haven)

# 213 rows, hh_id is NA for 20
spotcheck_uganda <-
  read_dta(
    file.path(
      path_box,
      "Data - SHARED WITH IPA",
      "Uganda",
      "02_Baseline",
      "03_Data Cleaning",
      "2_raw_data",
      "6_Spot Check Survey",
      "2_dta",
      "Household Survey Spot Check.dta"
    )
  )

# 
spotcheck_malawi <-
  read_dta(
    file.path(
      path_box,
      "Data - SHARED WITH IPA",
      "Malawi",
      "02_Baseline",
      "02_Data Management",
      "4_data",
      "4_monitoring",
      "1_Spotchecks",
      "Household Survey Spot Check.dta"
    )
  )

# 336 obs, hh_id is NA for 0
backcheck_uganda <-
  read_dta(
    file.path(
      path_box,
      "Data - SHARED WITH IPA",
      "Uganda",
      "02_Baseline",
      "03_Data Cleaning",
      "2_raw_data",
      "7_Backcheck Survey",
      "DIL Household Survey Backcheck.dta"
    )
  ) %>%
  rename(hh_id = caseid) %>% 
  dplyr::filter(!is.na(hh_id))
  

# matched, 289 obs, hh_id is NA for 0
backcheck_malawi <-
  read_dta(
    file.path(
      path_box,
      "Data - SHARED WITH IPA",
      "Malawi",
      "02_Baseline",
      "02_Data Management",
      "4_data",
      "3_backcheck",
      "3_post_hfc_data",
      "DIL_Household_Backcheck_checked.dta"
    )
  ) %>%
  rename(hh_id = caseid)
```

## TO DO - cleaning duplicates
## analyze spotchecks
Note the spotchecks concern all of 1) hh census, 2) hh survey, 3) monitoring survey, 4) promoter survey.

COMMENTS
- I don't see that there are separate chlorine tests in spot checks
- chlorine test steps followed in c90% of cases in Malawi, with higher scores for color disc
- chlorine test steps followed in almost 100% of cases in Uganda, but much smaller sample
- readings for colorwheel are similar (not statistically different); indeed, on average the main enumerator's reading is higher than the checker's (exception: TCR in Uganda)
### chlorine test steps
```{r}
spotcheck_vars <- c(
  "colordisc_rinse", "colordisc_fill", "colordisc_wip", "colordisc_dpd",
  "colordisc_sachet", "colordisc_swirl", "colordisc_wait",
  "colordisc_light", "colordisc_wash", "meter_rinse", "meter_fill",
  "meter_blank", "meter_wipe", "meter_dpd", "meter_vials",
  "meter_sachet", "meter_swirl", "meter_wait", "meter_wash"
)

spotcheck_summary_malawi <- spotcheck_malawi %>% 
  select(all_of(spotcheck_vars)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  dplyr::filter(value %in% c(0, 1)) %>%
  # group_by(variable) %>%
  summarise(
    n_ones = sum(value == 1),
    n_zeros = sum(value == 0),
    total = n(),
    share_correct = mean(value == 1)
  )

print(spotcheck_summary_malawi)

spotcheck_summary_uganda <- spotcheck_uganda %>%  # Change this line
  select(all_of(spotcheck_vars)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  dplyr::filter(value %in% c(0, 1)) %>%
  # group_by(variable) %>%
  summarise(
    n_ones = sum(value == 1),
    n_zeros = sum(value == 0),
    total = n(),
    share_correct = mean(value == 1)
  )

print(spotcheck_summary_uganda)
```

### chlorine test results
issue: small sample size
results: differences mostly negative, insignificant

why is the sample size so small?
malawi: 1264 rows -> 381 with hh id and in hh survey -> 125 matched (why so low)
uganda: 226 rows -> 82 with hh id and in hh survey -> 28 matched (also low)
```{r}
spotcheck_malawi <- spotcheck_malawi %>%
  dplyr::filter(surveytype == 2) %>%
  dplyr::filter(
    !is.na(hh_id),
    !hh_id %in% c("", "None", "-999", "N/A")
  )

spotcheck_uganda <- spotcheck_uganda %>%
  dplyr::filter(surveytype == 2) %>%
  dplyr::filter(
    !is.na(hh_id),
    !hh_id %in% c("", "None", "-999", "N/A")
  )
```

uganda: 
```{r}
# match to hh survey
hh_survey_spotchecks_malawi <- hh_survey %>%
  dplyr::filter(country == "Malawi") %>%
  left_join(
    spotcheck_malawi %>% select(hh_id, tcr, fcr),
    by = c("household_id" = "hh_id")) 

hh_survey_spotchecks_uganda <- hh_survey %>%
  dplyr::filter(country == "Uganda") %>%
  left_join(
    spotcheck_uganda %>% select(hh_id, tcr, fcr),
    by = c("household_id" = "hh_id")) 
```

```{r}
# compare results with hh_survey results
test_comparison_malawi <- hh_survey_spotchecks_malawi %>%
  select(disctcr, discfcr, tcr, fcr) %>%
  mutate(
    diff_tcr = (disctcr - tcr), # if >0, then higher reading by enumerator than checker
    diff_fcr = (discfcr - fcr)
  ) %>%
  mutate(
    disctcr_hh_survey = disctcr,
    disctcr_spotcheck = tcr,
    discfcr_hh_survey = discfcr,
    discfcr_spotcheck = fcr
  ) %>%
  select(-disctcr, -tcr, -discfcr, -fcr) %>%
  dplyr::filter(abs(discfcr_spotcheck) < 100)%>% # to get rid of one really high result, clearly an error
  dplyr::filter(abs(disctcr_spotcheck) < 100) %>%  
  summarize(
    disctcr_hh_survey = mean(disctcr_hh_survey, na.rm = TRUE),
    disctcr_spotcheck = mean(disctcr_spotcheck, na.rm = TRUE),
    tcr_survey_minus_spotcheck = mean(diff_tcr, na.rm = TRUE),
    discfcr_hh_survey = mean(discfcr_hh_survey, na.rm = TRUE), 
    discfcr_spotcheck = mean(discfcr_spotcheck, na.rm = TRUE),
    fcr_survey_minus_spotcheck = mean(diff_fcr, na.rm = TRUE),
    n = n()
  )

print(test_comparison_malawi)

test_comparison_uganda <- hh_survey_spotchecks_uganda %>%
  select(disctcr, discfcr, tcr, fcr) %>%
  mutate(
    diff_tcr = (disctcr - tcr), # if >0, then higher reading by enumerator than checker
    diff_fcr = (discfcr - fcr)
  ) %>%
  mutate(
    disctcr_hh_survey = disctcr,
    disctcr_spotcheck = tcr,
    discfcr_hh_survey = discfcr,
    discfcr_spotcheck = fcr
  ) %>%
  select(-disctcr, -tcr, -discfcr, -fcr) %>%
  dplyr::filter(abs(discfcr_spotcheck) < 100)%>% # to get rid of one really high result, clearly an error
  dplyr::filter(abs(disctcr_spotcheck) < 100) %>%  
  summarize(
    disctcr_hh_survey = mean(disctcr_hh_survey, na.rm = TRUE),
    disctcr_spotcheck = mean(disctcr_spotcheck, na.rm = TRUE),
    tcr_survey_minus_spotcheck = mean(diff_tcr, na.rm = TRUE),
    discfcr_hh_survey = mean(discfcr_hh_survey, na.rm = TRUE), 
    discfcr_spotcheck = mean(discfcr_spotcheck, na.rm = TRUE),
    fcr_survey_minus_spotcheck = mean(diff_fcr, na.rm = TRUE),
    n = n()
  )

print(test_comparison_uganda)

# test for malawi
malawi_data <- hh_survey_spotchecks_malawi %>%
  select(disctcr, discfcr, tcr, fcr) %>%
  mutate(
    diff_tcr = disctcr - tcr,
    diff_fcr = discfcr - fcr
  ) %>%
  dplyr::filter(fcr < 100) %>%
  dplyr::filter(tcr < 100)

tcr_test_malawi <- t.test(malawi_data$disctcr, malawi_data$tcr, paired = TRUE)
fcr_test_malawi <- t.test(malawi_data$discfcr, malawi_data$fcr, paired = TRUE)

cat("MALAWI RESULTS:\n")
cat("TCR difference test:\n")
cat("  p-value:", round(tcr_test_malawi$p.value, 4), "\n")
cat("FCR difference test:\n")
cat("  p-value:", round(fcr_test_malawi$p.value, 4), "\n")
# 
# test for uganda
uganda_data <- hh_survey_spotchecks_uganda %>%
  select(disctcr, discfcr, tcr, fcr) %>%
  mutate(
    diff_tcr = disctcr - tcr,
    diff_fcr = discfcr - fcr
  ) %>%
  dplyr::filter(fcr < 100)

tcr_test_uganda <- t.test(uganda_data$disctcr, uganda_data$tcr, paired = TRUE)
fcr_test_uganda <- t.test(uganda_data$discfcr, uganda_data$fcr, paired = TRUE)

cat("UGANDA RESULTS:\n")
cat("TCR difference test:\n")
cat("  p-value:", round(tcr_test_uganda$p.value, 4), "\n")
cat("FCR difference test:\n")
cat("  p-value:", round(fcr_test_uganda$p.value, 4), "\n")
```

## analyzing backchecks - compare to hh survey

### confirmation of correct WP
<b>1.9 Is ${wp_name_pl} the primary water source that your household uses for collecting drinking water? YES in >99% of cases
```{r}
use_wp_table_uganda <- backcheck_uganda %>%
  summarize(
    use_waterpoint_mean = mean(use_waterpoint, na.rm = TRUE)
  )

use_wp_table_uganda

use_wp_table_malawi <- backcheck_malawi %>%
  summarize(
    use_waterpoint_mean = mean(use_waterpoint, na.rm = TRUE)
  )

use_wp_table_malawi
```


### merging hh survey and backchecks
```{r}
hh_survey_backcheck_uganda <- hh_survey %>%
  dplyr::filter(country == "UGANDA") %>%
  left_join(
    backcheck_uganda %>% select(hh_id, use_waterpoint),
    by = c("household_id" = "hh_id")
  )

hh_survey_backcheck_malawi <- hh_survey %>%
  dplyr::filter(country == "MALAWI") %>%
  left_join(
    backcheck_malawi %>% select(hh_id, use_waterpoint),
    by = c("household_id" = "hh_id")
  )
```

### checking consistency
```{r}
consistency_checks_malawi <- hh_survey_backcheck_malawi %>%
  summarize(
    wp_dsw_diff = mean()
  )

consistency_checks_uganda <- hh_survey_backcheck_uganda %>%
    
```


# REMAINING TO DO (lower priority):
check consistency between hh survey and back check of:
- other water treatment methods (make_watersafe ...)
- wp_dsw and wp_ilc - checks of awareness of dispenser
- if they report using more than 1

```{r}
### merging hh survey and backchecks
hh_survey_backcheck_uganda <- hh_survey %>%
  dplyr::filter(country == "UGANDA") %>%
  left_join(
    backcheck_uganda %>% 
      select(hh_id, 
             wp_dsw,
             wp_ilc,
             wp_more,
             make_watersafe_0,
             make_watersafe_1,
             make_watersafe_2,
             make_watersafe_3,
             make_watersafe_4,
             make_watersafe_5,
             make_watersafe_6,
             make_watersafe_7,
             make_watersafe_8,
             make_watersafe__666,
             make_watersafe__999) %>%
      rename(hh_dsw_backcheck = wp_dsw,
             hh_ilc_backcheck = wp_ilc,
             wp_more_backcheck = wp_more,
             watertreat_any_backcheck = make_watersafe_0,
             watertreat_boil_backcheck = make_watersafe_1,
             watertreat_dispcl_backcheck = make_watersafe_2,
             watertreat_othercl_backcheck = make_watersafe_3,
             watertreat_strain_backcheck = make_watersafe_4,
             watertreat_filter_backcheck = make_watersafe_5,
             watertreat_sand_backcheck = make_watersafe_6,
             watertreat_solar_backcheck = make_watersafe_7,
             watertreat_decant_backcheck = make_watersafe_8,
             watertreat_other_backcheck = make_watersafe__666,
             watertreat_dk_backcheck = make_watersafe__999),
    by = c("household_id" = "hh_id")
  )

hh_survey_backcheck_malawi <- hh_survey %>%
  dplyr::filter(country == "MALAWI") %>%
  left_join(
    backcheck_malawi %>% 
      select(hh_id,
             wp_dsw,
             wp_ilc,
             wp_more,
             make_watersafe_0,
             make_watersafe_1,
             make_watersafe_2,
             make_watersafe_3,
             make_watersafe_4,
             make_watersafe_5,
             make_watersafe_6,
             make_watersafe_7,
             make_watersafe_8,
             make_watersafe__666,
             make_watersafe__999) %>%
      rename(hh_dsw_backcheck = wp_dsw,
             hh_ilc_backcheck = wp_ilc,
             wp_more_backcheck = wp_more,
             watertreat_any_backcheck = make_watersafe_0,
             watertreat_boil_backcheck = make_watersafe_1,
             watertreat_dispcl_backcheck = make_watersafe_2,
             watertreat_othercl_backcheck = make_watersafe_3,
             watertreat_strain_backcheck = make_watersafe_4,
             watertreat_filter_backcheck = make_watersafe_5,
             watertreat_sand_backcheck = make_watersafe_6,
             watertreat_solar_backcheck = make_watersafe_7,
             watertreat_decant_backcheck = make_watersafe_8,
             watertreat_other_backcheck = make_watersafe__666,
             watertreat_dk_backcheck = make_watersafe__999),
    by = c("household_id" = "hh_id")
  )

### checking consistency
consistency_checks_malawi <- hh_survey_backcheck_malawi %>%
  summarize(
    match_hh_dsw = mean(as.character(hh_dsw) == as.character(hh_dsw_backcheck), na.rm = TRUE),
    match_hh_ilc = mean(as.character(hh_ilc) == as.character(hh_ilc_backcheck), na.rm = TRUE),
    match_watertreat_any = mean(as.character(watertreat_any) == as.character(watertreat_any_backcheck), na.rm = TRUE),
    match_watertreat_boil = mean(as.character(watertreat_boil) == as.character(watertreat_boil_backcheck), na.rm = TRUE),
    match_watertreat_dispcl = mean(as.character(watertreat_dispcl) == as.character(watertreat_dispcl_backcheck), na.rm = TRUE),
    match_watertreat_othercl = mean(as.character(watertreat_othercl) == as.character(watertreat_othercl_backcheck), na.rm = TRUE),
    match_watertreat_strain = mean(as.character(watertreat_strain) == as.character(watertreat_strain_backcheck), na.rm = TRUE),
    match_watertreat_filter = mean(as.character(watertreat_filter) == as.character(watertreat_filter_backcheck), na.rm = TRUE),
    match_watertreat_sand = mean(as.character(watertreat_sand) == as.character(watertreat_sand_backcheck), na.rm = TRUE),
    match_watertreat_solar = mean(as.character(watertreat_solar) == as.character(watertreat_solar_backcheck), na.rm = TRUE),
    match_watertreat_decant = mean(as.character(watertreat_decant) == as.character(watertreat_decant_backcheck), na.rm = TRUE),
    match_watertreat_other = mean(as.character(watertreat_other) == as.character(watertreat_other_backcheck), na.rm = TRUE),
    match_watertreat_dk = mean(as.character(watertreat_dk) == as.character(watertreat_dk_backcheck), na.rm = TRUE),
    n_households = n()
  )

consistency_checks_uganda <- hh_survey_backcheck_uganda %>%
  summarize(
    match_hh_dsw = mean(as.character(hh_dsw) == as.character(hh_dsw_backcheck), na.rm = TRUE),
    match_hh_ilc = mean(as.character(hh_ilc) == as.character(hh_ilc_backcheck), na.rm = TRUE),
    match_watertreat_any = mean(as.character(watertreat_any) == as.character(watertreat_any_backcheck), na.rm = TRUE),
    match_watertreat_boil = mean(as.character(watertreat_boil) == as.character(watertreat_boil_backcheck), na.rm = TRUE),
    match_watertreat_dispcl = mean(as.character(watertreat_dispcl) == as.character(watertreat_dispcl_backcheck), na.rm = TRUE),
    match_watertreat_othercl = mean(as.character(watertreat_othercl) == as.character(watertreat_othercl_backcheck), na.rm = TRUE),
    match_watertreat_strain = mean(as.character(watertreat_strain) == as.character(watertreat_strain_backcheck), na.rm = TRUE),
    match_watertreat_filter = mean(as.character(watertreat_filter) == as.character(watertreat_filter_backcheck), na.rm = TRUE),
    match_watertreat_sand = mean(as.character(watertreat_sand) == as.character(watertreat_sand_backcheck), na.rm = TRUE),
    match_watertreat_solar = mean(as.character(watertreat_solar) == as.character(watertreat_solar_backcheck), na.rm = TRUE),
    match_watertreat_decant = mean(as.character(watertreat_decant) == as.character(watertreat_decant_backcheck), na.rm = TRUE),
    match_watertreat_other = mean(as.character(watertreat_other) == as.character(watertreat_other_backcheck), na.rm = TRUE),
    match_watertreat_dk = mean(as.character(watertreat_dk) == as.character(watertreat_dk_backcheck), na.rm = TRUE),
    n_households = n()
  )

# View results
print(consistency_checks_malawi)
print(consistency_checks_uganda)
```
