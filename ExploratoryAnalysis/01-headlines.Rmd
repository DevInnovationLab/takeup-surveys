# Primary outcomes

```{r}
pacman::p_load(
  sf,
  tidyverse,
  viridis,
  fixest,
  broom,
  modelsummary,
  survey
)
```

## People using DSW/ILC water points

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  ) %>%
  st_drop_geometry() %>%
  mutate(sample_group_combined = if_else(sample_group == "ILC", "ILC", "DSW"))
```


```{r}
users_village <-
  hh_census %>%
  dplyr::filter(wp_intervention_type != "Non-program") %>%
  group_by(sample_group, country) %>%
  mutate(
    hh_members = if_else(
      !is.na(hh_members), 
      hh_members, 
      mean(hh_members, na.rm = TRUE)
    )
  ) %>%
  group_by(village_id, sample_group, country) %>%
  summarise(
    users = sum(hh_members, na.rm = TRUE)
  ) %>%
  left_join(weights) %>%
  group_by(sample_group, country) %>%
  mutate(weight = pop/n()) %>%
  ungroup

group_total <-
  map(
  users_village %>%
    group_by(country, sample_group) %>%
    group_split(),
  ~ total_cis(data = ., var = "users")
) %>% 
  bind_rows() %>%
  bind_cols(
    users_village %>% 
      select(country, sample_group) %>% 
      unique
  )

country_total <-
  map(
  users_village %>%
    group_by(country) %>%
    group_split(),
  ~ total_cis(data = ., var = "users")
) %>% 
  bind_rows() %>%
  bind_cols(
    users_village %>% 
      select(country) %>% 
      unique
  )
```


## Chlorination

```{r}
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  ) %>%
  dplyr::filter(survey == "Household Survey")
```


```{r warning = FALSE}
hh_survey_grouped <-
  hh_survey %>%
  group_by(country, sample_group) %>%
  group_split
  
treatment <-
  hh_survey_grouped %>%
  map(
    ~ village_mean_ci(
      data = .x,
      outcomes = c("make_watersafe_2", test_vars),
      dummy = TRUE
    ) %>%
      mutate(
        country = .x %>% pull(country) %>% unique,
        sample_group = .x %>% pull(sample_group) %>% unique
      )
  ) %>%
  bind_rows %>%
  mutate(
    outcome = outcome %>%
      factor(
        levels = c(
          "make_watersafe_2",
          "disctcr_02", "metertcr_02", "metertcr_01",
          "discfcr_02", "meterfcr_02", "meterfcr_01"
        ),
        ordered = TRUE
      )
  )
```

```{r}
treatment %>%
  ggplot(
    aes(
      x =  mean,
      xmin = lb,
      xmax = ub,
      y = outcome
    )
  ) +
  geom_errorbarh() +
  geom_point() +
  facet_grid(sample_group ~ country)
```


```{r}
write_csv(
  all,
  file.path(
    path_git,
    "output",
    "tables",
    "hh-chlorine-detection.csv"
  )
)

```

# Headlines

```{r}
chlorination_mw <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ sample_group | village_id") %>% as.formula,
      data = hh_survey %>% dplyr::filter(country == "Malawi", sample_group != "ILC"),
      cluster = ~ village_id
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Malawi")

chlorination_mw_ilc <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + sample_group | village_id") %>% as.formula,
      data = hh_survey %>% 
        dplyr::filter(country == "Malawi", sample_group == "ILC") %>%
        left_join(
          clusters %>%
            mutate(village_id = as.character(wcp_villageid)) %>%
            select(village_id, ilc_clusterid, weight)
        ),
      cluster = ~ ilc_clusterid,
      weight = ~ weight
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Malawi")

chlorination_ug <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + sample_group | village_id") %>% as.formula,
      data = hh_survey %>% dplyr::filter(country == "Uganda"),
      cluster = ~ village_id
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Uganda")

chlorination_reg <-
  bind_rows(
    chlorination_mw,
    chlorination_ug
  ) %>%
  bind_rows(chlorination_mw_ilc) %>%
  transmute(
    country,
    outcome,
    sample_group = str_remove_all(term, "sample_group"),
    mean = estimate,
    se = std.error,
    lb = conf.low,
    ub = conf.high
  )
```

```{r}
outcomes <- c("discfcr_02", "disctcr_02", "meterfcr_02", "metertcr_02", "meterfcr_01", "metertcr_01")

chlorination_mw <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + sample_group") %>% as.formula,
      data = hh_survey %>% dplyr::filter(country == "Malawi", sample_group != "ILC"),
      cluster = ~ village_id
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Malawi")

chlorination_mw_ilc <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + sample_group") %>% as.formula,
      data = hh_survey %>% 
        dplyr::filter(country == "Malawi", sample_group == "ILC") %>%
        left_join(
          clusters %>%
            mutate(village_id = as.character(wcp_villageid)) %>%
            select(village_id, ilc_clusterid, weight)
        ),
      cluster = ~ ilc_clusterid,
      weight = ~ weight
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Malawi")

chlorination_mw_ilcwp <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + wp_intervention_type") %>% as.formula,
      data = hh_survey %>% 
        dplyr::filter(country == "Malawi", sample_group == "ILC") %>%
        left_join(
          clusters %>%
            mutate(village_id = as.character(wcp_villageid)) %>%
            select(village_id, ilc_clusterid, weight)
        ),
      cluster = ~ ilc_clusterid,
      weight = ~ weight
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Malawi")

chlorination_ug <-
  map(
    outcomes,
    ~ feols(
      paste(.x, " ~ 0 + sample_group") %>% as.formula,
      data = hh_survey %>% dplyr::filter(country == "Uganda"),
      cluster = ~ village_id
    ) %>%
      tidy(., conf.int = TRUE)
  ) %>%
  set_names(outcomes) %>%
  bind_rows(.id = "outcome") %>%
  mutate(country = "Uganda")

chlorination_reg <-
  bind_rows(
    chlorination_mw,
    chlorination_ug
  ) %>%
  #bind_rows(chlorination_mw_ilc) %>%
  transmute(
    country,
    outcome,
    sample_group = str_remove_all(term, "sample_group"),
    mean = estimate,
    se = std.error,
    lb = conf.low,
    ub = conf.high
  )
```
```{r}
chlorination_reg %>%
  transmute(
    country, sample_group, outcome,
    mean = round(mean * 100, 1) %>% as.character,
    ci = paste0("(", round(lb * 100, 1), ", ", round(ub * 100, 1), ")")
  ) %>%
  pivot_longer(
    cols = c(mean, ci)
  ) %>%
  pivot_wider(names_from = outcome) %>%
  select(-name) %>%
  write_csv(
    file.path(
      path_git,
      "output",
      "tables",
      "hh-survey-cl.csv"
    )
  )
```

## Export main table

```{r}
table1 <-
  
  
%>%
  write_csv(
    file.path(
      "..",
      "output",
      "tables",
      "users.csv"
    )
  )
```


Villages in large clusters are not significantly different from villages in small clusters, so we will calculate the average number of households per village while disregarding the size of the cluster

```{r}
cluster_hhs <-
  hh_census %>%
  dplyr::filter(sample_group == "ILC") %>%
  group_by(village_id) %>%
  summarise(
    hhs = n_distinct(household_id),
    hh_members_c = sum(hh_members, na.rm = TRUE),
    users = sum(wp_intervention_type != "Non-program")
  ) %>%
  left_join(
    clusters %>%
      mutate(village_id = as.character(wcp_villageid)) %>%
      group_by(village_id) %>%
      summarise(
        across(
          c(large_cluster, verylarge_cluster),
          ~ any(. == 1)
        )
      )
  )

lm(
  hhs ~ large_cluster,
  data = cluster_hhs
) %>%
  summary

lm(
  hh_members ~ large_cluster,
  data = cluster_hhs
) %>%
  summary

lm(
  users ~ large_cluster,
  data = cluster_hhs
) %>%
  summary

lm(
  hhs ~ verylarge_cluster,
  data = cluster_hhs
) %>%
  summary

lm(
  hh_members ~ verylarge_cluster,
  data = cluster_hhs
) %>%
  summary

lm(
  users ~ verylarge_cluster,
  data = cluster_hhs
) %>%
  summary
```

```{r}
cluster_hhs <-
  hh_survey %>%
  dplyr::filter(sample_group == "ILC") %>%
  group_by(village_id) %>%
  summarise(
    across(
      outcomes,
      ~ mean(., na.rm = TRUE)
    )
  ) %>%
  left_join(
    clusters %>%
      mutate(village_id = as.character(wcp_villageid)) %>%
      group_by(village_id, ilc_clusterid) %>%
      summarise(
        across(
          c(large_cluster, verylarge_cluster),
          ~ any(. == 1)
        ),
        weight
      )
  )

outcomes %>%
  map(
    ~ feols(
      paste(., "~ large_cluster") %>% as.formula,
      data = cluster_hhs,
      weights = ~weight,
      cluster = ~ ilc_clusterid
    )
  ) %>%
  modelsummary(stars = TRUE)

outcomes %>%
  map(
    ~ feols(
      paste(., "~ verylarge_cluster") %>% as.formula,
      data = cluster_hhs,
      weights = ~weight,
      cluster = ~ ilc_clusterid
    )
  ) %>%
  modelsummary(stars = TRUE)
```

