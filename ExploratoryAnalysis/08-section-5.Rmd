---
title: "Section 5 Analysis"
output: html_document
---

This is the code to generate the tables present in section 6 of the report, as well as numbers that are referenced in its text.

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue",
    "patchwork",
    "tidyr",
    "dplyr",
    "knitr",
    "kableExtra",
    "vtable",
    "stargazer",
    "ggplot2",
    "haven"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

## setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)

# print tables nicely
options(knitr.table.format = "html")
knit_print.data.frame <- function(x, ...) {
  res <- kable(x, format = "html") %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = TRUE,
      position = "left",
      font_size = 9
    ) %>%
    scroll_box(width = "100%", height = "400px") 
  knitr::asis_output(res)
}
registerS3method("knit_print", "data.frame", knit_print.data.frame)
registerS3method("knit_print", "tbl_df", knit_print.data.frame)

# import
path_box <- "/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup"

villages <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "villages.rds"
    )
  ) 

sampled_villages <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "villages.rds"
    )
  ) %>%
  dplyr::filter(sample == "Main sample")

pm_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Final",
      "pm-survey.rds"
    )
  )

promoter_list_uganda <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_uganda.csv"
    )
  )

promoter_list_malawi <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_malawi.csv"
    )
  )
    
hh_survey <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdSurvey",
      "DataSets",
      "Final",
      "hh-survey.rds"
    )
  )

hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  )

pm_survey_households <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Constructed",
      "pm-survey-households.rds"
    )
  )

pm_list_mw <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_malawi.csv"
    )
  )

pm_list_ug <-
  read_csv(
    file.path(
      path_box,
      "Data",
      "PromoterSurvey",
      "DataSets",
      "Raw",
      "promoter_list_uganda.csv"
    )
  )

wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  mutate(ea_id = as.character(ea_id))

malawi_wp <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/malawi-water-points.dta") %>%
  mutate(
    villageid = as.character(villageid)
  )
malawi_villages <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/malawi-villages.dta") %>%
  mutate(
    villageid = as.character(villageid)
  )
uganda_wp <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/uganda-water-points (luizaandrade@uchicago.edu).dta") %>%
  mutate(
    villageid = as.character(villageid)
  )
uganda_villages <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/uganda-villages.dta") %>%
    mutate(
    villageid = as.character(villageid)
  )
malawi_wcp <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/malawi-water-collection-points.dta")
uganda_wcp <- read_dta("/Users/lenawisniewska/Library/CloudStorage/Box-Box/i-h2o-takeup/Data/EvidenceAction/Final/uganda-water-collection-points.dta")
```

# country totals
```{r}
# malawi 
malawi_wp <- malawi_wp %>%
  left_join(malawi_villages %>% select(villageid, ilc), by = "villageid") %>%
  mutate(
    wp_category = case_when(
      program == 1 & pre_expansion == 1 & ilc == 0 ~ "DSW Footprint",
      program == 1 & pre_expansion == 0 & ilc == 0 ~ "DSW Expansion",
      program == 2 ~ "ILC water points",
      program == 1 & ilc == 1 ~ "DSW in ILC village",
      TRUE ~ NA_character_
    ),
    country = "MALAWI"
  )

malawi_wcp_count <- nrow(malawi_wcp)

# uganda
uganda_wp <- uganda_wp %>%
  left_join(uganda_villages %>% select(villageid, ilc), by = "villageid") %>%
  mutate(
    wp_category = case_when(
      program == 1 & pre_expansion == 1 & ilc == 0 ~ "DSW Footprint",
      program == 1 & pre_expansion == 0 & ilc == 0 ~ "DSW Expansion",
      program == 2 ~ "ILC",
      program == 1 & ilc == 1 ~ "DSW in ILC village",
      TRUE ~ NA_character_
    ),
    country = "UGANDA"
  )

uganda_wcp_count <- nrow(uganda_wcp)

# create table summary
country_totals <- bind_rows(malawi_wp, uganda_wp) %>%
  count(country, wp_category, name = "count") %>%
  mutate(
    country_total = case_when(
      country == "MALAWI" & wp_category == "ILC water points" ~ count + malawi_wcp_count, # add up water points and water collection points to get all ILC points
      country == "UGANDA" & wp_category == "ILC water points" ~ count + uganda_wcp_count,
      TRUE ~ count
    )
  ) %>%
  arrange(country, wp_category)

country_totals
```

# corrections: pm_survey
```{r}
# join with wp census
pm_survey <- pm_survey %>%
  left_join(wp_census %>% select(wp_id, intervention_type),
            by = "wp_id")

#deleting test village
pm_survey <- pm_survey %>%
  dplyr::filter(village_id != "1010602004")

# correct unmatched wp ids (by matching to wp census by wp name): 
pm_unmatched <- pm_survey %>%
  dplyr::filter(is.na(intervention_type))

pm_survey <- pm_survey %>%
  mutate(
    wp_id = case_when(
      wp_name == "NANGOLO BOREHOLE" ~ "1050702004001",
      wp_name == "FUSANI TAP" ~ "2070302012007", 
      wp_name == "BETHANI TAP" ~ "2070302012004",
      TRUE ~ wp_id  # Keep original wp_id for all other cases
    )
  )
# only remaining is MPOPI WAKWA LIWAYA/ MPOPI WAKWA DICKSON - in Liwaya, a village that was replaced - it is a DSW water point, so I add 1 to Malawi DSW

# merge intervention_type from wp census for the corrected water points
pm_survey <- pm_survey %>%
  left_join(wp_census %>% select(wp_id, intervention_type),
            by = "wp_id",
            suffix = c("", "_new")) %>%
  mutate(intervention_type = coalesce(intervention_type, intervention_type_new)) %>%
  dplyr::select(-intervention_type_new)
```

```{r}
# identifying duplicates
pm_survey %>%
  group_by(country) %>%
  summarise(
    total_rows = n(),
    unique_wp_ids = n_distinct(wp_id, na.rm = TRUE),
    missing_wp_ids = sum(is.na(wp_id)),
    .groups = "drop"
  ) %>%
  arrange(desc(total_rows))

pm_survey %>%
  dplyr::filter(!is.na(wp_id)) %>%
  count(country, wp_id) %>%
  dplyr::filter(n > 1) %>%
  arrange(desc(n))

# deleting duplicates - keeping first observation
pm_survey <- pm_survey %>%
  dplyr::filter(!is.na(wp_id)) %>%
  distinct(wp_id, .keep_all = TRUE)
```

# creating wp_category
wp_category is the variable for water point type in a given village type
```{r}
wp_census <- wp_census %>%
  mutate(
    country = toupper(country),
    sample_group = toupper(sample_group),
    intervention_type = toupper(intervention_type),
    wp_category = case_when(
      intervention_type == "NON-PROGRAM" ~ "Non-program",
      intervention_type %in% c("ILC WATER POINT", "ILC WATER COLLECTION POINT") ~ "ILC",
      intervention_type == "DSW" & sample_group == "FOOTPRINT" ~ "DSW Footprint",
      intervention_type == "DSW" & sample_group == "EXPANSION" ~ "DSW Expansion",
      intervention_type == "DSW" & sample_group == "ILC" ~ "DSW in ILC village",
      TRUE ~ NA_character_
    )
  ) %>%
  dplyr::filter(!is.na(sample_group), !is.na(intervention_type))

# create lookup table
wp_lookup <- wp_census %>% 
  select(wp_id, ea_id, country, sample_group, intervention_type, wp_category) %>%
  distinct()

wp_lookup_ea_id <- wp_census %>% 
  select(ea_id, country, sample_group, intervention_type, wp_category) %>%
  distinct(ea_id, .keep_all = TRUE) %>%
  mutate(ea_id = as.character(ea_id))

# join to other datasets
pm_survey <- pm_survey %>%
  select(-any_of(c("country", "sample_group", "wp_category", "ea_id"))) %>%
  left_join(wp_lookup, by = "wp_id")

hh_survey <- hh_survey %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "wp_category", "ea_id"))) %>%
  left_join(wp_lookup, by = "wp_id")

hh_census <- hh_census %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "wp_category", "ea_id"))) %>%
  left_join(wp_lookup, by = "wp_id")

hh_census <- hh_census %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "wp_category", "ea_id"))) %>%
  left_join(wp_lookup, by = "wp_id")

ea_promoters_malawi <- pm_list_mw %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "wp_category", "ea_id"))) %>%
  mutate(i102_wpt_id = as.character(i102_wpt_id)) %>%
  left_join(wp_lookup_ea_id, by = c("i102_wpt_id" = "ea_id"))

ea_promoters_uganda <- pm_list_ug %>%
  select(-any_of(c("country", "sample_group", "intervention_type", "wp_category", "ea_id"))) %>%
  mutate(i102_wpt_id = as.character(i102_wpt_id)) %>%
  left_join(wp_lookup_ea_id, by = c("i102_wpt_id" = "ea_id"))
```

# corrections: pm_survey_households
```{r}
#deleting test village
pm_survey_households <- pm_survey_households %>%
  dplyr::filter(village_id != "1010602004")

# correcting WPs where WP ID is NA in the dataset
missing_wp_ids <- pm_survey_households %>%
  dplyr::filter(is.na(wp_id)) %>%
  distinct(wp_id_c) %>%
  arrange(wp_id_c)

unique_wp_combinations <- pm_survey_households %>%
  dplyr::filter(wp_id_c %in% missing_wp_ids$wp_id_c) %>%
  distinct(wp_name, wp_id_c) %>%  
  arrange(wp_name, wp_id_c) %>%
  mutate(new_wp_id = NA_character_)

write.csv(unique_wp_combinations, "unique_wp_combinations_for_correction.csv", row.names = FALSE)
```

I corrected the IDs for 10 water points manually, by matching to the water point census by the water point name.

```{r}
wp_corrections_lookup <- read.csv("unique_wp_combinations_corrected.csv", stringsAsFactors = FALSE)

pm_survey_households_clean <- pm_survey_households %>%
  left_join(wp_corrections_lookup %>% select(wp_name, wp_id_c, new_wp_id), 
            by = c("wp_name", "wp_id_c")) %>%
  mutate(wp_id_c = ifelse(!is.na(new_wp_id), new_wp_id, wp_id_c)) %>%
  select(-new_wp_id)

write.csv(pm_survey_households_clean, "pm_survey_households_corrections.csv", row.names = FALSE)
```

## table 8 
Main estimates using promoter survey and monitoring survey
```{r}
# column 1: household count and SE
hh_count_tbl <- pm_survey  %>%
  mutate(hh_listed = as.numeric(hh_listed)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    avg_hh_count = mean(hh_listed, na.rm = TRUE),
    wp_values = list(hh_listed[!is.na(hh_listed)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)
  
# column 2: hh size and SE
hh_size_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 4: total numbers of each type of water point in each country (calculated in STATA)
# country_totals1 <- tibble(
#   country = c("UGANDA", "UGANDA", 
#               "MALAWI", "MALAWI", "MALAWI", "MALAWI"),
#   wp_category = c("DSW Footprint", "DSW Expansion",
#                 "DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"),
#   country_total = c(4843, 12875,
#                     3123, 12040, 1035, 2376)
# )

# column 6: chlorination rate
chl_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculate SE using variance decomposition
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations (for columns 3, 5, and CI for column 6)
table8 <- hh_count_tbl %>%
  left_join(hh_size_tbl, by = c("country", "wp_category")) %>%
  left_join(chl_tbl, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>%  
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, 
         se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn,
         ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table8 %>%
  ungroup() %>%  
  kable(format = "html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    font_size = 9
  ) %>%
  scroll_box(width = "100%")

# country totals and CIs
country_totals_table8 <- table8 %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    # for total access
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )

country_totals_table8
```

## table 9 [numbers are currently off in col 4 - EA list]
Number of water points in different datasets by type
```{r}
wp_table <- wp_census %>%
  group_by(country, wp_category) %>%
  summarise(
    wp_census = n_distinct(wp_id),
    wp_functional = n_distinct(wp_id[wp_func == TRUE]),
    .groups = "drop"
  ) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>%
  left_join(
    bind_rows(
      ea_promoters_uganda %>% count(wp_category, name = "ea_list") %>% mutate(country = "UGANDA"),
      ea_promoters_malawi %>% count(wp_category, name = "ea_list") %>% mutate(country = "MALAWI")
    ),
    by = c("country", "wp_category")
  ) %>%
  left_join(
    pm_survey %>%
      group_by(country, wp_category) %>%
      summarise(promoter_survey = n_distinct(wp_id), .groups = "drop"),
    by = c("country", "wp_category")
  ) %>%
 # table presentation settings
  mutate(
    country = factor(country, levels = c("MALAWI", "UGANDA")),
    wp_category = factor(wp_category, levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))
  ) %>%
  dplyr::filter(!is.na(wp_category)) %>%
  arrange(country, wp_category) %>%
  select(country, wp_category, country_total, everything())

wp_table
```

Commentary in table caption: 
For Uganda, 8 of the 119 water points in the EA promoter list were identified as Non-program and 1 as ILC, and are not shown. Similarly for Malawi, where 15 out of 207 were identified as Non-program.
```{r}
ea_promoters_uganda %>%
  count(wp_category, sort = TRUE)

ea_promoters_malawi %>%
  count(wp_category, sort = TRUE)
```

## table 10 
Table 8 but using HH census and HH survey; only using WPs in promoter survey
```{r}
# column 1: household count and SE
hh_count_tbl_wp_census <- hh_census %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%  # include this row to obtain estimates if we only considered households located in the village
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_count = mean(hh_count, na.rm = TRUE),
    wp_values = list(hh_count[!is.na(hh_count)]), # used in calculating SE below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)

# column 2: household size and SE 
hh_size_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]), # used in SE calculations below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculating SE
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations
table10 <- hh_count_tbl_wp_census %>%
  left_join(hh_size_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(chl_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>% # this is created in the "table 8" chunk
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  # rounding
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn, ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table10 %>%
  ungroup() %>%  
  kable(format = "html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    font_size = 9
  ) %>%
  scroll_box(width = "100%")

country_totals_table10 <- table10 %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )
country_totals_table10
```

## table 11
```{r}
# number of water points in the promoter survey
wp_count_pm <- pm_survey %>%
  group_by(country, wp_category) %>% 
  summarise(
    wp_count_pm = n_distinct(wp_id),               
    .groups = "drop"
  )

# number of households in the promoter survey
pm_hh_listed <- pm_survey %>%
  mutate(hh_listed = as.numeric(hh_listed)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_hh_listed = sum(hh_listed, na.rm = TRUE),               
    .groups = "drop"
  )

# number of households from the promoter survey that are also in the HH census - represented by the variable cal_hh_count for each WP
pm_hh_census <- pm_survey %>%
  mutate(cal_hh_count = as.numeric(cal_hh_count)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_hh_census = sum(cal_hh_count, na.rm = TRUE),               
    .groups = "drop"
  )

# number of households whose self-report in HH census matches the promoter's report
pm_hh_matched <- pm_survey_households_clean %>%
  left_join(pm_survey %>% select(wp_id, wp_category), 
            by = c("wp_id_c" = "wp_id")) %>%
  dplyr::filter(!is.na(wp_category)) %>%
  dplyr::filter(household_id %in% hh_census$household_id) %>%
  left_join(hh_census %>% select(household_id, wp_id), 
            by = "household_id", suffix = c("_pm", "_census")) %>%
  mutate(wp_match = wp_id_c == wp_id_census) %>% 
  group_by(country, wp_category) %>%
  summarise(
    pm_hh_matched = sum(wp_match, na.rm = TRUE),
    .groups = "drop") %>%
  mutate(country = toupper(country))

# number of households outside of the village
pm_hh_outside <- pm_survey %>%
  mutate(hh_outsiden = as.numeric(hh_outsiden)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_hh_outside = sum(hh_outsiden, na.rm = TRUE),               
    .groups = "drop"
  )

# total number of water points in the wp census
wp_count_wp_census <- wp_census %>%
  group_by(country, wp_category) %>% 
  summarise(
    wp_count_wp_census = n_distinct(wp_id),               
    .groups = "drop"
  )

# total number of households that report using the water points in the wp census, regardless of whether they are in the promoter survey or not
census_hh_listed <- hh_census %>%
  dplyr::filter(wp_id %in% wp_census$wp_id) %>%
  group_by(country, wp_category) %>%
  summarise(
    census_hh_listed = n_distinct(household_id),
    .groups = "drop"
  )

# average numbers of households per water point
pm_avg_hh_per_wp <- pm_survey %>%
  mutate(hh_listed = as.numeric(hh_listed)) %>%
  group_by(country, wp_category) %>% 
  summarise(
    pm_avg_hh_per_wp = round(mean(hh_listed, na.rm = TRUE), 2),               
    .groups = "drop"
  )

census_avg_hh_per_wp <- hh_census %>%
  dplyr::filter(wp_id %in% wp_census$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    census_hh_listed = n_distinct(household_id),   # households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    census_avg_hh_per_wp = round(mean(census_hh_listed, na.rm = TRUE), 2),  # avg across wps
    .groups = "drop"
  )

# table
hh_tbl <- wp_count_pm  %>%
  left_join(pm_hh_listed, by = c("country", "wp_category")) %>%
  left_join(pm_hh_outside, by = c("country", "wp_category")) %>%
  left_join(pm_hh_census, by = c("country", "wp_category")) %>%
  left_join(pm_hh_matched, by = c("country", "wp_category")) %>%
  left_join(pm_avg_hh_per_wp, by = c("country", "wp_category")) %>%
  left_join(wp_count_wp_census, by = c("country", "wp_category")) %>%
  left_join(census_hh_listed, by = c("country", "wp_category")) %>%
  left_join(census_avg_hh_per_wp, by = c("country", "wp_category")) %>%
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC")) %>%
  mutate(country = factor(country, levels = c("MALAWI", "UGANDA"))) %>%
  mutate(wp_category = factor(wp_category, levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

hh_tbl
```

## table 12 
Table 10 but for all water points
```{r}
# column 1: household count and SE
hh_count_tbl_wp_census <- hh_census %>%
  # dplyr::filter(inclusion == "Within village boundaries") %>%  # include this row to obtain estimates if we only considered households located in the village
  group_by(country, wp_category, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_count = mean(hh_count, na.rm = TRUE),
    wp_values = list(hh_count[!is.na(hh_count)]), # used in calculating SE below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)

# column 2: household size and SE 
hh_size_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]), # used in SE calculations below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculating SE
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations
table12 <- hh_count_tbl_wp_census %>%
  left_join(hh_size_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(chl_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>% # this is created in the "table 8" chunk
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  # rounding
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn, ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table12 %>%
  ungroup() %>%  # Remove rowwise grouping
  kable(format = "html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    font_size = 9
  ) %>%
  scroll_box(width = "100%")

country_totals_table12 <- table12 %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )
country_totals_table12
```

## table 13
Table 8 but excluding households outside the village from column 1. For households where the promoter provides the number of user households that are outside of the village, I subtract this number from the number of user households they list
```{r}
# column 1: household count and SE
hh_count_tbl <- pm_survey  %>%
  mutate(
    hh_listed = as.numeric(hh_listed),
    hh_outsiden = as.numeric(hh_outsiden),
    # Calculate inside households - subtract outside if available, otherwise use listed
    hh_inside = case_when(
      !is.na(hh_outsiden) ~ hh_listed - hh_outsiden,
      TRUE ~ hh_listed
    )) %>%
  group_by(country, wp_category) %>% 
  summarise(
    avg_hh_count = mean(hh_inside, na.rm = TRUE),  # Using inside households
    wp_values = list(hh_listed[!is.na(hh_listed)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)
  
# column 2: hh size and SE
hh_size_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculate SE using variance decomposition
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations (for columns 3, 5, and CI for column 6)
table13 <- hh_count_tbl %>%
  left_join(hh_size_tbl, by = c("country", "wp_category")) %>%
  left_join(chl_tbl, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>%  
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, 
         se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn,
         ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table13 %>%
  ungroup() %>%  # Remove rowwise grouping
  kable(format = "html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    font_size = 9
  ) %>%
  scroll_box(width = "100%")

# country totals and CIs
country_totals_table13 <- table13 %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    # for total access
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )

country_totals_table13
```

## table 14 
Table 8 but excluding households outside village and double-counted households
```{r}
# identify households that appear multiple times AND only use one water point
double_counted_households <- pm_survey_households_clean %>%
  count(household_id, name = "times_appeared") %>%
  dplyr::filter(times_appeared > 1) %>% # only keep HHs that appear more than once
  # join with hh census
  left_join(hh_census %>% select(household_id, wp_secweek), by = "household_id") %>%
  # only consider as double-counted if they say NO to wp_secweek (use only 1 water point)
  dplyr::filter(wp_secweek == FALSE) %>%
  pull(household_id)

# for double-counted households, determine their "correct" water point assignment
primary_assignments <- pm_survey_households_clean %>%
  dplyr::filter(household_id %in% double_counted_households) %>%
  # get the water point they're actually associated with in hh_census
  left_join(
    hh_census %>% select(household_id, wp_id) %>% rename(hh_census_wp_id = wp_id), 
    by = "household_id"
  ) %>%
  # check if their hh_census wp_id matches any of their pm_survey wp_id_c values
  group_by(household_id) %>%
  mutate(
    hh_census_wp_matches = any(hh_census_wp_id == wp_id_c, na.rm = TRUE),
    # if hh_census wp_id matches one of the pm_survey wp_id_c, use that matching one
    correct_wp_id_c = case_when(
      hh_census_wp_matches & !is.na(hh_census_wp_id) ~ wp_id_c[wp_id_c == hh_census_wp_id][1],
      TRUE ~ min(wp_id_c, na.rm = TRUE)  # otherwise, use first wp_id_c for simplicity (current logic)
    )
  ) %>%
  # keep only the correct assignment for each household
  dplyr::filter(wp_id_c == correct_wp_id_c) %>%
  select(household_id, wp_id_c) %>%
  distinct() %>%
  mutate(is_primary_assignment = TRUE) # indicator for HH being in primary assignment dataset

# create adjustment factors for each water point
wp_adjustments <- pm_survey_households_clean %>%
  left_join(primary_assignments, by = c("household_id", "wp_id_c")) %>%
  mutate(
    # if hh is in is_primary_assignment (so there is 1 water point we want to assign it)
    should_subtract = household_id %in% double_counted_households & is.na(is_primary_assignment)
  ) %>%
  group_by(wp_id_c) %>%
  summarise(
    households_to_subtract = sum(should_subtract, na.rm = TRUE),
    .groups = "drop"
  )

# column 1: household count and SE
hh_count_tbl <- pm_survey  %>%
  mutate(
    hh_listed = as.numeric(hh_listed),
    hh_outsiden = as.numeric(hh_outsiden),
    hh_inside = case_when(
      !is.na(hh_outsiden) ~ hh_listed - hh_outsiden,
      TRUE ~ hh_listed
    )) %>%
  left_join(wp_adjustments, by = c("wp_id" = "wp_id_c")) %>%
  mutate(
    households_to_subtract = coalesce(households_to_subtract, 0),
    # adjust for double-counted households
    hh_inside_adjusted = hh_inside - households_to_subtract
  ) %>%
  group_by(country, wp_category) %>% 
  summarise(
    avg_hh_count = mean(hh_inside_adjusted, na.rm = TRUE),  # Using inside households
    wp_values = list(hh_listed[!is.na(hh_listed)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)
  
# column 2: hh size and SE
hh_size_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl <- hh_survey %>%
  dplyr::filter(survey == "Monitoring Survey") %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculate SE using variance decomposition
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations (for columns 3, 5, and CI for column 6)
table14 <- hh_count_tbl %>%
  left_join(hh_size_tbl, by = c("country", "wp_category")) %>%
  left_join(chl_tbl, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>%  
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, 
         se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn,
         ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table14 %>%
  ungroup() %>%  # Remove rowwise grouping
  kable(format = "html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    font_size = 9
  ) %>%
  scroll_box(width = "100%")

# country totals and CIs
country_totals_table14 <- table14 %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    # for total access
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )

country_totals_table14
```

## table 15 
Balance tables: Uganda DSW Footprint.
significant difference in jc_chlorine
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "UGANDA", wp_category == "DSW Footprint") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", 
             "disctcr_02", "meterfcr_02", "meterfcr_01", 
             "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 16 
Balance tables: Uganda DSW Footprint but between EA list and not EA list water points
```{r}
wp_census %>%
  # dplyr::filter(wp_category != "Non-program") %>%
  mutate(
    in_promoter_list = if_else(
      ea_id %in% ea_promoters_uganda$i102_wpt_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "UGANDA", wp_category == "DSW Footprint") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "in_promoter_list",
    group.test = TRUE,
    out = "return") 
```

## table 17 
Balance tables: Uganda DSW Expansion.
difference in jc_chlorine not significant. difference in disp_tank_present is significant, but since it does not translate to significant difference in chlorine presence, I don't think this is important
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "UGANDA", wp_category == "DSW Expansion") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 18 
Balance tables: Malawi DSW Footprint.
significant difference in meterfcr_02, but because there are just 3 water points in wp_census that the test was conducted for, I don't think this is very important
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "MALAWI", wp_category == "DSW Footprint") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 19 
Balance tables: Malawi DSW Expansion.
no significant differences
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "MALAWI", wp_category == "DSW Expansion") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 20 
Balance tables: Malawi DSW in ILC vill.
no significant differences
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                       
      "NO"                          
    )
  ) %>%
  dplyr::filter(country == "MALAWI", wp_category == "DSW in ILC village") %>%
  sumtable(
    vars = c("wp_func", "disp_tank_present", "jc_chlorine", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 21 
Balance tables: Malawi ILC.
no significant differences
```{r}
wp_census %>%
  mutate(
    promoter_survey = if_else(
      wp_id %in% pm_survey$wp_id,  
      "YES",                        
      "NO"                         
    )
  ) %>%
  dplyr::filter(country == "MALAWI", wp_category == "ILC") %>%
  sumtable(
    vars = c("wp_func", "discfcr_02", "meterfcr_02", "meterfcr_01", "disctcr_02", "metertcr_02", "metertcr_01"),
    group = "promoter_survey",
    group.test = TRUE,
    out = "return") 
```

## table 22
Chlorination at the household regressed on whether the household self-reports using a water point that is in the promoter survey and/or Evidence Action list.

We find that in both Uganda and Malawi, households using water points in the promoter survey are significantly more likely to have chlorine identified at the household, though the magnitude of the coefficient is larger in Uganda. The association is also positive if we regress chlorination on the presence of the self-reported primary water point in the Evidence Action list instead. Indeed, as shown in column (3), for Uganda, if we control for this, then the association between presence in the promoter survey and chlorination becomes insignificant, although this is not the case for Malawi.
```{r}
# install.packages("stargazer")
# library(stargazer)

# promoter_survey tells us if primary water point is in promoter survey, ea_list tells us if primary water point is in ea list
hh_survey <- hh_survey %>%
  mutate(promoter_survey = ifelse(wp_id %in% pm_survey$wp_id, 1, 0)) %>%
  mutate(ea_list = ifelse(
  ea_id %in% ea_promoters_uganda$i102_wpt_id | ea_id %in% ea_promoters_malawi$i102_wpt_id,
  1, 0
  ))

uganda_hh_survey <- hh_survey %>%
  dplyr::filter(country == "UGANDA")
malawi_hh_survey <- hh_survey %>%
  dplyr::filter(country == "MALAWI")

# run models
# column 1: promoter survey, Uganda
model1 <- lm(disctcr ~ promoter_survey, data = uganda_hh_survey)
# column 2: EA list, Uganda
model2 <- lm(disctcr ~ ea_list, data = uganda_hh_survey)
# column 3: both, Uganda
model3 <- lm(disctcr ~ ea_list + promoter_survey, data = uganda_hh_survey)
# column 4: promoter survey, Malawi
model4 <- lm(disctcr ~ promoter_survey, data = malawi_hh_survey)
# column 5: EA list, malawi
model5 <- lm(disctcr ~ ea_list, data = malawi_hh_survey)
# column 6: both, Malawi
model6 <- lm(disctcr ~ ea_list + promoter_survey, data = malawi_hh_survey)

# generate table
stargazer(model1, model2, model3, model4, model5, model6,
          type = "text",
          title = "Association between Promoter Survey, EA List and Chlorination",
          dep.var.labels = "DISCTCR (Colorwheel)",
          covariate.labels = c("Promoter Survey", "EA list"),
          column.labels = c("Uganda", "", "", "Malawi", "", ""),
          model.numbers = FALSE,
          keep.stat = c("n", "rsq", "adj.rsq"))
```

## section 6.4.1: adjusting numbers for waterfall charts
share of households outside village among EA water points
```{r}
share_outside_tbl <- hh_census %>%
  dplyr::filter(intervention_type != "NON-PROGRAM") %>%
  mutate(
    outside_village = case_when(
      inclusion == "Within village boundaries" ~ 0,
      inclusion == "Up to 200m outside of village boundaries" ~ 1,
      TRUE ~ NA_real_
    )
  ) %>%
  group_by(country, sample_group, wp_id) %>%
  summarize(
    share_outside_wp = mean(outside_village, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(country, sample_group) %>%
  summarize(
    share_outside = mean(share_outside_wp, na.rm = TRUE),
    n_wp = n(),
    .groups  = "drop"
  )

share_outside_tbl
```

## tables excl outside HHs for waterfall charts
table 1 estimates excluding outside households
```{r}
# table 1 numbers for each village type (sample_group)
table1 <- tibble::tribble(
  ~country, ~sample_group, ~indiv_access_popn,
  "MALAWI", "EXPANSION", 1775112,
  "MALAWI", "FOOTPRINT", 247293,
  "MALAWI", "ILC", 189076,
  "UGANDA", "EXPANSION", 2495942,
  "UGANDA", "FOOTPRINT", 879105,
)

table1_ex_outside <- table1 %>%
  left_join(share_outside_tbl, by = c("country", "sample_group")) %>%
  mutate(
    indiv_access_popn = indiv_access_popn * (1 - coalesce(share_outside, 0))
  ) %>%
  select(country, sample_group, indiv_access_popn)

table1_ex_outside
```

table 12 estimates excluding outside households
```{r}
# column 1: household count and SE
hh_count_tbl_wp_census <- hh_census %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%  # include this row to obtain estimates if we only considered households located in the village
  group_by(country, wp_category, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_count = mean(hh_count, na.rm = TRUE),
    wp_values = list(hh_count[!is.na(hh_count)]), # used in calculating SE below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)

# column 2: household size and SE 
hh_size_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]), # used in SE calculations below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculating SE
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations (same as in 5.1)
table12_ex_outside <- hh_count_tbl_wp_census %>%
  left_join(hh_size_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(chl_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>% # this is created in the "table 8" chunk
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  # rounding
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn, ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table12_ex_outside

country_totals_table12_ex_out <- table12_ex_outside %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )

country_totals_table12_ex_out
```

table 10 estimates excluding outside households
```{r}
# column 1: household count and SE
hh_count_tbl_wp_census <- hh_census %>%
  dplyr::filter(inclusion == "Within village boundaries") %>%  # include this row to obtain estimates if we only considered households located in the village
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    hh_count = n_distinct(household_id),   # number of households per wp
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_count = mean(hh_count, na.rm = TRUE),
    wp_values = list(hh_count[!is.na(hh_count)]), # used in calculating SE below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_values),
    between_var = if(K > 1) sum((wp_values - avg_hh_count)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_count = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_count, se_hh_count)

# column 2: household size and SE 
hh_size_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>% 
  summarise(
    hh_size = mean(hh_members, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    avg_hh_size = mean(hh_size, na.rm = TRUE),
    wp_hh_sizes = list(hh_size[!is.na(hh_size)]), # used in SE calculations below
    .groups = "drop"
  ) %>%
  rowwise() %>%
  # calculating SE
  mutate(
    K = length(wp_hh_sizes),
    between_var = if(K > 1) sum((wp_hh_sizes - avg_hh_size)^2) / (K * (K - 1)) else 0,
    within_var = 0,
    total_var = between_var + within_var,
    se_hh_size = sqrt(total_var)
  ) %>%
  select(country, wp_category, avg_hh_size, se_hh_size)

# column 6: chlorination rate
chl_tbl_wp_census <- hh_survey %>%
  dplyr::filter(survey == "Household Survey") %>%
  dplyr::filter(wp_id %in% pm_survey$wp_id) %>%
  group_by(country, wp_category, wp_id) %>%
  summarise(
    wp_chl_rate = mean(disctcr > 0.2, na.rm = TRUE),
    wp_se_chl_rate = sqrt(wp_chl_rate * (1 - wp_chl_rate) / n()), # SE for proportion within WP
    .groups = "drop"
  ) %>%
  group_by(country, wp_category) %>%
  summarise(
    chl_rate = mean(wp_chl_rate, na.rm = TRUE),
    # store individual water point rates and SEs
    wp_rates = list(wp_chl_rate[!is.na(wp_chl_rate)]),
    wp_ses = list(wp_se_chl_rate[!is.na(wp_se_chl_rate)]),
    .groups = "drop"
  ) %>%
  # calculating SE
  rowwise() %>%
  mutate(
    K = length(wp_rates),
    between_var = if(K > 1) sum((wp_rates - chl_rate)^2) / (K * (K - 1)) else 0,
    within_var = if(K > 0) sum(wp_ses^2) / (K^2) else 0,
    total_var = between_var + within_var,
    se_chl_rate = sqrt(total_var)
  ) %>%
  select(country, wp_category, chl_rate, se_chl_rate)

# merge + calculations (same as in 5.1)
table10_ex_outside <- hh_count_tbl_wp_census %>%
  left_join(hh_size_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(chl_tbl_wp_census, by = c("country", "wp_category")) %>%
  left_join(country_totals, by = c("country", "wp_category")) %>% # this is created in the "table 8" chunk
  mutate(
    # column 3
    indiv_access_sample = avg_hh_count * avg_hh_size,
    # column 5
    indiv_access_popn = indiv_access_sample * country_total,
    # column 3 SE (delta method assuming covariance = 0)
    se_indiv_access_sample = sqrt(
      (avg_hh_size^2) * (se_hh_count^2) + 
      (avg_hh_count^2) * (se_hh_size^2)
    ),
    # column 5 SE (variable multiplied by a constant)
    se_indiv_access_popn = country_total * se_indiv_access_sample,
    # column 5 95% confidence interval
    ci_lower_indiv_access_popn = indiv_access_popn - 1.96 * se_indiv_access_popn,
    ci_upper_indiv_access_popn = indiv_access_popn + 1.96 * se_indiv_access_popn,
     # column 6 95% confidence interval
    ci_lower_chl_rate = chl_rate - 1.96 * se_chl_rate,
    ci_upper_chl_rate = chl_rate + 1.96 * se_chl_rate
  ) %>%
  # rounding
  mutate(
    across(c(avg_hh_count, avg_hh_size, indiv_access_sample, indiv_access_popn, se_hh_count, se_hh_size, 
         se_indiv_access_sample, se_indiv_access_popn, ci_lower_indiv_access_popn, ci_upper_indiv_access_popn),
       ~ round(.x, 2))
  ) %>%
  select(
  country, wp_category, avg_hh_count, se_hh_count, avg_hh_size, se_hh_size, indiv_access_sample, se_indiv_access_sample,
  country_total, indiv_access_popn,  se_indiv_access_popn, # se_indiv_access_popn is not used directly in table 8, but is needed for CI calculation below
  ci_lower_indiv_access_popn, ci_upper_indiv_access_popn, chl_rate, ci_lower_chl_rate, ci_upper_chl_rate
  ) %>%
  # presentation settings
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC"))  %>%
  mutate(country = factor(country, 
                           levels = c("UGANDA", "MALAWI"))) %>%
  mutate(wp_category = factor(wp_category, 
                           levels = c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC"))) %>%
  arrange(country, wp_category)

table10_ex_outside

country_totals_table10_ex_out <- table10_ex_outside %>%
  group_by(country) %>%
  summarise(
    total_indiv_access_popn = sum(indiv_access_popn, na.rm = TRUE),
    # SE: square root of sum of squared SEs (assuming independence)
    se_total_indiv_access_popn = sqrt(sum(se_indiv_access_popn^2, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  # confidence interval
  mutate(
    ci_lower_total_access = total_indiv_access_popn - 1.96 * se_total_indiv_access_popn,
    ci_upper_total_access = total_indiv_access_popn + 1.96 * se_total_indiv_access_popn,
  ) %>%
  select(
    country,
    total_indiv_access_popn, 
    ci_lower_total_access, ci_upper_total_access
  )

country_totals_table10_ex_out
```

# waterfall charts
```{r}
#combine all relevant country totals into 1 table
country_sums <- table1 %>%
  group_by(country) %>%
  summarise(table1 = sum(indiv_access_popn, na.rm = TRUE)) %>%
  left_join(
    table1_ex_outside %>% group_by(country) %>% summarise(table1_ex_outside = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table12_ex_outside %>% group_by(country) %>% summarise(table12 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table10_ex_outside %>% group_by(country) %>% summarise(table10 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table14 %>% group_by(country) %>% summarise(table14 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table13 %>% group_by(country) %>% summarise(table13 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  ) %>%
  left_join(
    table8 %>% group_by(country) %>% summarise(table8 = sum(indiv_access_popn, na.rm = TRUE)),
    by = "country"
  )

# calculate differences for waterfall chart
create_waterfall <- function(country_name, country_data) {
  
  df <- data.frame(
    category = c("Table 1", 
                 "Exclude \ncensus\nout-of-village\nhouseholds", 
                 "Unit of\nobservation",
                 "Sample \nselection\nof water points",
                 "Dataset",
                 "Double-counting",
                 "Add \npromoter\nsurvey\nout-of-village\nhouseholds",
                 "Table 8"),
    amount = c(
      country_data$table1,
      country_data$table1_ex_outside - country_data$table1,
      country_data$table12 - country_data$table1_ex_outside,
      country_data$table10 - country_data$table12,
      country_data$table14 - country_data$table10,
      country_data$table13 - country_data$table14,
      country_data$table8 - country_data$table13,
      country_data$table8
    )
  )
  
  # Round to nearest 50,000
  df <- df %>%
    mutate(amount_rounded = round(amount / 50000) * 50000)
  
  # Make category a factor to preserve order
  df$category <- factor(df$category, levels = df$category)
  
  # Calculate positions using rounded values
  df <- df %>%
    mutate(
      id = row_number(),
      type = case_when(
        id == 1 | id == n() ~ "total",
        id == 5 ~ "dataset",                     
        amount_rounded < 0 ~ "decrease",
        TRUE ~ "increase"
      ),
      end = cumsum(amount_rounded),
      start = lag(end, default = 0)
    ) %>%
    mutate(
      start = ifelse(type == "total", 0, start),
      end = ifelse(type == "total", amount_rounded, end)
    )
  
# create waterfall charts
  ggplot(df, aes(x = category, fill = type)) +
    geom_rect(aes(xmin = id - 0.45, xmax = id + 0.45, 
                  ymin = start, ymax = end)) +
    geom_text(aes(x = id, y = end, label = scales::comma(abs(amount_rounded))), 
              vjust = -0.5, size = 4, fontface = "bold") +
    scale_fill_manual(values = c("decrease" = "#d73027", 
                                  "increase" = "#4575b4",
                                  "dataset" = "#FDB462",    # yellow for unexplained part
                                  "total" = "#4575b4")) +   
    labs(title = paste("Breaking down the difference between census and monitoring\nestimates for", country_name),
         y = "people with access (thousand)",
         x = NULL) +
    theme_minimal() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10),
      plot.title = element_text(size = 14, face = "bold"),
      panel.grid.major.x = element_blank()
    ) +
    scale_y_continuous(limits = c(0, max(df$end) * 1.1), 
                       labels = scales::comma)
}

# Create plots for each country
uganda_data <- country_sums %>% filter(country == "UGANDA")
malawi_data <- country_sums %>% filter(country == "MALAWI")

create_waterfall("Uganda", uganda_data)
create_waterfall("Malawi", malawi_data)
```

## section 6.2: sample: EA list versus promoter survey (Uganda) [numbers are currently off]
In Uganda, Evidence Action provided information for 133 promoters in the sampled villages, representing 129 unique water points. Out of these, 119 are in the water point census, and 110 are included in the promoter survey. There are 10 promoter surveys for water points for which Evidence Action did not provide contact information, for a total of 120 promoter surveys in Uganda.
```{r}
ea_promoters_uganda <-
  ea_promoters_uganda %>%
  dplyr::filter(villageid %in% sampled_villages$village_id)

nrow(ea_promoters_uganda)

ea_promoters_uganda %>%
  pull(i102_wpt_id) %>%
  n_distinct()

ea_promoters_uganda %>%
  dplyr::filter(i102_wpt_id %in% wp_census$ea_id) %>%
  distinct(i102_wpt_id) %>%
  nrow

ea_promoters_uganda %>%
  dplyr::filter(i102_wpt_id %in% pm_survey$ea_id) %>%
  distinct() %>%
  nrow
```

```{r}
# ea list
ea_promoters_uganda <- ea_promoters_uganda %>%
  dplyr::filter(!is.na(main_contact) | !is.na(assistant_contact)) %>%
  mutate(villageid = as.character(villageid)) %>%
  dplyr::filter(villageid %in% wp_census$village_id) %>%
  unique %>%
  dplyr::filter(i102_wpt_id %in% wp_census$ea_id)

# promoter survey
pm_survey_uganda <- pm_survey %>%
    dplyr::filter(country == "UGANDA")

# checking how many wp in pm survey are in ea list
pm_survey_NOT_in_ea_list_uganda <- pm_survey %>%
  dplyr::filter(country == "UGANDA") %>%
  dplyr::filter(!ea_id %in% ea_promoters_uganda$i102_wpt_id)

pm_survey_in_ea_list_uganda <- pm_survey %>%
  dplyr::filter(country == "UGANDA") %>%
  dplyr::filter(ea_id %in% ea_promoters_uganda$i102_wpt_id)

count(pm_survey_NOT_in_ea_list_uganda)
count(pm_survey_in_ea_list_uganda)
```

## section 6.2: sample: EA list versus promoter survey (Malawi) [numbers are currently off]
In Malawi, Evidence Action provided information for 287 promoters in the sampled villages, representing 264 unique water points. Out of these, 207 are in the water point census (though 20 were identified as Non-program), and 142 are included in the promoter survey. There are 57 promoter surveys for water points for which Evidence Action did not provide contact information (primarily ILC water collection points), for a total of 199 promoter surveys in Malawi. 
```{r}
ea_promoters_malawi <- ea_promoters_malawi %>%
  select(-wcp102_wpt_id) %>%
  dplyr::filter(villageid %in% sampled_villages$village_id) %>%
  unique

nrow(ea_promoters_malawi)

ea_promoters_malawi %>%
  pull(i102_wpt_id) %>%
  n_distinct()

ea_promoters_malawi %>%
  dplyr::filter(i102_wpt_id %in% wp_census$ea_id) %>%
  distinct() %>%
  nrow

ea_promoters_malawi %>%
  dplyr::filter(i102_wpt_id %in% pm_survey$ea_id) %>%
  distinct(i102_wpt_id, .keep_all = TRUE) %>% # there are duplicate water points in the list
  nrow
```

```{r}
# ea list
ea_promoters_malawi <- ea_promoters_malawi %>%
  dplyr::filter(!is.na(main_contact) | !is.na(assistant_contact)) %>%
  mutate(villageid = as.character(villageid)) %>%
  dplyr::filter(villageid %in% wp_census$village_id) %>%
  unique %>%
  dplyr::filter(i102_wpt_id %in% wp_census$ea_id)

# promoter survey
pm_survey_malawi <- pm_survey %>%
    dplyr::filter(country == "MALAWI")

# checking how many wp in pm survey are in ea list
pm_survey_NOT_in_ea_list_malawi <- pm_survey %>%
  dplyr::filter(country == "MALAWI") %>%
  dplyr::filter(!ea_id %in% ea_promoters_malawi$i102_wpt_id)

pm_survey_in_ea_list_malawi <- pm_survey %>%
  dplyr::filter(country == "MALAWI") %>%
  dplyr::filter(ea_id %in% ea_promoters_malawi$i102_wpt_id)

count(pm_survey_NOT_in_ea_list_malawi)
count(pm_survey_in_ea_list_malawi)
```

## section 6.3: share of households in hh census identified by promoters
Promoters in Footprint villages are better at identifying households using the water points they are responsible for, being able to identify around 90% of the self-reported users of these water points, in both countries. In Expansion villages, these numbers are lower, at around 84% for Malawi and 74% for Uganda.
```{r}
hh_census %>%
  inner_join(pm_survey_households_clean, by = c("household_id")) %>%
  mutate(pm_matched = wp_id.x == wp_id_c) %>%
  group_by(
    `country.x`, wp_category
  ) %>%
  summarise(
    mean(pm_matched, na.rm = TRUE)
  )
```

## section 6.4.4: water points with some households outside of village (30%)
```{r}
# Calculate share of water points with outside households
hh_outside_share <- pm_survey %>%
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC")) %>%
  group_by(country, wp_category) %>%
  summarise(
    n_water_points = n(),
    wp_with_outside_hh = sum(hh_outside == TRUE, na.rm = TRUE),
    share_wp_with_outside = round(wp_with_outside_hh / n_water_points * 100, 1),
    .groups = "drop"
  )

print(hh_outside_share)

# Overall share across all water points
overall_share <- pm_survey %>%
  dplyr::filter(wp_category %in% c("DSW Footprint", "DSW Expansion", "DSW in ILC village", "ILC")) %>%
  dplyr::filter(!(country == "UGANDA" & wp_category == "ILC")) %>%
  summarise(
    total_water_points = n(),
    total_wp_with_outside = sum(hh_outside == TRUE, na.rm = TRUE),
    overall_share_wp_with_outside = round(total_wp_with_outside / total_water_points * 100, 1)
  )

print(overall_share)
```

# section 6.4.5 double-counting: how many hh ids come up more than once? [numbers are currently off - updated in description below, but not in report]
627 HHs are listed more than once, 341 are double-counted
```{r}
appearing_twice_households <- pm_survey_households_clean %>%
  count(household_id, name = "times_appeared") %>%
  dplyr::filter(times_appeared > 1) %>%
  summarize(
    appearing_twice_households = n_distinct(household_id)
  )

appearing_twice_households

double_counted_households <- pm_survey_households_clean %>%
  count(household_id, name = "times_appeared") %>%
  dplyr::filter(times_appeared > 1) %>%
  left_join(hh_census %>% select(household_id, wp_secweek), by = "household_id") %>%
  dplyr::filter(wp_secweek == FALSE) %>%# limit to HHs that say they only use 1 water point
  summarize(
    double_counted_households = n_distinct(household_id)
  ) 

double_counted_households
```

## section 6.4.6 regression of chlorination on being listed by promoter
I regress chlorination on household presence in the promoter lists, limiting the sample to households using water points in the promoter survey. We find a significant positive association between these for both Uganda and Malawi.
```{r}
hh_survey <- hh_survey %>%
  mutate(
    listed_by_promoter = ifelse(household_id %in% pm_survey_households$household_id, 1, 0)
  )

promoter_wp_households <- hh_survey %>%
  dplyr::filter(promoter_survey == 1)

uganda_promoter_wp <- promoter_wp_households %>%
  dplyr::filter(country == "UGANDA")

malawi_promoter_wp <- promoter_wp_households %>%
  dplyr::filter(country == "MALAWI")

uganda_model <- lm(disctcr ~ listed_by_promoter, data = uganda_promoter_wp)
malawi_model <- lm(disctcr ~ listed_by_promoter, data = malawi_promoter_wp)

stargazer(uganda_model, malawi_model,
          type = "text",
          title = "Association between Being Listed by Promoter and Chlorination",
          dep.var.labels = "DISCTCR",
          covariate.labels = c("Listed by Promoter"),
          column.labels = c("Uganda", "Malawi"),
          model.numbers = FALSE,
          keep.stat = c("n", "rsq", "adj.rsq"))
```

## exploratory - not directly referenced in report:
number of villages in pm_survey and wp_census: all villages are in the pm_survey
```{r}
# total number of villages in the promoter survey
vil_count_pm <- pm_survey %>%
  group_by(country) %>% 
  summarise(
    n_vil_pm_survey = n_distinct(village_id),               
    .groups = "drop"
  )

print(vil_count_pm)

# total number of villages in the wp census
vil_count_wp <- wp_census %>%
  group_by(country) %>% 
  summarise(
    n_vil_wp_census = n_distinct(village_id),               
    .groups = "drop"
  )

print(vil_count_wp)
```

association between hh_listed by promoter and hh_count in hh census - it is positive and significant for all country-wp_category combos
```{r}
hh_counts_summary <- hh_census %>%
  group_by(wp_id) %>%
  summarise(
    hh_counts_hhcensus = n_distinct(household_id),
    .groups = "drop"
  )

comparison <- pm_survey %>%
  dplyr::filter(country == "MALAWI" & wp_category == "ILC") %>% # change around country and wp_category to analyze different subsamples
  select(wp_id, hh_listed, cal_hh_count) %>%
  mutate(
    hh_listed = as.numeric(hh_listed),
    cal_hh_count = as.numeric(cal_hh_count)
  ) %>%
  left_join(hh_counts_summary, by = "wp_id") %>%
  arrange(wp_id)

regression_model <- lm(hh_counts_hhcensus ~ hh_listed, data = comparison)

stargazer(regression_model,
          type = "text",
          title = "Uganda Footprint: Association between Promoter-Listed HH and Census HH Count",
          dep.var.labels = "HH Count (Census)",
          covariate.labels = c("HH Listed (Promoter)"),
          keep.stat = c("n", "rsq", "adj.rsq", "f"))
```

overlap between promoter list and household census
```{r}
unique_pm_survey <- unique(pm_survey_households_clean$household_id)
unique_hh_census <- unique(hh_census$household_id)

overlap_count <- length(intersect(unique_pm_survey, unique_hh_census))

cat("Unique household_ids in pm_survey_households_clean:", length(unique_pm_survey), "\n")
cat("Unique household_ids in hh_census:", length(unique_hh_census), "\n")
cat("Household_ids present in both datasets:", overlap_count, "\n")
cat("Percentage of PM survey households also in census:", 
    round(overlap_count / length(unique_pm_survey) * 100, 1), "%\n")
```

number of water points used per household - households in HH census
```{r}
# number of water points used per household - households in HH census
wp_distribution_census <- 
  hh_census %>%
  mutate(total_wp_used = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(total_wp_used) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

# sample 
total_households_census <- length(unique(trimws(as.character(hh_census$household_id))))

# plot
ggplot(wp_distribution_census, aes(x = as.factor(total_wp_used), y = n, fill = as.factor(total_wp_used))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used in Past Month per Household",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = paste0("Note: N= ",total_households_census," households included to date in the Household Census raw data.")) +
  # theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

number of water points used per household - households in promoter lists
```{r}
# number of water points used per household - households in promoter lists
hh_census_filtered <- hh_census %>%
  dplyr::filter(household_id %in% pm_survey_households_clean$household_id)

wp_distribution_census <- 
  hh_census_filtered %>%
  mutate(total_wp_used = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(total_wp_used) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

# sample 
total_households_census <- length(unique(trimws(as.character(hh_census_filtered$household_id))))

# plot
ggplot(wp_distribution_census, aes(x = as.factor(total_wp_used), y = n, fill = as.factor(total_wp_used))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used in Past Month per Household",
    subtitle = "Limited to households in PM survey data",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = paste0("Note: N= ",total_households_census," households included (filtered by PM survey participation).")) +
  # theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```
