# Household census

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  )
```

## Number of observations

```{r}
hh_census %>%
  group_by(country) %>%
  summarise(
    N = n(), 
    `DSW (%)` = (mean(wp_dsw, na.rm = TRUE) * 100) %>% round(1),
    `ILC (%)` = (mean(wp_ilc_device, na.rm = TRUE) * 100) %>% round(1)
  )
```

## Water treatment method

LW: make this % and add note

```{r}
wtmt_long <-hh_census %>%
  pivot_longer(
    cols = c(wtmt_method_0, wtmt_method_1, wtmt_method_2, wtmt_method_3,
             wtmt_method_4, wtmt_method_5, wtmt_method_6, wtmt_method_7, wtmt_method_8,
             wtmt_method__111, wtmt_method__666, wtmt_method__999),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- dplyr::filter(wtmt_long, used == 1) %>%
  dplyr::count(method, sort = TRUE) %>%
  
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (water is already treated)",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  )

n_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(wtmt_cols)))) > 0) %>%
  nrow()

wtmt_used %>%
  ggplot(aes(x = reorder(method_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
      caption = paste0("Note: ", 
  nrow(dplyr::filter(hh_census, rowSums(!is.na(dplyr::select(hh_census, dplyr::all_of(wtmt_cols)))) > 0)),
  " households that report not using a DSW or ILC water source.\n",
  "Each household may report more than one treatment method.")
    ) +
  theme
```

## Share of households using DSW or ILC

```{r}
wp_other_table <- 
  hh_census %>%
  mutate(
    hh_dsw = (wp_dsw == 1 | wp_dsw_pl == 1),
    hh_ilc = (wp_ilc == 1 | wp_ilc_pl == 1),
    hh_wp_ea = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC",
      TRUE ~ "Non-program"
    )
  ) %>%
  group_by(country, hh_wp_ea) %>%
  summarise(
    N = n()
  ) %>%
  group_by(country) %>%
  mutate(Percentage = (N/sum(N) * 100) %>% round(1) %>% paste("%"))

wp_other_table %>%
  kable(
    caption = "Household Exposure to Water Point Programs by Country",
    col.names = c("Country", "Program Type", "N", "Percentage")
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Share of households not using DSW or ILC who report using DSW or ILC (LW)

```{r}
wtmt_summary <- hh_census %>%
  summarise(
    dsw_yes = sum(wtmt_dsw == 1, na.rm = TRUE),
    dsw_total = sum(!is.na(wtmt_dsw)),
    ilc_yes = sum(wtmt_ilc == 1, na.rm = TRUE),
    ilc_total = sum(!is.na(wtmt_ilc))
  ) %>%
  pivot_longer(cols = everything(), names_to = c("type", "response"), names_sep = "_") %>%
  pivot_wider(names_from = response, values_from = value) %>%
  mutate(share = yes / total * 100) %>%
  mutate(type = recode(type, dsw = "DSW", ilc = "ILC"))

ggplot(wtmt_summary, aes(x = type, y = share, fill = type)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of HHs not using DSW/ILC who report a DSW/ILC waterpoint in their village",
    x = "",
    y = "Share Responding 'Yes' (%)",
    caption = paste0(
      "Note: ", 
      nrow(dplyr::filter(hh_census, !is.na(wtmt_dsw) | !is.na(wtmt_ilc))),
      " households that report not using a DSW or ILC water source."
    )
  ) +
  theme_minimal()
```

## Household composition

```{r}
hh_census %>%
  group_by(country) %>%
  summarise(
    across(
      c(hh_under5, hh_under2),
      ~ mean((.) > 1, na.rm = TRUE)
    )
  )
```