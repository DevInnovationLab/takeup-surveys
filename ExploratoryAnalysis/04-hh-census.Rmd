# Household census
```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue",
    "patchwork",
    "tidyr"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  )
```

## Number of observations and number/share of households using DSW and ILC water points

```{r}
hh_census %>%
  mutate(
    hh_dsw = wp_dsw == 1 | wp_dsw_pl == 1,
    hh_ilc = wp_ilc_device == 1 | wp_ilc_pl == 1
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    `DSW (n)` = sum(hh_dsw, na.rm = TRUE),
    `DSW (%)` = round(sum(hh_dsw, na.rm = TRUE) / n() * 100, 1),
    `ILC (n)` = sum(hh_ilc, na.rm = TRUE),
    `ILC (%)` = round(sum(hh_ilc, na.rm = TRUE) / n() * 100, 1)
  ) %>%
  kable(
    digits = 1,
    caption = "Observations and DSW/ILC Usage by Country",
    format = "html"
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Number of water points per household
(Same graph in hh_survey)
```{r}
wp_distribution_census <- 
  hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

total_households_census <- hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  summarise(total = sum(n)) %>%
  pull(total)

ggplot(wp_distribution_census, aes(x = as.factor(wp_secweekno), y = n, fill = as.factor(wp_secweekno))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used in Past Month per Household",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = glue("Note: N={total_households_census} households included to date in the Household Census raw data.")
  ) +
  theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

## Reasons for using other water source
```{r}
secwhen_long <- hh_census %>%
  pivot_longer(
    cols = c(wp_secwhen_1, wp_secwhen_2, wp_secwhen_3, wp_secwhen_4, wp_secwhen__666),
    names_to = "circumstance",
    values_to = "used"
  )

secwhen_used <- dplyr::filter(secwhen_long, used == 1) %>%
  dplyr::count(circumstance, sort = TRUE) %>%
  mutate(
    pct = 100 * n / sum(n),
    circumstance_label = case_when(
      circumstance == "wp_secwhen_1" ~ "Primary source is not working",
      circumstance == "wp_secwhen_2" ~ "Primary source does not give adequate water",
      circumstance == "wp_secwhen_3" ~ "Primary source gives water intermittently",
      circumstance == "wp_secwhen_4" ~ "No fixed reason",
      circumstance == "wp_secwhen_-666" ~ "Other",
      TRUE ~ "Unknown"
    )
  )

hh_census_wpsec <- hh_census %>%
  mutate(
    has_any_wp_secwhen = !is.na(wp_secwhen_1) |
                         !is.na(wp_secwhen_2) |
                         !is.na(wp_secwhen_3) |
                         !is.na(wp_secwhen_4)
  )

n_households <- hh_census_wpsec %>%
  summarise(n = sum(has_any_wp_secwhen)) %>%
  pull(n)

total_households_census <- hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  summarise(total = sum(n)) %>%
  pull(total)

secwhen_used %>%
  ggplot(aes(x = reorder(circumstance_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Reasons for Using Other Water Points",
    x = "Reason",
    y = "Share of Households (%)",
    caption = paste0("Note: In HH census raw data, there are ",total_households_census," households.\n",
                     "Here, N=", n_households," households reporting not always using primary water point for\n",   
                     "drinking water. Each household could report more than one reason.")
  ) +
  theme
```

## Water treatment method (HH census & HH survey side by side)
```{r}
# census
wtmt_long <-hh_census %>%
  pivot_longer(
    cols = c(wtmt_method_0, wtmt_method_1, wtmt_method_2, wtmt_method_3,
             wtmt_method_4, wtmt_method_5, wtmt_method_6, wtmt_method_7, wtmt_method_8,
             wtmt_method__111, wtmt_method__666, wtmt_method__999),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- dplyr::filter(wtmt_long, used == 1) %>%
  dplyr::count(method, sort = TRUE) %>%
  
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (water is already treated)*",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  )

n_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(wtmt_cols)))) > 0) %>%
  nrow()

# survey
wtmt_cols_survey <- c(
  "make_watersafe_1", "make_watersafe_2", "make_watersafe_3", "make_watersafe_4",
  "make_watersafe_5", "make_watersafe_6", "make_watersafe_7", "make_watersafe_8",
  "make_watersafe__666", "make_watersafe__999"
)

wtmt_long_survey <- hh_survey %>% 
  pivot_longer(
    cols = all_of(wtmt_cols_survey),
    names_to = "method",
    values_to = "used"
  )

wtmt_used_survey <- dplyr::filter(wtmt_long_survey, used == 1) %>%
  dplyr::count(method, sort = TRUE) %>%
  mutate(
    method_label = case_when(
      method == "make_watersafe_1" ~ "Boil",
      method == "make_watersafe_2" ~ "Apply chlorine from dispenser",
      method == "make_watersafe_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "make_watersafe_4" ~ "Strain through a cloth",
      method == "make_watersafe_5" ~ "Use water filter",
      method == "make_watersafe_6" ~ "Sand/composite etc",
      method == "make_watersafe_7" ~ "Solar disinfection",
      method == "make_watersafe_8" ~ "Let it stand and settle",
      method == "make_watersafe_666" ~ "Other",
      method == "make_watersafe_999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  )

nothing_count <- hh_survey %>% dplyr::filter(do_anything == 0) %>% nrow()
wtmt_used_survey <- wtmt_used_survey %>%
  bind_rows(
    tibble(
      method = "nothing",
      n = nothing_count,
      method_label = "Nothing (no treatment)"
    )
  )

total_count <- sum(wtmt_used_survey$n)
wtmt_used_survey <- wtmt_used_survey %>%
  mutate(pct = 100 * n / total_count)

# combine data from census and survey
plot_data <- bind_rows(
  wtmt_used %>%
    mutate(dataset = "HH Census") %>%
    select(method_label, pct, dataset),
  wtmt_used_survey %>%
    mutate(dataset = "HH Survey") %>%
    select(method_label, pct, dataset)
)

# ensure same ordering
plot_data <- plot_data %>%
  mutate(method_label = fct_reorder(method_label, pct, .fun = max))

# prep for caption
total_households_census <- length(unique(hh_census$hhid))
total_households_survey <- length(unique(hh_survey$household_id))
n_households_survey <- hh_survey %>%
  dplyr::filter(rowSums(!is.na(select(., all_of(wtmt_cols_survey)))) > 0 | !is.na(do_anything)) %>%
  nrow()
n_households_census <- hh_census %>%
  dplyr::filter(rowSums(!is.na(select(., all_of(wtmt_cols)))) > 0) %>%
  nrow()

# plot
ggplot(plot_data, aes(x = method_label, y = pct, fill = dataset)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~dataset, ncol = 2) +
  scale_fill_viridis_d() +
  labs(
    title = "Share of Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
    caption = paste0(
      "Note: For HH survey, raw dataset includes ",total_households_survey," households. Here, N=", n_households_survey, "\n",
      "households that responded to question about treating water.\n",
      "For HH census, raw dataset includes ",total_households_census," households. Here, N=",n_households_census,"\n",
      "households that report not using a DSW or ILC water point.\n",
      "Each household may report multiple methods.\n",
      "*Not an option in HH survey.\n"
    )
  ) +
  theme 
```

## Water treatment method by country
"Apply chlorine at home" more popular in Malawi, "Boil" more popular in Uganda
```{r}
wtmt_cols <- c(
  "wtmt_method_0", "wtmt_method_1", "wtmt_method_2", "wtmt_method_3",
  "wtmt_method_4", "wtmt_method_5", "wtmt_method_6", "wtmt_method_7",
  "wtmt_method_8", "wtmt_method__111", "wtmt_method__666", "wtmt_method__999"
)

country_n <- hh_census %>%
  mutate(non_na_count = rowSums(!is.na(select(., all_of(wtmt_cols))))) %>%
  group_by(country) %>%
  summarise(n = sum(non_na_count > 0), .groups = "drop")

wtmt_long <- hh_census %>%
  pivot_longer(
    cols = all_of(wtmt_cols),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- wtmt_long %>%
  mutate(keep = used == 1) %>%
  group_by(country, method) %>%
  summarise(n = sum(keep, na.rm = TRUE), .groups = "drop") %>%
  group_by(country) %>%
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (already treated)",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  ) %>%
  ungroup()

# prep for caption
caption_text <- country_n %>%
  mutate(label = paste0(country, ": N=", n)) %>%
  pull(label) %>%
  paste(collapse = "; ")
total_households_census <- length(unique(hh_census$hhid))

# plot
ggplot(wtmt_used, aes(x = reorder(method_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  facet_wrap(~ country) +
  labs(
    title = "Share of Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
    caption = paste0(
      "Note: In HH census raw data, there are ",total_households_census," households.\n",
      "Sample is households that report not using a DSW or ILC water point.\n",
      "Sample sizes by country: ", caption_text," \n",
      "Each household may report multiple methods."
    )
  ) +
  theme
```

## Households applying chlorine at home: household composition
No evident differences between households applying chlorine at home and average
```{r}
hh_census <- hh_census %>%
  mutate(
    chlorine_home_user = wtmt_method_3 == 1,
    responded_to_wtmt = if_any(
      .cols = starts_with("wtmt_method_"),
      .fns = ~ !is.na(.x)
    )
  )

all_households <- hh_census %>%
  summarise(
    group = "All Households",
    N = dplyr::n(),
    `Child under 5` = mean(hh_under5 >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2 >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant >= 1, na.rm = TRUE) * 100
  )

responders <- hh_census %>%
  summarise(
    group = "No DSW/ILC",
    N = sum(coalesce(responded_to_wtmt, FALSE)),
    `Child under 5` = mean(hh_under5[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100
  )

chlorine_users <- hh_census %>%
  summarise(
    group = "Applies Chlorine at Home",
    N = sum(coalesce(chlorine_home_user, FALSE)),
    `Child under 5` = mean(hh_under5[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100
  )

comp_data <- bind_rows(all_households, chlorine_users, responders) %>%
  pivot_longer(
    cols = c(`Child under 5`, `Child under 2`, `Pregnant woman`),
    names_to = "Characteristic",
    values_to = "Percent"
  )

comp_data <- comp_data %>%
  mutate(
    group = factor(group, levels = c(
      "All Households",
      "No DSW/ILC",
      "Applies Chlorine at Home"
    ))
  )

ggplot(comp_data, aes(x = Characteristic, y = Percent, fill = group)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  labs(
    title = "Household Composition of Chlorine-at-Home Households vs Average",
    x = "",
    y = "Share of Households (%)",
    fill = "Household Type",
    caption = paste0(
      "Note: N = ", all_households$N, " (All), ",
      responders$N, " (No DSW/ILC), ",
      chlorine_users$N, " (Chlorine Users)."
    )
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  theme
```

## Households applying chlorine at home: number of households in compound
Above average for households applying chlorine (both relative to all and relative to no DSW/ILC subsample)
```{r}
hh_census <- hh_census %>%
  mutate(
    chlorine_home_user = wtmt_method_3 == 1,
    responded_to_wtmt = if_any(
      .cols = starts_with("wtmt_method_"),
      .fns = ~ !is.na(.x)
    )
  )

compound_summary <- bind_rows(
  hh_census %>%
    summarise(
      group = "All Households",
      N = dplyr::n(),
      avg_hh_per_compound = mean(hh_hhsincompound, na.rm = TRUE)
    ),
  
  hh_census %>%
    summarise(
      group = "No DSW/ILC",
      N = sum(coalesce(responded_to_wtmt, FALSE)),
      avg_hh_per_compound = mean(hh_hhsincompound[responded_to_wtmt == TRUE], na.rm = TRUE)
    ),
  
  hh_census %>%
    summarise(
      group = "Applies Chlorine at Home",
      N = sum(coalesce(chlorine_home_user, FALSE)),
      avg_hh_per_compound = mean(hh_hhsincompound[chlorine_home_user == TRUE], na.rm = TRUE)
    )
)

compound_summary <- compound_summary %>%
  mutate(group = factor(group, levels = c(
    "All Households", "No DSW/ILC", "Applies Chlorine at Home"
  )))

ggplot(compound_summary, aes(x = group, y = avg_hh_per_compound, fill = group)) +
  geom_col(width = 0.6) +
  labs(
    title = "Avg. Number of Households per Compound of Chlorine-at-Home Households vs Average",
    x = "",
    y = "Households per Compound",
    fill = "Group",
    caption = paste0(
      "N = ", compound_summary$N[compound_summary$group == "All Households"], " (All), ",
      compound_summary$N[compound_summary$group == "No DSW/ILC"], " (No DSW/ILC), ",
      compound_summary$N[compound_summary$group == "Applies Chlorine at Home"], " (Chlorine Users)."
    )
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  theme
```

## Average Share of HHs using DSW, ILC, Treating, and Not Treating, by Village
LW: among everyone in village, how many people using DSW/ILC, how many not treating and aware, how many not treating and not aware
```{r}
# define treatment
wtmt_real_methods <- c(
  "wtmt_method_1", "wtmt_method_2", "wtmt_method_3",
  "wtmt_method_4", "wtmt_method_5", "wtmt_method_6",
  "wtmt_method_7", "wtmt_method_8"
)

# classify each household
hh_summary <- hh_census %>%
  mutate(
    hh_dsw = (wp_dsw == 1 | wp_dsw_pl == 1),
    hh_ilc = (wp_ilc_device == 1 | wp_ilc_pl == 1),
    treat_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0,
    category = case_when(
      hh_ilc ~ "ILC",
      hh_dsw ~ "DSW",
      treat_any ~ "Neither & Treat",
      !treat_any ~ "Neither & Don't Treat",
      TRUE ~ NA_character_
    )
  )

# per-village category counts (count distinct households)
per_village_cat <- hh_summary %>%
  group_by(villageid, category) %>%
  summarise(n_cat = n_distinct(hhid), .groups = "drop")

# total households per village (denominator)
village_totals <- hh_summary %>%
  group_by(villageid) %>%
  summarise(total_hh = n_distinct(hhid), .groups = "drop")

# join and compute share of village in each category
per_village_cat <- per_village_cat %>%
  left_join(village_totals, by = "villageid") %>%
  mutate(share = n_cat / total_hh)

per_village_wide <- per_village_cat %>%
  select(villageid, category, share) %>%
  pivot_wider(
    names_from = category,
    values_from = share,
    values_fill = 0
  )

avg_shares <- per_village_wide %>%
  summarise(
    DSW = mean(DSW, na.rm = TRUE),
    ILC = mean(ILC, na.rm = TRUE),
    `Neither & Treat` = mean(`Neither & Treat`, na.rm = TRUE),
    `Neither & Don't Treat` = mean(`Neither & Don't Treat`, na.rm = TRUE)
  ) %>%
  pivot_longer(
    everything(),
    names_to = "category",
    values_to = "average_share"
  )

ggplot(avg_shares, aes(x = category, y = average_share, fill = category)) +
  geom_col(show.legend = FALSE) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Average Share of Household Treatment Categories Across Villages",
    x = "Category",
    y = "Average Share of Households (%)"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  theme
```

## Water treatment by type of water source (eg well, tap)
LW: to do

## Share of households using at least 1 treatment method
Broken down by reported village access to DSW/ILC in next chart 
```{r}
wtmt_real_methods <- c(
  "wtmt_method_1",  # Boil
  "wtmt_method_2",  # Dispenser chlorine
  "wtmt_method_3",  # Home chlorine
  "wtmt_method_4",  # Strain through a cloth
  "wtmt_method_5",  # Use water filter
  "wtmt_method_6",  # Sand/composite
  "wtmt_method_7",  # Solar disinfection
  "wtmt_method_8"   # Let it stand and settle
)

hh_valid <- hh_census[rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0
  ) %>%
  count(used_any, name = "n") %>%
  mutate(
    pct = round(100 * n / sum(n), 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment")
  )

ggplot(summary_data, aes(x = "", y = pct, fill = label)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(pct, "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of Households Using Any Water Treatment Method",
    caption = paste0("Note: N=", sum(summary_data$n), 
                     " households that report not using a DSW or ILC water source.")
  ) +
  theme +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),  
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom"
  ) 
```

## Share of households using at least 1 treatment method by whether village has DSW or ILC
```{r}
wtmt_real_methods <- c(
  "wtmt_method_1", "wtmt_method_2", "wtmt_method_3", "wtmt_method_4",
  "wtmt_method_5", "wtmt_method_6", "wtmt_method_7", "wtmt_method_8"
)

hh_valid <- as.data.frame(hh_census)[
  rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0,
    category = case_when(
      wtmt_dsw == 1 & wtmt_ilc != 1 ~ "DSW Only",
      wtmt_ilc == 1 & wtmt_dsw != 1 ~ "ILC Only",
      wtmt_dsw == 1 & wtmt_ilc == 1 ~ "Both DSW & ILC",
      TRUE ~ "Neither"
    )
  ) %>%
  count(category, used_any, name = "n") %>%
  group_by(category) %>%
  mutate(
    total_n = sum(n),
    pct = round(100 * n / total_n, 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment"),
    category_label = paste0(category, "\n(n = ", total_n, ")")
  )

ggplot(summary_data, aes(x = label, y = pct, fill = label)) +
  geom_col(width = 0.6) +
  geom_text(
  aes(
    label = paste0(pct, "%"),
    vjust = ifelse(category == "ILC Only" & used_any, 1.5, -0.4),
    color = ifelse(category == "ILC Only" & used_any, "white", "black")
  ),
  size = 3.5,
  show.legend = FALSE
  ) +
  scale_color_identity() +
  facet_wrap(~category_label, ncol = 2) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Households Using Any Water Treatment Method by Reported DSW/ILC Availability in Village",
    x = NULL,
    y = "Share of Households (%)",
    caption = paste0("Note: Each panel is a distinct group of households among the ", sum(summary_data$n), 
                     " that report not using a DSW/ILC water point")
  ) +
  theme +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 10)
  )
```

## Share of households not using DSW or ILC who report DSW or ILC in village
A measure of awareness of DSW/ILC among HHs that do not use

```{r}
wtmt_summary <- hh_census %>%
  summarise(
    dsw_yes = sum(wtmt_dsw == 1, na.rm = TRUE),
    dsw_total = sum(!is.na(wtmt_dsw)),
    ilc_yes = sum(wtmt_ilc == 1, na.rm = TRUE),
    ilc_total = sum(!is.na(wtmt_ilc))
  ) %>%
  pivot_longer(cols = everything(), names_to = c("type", "response"), names_sep = "_") %>%
  pivot_wider(names_from = response, values_from = value) %>%
  mutate(share = yes / total * 100) %>%
  mutate(type = recode(type, dsw = "DSW", ilc = "ILC"))

ggplot(wtmt_summary, aes(x = type, y = share, fill = type)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of HHs not using DSW/ILC who report a DSW/ILC waterpoint in their village",
    x = "",
    y = "Share Responding 'Yes' (%)",
    caption = paste0(
      "Note: N=", 
      nrow(dplyr::filter(hh_census, !is.na(wtmt_dsw) | !is.na(wtmt_ilc))),
      " households that report not using a DSW or ILC water source."
    )
  ) +
  theme
```

## Household composition: share of households with 1+ child under 5 or 2, pregnant woman

```{r}
hh_census %>%
  group_by(country) %>%
  summarise(
    across(
      c(hh_under5, hh_under2, hh_pregnant),
      ~ mean((.) >= 1, na.rm = TRUE) * 100
    )
  ) %>%
  rename(
    `Country` = country,
    `Child under 5` = hh_under5,
    `Child under 2` = hh_under2,
    `Pregnant woman` = hh_pregnant
  ) %>%
  kable(digits = 1, caption = "Percentage Share of Households with at Least One Young Child or Pregnant Woman")
```

## Household composition: average members 

```{r}
demo_vars <- c("hh_members", "hh_adults", "hh_males", "hh_females",
               "hh_pregnant", "hh_under5", "hh_under2")

n_demo_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(demo_vars)))) > 0) %>%
  nrow()

hh_census %>%
  group_by(country) %>%
  summarise(
    `Members` = mean(hh_members, na.rm = TRUE),
    `Adults` = mean(hh_adults, na.rm = TRUE),
    `Men` = mean(hh_males, na.rm = TRUE),
    `Women` = mean(hh_females, na.rm = TRUE),
    `Pregnant Women` = mean(hh_pregnant, na.rm = TRUE),
    `Children <5` = mean(hh_under5, na.rm = TRUE),
    `Children <2` = mean(hh_under2, na.rm = TRUE)
  ) %>%
  kable(
    digits = 2,
    caption = paste0(
      "Average Household Composition by Country. Note: Averages for ",
      n_demo_households,
      " households included in Household Census to date."
    )
  )
```