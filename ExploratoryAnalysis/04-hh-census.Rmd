# Household census

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  )
```

## Number of observations

```{r}
hh_census %>%
  mutate(
    hh_dsw = wp_dsw == 1 | wp_dsw_pl == 1,
    hh_ilc = wp_ilc_device == 1 | wp_ilc_pl == 1
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    `DSW (%)` = round(mean(hh_dsw, na.rm = TRUE) * 100, 1),
    `ILC (%)` = round(mean(hh_ilc, na.rm = TRUE) * 100, 1)
  )
```

```{r}
hh_census %>%
  mutate(
    hh_dsw = wp_dsw == 1 | wp_dsw_pl == 1,
    hh_ilc = wp_ilc_device == 1 | wp_ilc_pl == 1
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    `DSW (n)` = sum(hh_dsw, na.rm = TRUE),
    `DSW (%)` = round(sum(hh_dsw, na.rm = TRUE) / n() * 100, 1),
    `ILC (n)` = sum(hh_ilc, na.rm = TRUE),
    `ILC (%)` = round(sum(hh_ilc, na.rm = TRUE) / n() * 100, 1)
  )
```

## Share of households using DSW or ILC
LW: the difference between the shares here and in the above table is that below, any HHs that access both DSW and ILC access points are counted as DSW, whereas above, they would be counted into both DSW and ILC (hence sum > 100%)

```{r}
wp_other_table <- 
  hh_census %>%
  mutate(
    hh_dsw = (wp_dsw == 1 | wp_dsw_pl == 1),
    hh_ilc = (wp_ilc == 1 | wp_ilc_pl == 1),
    hh_wp_ea = case_when(
      hh_dsw ~ "DSW",
      hh_ilc ~ "ILC",
      TRUE ~ "Non-program"
    )
  ) %>%
  group_by(country, hh_wp_ea) %>%
  summarise(
    N = n()
  ) %>%
  group_by(country) %>%
  mutate(Percentage = (N/sum(N) * 100) %>% round(1) %>% paste("%"))

wp_other_table %>%
  kable(
    caption = "Household Exposure to Water Point Programs by Country",
    col.names = c("Country", "Program Type", "N", "Percentage")
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Reasons for using other water source (LW added)

```{r}
secwhen_long <- hh_census %>%
  pivot_longer(
    cols = c(wp_secwhen_1, wp_secwhen_2, wp_secwhen_3, wp_secwhen_4, wp_secwhen__666),
    names_to = "circumstance",
    values_to = "used"
  )

secwhen_used <- dplyr::filter(secwhen_long, used == 1) %>%
  dplyr::count(circumstance, sort = TRUE) %>%
  mutate(
    pct = 100 * n / sum(n),
    circumstance_label = case_when(
      circumstance == "wp_secwhen_1" ~ "Primary source is not working",
      circumstance == "wp_secwhen_2" ~ "Primary source does not give adequate water",
      circumstance == "wp_secwhen_3" ~ "Primary source gives water intermittently",
      circumstance == "wp_secwhen_4" ~ "No fixed reason",
      circumstance == "wp_secwhen_-666" ~ "Other",
      TRUE ~ "Unknown"
    )
  )

hh_census_wpsec <- hh_census %>%
  mutate(
    has_any_wp_secwhen = !is.na(wp_secwhen_1) |
                         !is.na(wp_secwhen_2) |
                         !is.na(wp_secwhen_3) |
                         !is.na(wp_secwhen_4)
  )

n_households <- hh_census_wpsec %>%
  summarise(n = sum(has_any_wp_secwhen)) %>%
  pull(n)

secwhen_used %>%
  ggplot(aes(x = reorder(circumstance_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Reasons for Using Other Water Points",
    x = "Reason",
    y = "Share of Households (%)",
    caption = paste0("Note: Sample is ", n_households,
                     " households reporting using more than 1 water source.\n",
                     "Each household could report more than one reason.")
  ) +
  theme
```

## Number of water points per household (LW added)

LW: we have the same thing in hh_survey, but I realized there is also a census measure for this

```{r}
wp_distribution_census <- 
  hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

total_households_census <- hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  summarise(total = sum(n)) %>%
  pull(total)

ggplot(wp_distribution_census, aes(x = as.factor(wp_secweekno), y = n, fill = as.factor(wp_secweekno))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used per Household",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = glue("Note: This data includes observations from {total_households_census} households included to date in the Household Census.")
  ) +
  theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

## Water treatment method

LW:
- characteristics of households that apply chlorine at home: esp household composition (younger children, pregnant women, maybe number of HHs in compound). also whether in DSW or ILC villages
- apply chlorine from dispenser: look at distance (because their water point doesn't have DSW/ILC)
- nothing (already treated): type of water source they're using

```{r}
wtmt_long <-hh_census %>%
  pivot_longer(
    cols = c(wtmt_method_0, wtmt_method_1, wtmt_method_2, wtmt_method_3,
             wtmt_method_4, wtmt_method_5, wtmt_method_6, wtmt_method_7, wtmt_method_8,
             wtmt_method__111, wtmt_method__666, wtmt_method__999),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- dplyr::filter(wtmt_long, used == 1) %>%
  dplyr::count(method, sort = TRUE) %>%
  
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (water is already treated)",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  )

n_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(wtmt_cols)))) > 0) %>%
  nrow()

wtmt_used %>%
  ggplot(aes(x = reorder(method_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Share of Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
      caption = paste0("Note: Sample is ", 
  nrow(dplyr::filter(hh_census, rowSums(!is.na(dplyr::select(hh_census, dplyr::all_of(wtmt_cols)))) > 0)),
  " households that report not using a DSW or ILC water source.\n",
  "Each household may report more than one treatment method.")
    ) +
  theme
```

## Share of households using at least 1 treatment method (LW added)
Add this broken down for whether it is a DSW or ILC village

```{r}
wtmt_real_methods <- c(
  "wtmt_method_1",  # Boil
  "wtmt_method_2",  # Dispenser chlorine
  "wtmt_method_3",  # Home chlorine
  "wtmt_method_4",  # Strain through a cloth
  "wtmt_method_5",  # Use water filter
  "wtmt_method_6",  # Sand/composite
  "wtmt_method_7",  # Solar disinfection
  "wtmt_method_8"   # Let it stand and settle
)

hh_valid <- hh_census[rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0
  ) %>%
  count(used_any, name = "n") %>%
  mutate(
    pct = round(100 * n / sum(n), 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment")
  )

ggplot(summary_data, aes(x = "", y = pct, fill = label)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(pct, "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of Households Using Any Water Treatment Method",
    caption = paste0("Note: Sample is ", sum(summary_data$n), 
                     " households that report not using a DSW or ILC water source.")
  ) +
  theme +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),  
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom"
  ) 
```

## Share of households not using DSW or ILC who report using DSW or ILC (LW)
A measure of awareness of DSW/ILC among HHs that do not use

```{r}
wtmt_summary <- hh_census %>%
  summarise(
    dsw_yes = sum(wtmt_dsw == 1, na.rm = TRUE),
    dsw_total = sum(!is.na(wtmt_dsw)),
    ilc_yes = sum(wtmt_ilc == 1, na.rm = TRUE),
    ilc_total = sum(!is.na(wtmt_ilc))
  ) %>%
  pivot_longer(cols = everything(), names_to = c("type", "response"), names_sep = "_") %>%
  pivot_wider(names_from = response, values_from = value) %>%
  mutate(share = yes / total * 100) %>%
  mutate(type = recode(type, dsw = "DSW", ilc = "ILC"))

ggplot(wtmt_summary, aes(x = type, y = share, fill = type)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of HHs not using DSW/ILC who report a DSW/ILC waterpoint in their village",
    x = "",
    y = "Share Responding 'Yes' (%)",
    caption = paste0(
      "Note: Sample is ", 
      nrow(dplyr::filter(hh_census, !is.na(wtmt_dsw) | !is.na(wtmt_ilc))),
      " households that report not using a DSW or ILC water source."
    )
  ) +
  theme
```

```{r}
wtmt_real_methods <- c(
  "wtmt_method_1",  # Boil
  "wtmt_method_2",  # Dispenser chlorine
  "wtmt_method_3",  # Home chlorine
  "wtmt_method_4",  # Strain through a cloth
  "wtmt_method_5",  # Use water filter
  "wtmt_method_6",  # Sand/composite
  "wtmt_method_7",  # Solar disinfection
  "wtmt_method_8"   # Let it stand and settle
)

hh_valid <- as.data.frame(hh_census)[rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0,
    category = case_when(
      wtmt_dsw == 1 & wtmt_ilc != 1 ~ "DSW Only",
      wtmt_ilc == 1 & wtmt_dsw != 1 ~ "ILC Only",
      wtmt_dsw == 1 & wtmt_ilc == 1 ~ "Both DSW & ILC",
      TRUE ~ "Neither"
    )
  ) %>%
  count(category, used_any, name = "n") %>%
  group_by(category) %>%
  mutate(
    pct = round(100 * n / sum(n), 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment")
  )

ggplot(summary_data, aes(x = label, y = pct, fill = label)) +
  geom_col(width = 0.7) +
  facet_wrap(~category, ncol = 2) +
  geom_text(aes(label = paste0(pct, "%")), vjust = -0.3, size = 3.5) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of Households Using Any Water Treatment Method by Village Water Source Type",
    x = NULL, y = "Share of Households (%)",
    caption = paste0("Note: Sample is ", sum(summary_data$n), 
                     " households that report not using a DSW or ILC water source.\n",
                     "Each household may report more than one treatment method.")
  ) +
  theme +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none",
    strip.text = element_text(face = "bold")
  )
```

```

## Household composition: share of households with 1+ child under 5 or 2

```{r}
hh_census %>%
  group_by(country) %>%
  summarise(
    across(
      c(hh_under5, hh_under2, hh_pregnant),
      ~ mean((.) >= 1, na.rm = TRUE) * 100
    )
  ) %>%
  rename(
    `Country` = country,
    `Child under 5` = hh_under5,
    `Child under 2` = hh_under2,
    `Pregnant woman` = hh_pregnant
  ) %>%
  kable(digits = 1, caption = "Percentage Share of Households with at Least One Young Child or Pregnant Woman")
```

## Household composition: average members (LW added)

```{r}
demo_vars <- c("hh_members", "hh_adults", "hh_males", "hh_females",
               "hh_pregnant", "hh_under5", "hh_under2")

n_demo_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(demo_vars)))) > 0) %>%
  nrow()

hh_census %>%
  group_by(country) %>%
  summarise(
    `Members` = mean(hh_members, na.rm = TRUE),
    `Adults` = mean(hh_adults, na.rm = TRUE),
    `Men` = mean(hh_males, na.rm = TRUE),
    `Women` = mean(hh_females, na.rm = TRUE),
    `Pregnant Women` = mean(hh_pregnant, na.rm = TRUE),
    `Children <5` = mean(hh_under5, na.rm = TRUE),
    `Children <2` = mean(hh_under2, na.rm = TRUE)
  ) %>%
  kable(
    digits = 2,
    caption = paste0(
      "Average Household Composition by Country. Note: Averages for ",
      n_demo_households,
      " households included in Household Census to date."
    )
  )
```