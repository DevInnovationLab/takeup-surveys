# Household census
```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis",
    "glue"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

```{r}
hh_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "HouseholdCensus",
      "DataSets",
      "Final",
      "hh-census.rds"
    )
  )
```

## LW TO DO
- add graphs by footprint and expansion villages when available
- apply chlorine from dispenser: look at distance (because their water point doesn't have DSW/ILC) -> TO DO (when we have distance)

## Number of observations and number/share of households using DSW and ILC water points

```{r}
hh_census %>%
  mutate(
    hh_dsw = wp_dsw == 1 | wp_dsw_pl == 1,
    hh_ilc = wp_ilc_device == 1 | wp_ilc_pl == 1
  ) %>%
  group_by(country) %>%
  summarise(
    N = n(),
    `DSW (n)` = sum(hh_dsw, na.rm = TRUE),
    `DSW (%)` = round(sum(hh_dsw, na.rm = TRUE) / n() * 100, 1),
    `ILC (n)` = sum(hh_ilc, na.rm = TRUE),
    `ILC (%)` = round(sum(hh_ilc, na.rm = TRUE) / n() * 100, 1)
  ) %>%
  kable(
    digits = 1,
    caption = "Observations and DSW/ILC Usage by Country",
    format = "html"
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Dataframe to analyze needed raw data corrections
```{r}
corrections_df <- hh_census %>%
  select(key, wtmt_method_o, country, enumerator_ID)
```

## Number of water points per household
(Same graph in hh_survey)
```{r}
wp_distribution_census <- 
  hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 1),
    label = paste0(percentage, "%")
  )

total_households_census <- hh_census %>%
  mutate(wp_secweekno = if_else(is.na(wp_secweekno), 1L, wp_secweekno + 1L)) %>%
  count(wp_secweekno) %>%
  summarise(total = sum(n)) %>%
  pull(total)

ggplot(wp_distribution_census, aes(x = as.factor(wp_secweekno), y = n, fill = as.factor(wp_secweekno))) +
  geom_col() +
  geom_text(
    aes(label = label),
    vjust = -0.5,
    color = "black"
  ) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Water Points Used") +
  labs(
    title = "Distribution of Water Points Used per Household",
    x = "Number of Water Points Used",
    y = "Number of Households",
    caption = glue("Note: N={total_households_census} households included to date in the Household Census.")
  ) +
  theme +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic"),
    legend.position = "none"
  )
```

## Reasons for using other water source

```{r}
secwhen_long <- hh_census %>%
  pivot_longer(
    cols = c(wp_secwhen_1, wp_secwhen_2, wp_secwhen_3, wp_secwhen_4, wp_secwhen__666),
    names_to = "circumstance",
    values_to = "used"
  )

secwhen_used <- dplyr::filter(secwhen_long, used == 1) %>%
  dplyr::count(circumstance, sort = TRUE) %>%
  mutate(
    pct = 100 * n / sum(n),
    circumstance_label = case_when(
      circumstance == "wp_secwhen_1" ~ "Primary source is not working",
      circumstance == "wp_secwhen_2" ~ "Primary source does not give adequate water",
      circumstance == "wp_secwhen_3" ~ "Primary source gives water intermittently",
      circumstance == "wp_secwhen_4" ~ "No fixed reason",
      circumstance == "wp_secwhen_-666" ~ "Other",
      TRUE ~ "Unknown"
    )
  )

hh_census_wpsec <- hh_census %>%
  mutate(
    has_any_wp_secwhen = !is.na(wp_secwhen_1) |
                         !is.na(wp_secwhen_2) |
                         !is.na(wp_secwhen_3) |
                         !is.na(wp_secwhen_4)
  )

n_households <- hh_census_wpsec %>%
  summarise(n = sum(has_any_wp_secwhen)) %>%
  pull(n)

secwhen_used %>%
  ggplot(aes(x = reorder(circumstance_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Reasons for Using Other Water Points",
    x = "Reason",
    y = "Share of Households (%)",
    caption = paste0("Note: N=", n_households,
                     " households reporting using more than 1 water source.\n",
                     "Each household could report more than one reason.")
  ) +
  theme
```

## Water treatment method
LW: characteristics of households that apply chlorine at home
  - household composition (younger children, pregnant women, number of HHs in compound) -> DONE
  - whether in DSW or ILC villages -> DONE
- nothing (already treated): type of water source they're using -> DONE

add HH survey graph side by side
```{r}
wtmt_long <-hh_census %>%
  pivot_longer(
    cols = c(wtmt_method_0, wtmt_method_1, wtmt_method_2, wtmt_method_3,
             wtmt_method_4, wtmt_method_5, wtmt_method_6, wtmt_method_7, wtmt_method_8,
             wtmt_method__111, wtmt_method__666, wtmt_method__999),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- dplyr::filter(wtmt_long, used == 1) %>%
  dplyr::count(method, sort = TRUE) %>%
  
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (water is already treated)",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  )

n_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(wtmt_cols)))) > 0) %>%
  nrow()

wtmt_used %>%
  ggplot(aes(x = reorder(method_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  labs(
    title = "Share of Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
      caption = paste0("Note: N=", 
  nrow(dplyr::filter(hh_census, rowSums(!is.na(dplyr::select(hh_census, dplyr::all_of(wtmt_cols)))) > 0)),
  " households that report not using a DSW or ILC water \n",
  "point. Each household may report more than one treatment method.")
    ) +
  theme
```

## Water treatment method by country
```{r}
wtmt_cols <- c(
  "wtmt_method_0", "wtmt_method_1", "wtmt_method_2", "wtmt_method_3",
  "wtmt_method_4", "wtmt_method_5", "wtmt_method_6", "wtmt_method_7",
  "wtmt_method_8", "wtmt_method__111", "wtmt_method__666", "wtmt_method__999"
)

country_n <- hh_census %>%
  mutate(non_na_count = rowSums(!is.na(select(., all_of(wtmt_cols))))) %>%
  group_by(country) %>%
  summarise(n = sum(non_na_count > 0), .groups = "drop")

wtmt_long <- hh_census %>%
  pivot_longer(
    cols = all_of(wtmt_cols),
    names_to = "method",
    values_to = "used"
  )

wtmt_used <- wtmt_long %>%
  mutate(keep = used == 1) %>%
  group_by(country, method) %>%
  summarise(n = sum(keep, na.rm = TRUE), .groups = "drop") %>%
  group_by(country) %>%
  mutate(
    pct = 100 * n / sum(n),
    method_label = case_when(
      method == "wtmt_method_0" ~ "Nothing (no treatment)",
      method == "wtmt_method_1" ~ "Boil",
      method == "wtmt_method_2" ~ "Apply chlorine from dispenser",
      method == "wtmt_method_3" ~ "Apply chlorine at home (WaterGuard, PUR, AquaTabs)",
      method == "wtmt_method_4" ~ "Strain through a cloth",
      method == "wtmt_method_5" ~ "Use water filter",
      method == "wtmt_method_6" ~ "Sand/composite etc",
      method == "wtmt_method_7" ~ "Solar disinfection",
      method == "wtmt_method_8" ~ "Let it stand and settle",
      method == "wtmt_method__111" ~ "Nothing (already treated)",
      method == "wtmt_method__666" ~ "Other",
      method == "wtmt_method__999" ~ "Don't Know",
      TRUE ~ "Unknown"
    )
  ) %>%
  ungroup()

caption_text <- country_n %>%
  mutate(label = paste0(country, ": N=", n)) %>%
  pull(label) %>%
  paste(collapse = "; ")

ggplot(wtmt_used, aes(x = reorder(method_label, pct), y = pct)) +
  geom_col(fill = viridis(1)) +
  coord_flip() +
  facet_wrap(~ country) +
  labs(
    title = "Share of Households Using Each Water Treatment Method",
    x = "Treatment Method",
    y = "Share of Households (%)",
    caption = paste0(
      "Note: Household sample sizes â€“ ", caption_text, 
      ".\n Sample is households that report not using a DSW or ILC water point.\n",
  " Each household may report multiple methods."
    )
  ) +
  theme
```

## Households applying chlorine at home: household composition
No evident differences between households applying chlorine at home and average
```{r}
hh_census <- hh_census %>%
  mutate(
    chlorine_home_user = wtmt_method_3 == 1,
    responded_to_wtmt = if_any(
      .cols = starts_with("wtmt_method_"),
      .fns = ~ !is.na(.x)
    )
  )

all_households <- hh_census %>%
  summarise(
    group = "All Households",
    N = dplyr::n(),
    `Child under 5` = mean(hh_under5 >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2 >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant >= 1, na.rm = TRUE) * 100
  )

responders <- hh_census %>%
  summarise(
    group = "No DSW/ILC",
    N = sum(coalesce(responded_to_wtmt, FALSE)),
    `Child under 5` = mean(hh_under5[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant[responded_to_wtmt == TRUE] >= 1, na.rm = TRUE) * 100
  )

chlorine_users <- hh_census %>%
  summarise(
    group = "Applies Chlorine at Home",
    N = sum(coalesce(chlorine_home_user, FALSE)),
    `Child under 5` = mean(hh_under5[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100,
    `Child under 2` = mean(hh_under2[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100,
    `Pregnant woman` = mean(hh_pregnant[chlorine_home_user == TRUE] >= 1, na.rm = TRUE) * 100
  )

comp_data <- bind_rows(all_households, chlorine_users, responders) %>%
  pivot_longer(
    cols = c(`Child under 5`, `Child under 2`, `Pregnant woman`),
    names_to = "Characteristic",
    values_to = "Percent"
  )

comp_data <- comp_data %>%
  mutate(
    group = factor(group, levels = c(
      "All Households",
      "No DSW/ILC",
      "Applies Chlorine at Home"
    ))
  )

ggplot(comp_data, aes(x = Characteristic, y = Percent, fill = group)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  labs(
    title = "Household Composition of Chlorine-at-Home Households vs Average",
    x = "",
    y = "Share of Households (%)",
    fill = "Household Type",
    caption = paste0(
      "Note: N = ", all_households$N, " (All), ",
      responders$N, " (No DSW/ILC), ",
      chlorine_users$N, " (Chlorine Users)."
    )
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  theme
```
## Households applying chlorine at home: number of households in compound
Above average for households applying chlorine (both relative to all and relative to no DSW/ILC subsample)
```{r}
hh_census <- hh_census %>%
  mutate(
    chlorine_home_user = wtmt_method_3 == 1,
    responded_to_wtmt = if_any(
      .cols = starts_with("wtmt_method_"),
      .fns = ~ !is.na(.x)
    )
  )

compound_summary <- bind_rows(
  hh_census %>%
    summarise(
      group = "All Households",
      N = dplyr::n(),
      avg_hh_per_compound = mean(hh_hhsincompound, na.rm = TRUE)
    ),
  
  hh_census %>%
    summarise(
      group = "No DSW/ILC",
      N = sum(coalesce(responded_to_wtmt, FALSE)),
      avg_hh_per_compound = mean(hh_hhsincompound[responded_to_wtmt == TRUE], na.rm = TRUE)
    ),
  
  hh_census %>%
    summarise(
      group = "Applies Chlorine at Home",
      N = sum(coalesce(chlorine_home_user, FALSE)),
      avg_hh_per_compound = mean(hh_hhsincompound[chlorine_home_user == TRUE], na.rm = TRUE)
    )
)

compound_summary <- compound_summary %>%
  mutate(group = factor(group, levels = c(
    "All Households", "No DSW/ILC", "Applies Chlorine at Home"
  )))

ggplot(compound_summary, aes(x = group, y = avg_hh_per_compound, fill = group)) +
  geom_col(width = 0.6) +
  labs(
    title = "Avg. Number of Households per Compound of Chlorine-at-Home Households vs Average",
    x = "",
    y = "Households per Compound",
    fill = "Group",
    caption = paste0(
      "N = ", compound_summary$N[compound_summary$group == "All Households"], " (All), ",
      compound_summary$N[compound_summary$group == "No DSW/ILC"], " (No DSW/ILC), ",
      compound_summary$N[compound_summary$group == "Applies Chlorine at Home"], " (Chlorine Users)."
    )
  ) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  theme
```

## Reported Village Water Source Type for Households Reporting 'Nothing (Water Already Treated)'
Highest share not treating is in ILC villages, in line with the fact that ILC water should already be treated

among everyone in village, how many people using DSW/ILC, how many not treating and aware, how many not treating and not aware
collapse data into villages
```{r}
hh_census <- hh_census %>%
  mutate(
    source_type = case_when(
      wtmt_dsw == 1 & (is.na(wtmt_ilc) | wtmt_ilc != 1) ~ "DSW Only",
      wtmt_ilc == 1 & (is.na(wtmt_dsw) | wtmt_dsw != 1) ~ "ILC Only",
      wtmt_dsw == 1 & wtmt_ilc == 1 ~ "Both DSW & ILC",
      TRUE ~ "Neither"
    ),
    responded_to_wtmt = if_any(starts_with("wtmt_method_"), ~ !is.na(.x))
  )

group1 <- hh_census %>%
  mutate(include = wtmt_method__111 == 1) %>%
  count(source_type, group = "Do not treat ('Already Treated')", wt = include) %>%
  group_by(group) %>%
  mutate(
    pct = round(100 * n / sum(n), 1)
  )

group2 <- hh_census %>%
  mutate(include = responded_to_wtmt) %>%
  count(source_type, group = "Average", wt = include) %>%
  group_by(group) %>%
  mutate(
    pct = round(100 * n / sum(n), 1)
  )

comparison <- bind_rows(group1, group2)

ggplot(comparison, aes(x = source_type, y = pct, fill = group)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = paste0(pct, "%")), 
            position = position_dodge(width = 0.7), 
            vjust = -0.4, size = 3.5) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Reported Village DSW/ILC Availability for Households Reporting\n Not Treating Water ('Already Treated')' vs Average",
    x = "Village Water Source Type",
    y = "Share of Households (%)",
    fill = "Household Type",
    caption = paste0(
      "Note: N = ", sum(hh_census$wtmt_method__111 == 1, na.rm = TRUE), 
      " (Do not treat ('Already Treated')), ", 
      sum(hh_census$responded_to_wtmt, na.rm = TRUE), " (Average for Responders to Water Treatment Questions)."
    )
  ) +
  theme +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )
```
## add treatment by type of water source (eg well, tap)

## Share of households using at least 1 treatment method
Broken down by reported village access to DSW/ILC in next chart 
```{r}
wtmt_real_methods <- c(
  "wtmt_method_1",  # Boil
  "wtmt_method_2",  # Dispenser chlorine
  "wtmt_method_3",  # Home chlorine
  "wtmt_method_4",  # Strain through a cloth
  "wtmt_method_5",  # Use water filter
  "wtmt_method_6",  # Sand/composite
  "wtmt_method_7",  # Solar disinfection
  "wtmt_method_8"   # Let it stand and settle
)

hh_valid <- hh_census[rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0
  ) %>%
  count(used_any, name = "n") %>%
  mutate(
    pct = round(100 * n / sum(n), 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment")
  )

ggplot(summary_data, aes(x = "", y = pct, fill = label)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(pct, "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of Households Using Any Water Treatment Method",
    caption = paste0("Note: N=", sum(summary_data$n), 
                     " households that report not using a DSW or ILC water source.")
  ) +
  theme +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),  
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom"
  ) 
```

## Share of households using at least 1 treatment method by whether village has DSW or ILC
```{r}
wtmt_real_methods <- c(
  "wtmt_method_1", "wtmt_method_2", "wtmt_method_3", "wtmt_method_4",
  "wtmt_method_5", "wtmt_method_6", "wtmt_method_7", "wtmt_method_8"
)

hh_valid <- as.data.frame(hh_census)[
  rowSums(!is.na(hh_census[, wtmt_real_methods])) > 0, ]

summary_data <- hh_valid %>%
  mutate(
    used_any = rowSums(select(., all_of(wtmt_real_methods)) == 1, na.rm = TRUE) > 0,
    category = case_when(
      wtmt_dsw == 1 & wtmt_ilc != 1 ~ "DSW Only",
      wtmt_ilc == 1 & wtmt_dsw != 1 ~ "ILC Only",
      wtmt_dsw == 1 & wtmt_ilc == 1 ~ "Both DSW & ILC",
      TRUE ~ "Neither"
    )
  ) %>%
  count(category, used_any, name = "n") %>%
  group_by(category) %>%
  mutate(
    total_n = sum(n),
    pct = round(100 * n / total_n, 1),
    label = ifelse(used_any, "Used Treatment", "Did Not Use Treatment"),
    category_label = paste0(category, "\n(n = ", total_n, ")")
  )

ggplot(summary_data, aes(x = label, y = pct, fill = label)) +
  geom_col(width = 0.6) +
  geom_text(
  aes(
    label = paste0(pct, "%"),
    vjust = ifelse(category == "ILC Only" & used_any, 1.5, -0.4),
    color = ifelse(category == "ILC Only" & used_any, "white", "black")
  ),
  size = 3.5,
  show.legend = FALSE
  ) +
  scale_color_identity() +
  facet_wrap(~category_label, ncol = 2) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Households Using Any Water Treatment Method by Reported DSW/ILC Availability in Village",
    x = NULL,
    y = "Share of Households (%)",
    caption = paste0("Note: Each panel is a distinct group of households among the ", sum(summary_data$n), 
                     " that report not using a DSW/ILC water point")
  ) +
  theme +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 10)
  )
```

## Share of households not using DSW or ILC who report DSW or ILC in village
A measure of awareness of DSW/ILC among HHs that do not use

```{r}
wtmt_summary <- hh_census %>%
  summarise(
    dsw_yes = sum(wtmt_dsw == 1, na.rm = TRUE),
    dsw_total = sum(!is.na(wtmt_dsw)),
    ilc_yes = sum(wtmt_ilc == 1, na.rm = TRUE),
    ilc_total = sum(!is.na(wtmt_ilc))
  ) %>%
  pivot_longer(cols = everything(), names_to = c("type", "response"), names_sep = "_") %>%
  pivot_wider(names_from = response, values_from = value) %>%
  mutate(share = yes / total * 100) %>%
  mutate(type = recode(type, dsw = "DSW", ilc = "ILC"))

ggplot(wtmt_summary, aes(x = type, y = share, fill = type)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  scale_fill_viridis_d(option = "D", direction = -1) +
  labs(
    title = "Share of HHs not using DSW/ILC who report a DSW/ILC waterpoint in their village",
    x = "",
    y = "Share Responding 'Yes' (%)",
    caption = paste0(
      "Note: N=", 
      nrow(dplyr::filter(hh_census, !is.na(wtmt_dsw) | !is.na(wtmt_ilc))),
      " households that report not using a DSW or ILC water source."
    )
  ) +
  theme
```

## Household composition: share of households with 1+ child under 5 or 2

```{r}
hh_census %>%
  group_by(country) %>%
  summarise(
    across(
      c(hh_under5, hh_under2, hh_pregnant),
      ~ mean((.) >= 1, na.rm = TRUE) * 100
    )
  ) %>%
  rename(
    `Country` = country,
    `Child under 5` = hh_under5,
    `Child under 2` = hh_under2,
    `Pregnant woman` = hh_pregnant
  ) %>%
  kable(digits = 1, caption = "Percentage Share of Households with at Least One Young Child or Pregnant Woman")
```

## Household composition: average members 

```{r}
demo_vars <- c("hh_members", "hh_adults", "hh_males", "hh_females",
               "hh_pregnant", "hh_under5", "hh_under2")

n_demo_households <- hh_census %>%
  filter(rowSums(!is.na(select(., all_of(demo_vars)))) > 0) %>%
  nrow()

hh_census %>%
  group_by(country) %>%
  summarise(
    `Members` = mean(hh_members, na.rm = TRUE),
    `Adults` = mean(hh_adults, na.rm = TRUE),
    `Men` = mean(hh_males, na.rm = TRUE),
    `Women` = mean(hh_females, na.rm = TRUE),
    `Pregnant Women` = mean(hh_pregnant, na.rm = TRUE),
    `Children <5` = mean(hh_under5, na.rm = TRUE),
    `Children <2` = mean(hh_under2, na.rm = TRUE)
  ) %>%
  kable(
    digits = 2,
    caption = paste0(
      "Average Household Composition by Country. Note: Averages for ",
      n_demo_households,
      " households included in Household Census to date."
    )
  )
```