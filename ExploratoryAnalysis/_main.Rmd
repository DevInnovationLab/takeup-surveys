--- 
title: "Chlorine adoption survey"
author: "Development Innovation Lab"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
--- 
title: "Chlorine adoption survey"
author: "Development Innovation Lab"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---

```{r}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
```
# Introduction

THIS IS A WORK IN PROGRESS

This document shows exploratory analysis results for the chlorine adoption surveys conducted in Malawi and Uganda.

<!--chapter:end:index.Rmd-->

---
output:
  pdf_document: default
  html_document: default
---
# Water point census

```{r}
library(stringr)
library(sf)
library(tidyverse)
```

## Field observations

- In some villages, the promoters filled the dispenser after they saw the FOs inspecting it
- There is one DSW village that has an ILC device. The community guide reported that the ILC is operated by an organization called "Salvation"


```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry
```

## Eligible water points
LW: a table counting the number of observations, and counting how many of them satisfy the eligibility criteria (communal, used for drinking, functional)

```{r}
rows <- c(
  "Visited",
  "Communal",
  "Used for Drinking",
  "Functional",
  "Eligible (2-4 = Yes)"
)

counts = c(
  nrow(distinct(wp_census, wp_id)),
  sum(wp_census$wp_multicompound, na.rm = T),
  sum(wp_census$wp_drink, na.rm = T),
  sum(wp_census$wp_func, na.rm = T),
  sum((wp_census$wp_drink & wp_census$wp_multicompound & wp_census$wp_func), na.rm = T)
)

eligiblity_df <- data.frame(
  Name = rows,
  Counts = counts
)

ggplot(data = eligiblity_df,
       aes(x = Name, y = Counts)) +
  geom_bar(stat = "identity", color = "skyblue", fill = "skyblue") + 
  scale_x_discrete(limits = rows) +
  labs(
    title = "Water Point Eligibility Criteria",
    x = "Criteria",
    y = "Count",
    caption = paste0("Note: Cumulative data comes from ", nrow(distinct(wp_census, village_id)), " villages")
  ) + 
  theme

eligibility_df <- data.frame(
  Criteria = rows,
  N = counts
)

kable(
  eligibility_df,
  caption = "Water Point Eligibility Criteria",
  col.names = c("Criteria", "N"),
  align = c("l", "r"),
  format = "html"
) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## Number of water points found

```{r}
wp_census %>%
  select(wp_func, wp_dsw, wp_ilc_device, wp_ilc) %>%
  mutate(
    dsw_func = case_when(wp_dsw == 1 ~ wp_func),
    ilcwp_func = case_when(wp_ilc_device == 1 ~ wp_func),
    ilcwcp_func = case_when(wp_ilc == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = wp_dsw,
        ilcwp_n = wp_ilc_device,
        ilcwcp_n = wp_ilc
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  )
```

### Averages by village

LW: Add a table showing: average number of water points per village, number of villages with DSW, average number of DSW water points per village (only if any ILC [DSW?] is present), number of villages with ILC, average number of ILC water points per village (only if any ILC is present)

```{r}
village_stats <- wp_census %>%
  group_by(village_id) %>%
  summarise(
    total_wps = n(),
    dsw_wps = sum(wp_dsw, na.rm = TRUE),
    ilc_wps = sum(wp_ilc, na.rm = TRUE),
    has_dsw = any(wp_dsw == TRUE, na.rm = TRUE),
    has_ilc = any(wp_ilc == TRUE, na.rm = TRUE),
    .groups = "drop"
  )

summary_table <- tibble(
  Metric = c(
    "Avg. number of water points per village",
    "Number of villages with DSW",
    "Avg. number of DSW water points per village (with any DSW)",
    "Number of villages with ILC",
    "Avg. number of ILC water points per village (with any ILC)"
  ),
  Value = c(
    mean(village_stats$total_wps),
    sum(village_stats$has_dsw),
    mean(village_stats$dsw_wps[village_stats$has_dsw]),
    sum(village_stats$has_ilc),
    mean(village_stats$ilc_wps[village_stats$has_ilc])
  ) %>% round(2)
)

kable(summary_table,
      caption = "Village-level summary statistics for water points",
      col.names = c("Metric", "Value"),
      align = c("l", "r")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## Type of water points

### All water points

```{r}
wp_census %>%
  group_by(sourcetype, wp_ilc_device, wp_dsw, wp_ilc) %>%
  summarise(
    n = n()
  ) %>%
  mutate(
    ea = case_when(
      wp_ilc_device ~ "ILC water point",
      wp_ilc ~ "ILC water collection point",
      wp_dsw ~ "DSW",
      TRUE ~ "Non-program"
    )
  ) %>%
  group_by(sourcetype) %>%
  mutate(
    total = sum(n),
    # sourcetype = reorder(sourcetype, total, order = TRUE)
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = n,
      fill = ea
    )
  ) +
  geom_col() +
  geom_text(
    aes(
      x = total,
      label = total
    ),
    size = 3,
    hjust = 1.2,
    color = "white"
  ) +
  theme +
  scale_fill_viridis_d() +
  labs(
    y = NULL,
    x = "Number of sources",
    fill = NULL
  )
```

### Program water points

```{r}
wp_census %>%
  mutate(
    ea = case_when(
      wp_ilc_device ~ "ILC",
      wp_ilc ~ "ILC water collection point",
      wp_dsw ~ "DSW"
    )
  ) %>%
  dplyr::filter(!is.na(ea)) %>%
  group_by(sourcetype, ea) %>%
  summarise(n = n()) %>%
  group_by(ea) %>%
  mutate(
    total = sum(n),
    pct = (n/total) * 100
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = pct,
      fill = ea,
      label = pct %>% round(1)
    )
  ) + 
  geom_col() +
  geom_text(
    aes(color = ea),
    size = 3,
    hjust = 1.2
  ) +
  facet_wrap(~ ea) +
  theme +
  scale_fill_viridis_d() +
  scale_color_viridis_d(direction = -1) +
  labs(
    y = NULL,
    x = "Percent of sources",
    fill = NULL
  )
```

## Number of water points per village

```{r}
wp_census %>%
  group_by(village_id) %>%
  summarise(
    `Water points` = n(),
    `DSW water points` = sum(wp_dsw, na.rm = TRUE) %>% na_if(0),
    `ILC water points` = sum(wp_ilc_device, na.rm = TRUE) %>% na_if(0),
    `ILC water collection points` = sum(wp_ilc, na.rm = TRUE) %>% na_if(0)
  ) %>%
  summarise(
    across(
      - village_id,
      ~ mean(., na.rm = TRUE),
      .names = "Average_{.col}"
    ),
    across(
      - village_id,
      ~ min(., na.rm = TRUE),
      .names = "Minimum_{.col}"
    ),
    across(
      - village_id,
      ~ max(., na.rm = TRUE),
      .names = "Maximum_{.col}"
    )
    ,
    across(
      - village_id,
      ~ sum(!is.na(.), na.rm = TRUE),
      .names = "N_{.col}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(".value", "Type")
  ) %>%
  select(
    Type, N, Average, Minimum, Maximum
  ) %>%
  rename(
    `Number of villages` = N
  )
```
## Water point functionality rate

- Overall: `r (wp_census %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- DSW: `r (wp_census %>% dplyr::filter(wp_dsw) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water points: `r (wp_census %>% dplyr::filter(wp_ilc_device) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water collection points: `r (wp_census %>% dplyr::filter(wp_ilc) %>% pull(wp_func) %>% mean * 100) %>% round(1)`%

## Share of paid water points

- Overall: `r (wp_census %>% pull(wp_pay) %>% mean* 100) %>% round(1)`%
- DSW: `r (wp_census %>% dplyr::filter(wp_dsw) %>% pull(wp_pay) %>% mean* 100) %>% round(1)`%
- ILC water points: `r (wp_census %>% dplyr::filter(wp_ilc_device) %>% pull(wp_pay) %>% mean* 100) %>% round(1)`%
- ILC water collection points: `r (wp_census %>% dplyr::filter(wp_ilc) %>% pull(wp_pay) %>% mean * 100) %>% round(1)`%

LW: add average cost in ILC and DSW and water the payment is for 

- Average cost (all ILC water points): `r wp_census %>% filter(wp_ilc_device) %>% summarise(avg_cost = mean(wp_cost, na.rm = TRUE)) %>% pull(avg_cost) %>% round(0)` MWK
- Payment period for ILC: `r wp_census %>% filter(wp_ilc_device) %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period)`

- Average cost (all DSW water points): `r wp_census %>% filter(wp_dsw) %>% summarise(avg_cost = mean(wp_cost, na.rm = TRUE)) %>% pull(avg_cost) %>% round(0)` MWK
- Payment period for DSW: `r wp_census %>% filter(wp_dsw) %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period)`

```{r}


payment_summary <- tibble(
  Group = c(
    "Overall",
    "DSW",
    "ILC water points",
    "ILC water collection points"
  ),
  `Paying (%)` = c(
    wp_census %>% pull(wp_pay) %>% mean(na.rm = TRUE) * 100,
    wp_census %>% filter(wp_dsw) %>% pull(wp_pay) %>% mean(na.rm = TRUE) * 100,
    wp_census %>% filter(wp_ilc_device) %>% pull(wp_pay) %>% mean(na.rm = TRUE) * 100,
    wp_census %>% filter(wp_ilc) %>% pull(wp_pay) %>% mean(na.rm = TRUE) * 100
  ) %>% round(1),
  `Avg. Cost (MWK)` = c(
    wp_census %>% pull(wp_cost) %>% mean(na.rm = TRUE),
    wp_census %>% filter(wp_dsw) %>% pull(wp_cost) %>% mean(na.rm = TRUE),
    wp_census %>% filter(wp_ilc_device) %>% pull(wp_cost) %>% mean(na.rm = TRUE),
    wp_census %>% filter(wp_ilc) %>% pull(wp_cost) %>% mean(na.rm = TRUE)
  ) %>% round(0),
  `Payment Frequency` = c(
    wp_census %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period),
    wp_census %>% filter(wp_dsw) %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period),
    wp_census %>% filter(wp_ilc_device) %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period),
    wp_census %>% filter(wp_ilc) %>% count(wp_cost_period, sort = TRUE) %>% slice(1) %>% pull(wp_cost_period)
  )
)

kable(payment_summary,
      caption = "Water Point Payment Summary by System Type",
      col.names = c("Group", "Paying (%)", "Avg. Cost (MWK)", "Most Common Payment Frequency"),
      align = "lccc") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## DSW water points

```{r}
dsw <-
  wp_census %>%
  dplyr::filter(wp_dsw == 1)
```

### Functionality

```{r}
dsw %>%
  summarise(
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1),
      .names = "{.col}_Percent"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(!is.na(.)),
      .names = "{.col}_N Obs"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(., na.rm = TRUE),
      .names = "{.col}_Count"
    )
  ) %>%
  pivot_longer(
    everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(" ", ".value")
  ) %>%
  select(" ", `N Obs`, Count, Percent)
```


### Chlorine dosage

```{r}
dsw %>%
  ggplot(
    aes(
      x = jc_mldispensed,
      fill = as.factor(jc_mllost)
    )
  ) +
  geom_vline(
    xintercept = 2.8,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_vline(
    xintercept = 3.2,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_histogram() +
  scale_fill_viridis_d() +
  theme +
  labs(
    y = "Number of dispensers",
    x = "Chlorine dose (mL)",
    fill = "Some chlorine leaked out of the calibrated cylinder"
  )
```

### Chlorine residual distribution

```{r}
dsw %>%
  select(
    `Color wheel_TCR` = disctcr_c, 
    `Color wheel_FCR` = discfcr_c, 
    Colorimeter_TCR = metertcr_c,
    Colorimeter_FCR = meterfcr_c
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("instrument", "test")
  ) %>%
  ggplot(
    aes(
      x = value,
      fill = instrument
    )
  ) +
  scale_fill_viridis_d() + 
  geom_histogram() +
  facet_grid(test ~ instrument) +
  theme +
  labs(
    x = "Chlorine residual reading (mg/L)",
    y = "Number of tests"
  ) + 
  theme(legend.position = "none")
```

<!--chapter:end:02-wp-census.Rmd-->


# Water point chlorine residual tests

Placeholder


## Number of observations
## Color wheel and colorimeter readings
## TCR and FCR readings
## Dosage and chlorine residual
## Wait time and chlorine residual
## Reported color and chlorine residual
## Water source type and chlorine residual
## Source type and chlorine residual
## Turbidity and chlorine residual
## Colorimeter IDs and chlorine residual
## Color disc IDs and chlorine residual
## Enumerator IDs and chlorine residual

<!--chapter:end:03-wp-tests.Rmd-->


# Household census

Placeholder


## Number of observations

<!--chapter:end:04-hh-census.Rmd-->


# Household survey

Placeholder


## Number of observations

<!--chapter:end:05-hh-survey.Rmd-->


# Monitoring survey

Placeholder


## Number of observations

<!--chapter:end:06-monitoring-survey.Rmd-->

