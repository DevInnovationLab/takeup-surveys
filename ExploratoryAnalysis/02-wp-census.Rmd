---
output:
  pdf_document: default
  html_document: default
---
# Water point census

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis", 
    "broom"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

```{r}
villages <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "Villages",
      "DataSets",
      "Final",
      "villages.rds"
    )
  )
```

```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry 

wp_analysis <-
  wp_census %>%
  dplyr::filter(analysis)
```


```{r}
wp_census %>%
  dplyr::filter(str_detect(intervention_type, "ILC"), sample_group == "ILC") %>%
  group_by(intervention_type) %>%
  summarise(
    across(
      c(matches("meter(*)01"), ends_with("02")),
      ~(mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>% 
  select(-contains("un")) %>%
  set_names(c("", "Colorimeter, FCR", "Colorimeter, TCR", "Color wheel, FCR", "Color wheel, TCR")) %>%
  kable(
    "html",
    caption = "Percent of tests with chlorine residual above 0.2 PPM detected"
  ) %>%
      kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

## Included in the report

```{r}
wp_census %>%
  dplyr::filter(dsw, country == "Uganda") %>%
  group_by(country, sample_group) %>%
  summarise(
    across(
      c(wp_func, disp_tank_present, jc_valve, jc_chlorine, discfcr_02, disctcr_02),
      ~mean(. %>% replace_na(FALSE), na.rm = TRUE)
    )
  )
```

```{r}
wp_census %>%
  dplyr::filter(dsw, country == "Uganda") %>%
  summarise(
    across(
      c(wp_func, disp_tank_present, jc_valve, jc_chlorine, discfcr_02, disctcr_02),
      ~mean(. %>% replace_na(FALSE), na.rm = TRUE)
    )
  )
```

```{r}
map(
  c("wp_func", "disp_tank_present", "jc_chlorine", "jc_valve", "discfcr_02", "disctcr_02"),
  ~ lm(
    paste(., "~ sample_group") %>% as.formula,
    data = wp_census %>%
      mutate(
        across(
          c(wp_func, disp_tank_present, jc_chlorine, jc_valve, discfcr_02, disctcr_02),
          ~ replace_na(., FALSE)
        )
    ) %>%
    dplyr::filter(dsw, country == "Uganda") 
  ) %>% 
  tidy 
) %>% 
  bind_rows() %>%
  mutate(p.value = round(p.value, 3))
```




### Main table

```{r}
totals <-
  wp_census %>%
  transmute(
    country, sample_group, village_id, wp_id,
    `DSW water points` = intervention_type == "DSW",
    `ILC water points` = intervention_type == "ILC water point",
    `ILC water collection points` = intervention_type == "ILC water collection point"
  ) %>%
  group_by(country, sample_group) %>%
  summarise(
    Villages = n_distinct(village_id),
    `Water points`= n_distinct(wp_id),
    across(
      -c(village_id, wp_id),
      ~ sum(., na.rm = TRUE)
    )
  )
```

```{r}
village_average <-
  wp_census %>%
  transmute(
    country, sample_group, village_id,
    `DSW water points` = intervention_type == "DSW",
    `ILC water points` = intervention_type == "ILC water point",
    `ILC water collection points` = intervention_type == "ILC water collection point"
  ) %>%
  group_by(village_id, country, sample_group) %>%
  summarise(
    across(
      everything(),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  group_by(country, sample_group) %>%
  summarise(
    across(
      -village_id,
      ~ mean(., na.rm = TRUE) %>% round(1)
    )
  )
```

```{r}
totals_country <-
  wp_census %>%
  transmute(
    country, village_id, wp_id,
    `DSW water points` = intervention_type == "DSW",
    `ILC water points` = intervention_type == "ILC water point",
    `ILC water collection points` = intervention_type == "ILC water collection point"
  ) %>%
  group_by(country) %>%
  summarise(
    Villages = n_distinct(village_id),
    `Water points` = n_distinct(wp_id),
    across(
      -c(village_id, wp_id),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  mutate(sample_group = "Total")
```

```{r}
village_av_country <-
  wp_census %>%
  transmute(
    country, village_id,
    `DSW water points` = intervention_type == "DSW",
    `ILC water points` = intervention_type == "ILC water point",
    `ILC water collection points` = intervention_type == "ILC water collection point"
  ) %>%
  group_by(village_id, country) %>%
  summarise(
    across(
      everything(),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  group_by(country) %>%
  summarise(
    across(
      -village_id,
      ~ mean(., na.rm = TRUE) %>% round(1)
    )
  ) %>%
  mutate(
    sample_group = "Total"
  )
```

```{r}
table <-
  totals %>%
  left_join(village_average, by = c("country", "sample_group")) %>%
  rename_with(~ str_remove_all(., ".x")) %>%
  bind_rows(totals_country) %>%
  arrange(country, sample_group) %>%
  select(
    country, sample_group, Villages,
    starts_with("DSW"),
    starts_with("ILC water point"),
    everything()
  )
```

```{r}
table
```


## Functionality and sample sizes


```{r}
evac <-
  villages %>%
  dplyr::filter(visited == "In sample") %>%
  group_by(country, sample_group, village_id) %>%
  summarise(
    across(
      c(dsw_wpt, ilc_wpt, ilc_wcp),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  group_by(country, sample_group) %>%
  summarise(
    n_villages = n_distinct(village_id),
    across(
      c(dsw_wpt, ilc_wpt, ilc_wcp),
      list(
        n = ~ sum(.),
        mean = ~ mean(.),
        sd = ~ sd(.)
      )
    )
  )
```
```{r}
evac <-
  villages %>%
  dplyr::filter(visited == "In sample") %>%
  group_by(country) %>%
  summarise(
    across(
      c(dsw_wpt, ilc_wpt, ilc_wcp),
      ~ sum(., na.rm = TRUE)
    )
  )
```

```{r}
dsw_func <-
  wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  mutate(disp_func = disp_tank_present & jc_valve) %>%
  group_by(country, sample_group, village_id) %>%
  summarise(
    `Identified` = n_distinct(wp_id),
    `WP functional` = sum(wp_func & !is.na(wp_func), na.rm = TRUE),
    `Dispenser functional` = sum(disp_func & !is.na(disp_func), na.rm = TRUE),
    Filled = sum(jc_chlorine, na.rm = TRUE)
  ) %>%
  group_by(country, sample_group) %>%
  summarise(
    `Village average` = mean(`Identified`) %>% round(2),
    across(
      c(`Identified`, `WP functional`, `Dispenser functional`, Filled),
      ~ sum(.)
    )
  ) %>%
  left_join(
    evac %>%
      transmute(
        country, sample_group, n_villages, dsw_wpt_n, 
        dsw_wpt_mean = round(dsw_wpt_mean, 2)
      ),
    .
  ) %>%
  select(
    "country", "sample_group", "n_villages", "dsw_wpt_n", "dsw_wpt_mean",
    "Identified", everything()
  )

dsw_func %>%
  write_csv(
    file.path(
      path_git,
      "output",
      "tables",
      "wp-dsw-func.csv"
    )
  )
```

```{r}
dsw_country <-
  wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  mutate(disp_func = disp_tank_present & jc_valve) %>%
  group_by(country) %>%
  summarise(
    `Identified` = n_distinct(wp_id),
    `WP functional` = sum(wp_func & !is.na(wp_func), na.rm = TRUE),
    `Dispenser functional` = sum(disp_func & !is.na(disp_func), na.rm = TRUE),
    Filled = sum(jc_chlorine, na.rm = TRUE)
  ) 
```


```{r}
wp_census %>%
  dplyr::filter(str_detect(intervention_type, "ILC")) %>%
  mutate(wpt = intervention_type == "ILC water point") %>%
  group_by(country, sample_group) %>%
  summarise(
    `All` = n_distinct(village_id),
    `WP` = if_else(wpt, village_id, NA) %>% n_distinct,
    `WP Identified` = sum(wpt),
    `WP Functional` = sum(wpt & wp_func),
    `WCP Identified` = n_distinct(wp_id),
    `WCP Functional` = sum(wp_func),
    `WCP Tested with colorimeter` = sum(!is.na(meter_enum)),
    `WCP Tested with color wheel` = sum(!is.na(cw_enum))
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "ILC water point") %>%
  group_by(country) %>%
  summarise(
    `Found` = n_distinct(wp_id),
    `WP functional` = sum(wp_func & !is.na(wp_func), na.rm = TRUE),
    Colorimeter = sum(!is.na(meter_enum)),
    Colorwheel = sum(!is.na(cw_enum)),
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "ILC water collection point") %>%
  group_by(country) %>%
  summarise(
    `Found` = n_distinct(wp_id),
    `WP functional` = sum(wp_func & !is.na(wp_func), na.rm = TRUE),
    Colorimeter = sum(!is.na(meter_enum)),
    Colorwheel = sum(!is.na(cw_enum)),
  )
```

```{r}
wp_census %>%
  dplyr::filter(str_detect(intervention_type, "ILC")) %>%
  mutate(
    across(
      ends_with("cr"),
      ~ na_if(., 0)
    )
  ) %>%
  summarise(
    across(
      c(
        disctcr, discfcr,
        disctcr_02, discfcr_02,
        meterfcr, metertcr,
        meterfcr_01, metertcr_01,
        metertcr_02, meterfcr_02
      ),
      ~ mean(., na.rm = TRUE)
    )
  )
```
```{r}
wp_census %>%
  group_by(country, sample_group, intervention_type) %>%
  summarise(
    matched = mean(!is.na(ea_id)),
    matched_n = sum(!is.na(ea_id)),
    notmatched_n = sum(is.na(ea_id))
  )
```
```{r}
wp_census %>%
  group_by(country, intervention_type) %>%
  summarise(
    matched = mean(!is.na(ea_id)),
    matched_n = sum(!is.na(ea_id)),
    notmatched_n = sum(is.na(ea_id))
  )
```

```{r}
wp_census %>%
  group_by(country, intervention_type) %>%
  summarise(
    matched = mean(!is.na(ea_id)),
    matched_n = sum(!is.na(ea_id)),
    notmatched_n = sum(is.na(ea_id))
  )
```
```{r}
wp_census %>%
  dplyr::filter(country == "Uganda") %>%
  tabyl(intervention_type, ea_program)
```


```{r}
wp_census %>%
  dplyr::filter(country == "Malawi") %>%
  tabyl(intervention_type, ea_program)
```
```{r}
wp_census %>%
  group_by(country, intervention_type) %>%
  summarise(
    across(
      c(meter_enum, meter_nocl_enum, cw_enum, cw_nocl_enum),
      list(
        tested_n = ~sum(!is.na(.)),
        filled = ~sum(jc_chlorine, na.rm = TRUE)
      )
    )
  )
```

```{r}
wp_census %>%
  dplyr::filter(jc_chlorine) %>%
  group_by(country) %>%
  summarise(
    across(
      c(meter_enum, meter_nocl_enum, cw_enum, cw_nocl_enum),
      list(
        tested = ~mean(!is.na(.)),
        tested_n = ~sum(!is.na(.))
      )
    )
  )
```
```{r}
wp_census %>%
  group_by(country, intervention_type) %>%
  summarise(
    matched = mean(!is.na(ea_id)),
    matched_n = sum(!is.na(ea_id))
  )
```



### Number of water points found

```{r}
census <-
  wp_census %>%
  mutate(
    ilc_wpt_census = intervention_type == "ILC water point",
    ilc_wcp_census = intervention_type == "ILC water collection point",
    dsw_wpt_census = intervention_type == "DSW",
    dsw_matched = intervention_type == "DSW" & !is.na(ea_id)
  ) %>%
  group_by(country, sample_group) %>%
  summarise(
    across(
      c(ilc_wpt_census, ilc_wcp_census, dsw_wpt_census, dsw_matched),
      ~ sum(., na.rm = TRUE)
    )
  )
```

```{r}
wp_counts <-
  villages %>%
  dplyr::filter(visited == "In sample") %>%
  group_by(country, sample_group) %>%
  summarise(
    across(
      c(dsw_wpt, ilc_wpt, ilc_wcp),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  left_join(census)
```

```{r}
wp_counts %>%
  group_by(country) %>%
  summarise(
    across(
      c(dsw_wpt, dsw_wpt_census, dsw_matched),
    ~ sum(., na.rm = TRUE)
    )
  ) %>%
  mutate(pct = dsw_wpt_census/dsw_wpt)
```

## Chlorine testing

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  group_by(country, sample_group) %>%
  summarise(
    across(
      jc_mldispensed,
      list(
        n = ~sum(!is.na(.)),
        mean = ~ mean(., na.rm = TRUE) %>% round(2),
        sd = ~ sd(., na.rm = TRUE) %>% round(2)
      )
    ),
    across(
      all_of(test_vars),
      list(
        mean = ~ mean(. * 100, na.rm = TRUE) %>% round(1)
      )
    )
  ) %>%
  write_csv(
    file.path(
      path_git,
      "output",
      "tables",
      "wp-dsw-cl.csv"
    )
  )
```

```{r}
map(
  test_vars,
  ~ lm(
    paste(., "~ sample_group") %>% as.formula,
    wp_census %>% dplyr::filter(country == "Uganda")
  ) %>% tidy
) %>% 
  bind_rows %>%
  mutate(p.value = round(p.value, 3)) %>%
  dplyr::filter(!str_detect(term, "Intercept")) %>%
  mutate(outcome = test_vars)
```


## Functionality across all water sources

```{r}
wp_census %>%
  group_by(country, sample_group) %>%
  summarise(
    wp_n = n(),
    wp_func = mean(wp_func, na.rm = TRUE)
  ) 
```
```{r}
wp_census %>%
  group_by(country, sample_group, intervention_type) %>%
  summarise(
    wp_n = n(),
    wp_func = mean(wp_func, na.rm = TRUE)
  ) 
```
```{r}
wp_census %>%
  group_by(country) %>%
  summarise(
    wp_n = n(),
    wp_func = mean(wp_func, na.rm = TRUE)
  ) 
```

```{r}
map(
  c("Uganda", "Malawi"),
  ~ lm(
    wp_func ~ sample_group,
    data = wp_census %>% dplyr::filter(country == .x)
  ) %>%
    tidy %>%
    mutate(p.value = round(p.value, 3))
)
```

## Eligible water points

```{r}
eligiblity_df <-
  wp_census %>%
  group_by(country, sample_group) %>%
  # Calculate the relevant statistics
  summarise(
    Visited =  n_distinct(wp_id),
    across(
      c(wp_multicompound, wp_drink, wp_func, analysis),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # Add labels
  rename(
    Communal = wp_multicompound,
    `Used for drinking` = wp_drink,
    Functional = wp_func,
    `In analysis sample` = analysis
  )

  # Make it one stat per line
  
```

```{r}
eligiblity_df %>%
  pivot_longer(
    cols = -c(country, sample_group),
    names_to = "Name",
    values_to = "Counts"
  ) %>%
  # Change the order in which the statistics will be displayed
  mutate(
    Name = factor(
      Name,
      levels = c("Visited", "Communal", "Used for drinking", "Functional", "In analysis sample"),
      ordered = TRUE
    )
  ) %>%
  ggplot(
    aes(
      y = Name, 
      x = Counts,
      label = Counts
    )
  ) +
  geom_col(fill = viridis(1)) + 
  geom_text(
    hjust = 1.5,
    color = "white"
  ) +
  labs(
    title = "Water Point Eligibility Criteria",
    x = "Criteria",
    y = "Number of water points satisfying criteria",
    caption = paste0(
      "Note: Cumulative data comes from ", 
      wp_census %>% pull(village_id) %>% n_distinct, 
      " villages"
    )
  ) +
  facet_grid(country ~ sample_group) +
  theme
```

## Number of water points found

```{r}
wp_analysis %>%
  dplyr::filter(country == "Uganda") %>%
  select(wp_func, dsw, ilc_wp, ilc_wcp) %>%
  mutate(
    dsw_func = case_when(dsw == 1 ~ wp_func),
    ilcwp_func = case_when(ilc_wp == 1 ~ wp_func),
    ilcwcp_func = case_when(ilc_wcp == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = dsw,
        ilcwp_n = ilc_wp,
        ilcwcp_n = ilc_wcp
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  ) %>%
  kable(
    caption = "Number of water points found in Uganda",
    col.names = c("", "N", "Functional (%)"),
    align = c("l", "c", "c")
  ) 
```

```{r}
wp_analysis %>%
  transmute(
    wp_func,
    disp_tank_present,
    jc_valve,
    jc_chlorine,
    dsw,
    meterfcr = is.na(meterfcr), metertcr = is.na(metertcr), discfcr = is.na(discfcr), disctcr = is.na(disctcr),
    tank_valve = disp_tank_present & jc_valve,
    tank_valve_chlorine = disp_tank_present & jc_valve & jc_chlorine
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),         # <- N as integer (no rounding)
           .names = "{.col}__N"),
    across(everything(),
           ~ round(mean(.x, na.rm = TRUE) * 100, 2),    # <- only percent rounded
           .names = "{.col}__pct")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N|pct)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N", "Present (%)"),
    align     = c("l", "c", "c")
  )

wp_analysis %>%
  # mutate(
  #   dsw = case_when(
  #     wp_id == "2101208052004" ~ FALSE,
  #     TRUE ~ dsw
  #   ),
  #   disp_tank_present = case_when(
  #     wp_id == "6013001" ~ TRUE,
  #     wp_id == "6013005" ~ TRUE,
  #     TRUE ~ disp_tank_present
  #   )
  # ) %>%
  dplyr::filter(wp_func) %>%
  transmute(
    dsw,
    ilc_wp,
    ilc_wcp,
    non_program = !((dsw %in% TRUE) | (ilc_wp %in% TRUE) | (ilc_wcp %in% TRUE)),
    disp_tank_present,
    jc_valve,
    jc_chlorine,
    dsw,
    meterfcr = !is.na(meterfcr) & dsw, metertcr = !is.na(metertcr) & dsw, discfcr = !is.na(discfcr) & dsw, disctcr = !is.na(disctcr) & dsw,
    tank_valve = disp_tank_present & jc_valve,
    tank_valve_chlorine = disp_tank_present & jc_valve & jc_chlorine
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),
           .names = "{.col}__N")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N"),
    align     = c("l", "c")
  )

wp_analysis %>%
  dplyr::filter(wp_func, ilc_wp) %>%
  transmute(
    ilc_wp,
    meterfcr = !is.na(meterfcr), metertcr = !is.na(metertcr), discfcr = !is.na(discfcr), disctcr = !is.na(disctcr),
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),
           .names = "{.col}__N")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N"),
    align     = c("l", "c")
  )

wp_analysis %>%
  dplyr::filter(wp_func, ilc_wcp) %>%
  transmute(
    ilc_wcp,
    meterfcr = !is.na(meterfcr), metertcr = !is.na(metertcr), discfcr = !is.na(discfcr), disctcr = !is.na(disctcr),
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),
           .names = "{.col}__N")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N"),
    align     = c("l", "c")
  )
```

### Analysis sample size

```{r}
counts_by_country <-
  wp_analysis %>%
  group_by(country) %>%
  dplyr::filter(wp_func) %>%
  summarise(
    `ILC WP` = sum(ilc_wp, na.rm = TRUE),
    `ILC WCP` = sum(ilc_wcp, na.rm = TRUE),
    `DSW WP` = sum(dsw, na.rm = TRUE),
    `ILC WP with meterfcr` = sum(ilc_wp & !is.na(meterfcr), na.rm = TRUE),
    `ILC WP with metertcr` = sum(ilc_wp & !is.na(metertcr), na.rm = TRUE),
    `ILC WCP with meterfcr`= sum(ilc_wcp & !is.na(meterfcr), na.rm = TRUE),
    `ILC WCP with metertcr`= sum(ilc_wcp & !is.na(metertcr), na.rm = TRUE),
    `DSW WP with meterfcr` = sum(dsw & !is.na(meterfcr), na.rm = TRUE),
    `DSW WP with metertcr` = sum(dsw & !is.na(metertcr), na.rm = TRUE),
    `DSW WP with discfcr` = sum(dsw & !is.na(discfcr), na.rm = TRUE),
    `DSW WP with disctcr` = sum(dsw & !is.na(disctcr), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(country)

counts_by_country %>%
  kable(
    caption = "Functional ILC WP/WCP and DSW WP with colorimeter readings",
    align = c("l","r","r","r","r","r","r","r","r","r","r","r")
  )

wp_analysis %>% dplyr::filter(wp_func, dsw) %>% nrow()
wp_analysis %>% dplyr::filter(ilc_wp) %>% nrow()
wp_analysis %>% dplyr::filter(ilc_wcp) %>% nrow()
```

### Averages by village

```{r}
wp_analysis %>%
  group_by(village_id) %>%
  summarise(
    total_wps = n(),
    dsw_wps = sum(dsw, na.rm = TRUE),
    ilc_device_wps = sum(ilc_wp == TRUE, na.rm = TRUE),
    ilc_collection_only_wps = sum(ilc_wcp == TRUE, na.rm = TRUE),
    has_dsw = any(dsw == TRUE, na.rm = TRUE),
    has_ilc = any(ilc_wcp == TRUE | ilc_wp == TRUE, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  #group_by(country) %>%
  summarise(
    "Avg. number of water points per village" = mean(total_wps),
    "Number of villages with DSW" = sum(has_dsw),
    "Avg. number of DSW water points per village (with any DSW)" = dsw_wps %>% if_else(has_dsw, ., NA) %>% mean(na.rm = TRUE),
    "Number of villages with ILC" = sum(has_ilc),
    "Avg. number of water points with ILC devices per village (with any ILC)" = ilc_device_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE),
    "Avg. number of water points with ILC collection points per village (with any ILC)" = ilc_collection_only_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE)
  ) %>%
  mutate(
    across(
      starts_with("Avg."),
      ~ round(., 1) %>% as.character()
    ),
    across(
      starts_with("Number"),
      ~ round(.)  %>% as.character()
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  kable(
    caption = "Village-level summary statistics for water points",
      col.names = c("Metric", "Value"),
      align = c("l", "r")
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Type of water points

### All water points

```{r}
wp_census %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(
    n = n()
  ) %>%
  group_by(sourcetype) %>%
  mutate(
    total = sum(n)
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = n,
      fill = intervention_type
    )
  ) +
  geom_col() +
  geom_text(
    aes(
      x = total,
      label = total
    ),
    size = 3,
    hjust = 1.2,
    color = "white"
  ) +
  theme +
  scale_fill_viridis_d() +
  labs(
    y = NULL,
    x = "Number of sources",
    fill = NULL
  )
```

### Program water points

```{r}
wp_census %>%
  dplyr::filter(intervention_type != "Non-program") %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(n = n()) %>%
  group_by(intervention_type) %>%
  mutate(
    total = sum(n),
    pct = (n/total) * 100
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = pct,
      fill = intervention_type,
      label = pct %>% round(1)
    )
  ) + 
  geom_col() +
  geom_text(
    aes(color = intervention_type),
    size = 3,
    hjust = 1.2
  ) +
  facet_wrap(~ intervention_type) +
  theme +
  scale_fill_viridis_d() +
  scale_color_viridis_d(direction = -1) +
  labs(
    y = NULL,
    x = "Percent of sources",
    fill = NULL
  )
```

## Number of water points per village

```{r}
wp_census %>%
  group_by(village_id) %>%
  summarise(
    `Water points` = n(),
    `DSW water points` = sum(dsw, na.rm = TRUE) %>% na_if(0),
    `ILC water points` = sum(ilc_wp, na.rm = TRUE) %>% na_if(0),
    `ILC water collection points` = sum(ilc_wcp, na.rm = TRUE) %>% na_if(0)
  ) %>%
  summarise(
    across(
      - village_id,
      ~ mean(., na.rm = TRUE),
      .names = "Average_{.col}"
    ),
    across(
      - village_id,
      ~ min(., na.rm = TRUE),
      .names = "Minimum_{.col}"
    ),
    across(
      - village_id,
      ~ max(., na.rm = TRUE),
      .names = "Maximum_{.col}"
    )
    ,
    across(
      - village_id,
      ~ sum(!is.na(.), na.rm = TRUE),
      .names = "N_{.col}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(".value", "Type")
  ) %>%
  select(
    Type, N, Average, Minimum, Maximum
  ) %>%
  rename(
    `Number of villages` = N
  )
```

## Water point functionality rate

- Overall: `r (wp_census %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- DSW: `r (wp_census %>% dplyr::filter(dsw) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water points: `r (wp_census %>% dplyr::filter(ilc_wp) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water collection points: `r (wp_census %>% dplyr::filter(ilc_wcp) %>% pull(wp_func) %>% mean * 100) %>% round(1)`%

## Share of paid water points

```{r}
wp_census %>%
  group_by(country) %>%
  summarise(mean(wp_pay))
```

```{r}
wp_census %>%
  group_by(intervention_type, country) %>%
  summarise(
    `Paying (%)` = (mean(wp_pay == "Yes", na.rm = TRUE) * 100) %>% round(1),
    `Payment Frequency` = wp_cost_period %>% 
              na.omit() %>%
              {names(sort(table(.), decreasing = TRUE))[1]}
  )
```


```{r eval = FALSE}
wp_census %>%
   %>%
  kable(
    caption = "Water Point Payment Summary by System Type",
    col.names = c("Group", "Country", "Paying (%)", "Avg. Cost (MWK)", "Most Common Payment Frequency"),
    align = "lcccc"
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## ILC water points

### Chlorination

```{r}
wp_census %>%
  dplyr::filter(
    str_detect(intervention_type, "ILC"), 
    country == "Malawi",
    !is.na(ea_id),
    !is.na(disctcr)
  ) %>% select(ea_id, intervention_type, ends_with("cr")) %>% view
  group_by(intervention_type) %>%
  summarise(
    meter = sum(!is.na(meter_enum), na.rm = TRUE),
    across(
      c(
        meterfcr,
        metertcr
      ),
      ~ mean(., na.rm = TRUE) %>% round(2)
    ),
    across(
        c(
        meterfcr_01,
        metertcr_01,
        meterfcr_02,
        metertcr_02
      ),
      ~ mean(. * 100, na.rm = TRUE) %>% round(1)
    )
  )
```

```{r}
wp_census %>%
  dplyr::filter(
    str_detect(intervention_type, "ILC"), 
    country == "Malawi",
    !is.na(ea_id)
  ) %>%
  group_by(intervention_type) %>%
  summarise(
    meter = sum(!is.na(meter_enum), na.rm = TRUE),
    across(
      c(
        discfcr,
        disctcr
      ),
      ~ mean(., na.rm = TRUE) %>% round(2)
    ),
    across(
      c(
        discfcr_02,
        disctcr_02
      ),
      ~ mean(. * 100, na.rm = TRUE) %>% round(1)
    )
  )
```

```{r}
wp_census %>%
  dplyr::filter(str_detect(intervention_type, "ILC"), country == "Malawi") %>%
  group_by(intervention_type) %>%
  summarise(
    N = n_distinct(wp_id),
    Functional = sum(wp_func),
    meter = sum(!is.na(meter_enum), na.rm = TRUE),
    cw = sum(!is.na(cw_enum), na.rm = TRUE),
    across(
      c(
        meterfcr,
        discfcr_02,
        meterfcr_01,
        discfcr_02,
        discfcr
      ),
      ~ mean(., na.rm = TRUE)
    )
  )
```


## DSW water points




### Functionality

WHAT'S GOING ON HERE?

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "DSW", disp_tank_present, is.na(jc_valve)) %>%
  view
```

```{r}
wp_census %>%
  dplyr::filter(wp_func, intervention_type == "DSW") %>%
  group_by(country) %>%
  mutate(
    disp_working = disp_tank_present & jc_valve
  ) %>%
  summarise(
    N = n(),
    across(
      c(
        disp_tank_present,
        jc_valve,
        `Dispenser is working` = disp_working,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine,
        meterfcr_un_01, discfcr_un_02, meterfcr_un_02,
        meterfcr_01, discfcr_02, meterfcr_02
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    ),
    across(
      c(discfcr, jc_mldispensed),
      ~ mean(., na.rm = TRUE)
    )
  )
```



```{r}
wp_census %>%
  dplyr::filter(wp_func, intervention_type == "DSW") %>%
  group_by(country) %>%
  mutate(
    disp_working = disp_tank_present & jc_valve
  ) %>%
  summarise(
    N = n(),
    across(
      c(
        disp_tank_present,
        jc_valve,
        `Dispenser is working` = disp_working,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine,
        meterfcr_un_01, discfcr_un_02, meterfcr_un_02,
        meterfcr_01, discfcr_02, meterfcr_02
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    ),
    across(
      c(discfcr, jc_mldispensed),
      ~ mean(., na.rm = TRUE)
    )
  )
```



```{r}
lm(
  disctcr ~ jc_mldispensed,
  data = wp_census
) %>% summary

lm(
  disctcr ~ jc_mldispensed,
  data = wp_census %>% dplyr::filter(country == "Malawi")
) %>% summary

lm(
  disctcr ~ jc_mldispensed,
  data = wp_census %>% dplyr::filter(country == "Uganda")
) %>% summary


wp_census %>%
  dplyr::filter(!is.na(wp_turbidity)) %>%
  tabyl(wp_turbidity, country) %>%
  adorn_percentages(denominator = "col")
```

```{r}
wp_census %>%
  dplyr::filter(wp_func, intervention_type == "DSW") %>%
  group_by(country, sample_group) %>%
  mutate(
    disp_working = disp_tank_present & jc_valve
  ) %>%
  summarise(
    N = n(),
    across(
      c(
        disp_tank_present,
        jc_valve,
        `Dispenser is working` = disp_working,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine,
        meterfcr_un_01, discfcr_un_02, meterfcr_un_02,
        meterfcr_01, discfcr_02, meterfcr_02
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    ),
    across(
      c(discfcr, jc_mldispensed),
      ~ mean(., na.rm = TRUE)
    )
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  group_by(country, sample_group) %>%
  summarise(
    N = n(),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  )
  #   across(
  #     c(
  #       `Water point is functional` = wp_func,
  #       `Casing is present` = disp_casing_present,
  #       `PVC pole is present` = disp_pvc_pole_present,
  #       `Tank is present` = disp_tank_present,
  #       `Valve is working (conditional on tank being present)` = jc_valve,
  #       `Dispenser is not empty (conditional on valve working)` = jc_chlorine
  #     ),
  #     ~ sum(!is.na(.)),
  #     .names = "{.col}_N Obs"
  #   ),
  #   across(
  #     c(
  #       `Water point is functional` = wp_func,
  #       `Casing is present` = disp_casing_present,
  #       `PVC pole is present` = disp_pvc_pole_present,
  #       `Tank is present` = disp_tank_present,
  #       `Valve is working (conditional on tank being present)` = jc_valve,
  #       `Dispenser is not empty (conditional on valve working)` = jc_chlorine
  #     ),
  #     ~ sum(., na.rm = TRUE),
  #     .names = "{.col}_Count"
  #   )
  # )
```

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  group_by(country) %>%
  summarise(
    n = n(),
    filled = sum(jc_chlorine, na.rm = TRUE),
    pct_filled = filled/n
  )
```

```{r}
wp_census %>%
  dplyr::filter(intervention_type == "DSW") %>%
  group_by(country, sample_group) %>%
  summarise(
    n = n(),
    across(
      c(jc_chlorine, discfcr_02),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  mutate(
    pct_filled = jc_chlorine/n,
    pct_fcr = discfcr_02/n
  )
```

### Chlorine dosage

```{r}
dsw %>%
  ggplot(
    aes(
      x = jc_mldispensed,
      fill = as.factor(jc_mllost)
    )
  ) +
  geom_vline(
    xintercept = 2.8,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_vline(
    xintercept = 3.2,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_histogram() +
  scale_fill_viridis_d() +
  theme +
  labs(
    y = "Number of dispensers",
    x = "Chlorine dose (mL)",
    fill = "Some chlorine leaked out of the calibrated cylinder"
  )
```

### Chlorine residual distribution

```{r}
dsw %>%
  select(
    `Color wheel_TCR` = disctcr, 
    `Color wheel_FCR` = discfcr, 
    Colorimeter_TCR = metertcr,
    Colorimeter_FCR = meterfcr
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("instrument", "test")
  ) %>%
  ggplot(
    aes(
      x = value,
      fill = instrument
    )
  ) +
  scale_fill_viridis_d() + 
  geom_density() +
  facet_grid(test ~ instrument) +
  theme +
  labs(
    x = "Chlorine residual reading (mg/L)",
    y = "Number of tests"
  ) + 
  theme(legend.position = "none")
```


### Colorimeter vs color wheel

```{r}
tol <- 0.0499

# Map columns to instrument/residual/treated
map <- tribble(
  ~col,             ~instrument,   ~residual, ~treated,
  "meterfcr_c",     "colorimeter", "FCR",     "chlorinated",
  "metertcr_c",     "colorimeter", "TCR",     "chlorinated",
  "discfcr_c",      "color wheel", "FCR",     "chlorinated",
  "disctcr_c",      "color wheel", "TCR",     "chlorinated",
  "meterfcr_un_c",  "colorimeter", "FCR",     "unchlorinated",
  "metertcr_un_c",  "colorimeter", "TCR",     "unchlorinated",
  "discfcr_un_c",   "color wheel", "FCR",     "unchlorinated",
  "disctcr_un_c",   "color wheel", "TCR",     "unchlorinated"
)

wp_cons <- read_rds(file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Constructed",
      "wp-constructed.rds"
    ))

pairs <- wp_cons %>%
  select(any_of(map$col), dsw, ilc_wp, ilc_wcp, country, wp_id) %>%  # include a unique id
  pivot_longer(cols = any_of(map$col), names_to = "col", values_to = "value") %>%
  left_join(map, by = "col") %>%
  mutate(value = as.numeric(value)) %>%
  group_by(wp_id, country, dsw, ilc_wp, ilc_wcp, instrument, treated, residual) %>%
  summarise(value = mean(value, na.rm = TRUE), .groups = "drop") %>%  # or first(na.omit(value))
  pivot_wider(names_from = residual, values_from = value) %>%
  drop_na(FCR, TCR) %>%
  mutate(system = case_when(
    isTRUE(dsw) ~ "DSW",
    isTRUE(ilc_wp) ~ "ILC_WP",
    isTRUE(ilc_wcp) ~ "ILC_WCP",
    TRUE ~ "Non-program"
  ))

overall <- pairs %>%
  group_by(instrument, treated) %>%
  summarise(
    n_pairs = n(),
    n_FCR_gt_TCR = sum(FCR > (TCR + tol)),
    pct_FCR_gt_TCR = round(100 * n_FCR_gt_TCR / n_pairs, 1),
    .groups = "drop"
  ) %>%
  arrange(treated, instrument)

overall %>% knitr::kable(
  caption = paste0("Frequency of FCR > TCR by instrument (tolerance = ", tol, " ppm)"),
  col.names = c("Instrument", "Status", "N pairs", "N (FCR > TCR)", "Percent (%)"),
  align = "lcrrr"
)
```

```{r}
wp_cons %>%
  summarise(
    across(
      .cols = any_of(c("metertcr","meterfcr","disctcr","discfcr")),
      .fns  = ~ mean(., na.rm = TRUE),
      .names = "{.col}_mean"
    )
  )
```

```{r}
library(dplyr)

overall_fp <- wp_cons %>%
  summarise(
    n_meter_un   = sum(!is.na(metertcr_un_c)),
    n_meter_02_pos = sum(metertcr_un_c > 0.199, na.rm = T),
    pct_meter_02_un = round(100 * mean(metertcr_un_c > (0.199), na.rm = TRUE), 2),
    n_meter_01_pos = sum(metertcr_un_c > 0.099, na.rm = T),
    pct_meter_01_un = round(100 * mean(metertcr_un_c > (0.099), na.rm = TRUE), 2),
    n_disc_un    = sum(!is.na(disctcr_un_c)),
    n_disc_pos = sum(disctcr_un_c > 0.1, na.rm = T),
    pct_disc_un  = round(100 * mean(disctcr_un_c  > (0.1), na.rm = TRUE), 2)
  )

overall_fp

```

## Nonfunctionality of ILC water points

```{r}
ilc_wp <- wp_constructed %>% dplyr::filter(intervention_type == "ILC water point", !wp_func) %>%
  select(wp_id,key,country,dsw,ilc_wp, ilc_wcp, wp_ilc_evac, wp_ilc_device_c, sourcetype, wp_type_o, wp_func_reason_ilc:wp_func_last)
ilc_wcp <- wp_constructed %>% dplyr::filter(intervention_type == "ILC water collection point", !wp_func) %>%
  select(wp_id,key,country,dsw,ilc_wp, ilc_wcp, wp_ilc_evac, wp_ilc_device_c, sourcetype, wp_type_o, wp_func_reason_ilc:wp_func_last)

view(ilc_wcp)
```
