---
output:
  pdf_document: default
  html_document: default
---
# Water point census

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```


```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry %>%
  # Calculate which WPs will be included in analysis -- this is being moved to the processing code
  mutate(analysis = wp_multicompound & wp_drink) 

wp_analysis <-
  wp_census %>%
  dplyr::filter(analysis)
```

## Eligible water points

```{r}
eligiblity_df <-
  wp_census %>%
  # Calculate the relevant statistics
  summarise(
    Visited =  n_distinct(wp_id),
    across(
      c(wp_multicompound, wp_drink, wp_func, analysis),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # Add labels
  rename(
    Communal = wp_multicompound,
    `Used for drinking` = wp_drink,
    Functional = wp_func,
    `In analysis sample` = analysis
  ) %>%
  # Make it one stat per line
  pivot_longer(
    cols = everything(),
    names_to = "Name",
    values_to = "Counts"
  ) %>%
  # Change the order in which the statistics will be displayed
  mutate(
    Name = factor(
      Name,
      levels = c("Visited", "Communal", "Used for drinking", "Functional", "In analysis sample"),
      ordered = TRUE
    )
  )
```

```{r}
eligiblity_df %>%
  ggplot(
    aes(
      x = Name, 
      y = Counts,
      label = Counts
    )
  ) +
  geom_col(fill = viridis(1)) + 
  geom_text(
    vjust = 1.5,
    color = "white"
  ) +
  labs(
    title = "Water Point Eligibility Criteria",
    x = "Criteria",
    y = "Number of water points satisfying criteria",
    caption = paste0(
      "Note: Cumulative data comes from ", 
      wp_census %>% pull(village_id) %>% n_distinct, 
      " villages"
    )
  ) + 
  theme
```

## Number of water points found

```{r}
wp_analysis %>%
  dplyr::filter(country == "Malawi") %>%
  select(wp_func, dsw, ilc_wp, ilc_wcp) %>%
  mutate(
    dsw_func = case_when(dsw == 1 ~ wp_func),
    ilcwp_func = case_when(ilc_wp == 1 ~ wp_func),
    ilcwcp_func = case_when(ilc_wcp == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = dsw,
        ilcwp_n = ilc_wp,
        ilcwcp_n = ilc_wcp
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  ) %>%
  kable(
    caption = "Number of water points found in Malawi",
    col.names = c("", "N", "Functional (%)"),
    align = c("l", "c", "c")
  ) 
```

```{r}
wp_analysis %>%
  dplyr::filter(country == "Uganda") %>%
  select(wp_func, dsw, ilc_wp, ilc_wcp) %>%
  mutate(
    dsw_func = case_when(dsw == 1 ~ wp_func),
    ilcwp_func = case_when(ilc_wp == 1 ~ wp_func),
    ilcwcp_func = case_when(ilc_wcp == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = dsw,
        ilcwp_n = ilc_wp,
        ilcwcp_n = ilc_wcp
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  ) %>%
  kable(
    caption = "Number of water points found in Uganda",
    col.names = c("", "N", "Functional (%)"),
    align = c("l", "c", "c")
  ) 
```

```{r}
wp_analysis %>%
  transmute(
    wp_func,
    disp_tank_present,
    jc_valve,
    jc_chlorine,
    dsw,
    meterfcr = is.na(meterfcr), metertcr = is.na(metertcr), discfcr = is.na(discfcr), disctcr = is.na(disctcr),
    tank_valve = disp_tank_present & jc_valve,
    tank_valve_chlorine = disp_tank_present & jc_valve & jc_chlorine
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),         # <- N as integer (no rounding)
           .names = "{.col}__N"),
    across(everything(),
           ~ round(mean(.x, na.rm = TRUE) * 100, 2),    # <- only percent rounded
           .names = "{.col}__pct")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N|pct)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N", "Present (%)"),
    align     = c("l", "c", "c")
  )

wp_analysis %>%
  # mutate(
  #   dsw = case_when(
  #     wp_id == "2101208052004" ~ FALSE,
  #     TRUE ~ dsw
  #   ),
  #   disp_tank_present = case_when(
  #     wp_id == "6013001" ~ TRUE,
  #     wp_id == "6013005" ~ TRUE,
  #     TRUE ~ disp_tank_present
  #   )
  # ) %>%
  dplyr::filter(wp_func) %>%
  transmute(
    dsw,
    ilc_wp,
    ilc_wcp,
    non_program = !((dsw %in% TRUE) | (ilc_wp %in% TRUE) | (ilc_wcp %in% TRUE)),
    disp_tank_present,
    jc_valve,
    jc_chlorine,
    dsw,
    meterfcr = !is.na(meterfcr) & dsw, metertcr = !is.na(metertcr) & dsw, discfcr = !is.na(discfcr) & dsw, disctcr = !is.na(disctcr) & dsw,
    tank_valve = disp_tank_present & jc_valve,
    tank_valve_chlorine = disp_tank_present & jc_valve & jc_chlorine
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),
           .names = "{.col}__N")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N"),
    align     = c("l", "c")
  )

wp_analysis %>%
  dplyr::filter(wp_func, ilc_wp) %>%
  transmute(
    ilc_wp,
    meterfcr = !is.na(meterfcr), metertcr = !is.na(metertcr), discfcr = !is.na(discfcr), disctcr = !is.na(disctcr),
  ) %>%
  summarise(
    across(everything(),
           ~ as.integer(sum(.x, na.rm = TRUE)),
           .names = "{.col}__N")
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c(" ", ".value"),
    names_pattern = "(.*)__(N)"
  ) %>%
  kable(
    caption   = "Number of water points found",
    col.names = c("", "N"),
    align     = c("l", "c")
  )
```

### Analysis sample size

```{r}
counts_by_country <-
  wp_analysis %>%
  group_by(country) %>%
  dplyr::filter(wp_func) %>%
  summarise(
    `ILC WP` = sum(ilc_wp, na.rm = TRUE),
    `ILC WCP` = sum(ilc_wcp, na.rm = TRUE),
    `DSW WP` = sum(dsw, na.rm = TRUE),
    `ILC WP with meterfcr` = sum(ilc_wp & !is.na(meterfcr), na.rm = TRUE),
    `ILC WP with metertcr` = sum(ilc_wp & !is.na(metertcr), na.rm = TRUE),
    `ILC WCP with meterfcr`= sum(ilc_wcp & !is.na(meterfcr), na.rm = TRUE),
    `ILC WCP with metertcr`= sum(ilc_wcp & !is.na(metertcr), na.rm = TRUE),
    `DSW WP with meterfcr` = sum(dsw & !is.na(meterfcr), na.rm = TRUE),
    `DSW WP with metertcr` = sum(dsw & !is.na(metertcr), na.rm = TRUE),
    `DSW WP with discfcr` = sum(dsw & !is.na(discfcr), na.rm = TRUE),
    `DSW WP with disctcr` = sum(dsw & !is.na(disctcr), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(country)

ilc_meter_counts_by_country %>%
  kable(
    caption = "Functional ILC WP/WCP and DSW WP with colorimeter readings",
    align = c("l","r","r","r","r","r","r","r","r","r","r","r")
  )

wp_analysis %>% dplyr::filter(wp_func, dsw) %>% nrow()
wp_analysis %>% dplyr::filter(ilc_wp) %>% nrow()
wp_analysis %>% dplyr::filter(ilc_wcp) %>% nrow()
```

### Averages by village

```{r}
wp_analysis %>%
  group_by(village_id) %>%
  summarise(
    total_wps = n(),
    dsw_wps = sum(dsw, na.rm = TRUE),
    ilc_device_wps = sum(ilc_wp == TRUE, na.rm = TRUE),
    ilc_collection_only_wps = sum(ilc_wcp == TRUE, na.rm = TRUE),
    has_dsw = any(dsw == TRUE, na.rm = TRUE),
    has_ilc = any(ilc_wcp == TRUE | ilc_wp == TRUE, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  #group_by(country) %>%
  summarise(
    "Avg. number of water points per village" = mean(total_wps),
    "Number of villages with DSW" = sum(has_dsw),
    "Avg. number of DSW water points per village (with any DSW)" = dsw_wps %>% if_else(has_dsw, ., NA) %>% mean(na.rm = TRUE),
    "Number of villages with ILC" = sum(has_ilc),
    "Avg. number of water points with ILC devices per village (with any ILC)" = ilc_device_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE),
    "Avg. number of water points with ILC collection points per village (with any ILC)" = ilc_collection_only_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE)
  ) %>%
  mutate(
    across(
      starts_with("Avg."),
      ~ round(., 1) %>% as.character()
    ),
    across(
      starts_with("Number"),
      ~ round(.)  %>% as.character()
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  kable(
    caption = "Village-level summary statistics for water points",
      col.names = c("Metric", "Value"),
      align = c("l", "r")
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Type of water points

### All water points

```{r}
wp_census %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(
    n = n()
  ) %>%
  group_by(sourcetype) %>%
  mutate(
    total = sum(n)
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = n,
      fill = intervention_type
    )
  ) +
  geom_col() +
  geom_text(
    aes(
      x = total,
      label = total
    ),
    size = 3,
    hjust = 1.2,
    color = "white"
  ) +
  theme +
  scale_fill_viridis_d() +
  labs(
    y = NULL,
    x = "Number of sources",
    fill = NULL
  )
```

### Program water points

```{r}
wp_census %>%
  dplyr::filter(intervention_type != "Non-program") %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(n = n()) %>%
  group_by(intervention_type) %>%
  mutate(
    total = sum(n),
    pct = (n/total) * 100
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = pct,
      fill = intervention_type,
      label = pct %>% round(1)
    )
  ) + 
  geom_col() +
  geom_text(
    aes(color = intervention_type),
    size = 3,
    hjust = 1.2
  ) +
  facet_wrap(~ intervention_type) +
  theme +
  scale_fill_viridis_d() +
  scale_color_viridis_d(direction = -1) +
  labs(
    y = NULL,
    x = "Percent of sources",
    fill = NULL
  )
```

## Number of water points per village

```{r}
wp_census %>%
  group_by(village_id) %>%
  summarise(
    `Water points` = n(),
    `DSW water points` = sum(dsw, na.rm = TRUE) %>% na_if(0),
    `ILC water points` = sum(ilc_wp, na.rm = TRUE) %>% na_if(0),
    `ILC water collection points` = sum(ilc_wcp, na.rm = TRUE) %>% na_if(0)
  ) %>%
  summarise(
    across(
      - village_id,
      ~ mean(., na.rm = TRUE),
      .names = "Average_{.col}"
    ),
    across(
      - village_id,
      ~ min(., na.rm = TRUE),
      .names = "Minimum_{.col}"
    ),
    across(
      - village_id,
      ~ max(., na.rm = TRUE),
      .names = "Maximum_{.col}"
    )
    ,
    across(
      - village_id,
      ~ sum(!is.na(.), na.rm = TRUE),
      .names = "N_{.col}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(".value", "Type")
  ) %>%
  select(
    Type, N, Average, Minimum, Maximum
  ) %>%
  rename(
    `Number of villages` = N
  )
```

## Water point functionality rate

- Overall: `r (wp_census %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- DSW: `r (wp_census %>% dplyr::filter(dsw) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water points: `r (wp_census %>% dplyr::filter(ilc_wp) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water collection points: `r (wp_census %>% dplyr::filter(ilc_wcp) %>% pull(wp_func) %>% mean * 100) %>% round(1)`%

## Share of paid water points

```{r}
wp_census %>%
  group_by(country) %>%
  summarise(mean(wp_pay))
```

```{r}
wp_census %>%
  group_by(intervention_type, country) %>%
  summarise(
    `Paying (%)` = (mean(wp_pay == "Yes", na.rm = TRUE) * 100) %>% round(1),
    `Payment Frequency` = wp_cost_period %>% 
              na.omit() %>%
              {names(sort(table(.), decreasing = TRUE))[1]}
  )
```


```{r eval = FALSE}
wp_census %>%
   %>%
  kable(
    caption = "Water Point Payment Summary by System Type",
    col.names = c("Group", "Country", "Paying (%)", "Avg. Cost (MWK)", "Most Common Payment Frequency"),
    align = "lcccc"
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## DSW water points

```{r}
dsw <-
  wp_census %>%
  dplyr::filter(dsw == 1)
```

### Functionality

```{r}
dsw %>%
  summarise(
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1),
      .names = "{.col}_Percent"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(!is.na(.)),
      .names = "{.col}_N Obs"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(., na.rm = TRUE),
      .names = "{.col}_Count"
    )
  ) %>%
  pivot_longer(
    everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(" ", ".value")
  ) %>%
  select(" ", `N Obs`, Count, Percent)
```

### Chlorine dosage

```{r}
dsw %>%
  ggplot(
    aes(
      x = jc_mldispensed,
      fill = as.factor(jc_mllost)
    )
  ) +
  geom_vline(
    xintercept = 2.8,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_vline(
    xintercept = 3.2,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_histogram() +
  scale_fill_viridis_d() +
  theme +
  labs(
    y = "Number of dispensers",
    x = "Chlorine dose (mL)",
    fill = "Some chlorine leaked out of the calibrated cylinder"
  )
```

### Chlorine residual distribution

```{r}
dsw %>%
  select(
    `Color wheel_TCR` = disctcr, 
    `Color wheel_FCR` = discfcr, 
    Colorimeter_TCR = metertcr,
    Colorimeter_FCR = meterfcr
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("instrument", "test")
  ) %>%
  ggplot(
    aes(
      x = value,
      fill = instrument
    )
  ) +
  scale_fill_viridis_d() + 
  geom_density() +
  facet_grid(test ~ instrument) +
  theme +
  labs(
    x = "Chlorine residual reading (mg/L)",
    y = "Number of tests"
  ) + 
  theme(legend.position = "none")
```


### Colorimeter vs color wheel

```{r}
tol <- 0.0499

# Map columns to instrument/residual/treated
map <- tribble(
  ~col,             ~instrument,   ~residual, ~treated,
  "meterfcr_c",     "colorimeter", "FCR",     "chlorinated",
  "metertcr_c",     "colorimeter", "TCR",     "chlorinated",
  "discfcr_c",      "color wheel", "FCR",     "chlorinated",
  "disctcr_c",      "color wheel", "TCR",     "chlorinated",
  "meterfcr_un_c",  "colorimeter", "FCR",     "unchlorinated",
  "metertcr_un_c",  "colorimeter", "TCR",     "unchlorinated",
  "discfcr_un_c",   "color wheel", "FCR",     "unchlorinated",
  "disctcr_un_c",   "color wheel", "TCR",     "unchlorinated"
)

wp_cons <- read_rds(file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Constructed",
      "wp-constructed.rds"
    ))

pairs <- wp_cons %>%
  select(any_of(map$col), dsw, ilc_wp, ilc_wcp, country, wp_id) %>%  # include a unique id
  pivot_longer(cols = any_of(map$col), names_to = "col", values_to = "value") %>%
  left_join(map, by = "col") %>%
  mutate(value = as.numeric(value)) %>%
  group_by(wp_id, country, dsw, ilc_wp, ilc_wcp, instrument, treated, residual) %>%
  summarise(value = mean(value, na.rm = TRUE), .groups = "drop") %>%  # or first(na.omit(value))
  pivot_wider(names_from = residual, values_from = value) %>%
  drop_na(FCR, TCR) %>%
  mutate(system = case_when(
    isTRUE(dsw) ~ "DSW",
    isTRUE(ilc_wp) ~ "ILC_WP",
    isTRUE(ilc_wcp) ~ "ILC_WCP",
    TRUE ~ "Non-program"
  ))

overall <- pairs %>%
  group_by(instrument, treated) %>%
  summarise(
    n_pairs = n(),
    n_FCR_gt_TCR = sum(FCR > (TCR + tol)),
    pct_FCR_gt_TCR = round(100 * n_FCR_gt_TCR / n_pairs, 1),
    .groups = "drop"
  ) %>%
  arrange(treated, instrument)

overall %>% knitr::kable(
  caption = paste0("Frequency of FCR > TCR by instrument (tolerance = ", tol, " ppm)"),
  col.names = c("Instrument", "Status", "N pairs", "N (FCR > TCR)", "Percent (%)"),
  align = "lcrrr"
)
```

```{r}
wp_cons %>%
  summarise(
    across(
      .cols = any_of(c("metertcr","meterfcr","disctcr","discfcr")),
      .fns  = ~ mean(., na.rm = TRUE),
      .names = "{.col}_mean"
    )
  )
```

```{r}
library(dplyr)

overall_fp <- wp_cons %>%
  summarise(
    n_meter_un   = sum(!is.na(metertcr_un_c)),
    n_meter_02_pos = sum(metertcr_un_c > 0.199, na.rm = T),
    pct_meter_02_un = round(100 * mean(metertcr_un_c > (0.199), na.rm = TRUE), 2),
    n_meter_01_pos = sum(metertcr_un_c > 0.099, na.rm = T),
    pct_meter_01_un = round(100 * mean(metertcr_un_c > (0.099), na.rm = TRUE), 2),
    n_disc_un    = sum(!is.na(disctcr_un_c)),
    n_disc_pos = sum(disctcr_un_c > 0.1, na.rm = T),
    pct_disc_un  = round(100 * mean(disctcr_un_c  > (0.1), na.rm = TRUE), 2)
  )

overall_fp

```
