---
output:
  pdf_document: default
  html_document: default
---
# Water point census

```{r}
packages <-
  c(
    "stringr",
    "sf",
    "tidyverse",
    "viridis"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```


```{r}
wp_census <-
  read_rds(
    file.path(
      path_box,
      "Data",
      "WaterPointCensus",
      "DataSets",
      "Final",
      "wp-census.rds"
    )
  ) %>%
  st_drop_geometry %>%
  # Calculate which WPs will be included in analysis -- this is being moved to the processing code
  mutate(analysis = wp_multicompound & wp_drink) 

wp_analysis <-
  wp_census %>%
  dplyr::filter(analysis)
```

## Eligible water points

```{r}
eligiblity_df <-
  wp_census %>%
  # Calculate the relevanat statistics
  summarise(
    Visited =  n_distinct(wp_id),
    across(
      c(wp_multicompound, wp_drink, wp_func, analysis),
      ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # Add labels
  rename(
    Communal = wp_multicompound,
    `Used for drinking` = wp_drink,
    Functional = wp_func,
    `In analysis sample` = analysis
  ) %>%
  # Make it one stat per line
  pivot_longer(
    cols = everything(),
    names_to = "Name",
    values_to = "Counts"
  ) %>%
  # Change the order in which the statistics will be displayed
  mutate(
    Name = factor(
      Name,
      levels = c("Visited", "Communal", "Used for drinking", "Functional", "In analysis sample"),
      ordered = TRUE
    )
  )
```

```{r}
eligiblity_df %>%
  ggplot(
    aes(
      x = Name, 
      y = Counts,
      label = Counts
    )
  ) +
  geom_col(fill = viridis(1)) + 
  geom_text(
    vjust = 1.5,
    color = "white"
  ) +
  labs(
    title = "Water Point Eligibility Criteria",
    x = "Criteria",
    y = "Number of water points satisfying criteria",
    caption = paste0(
      "Note: Cumulative data comes from ", 
      wp_census %>% pull(village_id) %>% n_distinct, 
      " villages"
    )
  ) + 
  theme
```

## Number of water points found

```{r}
wp_analysis %>%
  dplyr::filter(country == "Malawi") %>%
  select(wp_func, dsw, ilc_wp, ilc_wcp) %>%
  mutate(
    dsw_func = case_when(dsw == 1 ~ wp_func),
    ilcwp_func = case_when(ilc_wp == 1 ~ wp_func),
    ilcwcp_func = case_when(ilc_wcp == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = dsw,
        ilcwp_n = ilc_wp,
        ilcwcp_n = ilc_wcp
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  ) %>%
  kable(
    caption = "Number of water points found in Malawi",
    col.names = c("", "N", "Functional (%)"),
    align = c("l", "c", "c")
  ) 
```

```{r}
wp_analysis %>%
  dplyr::filter(country == "Uganda") %>%
  select(wp_func, dsw, ilc_wp, ilc_wcp) %>%
  mutate(
    dsw_func = case_when(dsw == 1 ~ wp_func),
    ilcwp_func = case_when(ilc_wp == 1 ~ wp_func),
    ilcwcp_func = case_when(ilc_wcp == 1 ~ wp_func),
  ) %>%
  summarise(
    wp_n = n(),
    across(
      c(
        dsw_n = dsw,
        ilcwp_n = ilc_wp,
        ilcwcp_n = ilc_wcp
      ),
      ~ sum(., na.rm = TRUE)
    ),
    across(
      ends_with("func"),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1)
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("type", ".value")
  ) %>%
  set_names(c(" ", "N", "Percent functioning")) %>%
  mutate(
    ` ` = c("All water points", "DSW", "ILC water points", "ILC water collection points")
  ) %>%
  kable(
    caption = "Number of water points found in Uganda",
    col.names = c("", "N", "Functional (%)"),
    align = c("l", "c", "c")
  ) 
```

### Averages by village

```{r}
wp_analysis %>%
  group_by(village_id) %>%
  summarise(
    total_wps = n(),
    dsw_wps = sum(dsw, na.rm = TRUE),
    ilc_device_wps = sum(ilc_wp == TRUE, na.rm = TRUE),
    ilc_collection_only_wps = sum(ilc_wcp == TRUE, na.rm = TRUE),
    has_dsw = any(dsw == TRUE, na.rm = TRUE),
    has_ilc = any(ilc_wcp == TRUE | ilc_wp == TRUE, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  #group_by(country) %>%
  summarise(
    "Avg. number of water points per village" = mean(total_wps),
    "Number of villages with DSW" = sum(has_dsw),
    "Avg. number of DSW water points per village (with any DSW)" = dsw_wps %>% if_else(has_dsw, ., NA) %>% mean(na.rm = TRUE),
    "Number of villages with ILC" = sum(has_ilc),
    "Avg. number of water points with ILC devices per village (with any ILC)" = ilc_device_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE),
    "Avg. number of water points with ILC collection points per village (with any ILC)" = ilc_collection_only_wps %>% if_else(has_ilc, ., NA) %>% mean(na.rm = TRUE)
  ) %>%
  mutate(
    across(
      starts_with("Avg."),
      ~ round(., 1) %>% as.character()
    ),
    across(
      starts_with("Number"),
      ~ round(.)  %>% as.character()
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  kable(
    caption = "Village-level summary statistics for water points",
      col.names = c("Metric", "Value"),
      align = c("l", "r")
  ) %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover")
  )
```

## Type of water points

### All water points

```{r}
wp_census %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(
    n = n()
  ) %>%
  group_by(sourcetype) %>%
  mutate(
    total = sum(n)
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = n,
      fill = intervention_type
    )
  ) +
  geom_col() +
  geom_text(
    aes(
      x = total,
      label = total
    ),
    size = 3,
    hjust = 1.2,
    color = "white"
  ) +
  theme +
  scale_fill_viridis_d() +
  labs(
    y = NULL,
    x = "Number of sources",
    fill = NULL
  )
```

### Program water points

```{r}
wp_census %>%
  dplyr::filter(intervention_type != "Non-program") %>%
  group_by(sourcetype, intervention_type) %>%
  summarise(n = n()) %>%
  group_by(intervention_type) %>%
  mutate(
    total = sum(n),
    pct = (n/total) * 100
  ) %>%
  ggplot(
    aes(
      y = sourcetype,
      x = pct,
      fill = intervention_type,
      label = pct %>% round(1)
    )
  ) + 
  geom_col() +
  geom_text(
    aes(color = intervention_type),
    size = 3,
    hjust = 1.2
  ) +
  facet_wrap(~ intervention_type) +
  theme +
  scale_fill_viridis_d() +
  scale_color_viridis_d(direction = -1) +
  labs(
    y = NULL,
    x = "Percent of sources",
    fill = NULL
  )
```

## Number of water points per village

```{r}
wp_census %>%
  group_by(village_id) %>%
  summarise(
    `Water points` = n(),
    `DSW water points` = sum(dsw, na.rm = TRUE) %>% na_if(0),
    `ILC water points` = sum(ilc_wp, na.rm = TRUE) %>% na_if(0),
    `ILC water collection points` = sum(ilc_wcp, na.rm = TRUE) %>% na_if(0)
  ) %>%
  summarise(
    across(
      - village_id,
      ~ mean(., na.rm = TRUE),
      .names = "Average_{.col}"
    ),
    across(
      - village_id,
      ~ min(., na.rm = TRUE),
      .names = "Minimum_{.col}"
    ),
    across(
      - village_id,
      ~ max(., na.rm = TRUE),
      .names = "Maximum_{.col}"
    )
    ,
    across(
      - village_id,
      ~ sum(!is.na(.), na.rm = TRUE),
      .names = "N_{.col}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(".value", "Type")
  ) %>%
  select(
    Type, N, Average, Minimum, Maximum
  ) %>%
  rename(
    `Number of villages` = N
  )
```

## Water point functionality rate

- Overall: `r (wp_census %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- DSW: `r (wp_census %>% dplyr::filter(dsw) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water points: `r (wp_census %>% dplyr::filter(ilc_wp) %>% pull(wp_func) %>% mean* 100) %>% round(1)`%
- ILC water collection points: `r (wp_census %>% dplyr::filter(ilc_wcp) %>% pull(wp_func) %>% mean * 100) %>% round(1)`%

## Share of paid water points

```{r}
wp_census %>%
  group_by(country) %>%
  summarise(mean(wp_pay))
```

```{r}
wp_census %>%
  group_by(intervention_type, country) %>%
  summarise(
    `Paying (%)` = (mean(wp_pay == "Yes", na.rm = TRUE) * 100) %>% round(1),
    `Payment Frequency` = wp_cost_period %>% 
              na.omit() %>%
              {names(sort(table(.), decreasing = TRUE))[1]}
  )
```


```{r eval = FALSE}
wp_census %>%
   %>%
  kable(
    caption = "Water Point Payment Summary by System Type",
    col.names = c("Group", "Country", "Paying (%)", "Avg. Cost (MWK)", "Most Common Payment Frequency"),
    align = "lcccc"
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## DSW water points

```{r}
dsw <-
  wp_census %>%
  dplyr::filter(dsw == 1)
```

### Functionality

```{r}
dsw %>%
  summarise(
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ (mean(., na.rm = TRUE) * 100) %>% round(1),
      .names = "{.col}_Percent"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(!is.na(.)),
      .names = "{.col}_N Obs"
    ),
    across(
      c(
        `Water point is functional` = wp_func,
        `Casing is present` = disp_casing_present,
        `PVC pole is present` = disp_pvc_pole_present,
        `Tank is present` = disp_tank_present,
        `Valve is working (conditional on tank being present)` = jc_valve,
        `Dispenser is not empty (conditional on valve working)` = jc_chlorine
      ),
      ~ sum(., na.rm = TRUE),
      .names = "{.col}_Count"
    )
  ) %>%
  pivot_longer(
    everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c(" ", ".value")
  ) %>%
  select(" ", `N Obs`, Count, Percent)
```


### Chlorine dosage

```{r}
dsw %>%
  ggplot(
    aes(
      x = jc_mldispensed,
      fill = as.factor(jc_mllost)
    )
  ) +
  geom_vline(
    xintercept = 2.8,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_vline(
    xintercept = 3.2,
    color = "gray",
    linetype = "dashed"
  ) +
  geom_histogram() +
  scale_fill_viridis_d() +
  theme +
  labs(
    y = "Number of dispensers",
    x = "Chlorine dose (mL)",
    fill = "Some chlorine leaked out of the calibrated cylinder"
  )
```

### Chlorine residual distribution

```{r}
dsw %>%
  select(
    `Color wheel_TCR` = disctcr, 
    `Color wheel_FCR` = discfcr, 
    Colorimeter_TCR = metertcr,
    Colorimeter_FCR = meterfcr
  ) %>%
  pivot_longer(
    cols = everything(),
    names_pattern = "(.*)_(.*)",
    names_to = c("instrument", "test")
  ) %>%
  ggplot(
    aes(
      x = value,
      fill = instrument
    )
  ) +
  scale_fill_viridis_d() + 
  geom_density() +
  facet_grid(test ~ instrument) +
  theme +
  labs(
    x = "Chlorine residual reading (mg/L)",
    y = "Number of tests"
  ) + 
  theme(legend.position = "none")
```
